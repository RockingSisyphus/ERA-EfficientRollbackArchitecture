# 如何在消息尾部稳定生成HTML状态栏

对于希望在每条AI生成的消息末尾稳定渲染自定义HTML状态栏的作者来说，ERA变量框架提供了一个专门的设置来实现此功能。

## 实现步骤

1. **打开ERA设置面板**
    * 在酒馆界面右下角，找到并点击ERA的 **悬浮球** 图标，即可打开设置面板。
    * **如果看不到悬浮球**：请前往酒馆助手的脚本库，找到ERA变量框架脚本，检查其设置中的 `开启悬浮球` 选项是否被关闭了。请确保它是开启状态。

2. **开启符号生成功能**
    * 在ERA设置面板中，找到并启用 **`在ai消息尾部生成特殊符号`** 这个选项。
    * （可选）你可以自定义 **`特殊符号值`** 选项，默认值为 `<StatusPlaceHolderImpl/>`。这个值就是ERA框架会自动添加到消息末尾的符号。

3. **在酒馆中设置正则表达式替换**
    * 现在，ERA框架会确保每条AI生成的消息末尾都包含你设定的特殊符号。你需要在酒馆的 **正则表达式** 设置中，添加一条规则来将这个符号替换为你的HTML状态栏代码。
    * 前往酒馆的 `扩展功能` -> `正则表达式` 菜单。
    * 点击 `添加新的正则表达式` 并填写以下字段：
        * **匹配 (Match)**: 填入你的 **`特殊符号值`**。例如，如果使用默认值，就填 `<StatusPlaceHolderImpl/>`。
        * **替换 (Replace)**: 填入你想要显示的 **HTML状态栏代码**。这段代码可以包含ERA宏来动态显示变量。

    **替换 (Replace) 字段示例:**

    关于替换字段中使用的HTML代码，请参考本目录下的 **`状态栏HTML示例.html`** 文件。

    你可以将该文件中的全部内容复制并粘贴到酒馆正则表达式的“替换 (Replace)”字段中。

    **特别注意**：在粘贴HTML代码到“替换 (Replace)”字段时，必须使用Markdown的HTML代码围栏将其包裹起来，如下所示，否则酒馆助手可能无法正确解析：

    ``````
    ```html
    (这里粘贴你的完整HTML代码)
    ```
    ``````

    * 确保勾选 `启用`，然后保存设置。

## 重要提醒

* **符号生成逻辑**: ERA框架只会在AI生成的消息中 **不存在** 对应特殊符号时，才会在末尾添加它。因此，如果你发现某个消息末尾没有生成符号，请首先检查该消息内容本身是否已经包含了这个符号。

* **配合ERA宏使用**: 如果你的HTML状态栏中使用了ERA宏（例如 `{{ERA:player.hp}}`）来动态获取数据，为了确保每次状态栏都能显示最新的变量值，你 **必须** 在ERA设置中开启 **`强制重载功能`**。这会强制ERA在每次消息生成时都重新渲染包含宏的部分，确保数据实时更新。如果你不希望每次都强制重载，可以参考 **`进阶角色卡构建需要阅读和使用的文件`** 目录下的文档，了解更灵活的数据更新方式。

通过以上步骤，你就可以实现一个稳定、可靠且能动态更新的HTML状态栏。

---

### 进阶用法：通过监听事件更新

如果你不希望使用“强制重载”功能，或者想要实现更复杂的交互，可以不使用ERA宏，而是通过编写JavaScript脚本来监听ERA的 `era:writeDone` 事件，从而手动更新状态栏。

这种方法性能更好，也更灵活。详细实现请参考 **`进阶角色卡构建需要阅读和使用的文件`** 目录下的 **`动态更新状态栏示例.html`** 文件。
