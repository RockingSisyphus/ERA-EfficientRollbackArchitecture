var e={n:t=>{var o=t&&t.__esModule?()=>t.default:()=>t;return e.d(o,{a:o}),o},d:(t,o)=>{for(var r in o)e.o(o,r)&&!e.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:o[r]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const t=_;var o=e.n(t);const r=z,n=r.z.object({在ai消息尾部生成特殊符号:r.z.boolean().default(!0),特殊符号值:r.z.string().default('<StatusPlaceHolderImpl/>'),开启悬浮球:r.z.boolean().default(!0),开启黑夜模式:r.z.boolean().default(!1),强制重载功能:r.z.boolean().default(!1),强制重载消息数:r.z.number().default(2),繁体转简体:r.z.boolean().default(!1),调试模式:r.z.boolean().default(!1)}),a={type:'chat'},l='era_data',s=(new RegExp(`<${l}>({.*?})<\\/${l}>`),Vue),c=(0,s.ref)(n.parse({})),i=(0,s.readonly)(c);function d(){const e=getVariables(a)||{};return{meta:o().get(e,'ERAMetaData',{}),stat:o().get(e,'stat_data',{})}}const u='era_debug_config';let g=[],b=[];function f(){try{const e=globalThis.localStorage?.getItem(u)||'{"enabled":[],"disabled":[]}',t=JSON.parse(e),o=e=>new RegExp(`^${e.replace(/\*/g,'.*?')}$`);g=(t.enabled||[]).map(o),b=(t.disabled||[]).map(o)}catch(e){console.error('《ERA-Log》: 加载调试配置失败。',e),g=[],b=[]}}function p(e){const t={enabled:[...new Set(e.enabled)],disabled:[...new Set(e.disabled)]};globalThis.localStorage?.setItem(u,JSON.stringify(t)),f(),console.log('%c《ERA-Log》调试模式已更新。','color: #3498db; font-weight: bold;',{'启用 (Enabled)':t.enabled,'禁用 (Disabled)':t.disabled})}if(f(),'undefined'!=typeof globalThis){const e={add(e){const t=globalThis.localStorage?.getItem(u)||'{"enabled":[],"disabled":[]}',o=JSON.parse(t),r=new Set(o.enabled||[]),n=new Set(o.disabled||[]);r.add(e),n.delete(e),p({enabled:Array.from(r),disabled:Array.from(n)})},remove(e){const t=globalThis.localStorage?.getItem(u)||'{"enabled":[],"disabled":[]}',o=JSON.parse(t),r=new Set(o.enabled||[]),n=new Set(o.disabled||[]);n.add(e),r.delete(e),p({enabled:Array.from(r),disabled:Array.from(n)})},status(){const e=globalThis.localStorage?.getItem(u)||'{"enabled":[],"disabled":[]}',t=JSON.parse(e);console.log('%c《ERA-Log》当前调试配置:','color: #3498db; font-weight: bold;',t)},clear(){p({enabled:[],disabled:[]})}};globalThis.eraDebug=e}const m='';class E{moduleName;constructor(e){this.moduleName=e||this._getModuleNameFromStack()||'unknown'}_getModuleNameFromStack(){try{const e=((new Error).stack||'').split('\n').find(e=>(e.includes('/src/ERA变量框架/')||e.includes('/dist/ERA变量框架/')||e.includes('\\src\\ERA变量框架\\')||e.includes('\\dist\\ERA变量框架\\'))&&!e.includes('/utils/log.ts'));if(!e)return null;const t=e.match(new RegExp('(src|dist)[\\\\/]ERA变量框架[\\\\/]([^?:]+)'));if(!t||!t[2])return null;return t[2].replace(/\\/g,'/').replace(/\.(vue|ts|js)$/,'').replace(/\/index$/,'')}catch(e){return console.error('《ERA-Log-Debug》: 解析模块名时发生意外错误。',e),null}}formatMessage(e,t){return`《ERA》${m?`（${m}）`:''}「${this.moduleName}」【${e}】${String(t)}`}debug(e,t,o){if(!(r=this.moduleName)||b.some(e=>e.test(r))||0===g.length||!g.some(e=>e.test(r)))return;var r;const n=this.formatMessage(e,t);void 0!==o?console.debug(n,o):console.debug(n)}log(e,t,o){const r=this.formatMessage(e,t);void 0!==o?console.log(`%c${r}`,'color: #3498db;',o):console.log(`%c${r}`,'color: #3498db;')}warn(e,t,o){const r=this.formatMessage(e,t);void 0!==o?console.warn(`%c${r}`,'color: #f39c12;',o):console.warn(`%c${r}`,'color: #f39c12;'),i.value.调试模式&&toastr.warning(r)}error(e,t,o){const r=this.formatMessage(e,t);void 0!==o?console.error(`%c${r}`,'color: #e74c3c; font-weight: bold;',o):console.error(`%c${r}`,'color: #e74c3c; font-weight: bold;'),i.value.调试模式&&toastr.error(r)}}new E('ERA变量框架/utils/data');const A={'.':'__DOT__','"':'__DQUOTE__','\'':'__SQUOTE__'},h=_.invert(A),w=(new RegExp(Object.keys(A).map(_.escapeRegExp).join('|'),'g'),new RegExp(Object.values(A).map(_.escapeRegExp).join('|'),'g'));function R(e){if(Array.isArray(e))return e.map(e=>R(e));if(_.isPlainObject(e)){const t={};for(const o in e)if(Object.prototype.hasOwnProperty.call(e,o)){t[o.replace(w,e=>h[e])]=R(e[o])}return t}return'string'==typeof e?e.replace(w,e=>h[e]):e}const v=new E('LogTest-MacroParser');function y(e,t,r){if(!e.includes('{{ERA'))return e;const n=t??d().stat,a=r??function(e){if(!o().isObject(e))return e;const t=o().cloneDeep(e);return function e(t){if(Array.isArray(t))t.forEach(t=>e(t));else if(o().isPlainObject(t))for(const o in t)o.startsWith('$')?delete t[o]:e(t[o])}(t),t}(d().stat);return e.replace(/{{\s*ERA(-withmeta)?\s*:\s*([^}]+?)\s*}}/gi,(e,t,o)=>{const r='parseEraMacros',l=o.trim(),s=!!t,c=s?n:a;if(!c)return v.warn(r,`无法获取到宏替换所需的数据 (includeMeta: ${s})`),e;let i;if(i='$ALLDATA'===l?c:_.get(c,l),void 0===i)return v.warn(r,`在数据源中未找到路径 "${l}", 宏将替换为空字符串.`),'';const d=R(i);return v.debug(r,`宏替换数据反转义: ${l}`,{before:i,after:d}),'object'==typeof d&&null!==d?JSON.stringify(d):String(d)})}const S=(e,t)=>{if(t)return;if(!e.prompt.some(e=>'string'==typeof e.content&&e.content.includes('{{ERA')))return;v.debug('handleGenerateAfterData','发送 era:getCurrentVars 事件以获取宏替换所需的状态。'),eventEmit('era:getCurrentVars')};$(()=>{console.log('日志测试脚本已加载。'),eventOn(tavern_events.GENERATE_AFTER_DATA,S),$(window).on('pagehide',()=>{eventRemoveListener(tavern_events.GENERATE_AFTER_DATA,S)})});export{y as parseEraMacros};
//# sourceMappingURL=index.js.map