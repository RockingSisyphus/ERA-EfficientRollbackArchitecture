import{Converter as e}from'https://testingcf.jsdelivr.net/npm/opencc-js/+esm';const o=z,s=o.z.object({在ai消息尾部生成特殊符号:o.z.boolean().default(!0),特殊符号值:o.z.string().default('<StatusPlaceHolderImpl/>'),开启悬浮球:o.z.boolean().default(!0),开启黑夜模式:o.z.boolean().default(!1),强制重载功能:o.z.boolean().default(!1),强制重载消息数:o.z.number().default(2),繁体转简体:o.z.boolean().default(!1),调试模式:o.z.boolean().default(!1)}),l='era_data',t=(new RegExp(`<${l}>({.*?})<\\/${l}>`),_,Vue),a=(0,t.ref)(s.parse({})),n=(0,t.readonly)(a);const r='era_debug_config';let c=[],d=[];function i(){try{const e=globalThis.localStorage?.getItem(r)||'{"enabled":[],"disabled":[]}',o=JSON.parse(e),s=e=>new RegExp(`^${e.replace(/\*/g,'.*?')}$`);c=(o.enabled||[]).map(s),d=(o.disabled||[]).map(s)}catch(e){console.error('《ERA-Log》: 加载调试配置失败。',e),c=[],d=[]}}function g(e){const o={enabled:[...new Set(e.enabled)],disabled:[...new Set(e.disabled)]};globalThis.localStorage?.setItem(r,JSON.stringify(o)),i(),console.log('%c《ERA-Log》调试模式已更新。','color: #3498db; font-weight: bold;',{'启用 (Enabled)':o.enabled,'禁用 (Disabled)':o.disabled})}if(i(),'undefined'!=typeof globalThis){const e={add(e){const o=globalThis.localStorage?.getItem(r)||'{"enabled":[],"disabled":[]}',s=JSON.parse(o),l=new Set(s.enabled||[]),t=new Set(s.disabled||[]);l.add(e),t.delete(e),g({enabled:Array.from(l),disabled:Array.from(t)})},remove(e){const o=globalThis.localStorage?.getItem(r)||'{"enabled":[],"disabled":[]}',s=JSON.parse(o),l=new Set(s.enabled||[]),t=new Set(s.disabled||[]);t.add(e),l.delete(e),g({enabled:Array.from(l),disabled:Array.from(t)})},status(){const e=globalThis.localStorage?.getItem(r)||'{"enabled":[],"disabled":[]}',o=JSON.parse(e);console.log('%c《ERA-Log》当前调试配置:','color: #3498db; font-weight: bold;',o)},clear(){g({enabled:[],disabled:[]})}};globalThis.eraDebug=e}const u='';class b{moduleName;constructor(e){this.moduleName=e||this._getModuleNameFromStack()||'unknown'}_getModuleNameFromStack(){try{const e=((new Error).stack||'').split('\n').find(e=>(e.includes('/src/ERA变量框架/')||e.includes('/dist/ERA变量框架/')||e.includes('\\src\\ERA变量框架\\')||e.includes('\\dist\\ERA变量框架\\'))&&!e.includes('/utils/log.ts'));if(!e)return null;const o=e.match(new RegExp('(src|dist)[\\\\/]ERA变量框架[\\\\/]([^?:]+)'));if(!o||!o[2])return null;return o[2].replace(/\\/g,'/').replace(/\.(vue|ts|js)$/,'').replace(/\/index$/,'')}catch(e){return console.error('《ERA-Log-Debug》: 解析模块名时发生意外错误。',e),null}}formatMessage(e,o){return`《ERA》${u?`（${u}）`:''}「${this.moduleName}」【${e}】${String(o)}`}debug(e,o,s){if(!(l=this.moduleName)||d.some(e=>e.test(l))||0===c.length||!c.some(e=>e.test(l)))return;var l;const t=this.formatMessage(e,o);void 0!==s?console.debug(t,s):console.debug(t)}log(e,o,s){const l=this.formatMessage(e,o);void 0!==s?console.log(`%c${l}`,'color: #3498db;',s):console.log(`%c${l}`,'color: #3498db;')}warn(e,o,s){const l=this.formatMessage(e,o);void 0!==s?console.warn(`%c${l}`,'color: #f39c12;',s):console.warn(`%c${l}`,'color: #f39c12;'),n.value.调试模式&&toastr.warning(l)}error(e,o,s){const l=this.formatMessage(e,o);void 0!==s?console.error(`%c${l}`,'color: #e74c3c; font-weight: bold;',s):console.error(`%c${l}`,'color: #e74c3c; font-weight: bold;'),n.value.调试模式&&toastr.error(l)}}new b('ERA变量框架/utils/data');const m={'.':'__DOT__','"':'__DQUOTE__','\'':'__SQUOTE__'};_.invert(m),new RegExp(Object.keys(m).map(_.escapeRegExp).join('|'),'g'),new RegExp(Object.values(m).map(_.escapeRegExp).join('|'),'g');e({from:'tw',to:'cn'});function f(e){if(!e.includes('{{'))return e;let o=e;return o=o.replace(/{{user}}/gi,SillyTavern.name1),o=o.replace(/{{char}}/gi,SillyTavern.name2),o}new b('ERA变量框架/utils/message');function p(e){if(!e)return null;let o=null;if('string'==typeof e.mes)o=e.mes;else if(Array.isArray(e.swipes)){const s=Number(e.swipe_id??0);o=e.swipes[s]||null}else'string'==typeof e.message&&(o=e.message);return null===o?null:f(o)}$(()=>{console.log('日志测试脚本已加载。'),eventOn('message_swiped',async e=>{}),eventOn('message_received',async e=>{console.log('[logTest] 调用 ensurePlaceholder...');const o=getChatMessages(e,{include_swipes:!0})[0];console.log('[logTest] 拿到的chat_message...',o);const s='<test>',l=p(o);if(l&&l.includes(s))return void console.debug('消息已包含占位符，无需操作。');const t=(l||'').trimEnd()+'\n'+s;try{const s={message_id:e};if(Array.isArray(o.swipes)){const e=Number(o.swipe_id??0),l=[...o.swipes];l[e]=t,s.swipes=l}else s.message=t;console.log('[logTest] 写入前的message...',s),await setChatMessages([s],{refresh:'affected'})}catch(e){console.error('更新消息时发生错误。',e)}console.log('[logTest] ensurePlaceholder 完成。')})});
//# sourceMappingURL=index.js.map