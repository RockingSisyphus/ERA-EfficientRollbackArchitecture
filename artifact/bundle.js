import{Converter as e}from'https://testingcf.jsdelivr.net/npm/opencc-js/+esm';import{createPinia as t,defineStore as a,storeToRefs as n}from'https://testingcf.jsdelivr.net/npm/pinia/+esm';var r={23:(e,t,a)=>{var n=a(846);n.__esModule&&(n=n.default),'string'==typeof n&&(n=[[e.id,n,'']]),n.locals&&(e.exports=n.locals);(0,a(424).A)('d9852d4e',n,!1,{ssrId:!0})},38:(e,t,a)=>{var n=a(427);n.__esModule&&(n=n.default),'string'==typeof n&&(n=[[e.id,n,'']]),n.locals&&(e.exports=n.locals);(0,a(424).A)('14f85fa8',n,!1,{ssrId:!0})},42:(e,t)=>{t.A=(e,t)=>{const a=e.__vccOpts||e;for(const[e,n]of t)a[e]=n;return a}},45:(e,t,a)=>{var n=a(800);n.__esModule&&(n=n.default),'string'==typeof n&&(n=[[e.id,n,'']]),n.locals&&(e.exports=n.locals);(0,a(424).A)('6d46e850',n,!1,{ssrId:!0})},51:(e,t,a)=>{a.r(t),a.d(t,{default:()=>i});var n=a(93),r=a.n(n),s=a(54),o=a.n(s)()(r());o.push([e.id,'.about-era-card[data-v-9b1026a6]{width:100%;padding:12px;background:var(--actions-bg-glass);border:1px solid var(--border-strong);border-radius:16px;backdrop-filter:blur(10px);box-shadow:var(--actions-shadow-card),var(--shadow-inset);display:flex;flex-direction:column;gap:10px;transition:background 0.3s ease,border-color 0.3s ease}.card-title[data-v-9b1026a6]{margin:0 0 4px;font-size:14px;font-weight:800;letter-spacing:0.3px;color:var(--text-title);transition:color 0.3s ease}.info-list[data-v-9b1026a6]{font-size:13px;color:var(--text-normal)}.info-list ul[data-v-9b1026a6]{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:8px}.info-list li[data-v-9b1026a6]{display:flex;justify-content:space-between}.info-list a[data-v-9b1026a6]{color:var(--text-subtitle);text-decoration:none;font-weight:600;transition:color 0.3s ease}.info-list a[data-v-9b1026a6]:hover{color:var(--text-title);text-decoration:underline}\n','']);const i=o},54:e=>{e.exports=function(e){var t=[];return t.toString=function(){return this.map(function(t){var a='',n=void 0!==t[5];return t[4]&&(a+='@supports ('.concat(t[4],') {')),t[2]&&(a+='@media '.concat(t[2],' {')),n&&(a+='@layer'.concat(t[5].length>0?' '.concat(t[5]):'',' {')),a+=e(t),n&&(a+='}'),t[2]&&(a+='}'),t[4]&&(a+='}'),a}).join('')},t.i=function(e,a,n,r,s){'string'==typeof e&&(e=[[null,e,void 0]]);var o={};if(n)for(var i=0;i<this.length;i++){var l=this[i][0];null!=l&&(o[l]=!0)}for(var c=0;c<e.length;c++){var d=[].concat(e[c]);n&&o[d[0]]||(void 0!==s&&(void 0===d[5]||(d[1]='@layer'.concat(d[5].length>0?' '.concat(d[5]):'',' {').concat(d[1],'}')),d[5]=s),a&&(d[2]?(d[1]='@media '.concat(d[2],' {').concat(d[1],'}'),d[2]=a):d[2]=a),r&&(d[4]?(d[1]='@supports ('.concat(d[4],') {').concat(d[1],'}'),d[4]=r):d[4]=''.concat(r)),t.push(d))}},t}},76:(e,t,a)=>{var n=a(51);n.__esModule&&(n=n.default),'string'==typeof n&&(n=[[e.id,n,'']]),n.locals&&(e.exports=n.locals);(0,a(424).A)('56282654',n,!1,{ssrId:!0})},93:e=>{e.exports=function(e){return e[1]}},136:(e,t,a)=>{var n=a(985);n.__esModule&&(n=n.default),'string'==typeof n&&(n=[[e.id,n,'']]),n.locals&&(e.exports=n.locals);(0,a(424).A)('b04d1a4a',n,!1,{ssrId:!0})},222:(e,t,a)=>{a.r(t),a.d(t,{default:()=>i});var n=a(93),r=a.n(n),s=a(54),o=a.n(s)()(r());o.push([e.id,'.input-btn-combo[data-v-6bdeb56f]{display:flex;gap:8px}.input-field[data-v-6bdeb56f]{flex-grow:1;width:0;padding:8px 12px;border-radius:10px;border:1px solid var(--settings-border-input,var(--border-soft));background:var(--settings-bg-btn-subtle,var(--actions-btn-bg));color:var(--settings-text-input,var(--text-normal));font-size:13px;font-weight:600;text-align:center;transition:all 0.3s ease;box-shadow:var(--settings-shadow-inset)}.input-field[data-v-6bdeb56f]::placeholder{color:var(--text-soft);font-weight:500}.input-field[data-v-6bdeb56f]:focus{outline:none;border-color:var(--actions-outline-focus);box-shadow:var(--settings-shadow-inset),0 0 0 3px var(--snapshot-accent-soft)}.input-field[data-v-6bdeb56f]::-webkit-outer-spin-button,.input-field[data-v-6bdeb56f]::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}.input-field[type=\'number\'][data-v-6bdeb56f]{-moz-appearance:textfield}.combo-btn[data-v-6bdeb56f]{flex-shrink:0;padding-left:12px;padding-right:12px}.action-buttons-card[data-v-6bdeb56f]{width:100%;padding:12px;background:var(--actions-bg-glass);border:1px solid var(--border-strong);border-radius:16px;backdrop-filter:blur(10px);box-shadow:var(--actions-shadow-card),var(--shadow-inset);display:flex;flex-direction:column;gap:10px;transition:background 0.3s ease,border-color 0.3s ease}.card-title[data-v-6bdeb56f]{margin:0 0 4px;font-size:14px;font-weight:800;letter-spacing:0.3px;color:var(--text-title);transition:color 0.3s ease}.btns[data-v-6bdeb56f]{display:flex;flex-direction:column;gap:16px}.btn-group[data-v-6bdeb56f]{display:flex;flex-direction:column;gap:6px}.btn-desc[data-v-6bdeb56f]{font-size:11px;color:var(--text-soft);padding:0 4px;line-height:1.5;margin:0;transition:color 0.3s ease}.btn[data-v-6bdeb56f]{display:grid;grid-template-columns:22px 1fr;align-items:center;-moz-column-gap:8px;column-gap:8px;padding:10px 12px;border-radius:12px;border:1px solid var(--border-soft);background:var(--actions-btn-bg);color:var(--actions-btn-text);font-weight:700;font-size:13px;cursor:pointer;box-shadow:var(--settings-shadow-inset),var(--shadow-button);transition:transform 0.12s ease,box-shadow 0.12s ease,background 0.2s ease,color 0.3s ease,border-color 0.3s ease;text-align:left}.btn.primary[data-v-6bdeb56f]{background:var(--actions-btn-primary-bg);border-color:var(--actions-btn-primary-border);color:var(--actions-btn-primary-text)}.btn.subtle[data-v-6bdeb56f]{background:var(--actions-btn-subtle-bg);border-color:var(--actions-btn-subtle-border)}.btn.danger[data-v-6bdeb56f]{background:var(--actions-btn-danger-bg);border-color:var(--actions-btn-danger-border);color:var(--actions-btn-danger-text)}.btn[data-v-6bdeb56f]:hover{transform:translateY(-1px);box-shadow:var(--settings-shadow-inset),var(--shadow-button-hover)}.btn[data-v-6bdeb56f]:active{transform:translateY(0);box-shadow:var(--settings-shadow-inset),var(--actions-shadow-btn-active)}.btn[data-v-6bdeb56f]:focus-visible{outline:2px solid var(--actions-outline-focus);outline-offset:2px}.ico[data-v-6bdeb56f]{display:inline-grid;place-items:center;width:22px;height:22px;filter:saturate(0.95)}.label[data-v-6bdeb56f]{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}\n','']);const i=o},273:(e,t,a)=>{var n=a(276);n.__esModule&&(n=n.default),'string'==typeof n&&(n=[[e.id,n,'']]),n.locals&&(e.exports=n.locals);(0,a(424).A)('938e4c44',n,!1,{ssrId:!0})},276:(e,t,a)=>{a.r(t),a.d(t,{default:()=>i});var n=a(93),r=a.n(n),s=a(54),o=a.n(s)()(r());o.push([e.id,'.json-root[data-v-6fc9ef75]{font-size:12px;color:var(--settings-text-input);transition:color 0.3s ease}.json-line[data-v-6fc9ef75]{position:relative;display:flex;align-items:center;gap:6px;padding:2px 6px;border-radius:6px;transition:background 0.2s ease}.json-line[data-v-6fc9ef75]:hover{background:var(--json-hover-bg)}.json-children[data-v-6fc9ef75]{border-left:1px dashed var(--json-tree-line);transition:border-color 0.3s ease}.key[data-v-6fc9ef75]{color:var(--json-key-color);font-weight:700;transition:color 0.3s ease}.colon[data-v-6fc9ef75]{color:var(--text-normal);transition:color 0.3s ease}.brace[data-v-6fc9ef75]{color:var(--text-normal);transition:color 0.3s ease}.val.string[data-v-6fc9ef75]{color:var(--json-val-string)}.val.number[data-v-6fc9ef75]{color:var(--json-val-number)}.val.boolean[data-v-6fc9ef75]{color:var(--json-val-boolean)}.val.null[data-v-6fc9ef75]{color:var(--json-val-null)}.val.undefined[data-v-6fc9ef75]{color:var(--json-val-null)}.json-root[data-v-6fc9ef75]{overflow:clip;contain:layout paint;min-height:0}.json-children[data-v-6fc9ef75]{overflow:clip;contain:paint}\n','']);const i=o},344:(e,t,a)=>{var n=a(425);n.__esModule&&(n=n.default),'string'==typeof n&&(n=[[e.id,n,'']]),n.locals&&(e.exports=n.locals);(0,a(424).A)('0d513677',n,!1,{ssrId:!0})},348:(e,t,a)=>{a.r(t),a.d(t,{default:()=>i});var n=a(93),r=a.n(n),s=a(54),o=a.n(s)()(r());o.push([e.id,'.settings-card[data-v-e1f9e9e0]{width:100%;padding:12px;background:var(--settings-bg-glass);border:1px solid var(--border-strong);border-radius:16px;backdrop-filter:blur(10px);box-shadow:var(--settings-shadow-card),var(--settings-shadow-inset);display:flex;flex-direction:column;gap:10px;transition:background 0.3s ease,border-color 0.3s ease}.card-header[data-v-e1f9e9e0]{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border-radius:10px;border:1px solid var(--border-soft);background:var(--chip-bg);color:var(--text-title);font-weight:800;font-size:13px;cursor:pointer;box-shadow:var(--settings-shadow-inset),var(--shadow-button);transition:background 0.3s ease,border-color 0.3s ease,color 0.3s ease,transform 0.2s ease,box-shadow 0.2s ease}.card-header[data-v-e1f9e9e0]:hover{transform:translateY(-1px);box-shadow:var(--settings-shadow-inset),var(--shadow-button-hover)}.title[data-v-e1f9e9e0]{pointer-events:none}.chev[data-v-e1f9e9e0]{opacity:0.7}.content[data-v-e1f9e9e0]{display:flex;flex-direction:column;gap:10px}.toolbar[data-v-e1f9e9e0]{display:flex;align-items:center;gap:8px}.spacer[data-v-e1f9e9e0]{flex:1}.mini-btn[data-v-e1f9e9e0]{padding:6px 10px;border-radius:8px;border:1px solid var(--border-normal);background:var(--chip-bg);color:var(--text-normal);cursor:pointer;font-size:12px;font-weight:700;box-shadow:var(--settings-shadow-inset),var(--settings-shadow-minibtn);transition:background 0.3s ease,border-color 0.3s ease,color 0.3s ease,transform 0.2s ease,box-shadow 0.2s ease}.mini-btn[data-v-e1f9e9e0]:hover{transform:translateY(-1px);box-shadow:var(--settings-shadow-inset),var(--settings-shadow-minibtn-hover)}.mini-btn.primary[data-v-e1f9e9e0]{background:var(--settings-bg-btn-primary);border-color:var(--settings-border-btn-primary);color:var(--settings-text-primary-btn)}.mini-btn.subtle[data-v-e1f9e9e0]{background:var(--settings-bg-btn-subtle);border-color:var(--settings-border-input)}.vars[data-v-e1f9e9e0]{display:flex;flex-direction:column;gap:8px}.var-row[data-v-e1f9e9e0]{display:grid;grid-template-columns:1fr minmax(120px,1.2fr) auto;align-items:center;gap:10px;padding:8px 10px;border:1px solid var(--border-soft);border-radius:10px;background:var(--settings-bg-var-row);transition:background 0.3s ease,border-color 0.3s ease}.var-key[data-v-e1f9e9e0]{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:12px;color:var(--text-subtitle);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;transition:color 0.3s ease}.var-editor[data-v-e1f9e9e0]{display:flex;align-items:center;gap:8px}.ipt[data-v-e1f9e9e0]{width:100%;padding:8px 10px;border-radius:8px;border:1px solid var(--settings-border-input);background:var(--bg-solid);font-size:12px;color:var(--settings-text-input);box-shadow:var(--settings-shadow-inset);transition:background 0.3s ease,border-color 0.3s ease,color 0.3s ease}.ta[data-v-e1f9e9e0]{min-height:64px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}.type-chip[data-v-e1f9e9e0]{font-size:11px;color:var(--text-subtitle);background:var(--settings-bg-type-chip);border:1px solid var(--settings-border-type-chip);border-radius:999px;padding:4px 8px;white-space:nowrap;transition:background 0.3s ease,border-color 0.3s ease,color 0.3s ease}.switch[data-v-e1f9e9e0]{position:relative;width:42px;height:24px;display:inline-block}.switch input[data-v-e1f9e9e0]{opacity:0;width:0;height:0}.switch .track[data-v-e1f9e9e0]{position:absolute;inset:0;border-radius:999px;background:var(--settings-bg-switch-track);box-shadow:var(--settings-shadow-inset);transition:background 0.2s ease}.switch .track[data-v-e1f9e9e0]::after{content:\'\';position:absolute;top:3px;left:3px;width:18px;height:18px;border-radius:50%;background:var(--settings-bg-switch-handle);box-shadow:var(--settings-shadow-switch-handle);transition:transform 0.2s ease,background 0.3s ease}.switch input:checked+.track[data-v-e1f9e9e0]{background:var(--settings-bg-switch-checked)}.switch input:checked+.track[data-v-e1f9e9e0]::after{transform:translateX(18px)}.hint[data-v-e1f9e9e0]{font-size:11px;color:var(--text-normal);transition:color 0.3s ease}.hint.ok[data-v-e1f9e9e0]{color:var(--settings-text-hint-ok)}.hint.bad[data-v-e1f9e9e0]{color:var(--settings-text-hint-bad)}.placeholder[data-v-e1f9e9e0]{padding:10px;color:var(--text-normal);font-size:12px;border:1px dashed var(--border-dashed);border-radius:10px;background:var(--bg-placeholder);transition:background 0.3s ease,border-color 0.3s ease,color 0.3s ease}\n','']);const i=o},424:(e,t,a)=>{function n(e,t){for(var a=[],n={},r=0;r<t.length;r++){var s=t[r],o=s[0],i={id:e+':'+r,css:s[1],media:s[2],sourceMap:s[3]};n[o]?n[o].parts.push(i):a.push(n[o]={id:o,parts:[i]})}return a}a.d(t,{A:()=>b});var r='undefined'!=typeof document;if('undefined'!=typeof DEBUG&&DEBUG&&!r)throw new Error('vue-style-loader cannot be used in a non-browser environment. Use { target: \'node\' } in your Webpack config to indicate a server-rendering environment.');var s={},o=r&&(document.head||document.getElementsByTagName('head')[0]),i=null,l=0,c=!1,d=function(){},u=null,p='data-vue-ssr-id',g='undefined'!=typeof navigator&&/msie [6-9]\b/.test(navigator.userAgent.toLowerCase());function b(e,t,a,r){c=a,u=r||{};var o=n(e,t);return m(o),function(t){for(var a=[],r=0;r<o.length;r++){var i=o[r];(l=s[i.id]).refs--,a.push(l)}t?m(o=n(e,t)):o=[];for(r=0;r<a.length;r++){var l;if(0===(l=a[r]).refs){for(var c=0;c<l.parts.length;c++)l.parts[c]();delete s[l.id]}}}}function m(e){for(var t=0;t<e.length;t++){var a=e[t],n=s[a.id];if(n){n.refs++;for(var r=0;r<n.parts.length;r++)n.parts[r](a.parts[r]);for(;r<a.parts.length;r++)n.parts.push(h(a.parts[r]));n.parts.length>a.parts.length&&(n.parts.length=a.parts.length)}else{var o=[];for(r=0;r<a.parts.length;r++)o.push(h(a.parts[r]));s[a.id]={id:a.id,refs:1,parts:o}}}}function f(){var e=document.createElement('style');return e.type='text/css',o.appendChild(e),e}function h(e){var t,a,n=document.querySelector('style['+p+'~="'+e.id+'"]');if(n){if(c)return d;n.parentNode.removeChild(n)}if(g){var r=l++;n=i||(i=f()),t=x.bind(null,n,r,!1),a=x.bind(null,n,r,!0)}else n=f(),t=w.bind(null,n),a=function(){n.parentNode.removeChild(n)};return t(e),function(n){if(n){if(n.css===e.css&&n.media===e.media&&n.sourceMap===e.sourceMap)return;t(e=n)}else a()}}var v,y=(v=[],function(e,t){return v[e]=t,v.filter(Boolean).join('\n')});function x(e,t,a,n){var r=a?'':n.css;if(e.styleSheet)e.styleSheet.cssText=y(t,r);else{var s=document.createTextNode(r),o=e.childNodes;o[t]&&e.removeChild(o[t]),o.length?e.insertBefore(s,o[t]):e.appendChild(s)}}function w(e,t){var a=t.css,n=t.media,r=t.sourceMap;if(n&&e.setAttribute('media',n),u.ssrId&&e.setAttribute(p,t.id),r&&(a+='\n/*# sourceURL='+r.sources[0]+' */',a+='\n/*# sourceMappingURL=data:application/json;base64,'+btoa(unescape(encodeURIComponent(JSON.stringify(r))))+' */'),e.styleSheet)e.styleSheet.cssText=a;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(a))}}},425:(e,t,a)=>{a.r(t),a.d(t,{default:()=>i});var n=a(93),r=a.n(n),s=a(54),o=a.n(s)()(r());o.push([e.id,'.acc[data-v-f723f6d6]{border:1px solid var(--border-soft);border-radius:12px;background:var(--accordion-bg);overflow:hidden;transition:background 0.3s ease,border-color 0.3s ease}.acc-head[data-v-f723f6d6]{width:100%;display:flex;align-items:center;gap:10px;background:var(--mk-pill-null-bg);border-bottom:1px solid var(--border-soft);padding:10px 12px;cursor:pointer;font-weight:800;color:var(--text-subtitle);transition:background 0.3s ease,border-color 0.3s ease,color 0.3s ease}.caret[data-v-f723f6d6]{transition:transform 0.18s ease}.caret.open[data-v-f723f6d6]{transform:rotate(90deg)}.title[data-v-f723f6d6]{font-size:13px}.spacer[data-v-f723f6d6]{flex:1}.hint[data-v-f723f6d6]{font-size:12px;color:var(--text-normal);transition:color 0.3s ease}.acc-body[data-v-f723f6d6]{max-height:0;overflow:hidden;transition:max-height 0.28s ease-in-out;background:var(--accordion-body-bg)}.acc-body.open[data-v-f723f6d6]{max-height:600px;overflow-y:auto}.inner[data-v-f723f6d6]{padding:10px 12px}\n','']);const i=o},427:(e,t,a)=>{a.r(t),a.d(t,{default:()=>i});var n=a(93),r=a.n(n),s=a(54),o=a.n(s)()(r());o.push([e.id,'.details-wrapper[data-v-6079192c]{display:flex;flex-direction:column;gap:10px}.detail-block[data-v-6079192c]{padding:10px 12px;background:var(--bg-soft);border:1px solid var(--border-soft);border-radius:10px;transition:background 0.3s ease,border-color 0.3s ease}.detail-title[data-v-6079192c]{margin:0 0 8px;font-size:13px;font-weight:800;color:var(--text-subtitle);transition:color 0.3s ease}\n','']);const i=o},439:(e,t,a)=>{a.r(t),a.d(t,{default:()=>i});var n=a(93),r=a.n(n),s=a(54),o=a.n(s)()(r());o.push([e.id,':root{--bg-blur-heavy:linear-gradient(180deg,rgba(255,255,255,0.75),rgba(255,255,255,0.65));--bg-blur-light:linear-gradient(90deg,rgba(255,255,255,0.65),rgba(255,255,255,0.45));--bg-solid:#fff;--bg-soft:rgba(255,255,255,0.6);--bg-empty:rgba(255,255,255,0.5);--paper:#fff;--border-strong:rgba(255,255,255,0.6);--border-normal:rgba(0,0,0,0.08);--border-soft:rgba(0,0,0,0.06);--border-dashed:rgba(0,0,0,0.08);--line:rgba(0,0,0,0.08);--text-title:#1f2937;--text-subtitle:#374151;--text-normal:#6b7280;--muted:#6b7280;--shadow-panel:0 10px 40px rgba(0,0,0,0.18);--shadow-button:0 2px 8px rgba(0,0,0,0.08);--shadow-button-hover:0 6px 16px rgba(0,0,0,0.12);--shadow-inset:inset 0 1px 0 rgba(255,255,255,0.6);--chip-bg:linear-gradient(180deg,#fafafa,#f4f4f4);--chip-text:#6b7280;--chip-border:rgba(0,0,0,0.06);--chip-ok-bg:linear-gradient(180deg,#ecfdf5,#d1fae5);--chip-ok-text:#065f46;--chip-ok-border:#a7f3d0;--mk-pill-bg:linear-gradient(180deg,#eef2ff,#e0e7ff);--mk-pill-text:#4338ca;--mk-pill-border:#c7d2fe;--mk-pill-null-bg:linear-gradient(180deg,#f9fafb,#f3f4f6);--mk-pill-null-text:#6b7280;--mk-pill-null-border:#e5e7eb;--settings-bg-glass:linear-gradient(180deg,rgba(255,255,255,0.76),rgba(255,255,255,0.62));--settings-shadow-card:0 10px 40px rgba(0,0,0,0.16);--settings-shadow-inset:inset 0 1px 0 #fff;--settings-shadow-minibtn:0 2px 6px rgba(0,0,0,0.06);--settings-shadow-minibtn-hover:0 5px 12px rgba(0,0,0,0.1);--settings-bg-var-row:linear-gradient(180deg,#ffffff,#f8fafc);--settings-text-input:#111827;--settings-text-primary-btn:#0f172a;--settings-border-input:#e5e7eb;--settings-bg-btn-primary:linear-gradient(180deg,#e0f2fe,#bfdbfe);--settings-border-btn-primary:#93c5fd;--settings-bg-btn-subtle:linear-gradient(180deg,#f9fafb,#f3f4f6);--settings-bg-type-chip:#eef2ff;--settings-border-type-chip:#c7d2fe;--settings-bg-switch-track:#e5e7eb;--settings-bg-switch-handle:#fff;--settings-shadow-switch-handle:0 1px 3px rgba(0,0,0,0.2);--settings-bg-switch-checked:#93c5fd;--settings-text-hint-ok:#065f46;--settings-text-hint-bad:#b91c1c;--actions-bg-glass:linear-gradient(180deg,rgba(255,255,255,0.76),rgba(255,255,255,0.62));--actions-shadow-card:0 10px 40px rgba(0,0,0,0.16);--actions-btn-bg:linear-gradient(180deg,#fafafa,#f3f4f6);--actions-btn-text:#374151;--actions-btn-primary-bg:linear-gradient(180deg,#e0f2fe,#bfdbfe);--actions-btn-primary-border:#93c5fd;--actions-btn-primary-text:#0f172a;--actions-btn-subtle-bg:linear-gradient(180deg,#f9fafb,#f3f4f6);--actions-btn-subtle-border:#e5e7eb;--actions-btn-danger-bg:linear-gradient(180deg,#fee2e2,#fecaca);--actions-btn-danger-border:#fca5a5;--actions-btn-danger-text:#991b1b;--actions-shadow-btn-active:0 2px 8px rgba(0,0,0,0.1);--actions-outline-focus:#60a5fa;--text-soft:#6b7280;--accordion-bg:linear-gradient(180deg,#fff,#fafafa);--accordion-body-bg:rgba(255,255,255,0.82);--meta-bg:linear-gradient(180deg,#ffffff,#f9fafb);--meta-shadow:0 6px 18px rgba(0,0,0,0.06);--meta-key-bg:#f3f4f6;--meta-glow-bg:linear-gradient(90deg,#60a5fa,#a78bfa,#34d399,#f472b6);--json-hover-bg:rgba(59,130,246,0.06);--json-tree-line:rgba(107,114,128,0.25);--json-key-color:#1f2937;--json-val-string:#047857;--json-val-number:#7c3aed;--json-val-boolean:#0369a1;--json-val-null:#9ca3af;--json-caret-shadow:0 1px 0 #fff,0 2px 6px rgba(0,0,0,0.06);--json-caret-open-shadow:0 3px 10px rgba(0,0,0,0.12);--tab-active-shadow:0 0 0 3px rgba(147,197,253,0.35);--tab-content-bg:rgba(255,255,255,0.86);--ball-hue:210;--ball-sat:15%;--ball-lum:95%;--ball-shadow-color:rgba(0,0,0,0.15);--ball-glow-color:rgba(180,200,220,0.55);--ball-inner-shadow-color:rgba(0,0,0,0.1);--ball-specular-color:rgba(255,255,255,0.9);--ball-glass-color:rgba(255,255,255,0.1);--ball-focus-outline:rgba(180,200,220,0.85);--ball-logo-bg:linear-gradient(180deg,#8899aa 0%,#556677 100%);--ball-logo-shadow-top:rgba(0,0,0,0.25);--ball-logo-shadow-near:rgba(255,255,255,0.6);--ball-logo-shadow-far:rgba(0,0,0,0.1);--ball-logo-filter-glow:drop-shadow(0 0 1px rgba(0,0,0,0.2));--snapshot-accent:#5b8cff;--snapshot-accent-soft:rgba(91,140,255,0.25);--snapshot-bg:#fff;--snapshot-stroke:rgba(0,0,0,0.12);--snapshot-text:#2a2a2a;--snapshot-muted:#777;--snapshot-bg-gradient:linear-gradient(180deg,rgba(255,255,255,0.6),rgba(255,255,255,0.3));--snapshot-inner-shadow:inset 0 1px 0 rgba(255,255,255,0.45);--snapshot-outer-shadow:0 1px 2px rgba(0,0,0,0.04);--snapshot-focus-inner-shadow:inset 0 1px 0 rgba(255,255,255,0.5);--snapshot-btn-bg:#f5f5f0;--snapshot-btn-text:#333;--snapshot-btn-hover-bg:#e9e9e0;--snapshot-btn-active-bg:#dcdccf}.dark-theme{--bg-blur-heavy:linear-gradient(180deg,rgba(35,37,43,0.8),rgba(28,29,33,0.75));--bg-blur-light:linear-gradient(90deg,rgba(50,52,59,0.7),rgba(42,43,48,0.6));--bg-solid:#2d2f37;--bg-soft:rgba(60,63,73,0.5);--bg-empty:rgba(60,63,73,0.25);--paper:#2d2f37;--border-strong:rgba(255,255,255,0.12);--border-normal:rgba(255,255,255,0.1);--border-soft:rgba(255,255,255,0.08);--border-dashed:rgba(255,255,255,0.1);--line:rgba(255,255,255,0.1);--text-title:#f9fafb;--text-subtitle:#d1d5db;--text-normal:#9ca3af;--muted:#9ca3af;--shadow-panel:0 10px 40px rgba(0,0,0,0.3);--shadow-button:0 2px 8px rgba(0,0,0,0.25);--shadow-button-hover:0 6px 16px rgba(0,0,0,0.35);--shadow-inset:inset 0 1px 0 rgba(255,255,255,0.1);--chip-bg:linear-gradient(180deg,#4b5563,#374151);--chip-text:#e5e7eb;--chip-border:rgba(255,255,255,0.1);--chip-ok-bg:linear-gradient(180deg,#064e3b,#052e22);--chip-ok-text:#a7f3d0;--chip-ok-border:#047857;--mk-pill-bg:linear-gradient(180deg,#3730a3,#312e81);--mk-pill-text:#c7d2fe;--mk-pill-border:#4f46e5;--mk-pill-null-bg:linear-gradient(180deg,#4b5563,#374151);--mk-pill-null-text:#9ca3af;--mk-pill-null-border:#6b7280;--settings-bg-glass:linear-gradient(180deg,rgba(40,42,48,0.8),rgba(33,34,38,0.75));--settings-shadow-card:0 10px 40px rgba(0,0,0,0.3);--settings-shadow-inset:inset 0 1px 0 rgba(255,255,255,0.05);--settings-shadow-minibtn:0 2px 6px rgba(0,0,0,0.2);--settings-shadow-minibtn-hover:0 5px 12px rgba(0,0,0,0.3);--settings-bg-var-row:#2d2f37;--settings-text-input:#f9fafb;--settings-text-primary-btn:#e0f2fe;--settings-border-input:#4b5563;--settings-bg-btn-primary:linear-gradient(180deg,#3b82f6,#2563eb);--settings-border-btn-primary:#1d4ed8;--settings-bg-btn-subtle:linear-gradient(180deg,#4b5563,#374151);--settings-bg-type-chip:#3730a3;--settings-border-type-chip:#4f46e5;--settings-bg-switch-track:#4b5563;--settings-bg-switch-handle:#d1d5db;--settings-shadow-switch-handle:0 1px 3px rgba(0,0,0,0.4);--settings-bg-switch-checked:#3b82f6;--settings-text-hint-ok:#34d399;--settings-text-hint-bad:#ef4444;--actions-bg-glass:linear-gradient(180deg,rgba(40,42,48,0.8),rgba(33,34,38,0.75));--actions-shadow-card:0 10px 40px rgba(0,0,0,0.3);--actions-btn-bg:linear-gradient(180deg,#4b5563,#374151);--actions-btn-text:#d1d5db;--actions-btn-primary-bg:linear-gradient(180deg,#3b82f6,#2563eb);--actions-btn-primary-border:#1d4ed8;--actions-btn-primary-text:#f1f5f9;--actions-btn-subtle-bg:linear-gradient(180deg,#4b5563,#374151);--actions-btn-subtle-border:#6b7280;--actions-shadow-btn-active:0 2px 8px rgba(0,0,0,0.2);--actions-outline-focus:#2563eb;--accordion-bg:var(--bg-solid);--accordion-body-bg:rgba(45,47,55,0.5);--meta-bg:linear-gradient(180deg,#2d2f37,#24262b);--meta-shadow:0 6px 18px rgba(0,0,0,0.2);--meta-key-bg:#374151;--meta-glow-bg:linear-gradient(90deg,#3b82f6,#8b5cf6,#10b981,#ec4899);--json-hover-bg:rgba(147,197,253,0.1);--json-tree-line:rgba(107,114,128,0.4);--json-key-color:#e5e7eb;--json-val-string:#6ee7b7;--json-val-number:#c4b5fd;--json-val-boolean:#7dd3fc;--json-val-null:#9ca3af;--json-caret-shadow:0 1px 0 rgba(255,255,255,0.05),0 2px 6px rgba(0,0,0,0.2);--json-caret-open-shadow:0 3px 10px rgba(0,0,0,0.3);--tab-active-shadow:0 0 0 3px rgba(59,130,246,0.4);--tab-content-bg:rgba(45,47,55,0.5);--ball-hue:220;--ball-sat:10%;--ball-lum:25%;--ball-shadow-color:rgba(0,0,0,0.3);--ball-glow-color:rgba(150,180,210,0.4);--ball-inner-shadow-color:rgba(0,0,0,0.4);--ball-specular-color:rgba(255,255,255,0.15);--ball-glass-color:rgba(255,255,255,0.05);--ball-focus-outline:rgba(150,180,210,0.7);--ball-logo-bg:linear-gradient(180deg,rgba(255,255,255,0.9) 0%,rgba(233,213,255,0.6) 45%,rgba(220,200,255,0.5) 65%,rgba(191,128,255,0.65) 100%),linear-gradient(180deg,rgba(0,0,0,0.45),rgba(0,0,0,0) 60%);--ball-logo-shadow-top:rgba(255,255,255,0.6);--ball-logo-shadow-near:rgba(0,0,0,0.3);--ball-logo-shadow-far:rgba(138,43,226,0.45);--ball-logo-filter-glow:drop-shadow(0 0 3px rgba(191,128,255,0.35));--snapshot-accent:#3b82f6;--snapshot-accent-soft:rgba(59,130,246,0.3);--snapshot-bg:#2d2f37;--snapshot-stroke:rgba(255,255,255,0.1);--snapshot-text:#f9fafb;--snapshot-muted:#9ca3af;--snapshot-bg-gradient:linear-gradient(180deg,rgba(255,255,255,0.08),transparent);--snapshot-inner-shadow:inset 0 1px 0 rgba(255,255,255,0.05);--snapshot-outer-shadow:0 1px 2px rgba(0,0,0,0.2);--snapshot-focus-inner-shadow:inset 0 1px 0 rgba(255,255,255,0.1);--snapshot-btn-bg:#4a4a4a;--snapshot-btn-text:#eee;--snapshot-btn-hover-bg:#5a5a5a;--snapshot-btn-active-bg:#3a3a3a}\n','']);const i=o},446:(e,t,a)=>{var n=a(439);n.__esModule&&(n=n.default),'string'==typeof n&&(n=[[e.id,n,'']]),n.locals&&(e.exports=n.locals);(0,a(424).A)('59de6eaf',n,!1,{ssrId:!0})},471:(e,t,a)=>{var n=a(348);n.__esModule&&(n=n.default),'string'==typeof n&&(n=[[e.id,n,'']]),n.locals&&(e.exports=n.locals);(0,a(424).A)('19a17811',n,!1,{ssrId:!0})},511:(e,t,a)=>{var n=a(952);n.__esModule&&(n=n.default),'string'==typeof n&&(n=[[e.id,n,'']]),n.locals&&(e.exports=n.locals);(0,a(424).A)('3cce307a',n,!1,{ssrId:!0})},544:(e,t,a)=>{var n=a(981);n.__esModule&&(n=n.default),'string'==typeof n&&(n=[[e.id,n,'']]),n.locals&&(e.exports=n.locals);(0,a(424).A)('0be4f183',n,!1,{ssrId:!0})},583:(e,t,a)=>{var n=a(222);n.__esModule&&(n=n.default),'string'==typeof n&&(n=[[e.id,n,'']]),n.locals&&(e.exports=n.locals);(0,a(424).A)('7b6876cf',n,!1,{ssrId:!0})},597:(e,t,a)=>{a.r(t),a.d(t,{default:()=>i});var n=a(93),r=a.n(n),s=a(54),o=a.n(s)()(r());o.push([e.id,'.floating-ball[data-v-3bb5cc6c]{--size:50px;--hue:var(--ball-hue,212);--sat:var(--ball-sat,100%);--lum:var(--ball-lum,52%);--surface:hsl(var(--hue) var(--sat) var(--lum));--surface-2:hsl(var(--hue) 95% 64%);--ring:hsl(calc(var(--hue) + 20) 95% 65%);--shadow:var(--ball-shadow-color,rgba(0,123,255,0.36));--glow:var(--ball-glow-color,rgba(102,200,255,0.55));--inner-shadow:var(--ball-inner-shadow-color,rgba(0,0,0,0.22));--specular:var(--ball-specular-color,rgba(255,255,255,0.75));--glass:var(--ball-glass-color,rgba(255,255,255,0.18));width:var(--size);height:var(--size);border-radius:50%;position:relative;display:grid;place-items:center;cursor:pointer;-webkit-user-select:none;user-select:none;-webkit-tap-highlight-color:transparent;background:radial-gradient(120% 120% at 30% 28%,rgba(255,255,255,0.85) 0%,rgba(255,255,255,0.22) 18%,rgba(255,255,255,0) 36%),radial-gradient(120% 120% at 70% 72%,rgba(0,0,0,0.18) 0%,rgba(0,0,0,0) 38%),conic-gradient(from 210deg at 50% 50%,var(--surface),var(--surface-2),var(--surface));box-shadow:inset 0 2px 6px var(--inner-shadow),0 2px 4px rgba(0,0,0,0.08),0 10px 22px var(--shadow);transition:transform 0.28s ease,box-shadow 0.28s ease,filter 0.28s ease;will-change:transform,box-shadow,filter;animation:ball-bob-3bb5cc6c 3.2s ease-in-out infinite}.floating-ball[data-v-3bb5cc6c]::after{content:\'\';position:absolute;inset:-8px;border-radius:50%;background:conic-gradient(from 0deg,var(--ring),transparent 30%,transparent 70%,var(--ring));filter:blur(6px);opacity:0.55;pointer-events:none;-webkit-mask:radial-gradient(farthest-side,transparent calc(100% - 12px),#000 0);mask:radial-gradient(farthest-side,transparent calc(100% - 12px),#000 0);animation:ring-spin-3bb5cc6c 12s linear infinite}.floating-ball[data-v-3bb5cc6c]::before{content:\'\';position:absolute;inset:2px;border-radius:50%;background:radial-gradient(120% 80% at 26% 24%,var(--specular) 0%,rgba(255,255,255,0.2) 26%,rgba(255,255,255,0) 46%),linear-gradient(160deg,var(--glass) 0%,rgba(255,255,255,0) 50%);mix-blend-mode:screen;pointer-events:none;transition:opacity 0.28s ease,transform 0.28s ease}.floating-ball[data-v-3bb5cc6c]:hover{transform:translateY(-2px) scale(1.04);box-shadow:inset 0 2px 8px rgba(0,0,0,0.22),0 4px 10px rgba(0,0,0,0.12),0 16px 36px rgba(0,123,255,0.45);filter:saturate(1.08)}.floating-ball[data-v-3bb5cc6c]:hover::before{opacity:0.95;animation:shimmer-3bb5cc6c 1.2s ease-out}.floating-ball[data-v-3bb5cc6c]:active{transform:translateY(0) scale(0.98);box-shadow:inset 0 2px 10px rgba(0,0,0,0.28),0 2px 6px rgba(0,0,0,0.12),0 10px 22px rgba(0,123,255,0.35)}.floating-ball[data-v-3bb5cc6c]:focus-visible{outline:2px solid var(--ball-focus-outline,rgba(102,200,255,0.85));outline-offset:2px}@media (prefers-reduced-motion:reduce){.floating-ball[data-v-3bb5cc6c]{animation:none}.floating-ball[data-v-3bb5cc6c]::after{animation:none}}@keyframes ball-bob-3bb5cc6c{0%,100%{transform:translateY(0)}50%{transform:translateY(-2px)}}@keyframes ring-spin-3bb5cc6c{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}@keyframes shimmer-3bb5cc6c{0%{transform:translateY(-1px) scale(0.98);opacity:0.6}50%{transform:translateY(-2px) scale(1.02);opacity:1}100%{transform:translateY(-1px) scale(0.99);opacity:0.85}}.floating-ball[data-v-3bb5cc6c]{--logo-scale:0.38}.era-logo[data-v-3bb5cc6c]{font-weight:800;font-size:calc(var(--size) * var(--logo-scale));letter-spacing:0.02em;line-height:1;transform:translateY(-1px);white-space:nowrap;-webkit-user-select:none;user-select:none;pointer-events:none;z-index:1;background:var(--ball-logo-bg,linear-gradient(180deg,rgba(255,255,255,0.96) 0%,rgba(255,255,255,0.55) 45%,rgba(220,240,255,0.4) 65%,rgba(120,195,255,0.55) 100%),linear-gradient(180deg,rgba(0,0,0,0.38),rgba(0,0,0,0) 60%));-webkit-background-clip:text;background-clip:text;color:transparent;text-shadow:0 1px 0 var(--ball-logo-shadow-top,rgba(255,255,255,0.75)),0 2px 4px var(--ball-logo-shadow-near,rgba(0,0,0,0.25)),0 8px 18px var(--ball-logo-shadow-far,rgba(0,123,255,0.35));filter:var(--ball-logo-filter-glow,drop-shadow(0 0 2px rgba(102,200,255,0.25)));animation:era-sheen-3bb5cc6c 4s ease-in-out infinite;transition:text-shadow 0.3s ease,filter 0.3s ease}.floating-ball:hover .era-logo[data-v-3bb5cc6c]{text-shadow:0 1px 0 var(--ball-logo-shadow-top,rgba(255,255,255,0.85)),0 3px 8px var(--ball-logo-shadow-near,rgba(0,0,0,0.28)),0 10px 26px var(--ball-logo-shadow-far,rgba(0,123,255,0.55));filter:var(--ball-logo-filter-glow,drop-shadow(0 0 3px rgba(102,200,255,0.38)))}@keyframes era-sheen-3bb5cc6c{0%,100%{background-position:0% 0%,0% 0%}50%{background-position:0% 40%,0% 0%}}\n','']);const i=o},682:(e,t,a)=>{var n=a(737);n.__esModule&&(n=n.default),'string'==typeof n&&(n=[[e.id,n,'']]),n.locals&&(e.exports=n.locals);(0,a(424).A)('7a7b8a95',n,!1,{ssrId:!0})},737:(e,t,a)=>{a.r(t),a.d(t,{default:()=>i});var n=a(93),r=a.n(n),s=a(54),o=a.n(s)()(r());o.push([e.id,'.right-rail[data-v-61d00544]{flex:1 1 420px;min-width:400px;height:min(680px,86vh);position:sticky;top:10px;align-self:flex-start;z-index:1;display:flex;flex-direction:column}.right-rail-content-wrapper[data-v-61d00544]{display:flex;flex-direction:column;gap:12px;overflow-y:auto;flex-grow:1}\n','']);const i=o},756:(e,t,a)=>{var n=a(597);n.__esModule&&(n=n.default),'string'==typeof n&&(n=[[e.id,n,'']]),n.locals&&(e.exports=n.locals);(0,a(424).A)('66508422',n,!1,{ssrId:!0})},800:(e,t,a)=>{a.r(t),a.d(t,{default:()=>i});var n=a(93),r=a.n(n),s=a(54),o=a.n(s)()(r());o.push([e.id,'.meta[data-v-9a5820b4]{position:relative;border:1px solid var(--border-soft);border-radius:12px;background:var(--meta-bg);box-shadow:var(--meta-shadow),var(--settings-shadow-inset);transition:background 0.3s ease,border-color 0.3s ease}.kv[data-v-9a5820b4]{display:grid;grid-template-columns:120px 1fr;gap:8px 12px}.item[data-v-9a5820b4]{display:contents}.k[data-v-9a5820b4]{justify-self:start;align-self:center;font-size:12px;color:var(--text-normal);background:var(--meta-key-bg);border:1px solid var(--settings-border-input);padding:4px 8px;border-radius:8px;font-weight:700;transition:background 0.3s ease,border-color 0.3s ease,color 0.3s ease}.v[data-v-9a5820b4]{align-self:center;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;color:var(--settings-text-input);background:var(--bg-solid);border:1px solid var(--settings-border-input);padding:6px 8px;border-radius:8px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;transition:background 0.3s ease,border-color 0.3s ease,color 0.3s ease}\n','']);const i=o},820:(e,t,a)=>{var n=a(839);n.__esModule&&(n=n.default),'string'==typeof n&&(n=[[e.id,n,'']]),n.locals&&(e.exports=n.locals);(0,a(424).A)('d29831b8',n,!1,{ssrId:!0})},839:(e,t,a)=>{a.r(t),a.d(t,{default:()=>i});var n=a(93),r=a.n(n),s=a(54),o=a.n(s)()(r());o.push([e.id,':where(#era-snapshot-ui){--snapshot-text:var(--text-normal);--snapshot-muted:var(--muted);--snapshot-bg:var(--paper);--snapshot-bg-gradient:linear-gradient(to bottom,color-mix(in oklab,var(--paper),transparent 92%),transparent);--snapshot-stroke:var(--line);--snapshot-accent:var(--primary,var(--accent,#4f46e5));--on-accent:var(--on-accent,#ffffff);--snapshot-accent-soft:color-mix(in oklab,var(--snapshot-accent),transparent 82%);--snapshot-outer-shadow:0 6px 18px color-mix(in oklab,#000,transparent 90%);--snapshot-inner-shadow:inset 0 1px 0 color-mix(in oklab,#fff,transparent 92%);--snapshot-focus-inner-shadow:inset 0 1px 0 color-mix(in oklab,#fff,transparent 90%);--snapshot-danger:var(--danger,#e11d48);--snapshot-danger-soft:color-mix(in oklab,var(--snapshot-danger),transparent 88%)}:where(html[data-theme=\'dark\'] #era-snapshot-ui),:where(body[data-theme=\'dark\'] #era-snapshot-ui){--snapshot-outer-shadow:0 8px 22px color-mix(in oklab,#000,transparent 70%);--snapshot-inner-shadow:inset 0 1px 0 color-mix(in oklab,#fff,transparent 94%)}@media (prefers-color-scheme:dark){#era-snapshot-ui{--snapshot-outer-shadow:0 8px 22px color-mix(in oklab,#000,transparent 72%);--snapshot-inner-shadow:inset 0 1px 0 color-mix(in oklab,#fff,transparent 94%)}}#era-snapshot-ui.snapshot-manager{display:flex;flex-direction:column;gap:16px}#era-snapshot-ui .selector-wrapper{display:block;margin-bottom:4px}#era-snapshot-ui .select-field{position:relative;display:block}#era-snapshot-ui .selector-label{font-size:14px;font-weight:700;color:var(--text-title);flex-shrink:0;letter-spacing:0.2px}#era-snapshot-ui .select-container{position:relative;flex-grow:1;isolation:isolate}#era-snapshot-ui .select-container::after{content:\'▾\';position:absolute;top:50%;right:12px;transform:translateY(-50%) rotate(0deg);font-size:14px;color:var(--snapshot-muted);pointer-events:none;transition:transform 0.18s ease,color 0.2s ease;z-index:1}#era-snapshot-ui .select-container:focus-within::after{transform:translateY(-50%) rotate(180deg);color:var(--snapshot-accent)}#era-snapshot-ui .mk-selector{width:100%;padding:10px 36px 10px 12px;border-radius:10px;border:1px solid var(--snapshot-stroke);background:var(--snapshot-bg-gradient),var(--snapshot-bg);backdrop-filter:saturate(1.05) blur(2px);color:var(--snapshot-text);font-family:inherit;font-size:14px;line-height:1.2;cursor:pointer;-webkit-appearance:none;appearance:none;transition:border-color 0.18s ease,box-shadow 0.18s ease,background 0.25s ease;box-shadow:var(--snapshot-inner-shadow),var(--snapshot-outer-shadow)}#era-snapshot-ui .mk-selector:hover{border-color:color-mix(in oklab,var(--snapshot-stroke),var(--snapshot-accent) 22%)}#era-snapshot-ui .mk-selector:focus{outline:none;border-color:var(--snapshot-accent);box-shadow:0 0 0 3px var(--snapshot-accent-soft),var(--snapshot-focus-inner-shadow)}#era-snapshot-ui .mk-selector:focus-visible{outline:none}#era-snapshot-ui .mk-selector option{color:var(--snapshot-text);background:var(--snapshot-bg)}#era-snapshot-ui .loading-indicator,#era-snapshot-ui .error-message{padding:18px;text-align:center;border-radius:12px;border:1px dashed var(--line,rgba(0,0,0,0.12));background:var(--bg-empty,rgba(0,0,0,0.03));color:var(--text-normal,#2a2a2a)}#era-snapshot-ui .error-message{color:var(--snapshot-danger);background:var(--snapshot-danger-soft);border-color:color-mix(in oklab,var(--snapshot-danger),transparent 55%)}@media (prefers-reduced-motion:reduce){#era-snapshot-ui .select-container::after,#era-snapshot-ui .mk-selector{transition:none}}#era-snapshot-ui .field-label{position:absolute;top:0;left:12px;transform:translateY(-50%);padding:0 6px;font-size:12px;line-height:1;color:var(--snapshot-muted);background:var(--snapshot-bg);border-radius:6px;pointer-events:none;z-index:1}#era-snapshot-ui .mk-selector{padding-top:22px}#era-snapshot-ui .select-field:focus-within .field-label{color:var(--snapshot-accent)}#era-snapshot-ui .select-container::after{content:\'▾\';position:absolute;top:50%;right:12px;transform:translateY(-50%);font-size:14px;color:var(--snapshot-muted);pointer-events:none;transition:transform 0.18s ease,color 0.2s ease}#era-snapshot-ui .select-container:focus-within::after{transform:translateY(-50%) rotate(180deg);color:var(--snapshot-accent)}#era-snapshot-ui .id-query-container{display:flex;border-radius:10px;transition:box-shadow 0.18s ease}#era-snapshot-ui .id-query-container:focus-within{box-shadow:0 0 0 3px var(--snapshot-accent-soft)}#era-snapshot-ui .id-input{flex-grow:1;border-top-right-radius:0;border-bottom-right-radius:0;border-right-width:0}#era-snapshot-ui .id-input:focus{box-shadow:none;border-color:var(--snapshot-stroke)}#era-snapshot-ui .query-button{flex-shrink:0;padding:22px 16px 10px;border-radius:10px;border-top-left-radius:0;border-bottom-left-radius:0;background-color:var(--snapshot-btn-bg);color:var(--snapshot-btn-text);border:1px solid var(--snapshot-stroke);font-family:inherit;font-size:14px;line-height:1.2;font-weight:700;cursor:pointer;transition:background-color 0.2s ease,border-color 0.2s ease,transform 0.1s ease}#era-snapshot-ui .query-button:hover{background-color:var(--snapshot-btn-hover-bg);border-color:color-mix(in oklab,var(--snapshot-stroke),var(--snapshot-text) 10%)}#era-snapshot-ui .query-button:active{transform:scale(0.97);background-color:var(--snapshot-btn-active-bg)}#era-snapshot-ui .query-button:focus-visible{outline:none;z-index:1;box-shadow:0 0 0 3px var(--snapshot-accent-soft)}\n','']);const i=o},840:(e,t,a)=>{a.r(t),a.d(t,{default:()=>i});var n=a(93),r=a.n(n),s=a(54),o=a.n(s)()(r());o.push([e.id,'.era-shell[data-v-7634a531]{display:flex;align-items:flex-start;gap:12px;flex-wrap:nowrap}[data-v-7634a531] .era-panel{flex:0 1 auto}@media (max-width:992px){.era-shell[data-v-7634a531]{flex-wrap:wrap}[data-v-7634a531] .era-panel,[data-v-7634a531] .right-rail{width:100%;flex-basis:auto}[data-v-7634a531] .right-rail{position:static;margin-top:12px;height:auto;max-height:40vh}}[data-v-7634a531] .floating-ball{position:fixed;right:max(16px,env(safe-area-inset-right));bottom:max(90px,env(safe-area-inset-bottom));z-index:2147483647;pointer-events:auto;touch-action:manipulation;will-change:transform}.era-expanded-layer[data-v-7634a531]{position:fixed;inset:0;display:grid;place-items:center;padding:clamp(12px,2.5vw,24px);pointer-events:auto;z-index:2147483646;background:transparent;overflow:auto}@media (max-width:640px){[data-v-7634a531] .era-panel{width:min(92vw,560px);height:min(88vh,calc(100svh - 32px))}.panel-body[data-v-7634a531]{overscroll-behavior:contain}}\n','']);const i=o},846:(e,t,a)=>{a.r(t),a.d(t,{default:()=>i});var n=a(93),r=a.n(n),s=a(54),o=a.n(s)()(r());o.push([e.id,'.era-app-container{position:fixed;inset:0;z-index:2147483646;pointer-events:none;isolation:isolate;contain:layout style paint;width:100svw;height:100svh}\n','']);const i=o},949:(e,t,a)=>{var n=a(840);n.__esModule&&(n=n.default),'string'==typeof n&&(n=[[e.id,n,'']]),n.locals&&(e.exports=n.locals);(0,a(424).A)('d3f1457a',n,!1,{ssrId:!0})},952:(e,t,a)=>{a.r(t),a.d(t,{default:()=>i});var n=a(93),r=a.n(n),s=a(54),o=a.n(s)()(r());o.push([e.id,'.tabs[data-v-2874077c]{border:1px solid var(--border-soft);border-radius:12px;overflow:hidden;background:var(--accordion-bg);transition:background 0.3s ease,border-color 0.3s ease}.tab-bar[data-v-2874077c]{display:flex;gap:8px;padding:8px;border-bottom:1px solid var(--border-soft);background:var(--mk-pill-null-bg);transition:background 0.3s ease,border-color 0.3s ease}.tab-btn[data-v-2874077c]{padding:8px 12px;font-weight:800;font-size:13px;color:var(--text-normal);background:var(--bg-solid);border:1px solid var(--settings-border-input);border-radius:10px;cursor:pointer;transition:background 0.3s ease,border-color 0.3s ease,color 0.3s ease,box-shadow 0.3s ease}.tab-btn.active[data-v-2874077c]{color:var(--settings-text-input);border-color:var(--settings-border-btn-primary);box-shadow:var(--settings-shadow-inset),var(--tab-active-shadow)}.tab-content[data-v-2874077c]{padding:10px 12px;background:var(--tab-content-bg);transition:background 0.3s ease}\n','']);const i=o},981:(e,t,a)=>{a.r(t),a.d(t,{default:()=>i});var n=a(93),r=a.n(n),s=a(54),o=a.n(s)()(r());o.push([e.id,'.era-panel[data-v-1e3782f8]{flex:2 1 600px;min-width:320px;height:min(680px,86vh);display:flex;flex-direction:column;background:var(--bg-blur-heavy);border:1px solid var(--border-strong);backdrop-filter:blur(10px);border-radius:16px;box-shadow:var(--shadow-panel),var(--shadow-inset);overflow:hidden;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;transition:background 0.3s ease,border-color 0.3s ease}.panel-top[data-v-1e3782f8]{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--border-soft);background:var(--bg-blur-light);transition:background 0.3s ease,border-color 0.3s ease}.panel-title[data-v-1e3782f8]{font-size:16px;font-weight:800;letter-spacing:0.5px;color:var(--text-title);transition:color 0.3s ease}.btn-close[data-v-1e3782f8]{width:32px;height:32px;line-height:30px;text-align:center;border-radius:8px;border:1px solid var(--border-normal);background:var(--bg-solid);cursor:pointer;font-size:18px;color:var(--text-normal);box-shadow:var(--shadow-button);transition:background 0.3s ease,border-color 0.3s ease,color 0.3s ease,transform 0.2s ease,box-shadow 0.2s ease}.btn-close[data-v-1e3782f8]:hover{transform:translateY(-1px);box-shadow:var(--shadow-button-hover)}.panel-body[data-v-1e3782f8]{padding:0;overflow:hidden;flex-grow:1;display:flex;flex-direction:column}.panel-content-wrapper[data-v-1e3782f8]{padding:14px 14px 16px;overflow-y:auto;flex-grow:1}.panel-content-wrapper[data-v-1e3782f8]>*+*{margin-top:12px}.empty[data-v-1e3782f8]{height:100%;display:grid;place-items:center;color:var(--text-normal);font-size:14px;border:1px dashed var(--border-dashed);border-radius:12px;background:var(--bg-empty);transition:background 0.3s ease,border-color 0.3s ease,color 0.3s ease}\n','']);const i=o},985:(e,t,a)=>{a.r(t),a.d(t,{default:()=>i});var n=a(93),r=a.n(n),s=a(54),o=a.n(s)()(r());o.push([e.id,'.json-line[data-v-6c2ac46e]{position:relative;display:flex;align-items:center;gap:6px;padding:2px 6px;border-radius:6px;transition:background 0.2s ease}.json-line[data-v-6c2ac46e]:hover{background:var(--json-hover-bg)}.json-children[data-v-6c2ac46e]{border-left:1px dashed var(--json-tree-line);transition:border-color 0.3s ease}.key[data-v-6c2ac46e]{color:var(--json-key-color);font-weight:700;transition:color 0.3s ease}.colon[data-v-6c2ac46e]{color:var(--text-normal);transition:color 0.3s ease}.brace[data-v-6c2ac46e]{color:var(--text-normal);transition:color 0.3s ease}.summary[data-v-6c2ac46e]{color:var(--text-normal);margin-left:4px;transition:color 0.3s ease}.val.string[data-v-6c2ac46e]{color:var(--json-val-string)}.val.number[data-v-6c2ac46e]{color:var(--json-val-number)}.val.boolean[data-v-6c2ac46e]{color:var(--json-val-boolean)}.val.null[data-v-6c2ac46e]{color:var(--json-val-null)}.val.undefined[data-v-6c2ac46e]{color:var(--json-val-null)}.caret[data-v-6c2ac46e]{width:18px;height:18px;border:1px solid var(--border-soft);border-radius:4px;background:var(--bg-solid);line-height:16px;text-align:center;font-size:10px;color:var(--text-normal);cursor:pointer;box-shadow:var(--json-caret-shadow);transition:transform 0.18s ease,box-shadow 0.18s ease,background 0.3s ease,border-color 0.3s ease,color 0.3s ease}.caret.open[data-v-6c2ac46e]{transform:rotate(90deg);box-shadow:var(--json-caret-open-shadow)}.node[data-v-6c2ac46e]{overflow:clip;contain:paint;min-height:0}.json-children[data-v-6c2ac46e]{overflow:clip;contain:paint}\n','']);const i=o}},s={};function o(e){var t=s[e];if(void 0!==t)return t.exports;var a=s[e]={id:e,exports:{}};return r[e](a,a.exports,o),a.exports}o.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return o.d(t,{a:t}),t},o.d=(e,t)=>{for(var a in t)o.o(t,a)&&!o.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o.r=e=>{'undefined'!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:'Module'}),Object.defineProperty(e,'__esModule',{value:!0})};const i=z,l=i.z.object({在ai消息尾部生成特殊符号:i.z.boolean().default(!0),特殊符号值:i.z.string().default('<StatusPlaceHolderImpl/>'),开启悬浮球:i.z.boolean().default(!0),开启黑夜模式:i.z.boolean().default(!1),强制重载功能:i.z.boolean().default(!1),强制重载消息数:i.z.number().default(2),繁体转简体:i.z.boolean().default(!1),调试模式:i.z.boolean().default(!1)}),c={type:'chat'},d='ERAMetaData',u='stat_data',p='EditLogs',g='SelectedMks',b='era_data',m=new RegExp(`<${b}>({.*?})<\\/${b}>`),f={INSERT_BY_OBJECT:'era:insertByObject',UPDATE_BY_OBJECT:'era:updateByObject',INSERT_BY_PATH:'era:insertByPath',UPDATE_BY_PATH:'era:updateByPath',DELETE_BY_OBJECT:'era:deleteByObject',DELETE_BY_PATH:'era:deleteByPath',GET_CURRENT_VARS:'era:getCurrentVars',GET_SNAPSHOT_AT_MK:'era:getSnapshotAtMk',GET_SNAPSHOTS_BETWEEN_MKS:'era:getSnapshotsBetweenMks',GET_SNAPSHOT_AT_MID:'era:getSnapshotAtMId',GET_SNAPSHOTS_BETWEEN_MIDS:'era:getSnapshotsBetweenMIds',REQUEST_WRITE_DONE:'era:requestWriteDone',FORCE_SYNC:'era:forceSync'},h='era:writeDone',v='era:apiWrite',y='era:queryResult',x=_;var w=o.n(x);const E=Vue,k=(0,E.ref)(l.parse({})),N=(0,E.readonly)(k);function A(e){if(!w().isObject(e))return e;const t=w().cloneDeep(e);return function e(t){if(Array.isArray(t))t.forEach(t=>e(t));else if(w().isPlainObject(t))for(const a in t)a.startsWith('$')?delete t[a]:e(t[a])}(t),t}function S(){const e=getVariables(c)||{};return{meta:w().get(e,d,{}),stat:w().get(e,u,{})}}async function V(e){await updateVariablesWith(async t=>{const a=w().get(t,d,{}),n=await e(a);return w().set(t,d,n),t},c)}async function C(e){await updateVariablesWith(async t=>{const a=l.parse(t??{}),n=await e(a);return k.value=n,n},{type:'script',script_id:getScriptId()})}const M='era_debug_config';let I=[],D=[];function T(){try{const e=globalThis.localStorage?.getItem(M)||'{"enabled":[],"disabled":[]}',t=JSON.parse(e),a=e=>new RegExp(`^${e.replace(/\*/g,'.*?')}$`);I=(t.enabled||[]).map(a),D=(t.disabled||[]).map(a)}catch(e){console.error('《ERA-Log》: 加载调试配置失败。',e),I=[],D=[]}}function R(e){const t={enabled:[...new Set(e.enabled)],disabled:[...new Set(e.disabled)]};globalThis.localStorage?.setItem(M,JSON.stringify(t)),T(),console.log('%c《ERA-Log》调试模式已更新。','color: #3498db; font-weight: bold;',{'启用 (Enabled)':t.enabled,'禁用 (Disabled)':t.disabled})}if(T(),'undefined'!=typeof globalThis){const e={add(e){const t=globalThis.localStorage?.getItem(M)||'{"enabled":[],"disabled":[]}',a=JSON.parse(t),n=new Set(a.enabled||[]),r=new Set(a.disabled||[]);n.add(e),r.delete(e),R({enabled:Array.from(n),disabled:Array.from(r)})},remove(e){const t=globalThis.localStorage?.getItem(M)||'{"enabled":[],"disabled":[]}',a=JSON.parse(t),n=new Set(a.enabled||[]),r=new Set(a.disabled||[]);r.add(e),n.delete(e),R({enabled:Array.from(n),disabled:Array.from(r)})},status(){const e=globalThis.localStorage?.getItem(M)||'{"enabled":[],"disabled":[]}',t=JSON.parse(e);console.log('%c《ERA-Log》当前调试配置:','color: #3498db; font-weight: bold;',t)},clear(){R({enabled:[],disabled:[]})}};globalThis.eraDebug=e}const B={mk:''};class O{moduleName;constructor(e){this.moduleName=e||this._getModuleNameFromStack()||'unknown'}_getModuleNameFromStack(){try{const e=((new Error).stack||'').split('\n').find(e=>(e.includes('/src/ERA变量框架/')||e.includes('/dist/ERA变量框架/')||e.includes('\\src\\ERA变量框架\\')||e.includes('\\dist\\ERA变量框架\\'))&&!e.includes('/utils/log.ts'));if(!e)return null;const t=e.match(new RegExp('(src|dist)[\\\\/]ERA变量框架[\\\\/]([^?:]+)'));if(!t||!t[2])return null;return t[2].replace(/\\/g,'/').replace(/\.(vue|ts|js)$/,'').replace(/\/index$/,'')}catch(e){return console.error('《ERA-Log-Debug》: 解析模块名时发生意外错误。',e),null}}formatMessage(e,t){return`《ERA》${B.mk?`（${B.mk}）`:''}「${this.moduleName}」【${e}】${String(t)}`}debug(e,t,a){if(!(n=this.moduleName)||D.some(e=>e.test(n))||0===I.length||!I.some(e=>e.test(n)))return;var n;const r=this.formatMessage(e,t);void 0!==a?console.debug(r,a):console.debug(r)}log(e,t,a){const n=this.formatMessage(e,t);void 0!==a?console.log(`%c${n}`,'color: #3498db;',a):console.log(`%c${n}`,'color: #3498db;')}warn(e,t,a){const n=this.formatMessage(e,t);void 0!==a?console.warn(`%c${n}`,'color: #f39c12;',a):console.warn(`%c${n}`,'color: #f39c12;'),N.value.调试模式&&toastr.warning(n)}error(e,t,a){const n=this.formatMessage(e,t);void 0!==a?console.error(`%c${n}`,'color: #e74c3c; font-weight: bold;',a):console.error(`%c${n}`,'color: #e74c3c; font-weight: bold;'),N.value.调试模式&&toastr.error(n)}}const j=new O('ERA变量框架/events/merger'),P={INIT:[tavern_events.APP_READY],SYNC:['manual_write',v,tavern_events.MESSAGE_RECEIVED,tavern_events.MESSAGE_DELETED,tavern_events.MESSAGE_SWIPED,tavern_events.CHAT_CHANGED,'manual_sync','manual_full_sync','combo_edit_and_continue'],API:Object.values(f),UPDATE_MK_ONLY:[tavern_events.MESSAGE_SENT],COLLISION_DETECTORS:[tavern_events.GENERATION_STARTED],COMBO_STARTERS:[tavern_events.MESSAGE_UPDATED],DIRECTED_SYNC:[tavern_events.MESSAGE_EDITED,'combo_swipe_and_regenerate']},L=new Map([]),F=new Map([[tavern_events.MESSAGE_UPDATED,{next:tavern_events.GENERATION_STARTED,resultType:'combo_edit_and_continue',maxInterval:1500,immediate:!0}],[tavern_events.MESSAGE_SWIPED,{next:tavern_events.GENERATION_STARTED,resultType:'combo_swipe_and_regenerate',maxInterval:600,immediate:!0}]]),W=new Map([[tavern_events.MESSAGE_SWIPED,500],[tavern_events.MESSAGE_UPDATED,1500]]);function J(e){return P.INIT.includes(e)?'INIT':P.SYNC.includes(e)?'SYNC':P.API.includes(e)?'API':P.UPDATE_MK_ONLY.includes(e)?'UPDATE_MK_ONLY':P.COLLISION_DETECTORS.includes(e)?'COLLISION_DETECTORS':P.COMBO_STARTERS.includes(e)?'COMBO_STARTERS':P.DIRECTED_SYNC.includes(e)?'DIRECTED_SYNC':'UNKNOWN'}function U(e){if(e.length<2)return!1;for(let t=0;t<e.length-1;t++){const a=e[t],n=e[t+1],r=F.get(a.type);if(r&&r.immediate&&n.type===r.next){if(n.timestamp-a.timestamp<=r.maxInterval)return j.debug('hasImmediateCombo',`检测到紧急事件组合: ${a.type} + ${n.type} -> ${r.resultType}`),!0}}return!1}function K(e){const t=_.cloneDeep(e),a=[];for(const t of e){if(0===a.length){a.push(t);continue}const e=a[a.length-1],n=t.timestamp-e.timestamp,r=F.get(e.type);if(r&&t.type===r.next){if(n<=r.maxInterval){j.debug('mergeEventBatch',`检测到事件组合: ${e.type} 和 ${t.type} (时间差: ${n}ms <= ${r.maxInterval}ms)。将合并为 ${r.resultType} 事件。`),a.pop(),a.push({type:r.resultType,timestamp:t.timestamp,detail:t.detail});continue}j.debug('mergeEventBatch',`检测到潜在的事件组合，但因超时而失败: ${e.type} 和 ${t.type} (时间差: ${n}ms > ${r.maxInterval}ms)。`)}const s=L.get(e.type);if(s&&t.type===s.next){if(n<=s.maxInterval){j.debug('mergeEventBatch',`检测到相邻事件对冲: ${e.type} 和 ${t.type} (时间差: ${n}ms <= ${s.maxInterval}ms)。将忽略这两个事件。`),a.pop();continue}j.debug('mergeEventBatch',`检测到潜在的事件对冲，但因超时而失败: ${e.type} 和 ${t.type} (时间差: ${n}ms > ${s.maxInterval}ms)。`)}const o=J(e.type);o===J(t.type)&&'SYNC'===o?a[a.length-1]=t:a.push(t)}const n=a.filter(e=>{const t=J(e.type),a='COLLISION_DETECTORS'===t,n='COMBO_STARTERS'===t;return(a||n)&&j.debug('mergeEventBatch',`清理未配对的事件: ${e.type}`),!a&&!n});return j.debug('mergeEventBatch',`事件合并: ${t.length} -> ${n.length}`,{before:t.map(e=>e.type),after:n.map(e=>e.type)}),n}const G=new O('ERA变量框架/utils/data'),Y={'.':'__DOT__','"':'__DQUOTE__','\'':'__SQUOTE__'},H=_.invert(Y),q=new RegExp(Object.keys(Y).map(_.escapeRegExp).join('|'),'g'),Q=new RegExp(Object.values(Y).map(_.escapeRegExp).join('|'),'g');function X(e){if(Array.isArray(e))return e.map(e=>X(e));if(_.isPlainObject(e)){const t={};for(const a in e)if(Object.prototype.hasOwnProperty.call(e,a)){t[a.replace(q,e=>Y[e])]=X(e[a])}return t}return'string'==typeof e?e.replace(q,e=>Y[e]):e}function Z(e){if(Array.isArray(e))return e.map(e=>Z(e));if(_.isPlainObject(e)){const t={};for(const a in e)if(Object.prototype.hasOwnProperty.call(e,a)){t[a.replace(Q,e=>H[e])]=Z(e[a])}return t}return'string'==typeof e?e.replace(Q,e=>H[e]):e}function ee(e){if(Array.isArray(e))return e.map(e=>Array.isArray(e)||_.isPlainObject(e)?JSON.stringify(e):e);if(_.isPlainObject(e)){const t={};for(const a in e)t[a]=ee(e[a]);return t}return e}function te(e,t){return _.mergeWith(_.cloneDeep(e),_.cloneDeep(t),(e,t)=>{if(Array.isArray(e)||Array.isArray(t))return t})}function ae(e){if(Array.isArray(e))return e;if(e&&'object'==typeof e)return[e];if('string'==typeof e){const t=e.replace(/^\s*```(?:json)?\s*|\s*```\s*$/g,'');try{const e=JSON.parse(t);return Array.isArray(e)?e:[]}catch{return[]}}return[]}function ne(e){const t=[];if(!e||'string'!=typeof e)return t;const a=function(e){if(!e)return'';let t='',a=!1;for(let n=0;n<e.length;n++){const r=e[n];if('"'!==r||0!==n&&'\\'===e[n-1]||(a=!a),a){t+=r;continue}const s=e[n+1];if('/'===r&&'/'===s){const a=e.indexOf('\n',n+2);if(-1===a)break;t+='\n',n=a;continue}if('/'===r&&'*'===s){const t=e.indexOf('*/',n+2);if(-1===t)break;n=t+1;continue}if('<'===r&&'\x3c!--'===e.substring(n,n+4)){const t=e.indexOf('--\x3e',n+4);if(-1===t)break;n=t+2;continue}t+=r}return t}(e),n=a.trim();let r=0,s=-1,o=!1;for(let e=0;e<n.length;e++){const a=n[e];if('"'!==a||0!==e&&'\\'===n[e-1]||(o=!o),!o)if('{'===a)0===r&&(s=e),r++;else if('}'===a&&r>0&&(r--,0===r&&-1!==s)){const a=n.substring(s,e+1);try{const e=JSON.parse(a);t.push(e)}catch(e){G.error(`JSONL 解析失败: ${e?.message||e}. 失败的片段: ${a}`,e)}s=-1}}return t}function re(e){if(!e)return e;let t=String(e).trim();return t=t.replace(/^\s*(?:```|~~~)\[a-zA-Z0-9_-\]*\s*\r?\n/,''),t=t.replace(/\r?\n(?:```|~~~)\s*$/,''),t.trim()}const se=e({from:'tw',to:'cn'});function oe(e){return se(e)}function ie(e){if(!e.includes('{{'))return e;let t=e;return t=t.replace(/{{user}}/gi,SillyTavern.name1),t=t.replace(/{{char}}/gi,SillyTavern.name2),t}const le=new O('ERA变量框架/utils/message');function ce(e){if(!e)return null;let t=null;if('string'==typeof e.mes)t=e.mes;else if(Array.isArray(e.swipes)){const a=Number(e.swipe_id??0);t=e.swipes[a]||null}else'string'==typeof e.message&&(t=e.message);return null===t?null:ie(t)}function de(e){const t=function(e){if('string'!=typeof e)return null;const t=e.match(m);if(!t||!t[1])return null;try{const e=t[1],a=e.match(/"era-message-key"\s*=\s*"(.*?)"/),n=e.match(/"era-message-type"\s*=\s*"(.*?)"/);if(a?.[1]&&n?.[1]){const e={'era-message-key':a[1],'era-message-type':n[1]};return le.debug('parseEraData','成功解析 EraData',e),e}return le.debug('parseEraData','未能在 EraData 块中找到完整的键值对',{customFormatBlock:e}),null}catch(e){return le.warn('parseEraData','解析 EraData 块时发生异常',e),null}}(ce(e));return t?'user'===t['era-message-type']:'user'===e?.role}function ue(){const e=getChatMessages('0-{{lastMessageId}}',{include_swipes:!0});if(!e||0===e.length)return le.debug('findLastAiMessage','聊天记录为空, 未找到任何消息。'),null;for(let t=e.length-1;t>=0;t--){const a=e[t];if(!de(a))return le.debug('findLastAiMessage',`找到最后一条 AI 消息, ID: ${a.message_id}`),a}return le.debug('findLastAiMessage','未在聊天记录中找到任何 AI 消息。'),null}async function pe(e,t,a='none'){ce(e);const n={message_id:e.message_id};if(Array.isArray(e.swipes)){const a=Number(e.swipe_id??0),r=[...e.swipes];r[a]=t,n.swipes=r}else n.message=t;await setChatMessages([n],{refresh:a})}const ge=new O('ERA变量框架/core/key/mk');function be(e){if(!e)return'';const t=ce(e);return function(e){if('string'!=typeof e)return null;const t=e.match(m);if(!t||!t[1])return null;try{const e=t[1],a=e.match(/"era-message-key"\s*=\s*"(.*?)"/),n=e.match(/"era-message-type"\s*=\s*"(.*?)"/);return a?.[1]&&n?.[1]?{'era-message-key':a[1],'era-message-type':n[1]}:null}catch{return null}}(t)?.['era-message-key']||''}async function me(e){if(!e||'number'!=typeof e.message_id||!e.role)return ge.warn('ensureMessageKey','无效的消息对象结构，无法确保Key。',{msg:e}),{mk:'',isNew:!1};const t=be(e);if(t)return{mk:t,isNew:!1};const a=`era_mk_${Date.now()}_${Math.random().toString(36).slice(2,8)}`,n='user'===e.role?'user':'assistant',r=`<${b}>{"era-message-key"="${a}","era-message-type"="${n}"}</${b}>`;ge.debug('ensureMessageKey',`为消息 (ID: ${e.message_id}) 注入新的Key: ${a}`);const s=(ce(e)??'')+'\n'+r;return await pe(e,s),{mk:a,isNew:!0}}const fe=async e=>{const t=getChatMessages(-1,{include_swipes:!0})?.[0];t&&'number'==typeof t.message_id&&e&&await V(a=>{const n=_.get(a,g,[]);return n[t.message_id]!==e&&(n[t.message_id]=e,_.set(a,g,n)),a})},he=new O('ERA变量框架/initer/auto/settings');async function ve(){!function(){const e=getVariables({type:'script',script_id:getScriptId()});k.value=l.parse(e??{})}(),he.log('initializeExternalSettings','开始初始化脚本设置...'),await C(async e=>(he.debug('initializeExternalSettings','当前设置:',e),e)),he.log('initializeExternalSettings','脚本设置初始化完成。')}$(()=>{ve()});const ye=new O('ERA变量框架/macro/placeholder');const xe=new O('ERA变量框架/core/timetravel');function we(e,t){if(!t||!t.length)return e;for(let a=t.length-1;a>=0;a--){const n=t[a],r=String(n?.op||'').toLowerCase(),s=String(n?.path||'');s&&('insert'===r?_.unset(e,s):'update'!==r&&'delete'!==r||(void 0===n.value_old?_.unset(e,s):_.set(e,s,_.cloneDeep(n.value_old))))}return e}function Ee(e,t){if(!t||!t.length)return e;for(const a of t){if(!a||!a.path)continue;const t=String(a?.op||'').toLowerCase();'insert'===t||'update'===t?_.set(e,a.path,_.cloneDeep(a.value_new)):'delete'===t&&_.unset(e,a.path)}return e}function ke(e,t,a){const n=t.indexOf(e);if(-1===n){const a=`在序列中未找到目标MK: ${e}`;throw xe.error('calculateStatAt',a,{targetMK:e,selectedMks:t}),new Error(a)}let r={};for(let e=0;e<=n;e++){const n=t[e];if(!n)continue;r=Ee(r,ae(a[n]))}return r}function _e(e,t,a,n){if(xe?.debug('findLatestNewValue',`开始为路径 <${e}> 从消息索引 <${t}> 向上追溯历史值...`),t<0||t>a.length)return xe?.warn('findLatestNewValue',`错误：起始消息索引 ${t} 超出范围。`,{path:e,startMessageId:t,selectedMksCount:a.length}),null;for(let r=t-1;r>=0;r--){const t=a[r];if(!t)continue;const s=ae(n[t]);if(s&&0!==s.length)for(let a=s.length-1;a>=0;a--){const n=s[a];if(n&&n.path){if(n.path===e)return'delete'===n.op?(xe?.warn('findLatestNewValue',`>> 在 MK:${t} 中为路径 <${e}> 找到了 'delete' 记录。这可能意味着正在尝试编辑一个已被删除的变量，因此其旧值应为 null。`),null):(xe?.debug('findLatestNewValue',`>> 成功! 在 MK:${t} 中找到精确路径 <${e}> 的值为: `,n.value_new),_.cloneDeep(n.value_new));if(e.startsWith(n.path+'.')){const a=e.substring(n.path.length+1),r=n.value_new;if(_.isPlainObject(r)&&_.has(r,a)){const e=_.get(r,a);return xe?.debug('findLatestNewValue',`>> 成功! 在 MK:${t} 中找到父级路径 <${n.path}>, 并从中提取子路径 <${a}> 的值为:`,e),_.cloneDeep(e)}}}}}return xe?.debug('findLatestNewValue',`向上追溯未找到路径 ${e} 的任何历史值，将使用 null 作为旧值`),null}const Ne=new O('ERA变量框架/core/snapshot');function Ae(e){try{const{meta:t}=S(),a=_.get(t,g,[]),n=_.get(t,p,{});if(!e)return Ne.error('getStatAtMK','目标 MK 不能为空。',{targetMK:e}),null;if(!a.includes(e))return Ne.error('getStatAtMK',`提供的 targetMK "${e}" 无效或不存在于 selectedMks 中。`,{targetMK:e,selectedMks:a}),null;return ke(e,a,n)}catch(t){return Ne.error('getStatAtMK',`计算状态快照时出错: ${t?.message||t}`,{error:t,targetMK:e,eraData:S()}),null}}function Se(e,t){try{const{meta:a}=S(),n=_.get(a,g,[]),r=_.get(a,p,{}),s=n.filter(e=>!!e);if(0===s.length)return[];if(e&&!s.includes(e))return Ne.error('getStatsBetweenMKs',`提供的 startMk "${e}" 无效或不存在于 selectedMks 中。`,{startMk:e,validMks:s}),null;if(t&&!s.includes(t))return Ne.error('getStatsBetweenMKs',`提供的 endMk "${t}" 无效或不存在于 selectedMks 中。`,{endMk:t,validMks:s}),null;const o=e||s[0],i=function(e,t,a,n){const r=a.indexOf(e),s=a.indexOf(t);if(-1===r||-1===s||r>s)return xe.error('calculateAllStatsBetweenMks','无效的 startMk 或 endMk。',{startMk:e,endMk:t,selectedMks:a}),[];let o=ke(e,a,n);const i=[{mk:e,message_id:r,stat:_.cloneDeep(o)}];for(let e=r+1;e<=s;e++){const t=a[e];t&&(o=Ee(o,ae(n[t])),i.push({mk:t,message_id:e,stat:_.cloneDeep(o)}))}return i}(o,t||s[s.length-1],n,r);return i}catch(a){return Ne.error('getStatsBetweenMKs',`计算批量快照时出错: ${a?.message||a}`,{error:a,startMk:e,endMk:t,eraData:S()}),null}}const Ve=new O('ERA变量框架/events/emitters/events'),Ce=_.debounce(()=>{eventEmit(v),Ve.log('debouncedEmitApiWrite',`已触发合并后的 ${v} 事件。`)},50,{leading:!1,trailing:!0});function Me(e){const{stat:t,meta:a}=S(),n=A(t);Ve.debug('emitWriteDoneEvent','获取了最新的 ERA 数据并生成了纯净版',{stat:t,meta:a,statWithoutMeta:n});const r={...e,stat:Z(t),statWithoutMeta:Z(n),selectedMks:_.get(a,g,[]),editLogs:_.get(a,p,{})};Ve.debug('emitWriteDoneEvent','构建了完整的事件载荷',{inputPayload:e,fullPayload:r}),eventEmit(h,r),Ve.log('emitWriteDoneEvent',`已触发 ${h} 事件。`,r)}function Ie(e,t,a){const{meta:n}=S(),r={queryType:e,request:t,result:a,selectedMks:_.get(n,g,[]),editLogs:_.get(n,p,{})};eventEmit(y,r),Ve.log('emitQueryResultEvent',`已为查询 [${e}] 发送 ${y} 事件。`)}const $e=new O('ERA变量框架/core/crud/delete');function De(e,t,a,n){const r=t?_.get(e,t):e;if(void 0===r)return void $e.warn('applyDeleteAtLevel',`VariableDelete 跳过：路径不存在 -> ${t||'(root)'}`,{basePath:t,patchObj:a});const s=_.get(r,['$meta','necessary']),o=_.get(a,'$meta'),i=_.isPlainObject(o)&&_.isEmpty(o)||_.has(a,['$meta','necessary']);if(_.isPlainObject(a)&&!_.isEmpty(a)){if('all'===s&&!i)return void $e.warn('applyDeleteAtLevel',`VariableDelete 失败：路径 <${t}> 受 "necessary: all" 保护，其子节点无法被删除。`,{basePath:t,patchObj:a,currentNodeInVars:r});for(const o of Object.keys(a)){const l=t?`${t}.${o}`:o,c=a[o];'children'!==s||!_.isPlainObject(c)||!_.isEmpty(c)||'$meta'===o&&i?De(e,l,c,n):$e.warn('applyDeleteAtLevel',`VariableDelete 失败：父路径 <${t||'(root)'}> 受 "necessary: children" 保护，其直属子节点 <${o}> 无法被删除。`,{basePath:t,key:o,patchObj:a,currentNodeInVars:r})}return}if('self'===s||'all'===s)return void $e.warn('applyDeleteAtLevel',`VariableDelete 失败：路径 <${t}> 受 "necessary: ${s}" 保护，无法被直接删除。`,{basePath:t,patchObj:a,currentNodeInVars:r});if(''===t)return void $e.error('applyDeleteAtLevel','VariableDelete 失败：不允许删除根对象。',{patchObj:a});const l=_.cloneDeep(r);_.unset(e,t),n.push({op:'delete',path:t,value_old:l}),$e.debug('applyDeleteAtLevel',`成功删除节点: ${t}`)}async function Te(e,t){if(!e||0===e.length)return{finalStat:t,editLog:[]};const a=_.cloneDeep(t),n=[];for(const t of e)if(_.isPlainObject(t)&&!_.isEmpty(t))try{$e.debug('processDeleteBlocks',`处理 deleteRoot: ${JSON.stringify(t)}`),De(a,'',t,n)}catch(e){$e.error('processDeleteBlocks',`处理 deleteRoot 失败: ${e?.message||e}`,{error:e,deleteRoot:t,currentStat:a})}return $e.debug('processDeleteBlocks','所有 VariableDelete 操作完成'),{finalStat:a,editLog:n}}const Re=new O('ERA变量框架/core/crud/insert/template');function Be(e,t){if(!e)return;const a=_.get(e,'$template'),n=_.get(e,t);if(_.isPlainObject(a)&&_.isPlainObject(n)){Re.debug('getInheritedTemplateContent',`为子节点 "${t}" 同时找到原型和特异性内容。\n      - 原型: ${JSON.stringify(a)}\n      - 特异性: ${JSON.stringify(n)}`);const e=te(_.cloneDeep(a),n);return Re.debug('getInheritedTemplateContent',`  - 合并后: ${JSON.stringify(e)}`),e}return _.isPlainObject(n)?(Re.debug('getInheritedTemplateContent',`为子节点 "${t}" 只找到特异性内容: ${JSON.stringify(n)}`),n):_.isPlainObject(a)?(Re.debug('getInheritedTemplateContent',`为子节点 "${t}" 只找到原型内容: ${JSON.stringify(a)}`),a):void Re.debug('getInheritedTemplateContent',`在父级模板内容中未为子节点 "${t}" 找到任何可继承的规则。`)}const Oe=new O('ERA变量框架/core/crud/insert/insert');function je(e,t,a,n,r,s){const o=function(e,t){const a=_.get(t,'$template');Re.debug('resolveTemplate',`解析出的模板内容:\n    - 继承: ${JSON.stringify(e)}\n    - 父节点变量: ${JSON.stringify(a)}`);let n={};return n=te(n,e),n=te(n,a),Re.debug('resolveTemplate',`合并后的最终模板内容: ${JSON.stringify(n)}`),_.isEmpty(n)?null:n}(r,s);Oe.debug('applyInsertAtLevel',`[入口] basePath: "${t||'root'}"`,{statData:_.cloneDeep(e)});const i=t?_.get(e,t):e,l=_.get(i,['$meta','unInsertAble']);if(Oe.debug('applyInsertAtLevel',`[路径检查] at path: "${t||'root'}". currentNodeInVars 的值:`,i),t&&void 0===i){const r=function(e,t){if(Re.debug('applyTemplateToPatch',`[进入] 模板内容: ${JSON.stringify(e)}, 补丁: ${JSON.stringify(t)}`),!_.isPlainObject(t))return Re.debug('applyTemplateToPatch','[退出] 补丁不是一个普通对象，直接返回。'),t;if(!e)return Re.debug('applyTemplateToPatch','[退出] 模板内容无效，直接返回补丁。'),t;if(_.isEmpty(t))return Re.debug('applyTemplateToPatch','补丁为空对象，完全使用模板内容。'),_.cloneDeep(e);const a=te(_.cloneDeep(e),t);return Re.debug('applyTemplateToPatch',`合并模板与补丁后的结果: ${JSON.stringify(a)}`),a}(o,a),s=ee(r);return Oe.debug('applyInsertAtLevel',`最终插入数据 at ${t}:\n${JSON.stringify(s,null,2)}`),_.set(e,t,s),n.push({op:'insert',path:t,value_new:_.cloneDeep(s)}),void Oe.debug('applyInsertAtLevel',`原子性插入到新路径: ${t}`)}if(_.isPlainObject(i)&&_.isPlainObject(a)){const r=Object.keys(a),s=r.every(e=>'$meta'===e),c=r.length>0;if('all'===l&&c&&!s)return void Oe.warn('applyInsertAtLevel',`VariableInsert 失败 <${t||'root'}> 受到 "$meta.unInsertAble: all" 的保护，不允许插入`,{basePath:t,patchObj:a,currentNodeInVars:i});Oe.debug('applyInsertAtLevel',`[递归补充] at path: "${t||'root'}"\n      - 当前层级模板 (localTplContent): ${JSON.stringify(o)}`);for(const s of r){if('self'===l&&'$meta'!==s&&!_.has(i,s)){Oe.warn('applyInsertAtLevel',`VariableInsert 失败 <${t||'root'}> 受到 "$meta.unInsertAble: self" 不允许插入 "${s}"`,{basePath:t,patchObj:a,currentNodeInVars:i,rejectedKey:s});continue}const r=t?`${t}.${s}`:s,c=a[s],d=Be(o,s);Oe.debug('applyInsertAtLevel',`  - 准备递归子节点: "${s}"\n      - 将传递给子节点的模板 (subInheritedContent): ${JSON.stringify(d)}`),je(e,r,c,n,d,i)}}else t&&Oe.warn('applyInsertAtLevel',`VariableInsert 失败：路径已存在且无法递归补充 -> ${t}`,{basePath:t,patchObj:a,currentNodeInVars:i})}async function Pe(e,t){if(!e||0===e.length)return{finalStat:t,editLog:[]};Oe.debug('processInsertBlocks','[初始状态] 进入 processInsertBlocks 时的 statData:',_.cloneDeep(t));const a=_.cloneDeep(t),n=[];for(const t of e)if(_.isPlainObject(t)&&!_.isEmpty(t))try{Oe.debug('processInsertBlocks',`处理 insertRoot: ${JSON.stringify(t)}`),je(a,'',t,n,null,null)}catch(e){Oe.error('processInsertBlocks',`处理 insertRoot 失败: ${e?.message||e}`,{error:e,insertRoot:t,currentStat:a})}return Oe.debug('processInsertBlocks','所有 VariableInsert 操作完成'),{finalStat:a,editLog:n}}const Le=new O('ERA变量框架/core/crud/update');async function Fe(e,t,a,n,r,s,o){const i=t?_.get(e,t):e;if(void 0===i)return void Le.warn('applyEditAtLevel',`VariableEdit 跳过：路径不存在 -> ${t||'(root)'}`,{basePath:t,patchObj:a});const l=_.get(i,['$meta','updatable'],!0),c=!1===l&&!0===_.get(a,['$meta','updatable']);if(!1!==l||c)for(const i of Object.keys(a)){const l=t?`${t}.${i}`:i,c=a[i];if(_.isPlainObject(c)){await Fe(e,l,c,n,r,s,o);continue}if(!_.has(e,l)){Le.warn('applyEditAtLevel',`VariableEdit 失败：路径非法，无法写入 -> ${l}`,{subPath:l,valNew:c,statData:e});continue}Le.debug('applyEditAtLevel',`[旧值查找] 准备为路径 <${l}> 从消息 ID <${r}> 向上追溯...`);let d=_e(l,r,s,o);null===d?(d=_.get(e,l),Le.debug('applyEditAtLevel',`[旧值查找] 追溯未找到历史值，从当前 stat_data 中获取到旧值: ${JSON.stringify(d)}`)):Le.debug('applyEditAtLevel',`[旧值查找] 追溯成功，找到历史旧值: ${JSON.stringify(d)}`);const u=ee(c);_.set(e,l,u),n.push({op:'update',path:l,value_old:_.cloneDeep(d),value_new:_.cloneDeep(u)})}else Le.warn('applyEditAtLevel',`VariableEdit 失败：路径 <${t}> 受 "$meta.updatable: false" 保护，无法被修改。`,{basePath:t,patchObj:a,currentNodeInVars:i})}async function ze(e,t,a,n){if(!e||0===e.length)return{finalStat:_.cloneDeep(a),editLog:[]};const r=_.cloneDeep(a),s=[],o=_.get(n,g,[]),i=_.get(n,p,{});for(const a of e)if(_.isPlainObject(a)&&!_.isEmpty(a))try{Le.debug('processEditBlocks','处理 editRoot: ',a),await Fe(r,'',a,s,t,o,i)}catch(e){Le.error('processEditBlocks',`处理 editRoot 失败: ${e?.message||e}`,{error:e,editRoot:a,finalStat:r})}return Le.debug('processEditBlocks','所有 VariableEdit 操作完成'),{finalStat:r,editLog:s}}const We=new O('ERA变量框架/core/crud/patcher'),Je=async(e,t,a,n={})=>{We.debug('ApplyVarChangeForMessage (Pure)',`开始计算消息 (ID: ${e.message_id})...`);const r=be(e);We.debug('ApplyVarChangeForMessage (Pure)','获取到当前消息mk',r);try{We.debug('ApplyVarChangeForMessage (Pure)','开始提取并解析指令...');const s=function(e,t=!1){const a=ce(e)||'';if(!a)return[];const n=[],r=/<(Variable(Insert|Edit|Delete))>\s*(?=[\s\S]*?\S[\s\S]*?<\/\1>)((?:(?!<(?:era_data|Variable(?:Think|Insert|Edit|Delete))>|<\/\1>)[\s\S])*?)\s*<\/\1>/gi;let s;for(;null!==(s=r.exec(a));){s[1];const e=s[2],a=re(s[3].trim());if(!a)continue;const r=t?oe(a):a;let o=ne(r);if(0===o.length)try{const e=JSON.parse(r);o=Array.isArray(e)?e:[e]}catch(e){le.debug('extractAndParseCommands','块内容既不是有效的 JSONL 也不是有效的 JSON，已跳过。',{content:r});continue}if(0===o.length)continue;const i=X(o);let l;switch(e.toLowerCase()){case'insert':l='insert';break;case'edit':l='edit';break;case'delete':l='delete';break;default:continue}n.push({type:l,data:i,index:s.index})}return n.sort((e,t)=>e.index-t.index),0===n.length?le.debug('extractAndParseCommands',`消息 (ID: ${e.message_id}) 未检测到变量修改标签。`):le.debug('extractAndParseCommands','解析出的有序指令列表',n),n.map(({index:e,...t})=>t)}(e,n.繁体转简体);let o=t;const i=[];We.debug('ApplyVarChangeForMessage (Pure)','开始按顺序处理指令...',s);for(const t of s){let n;switch(t.type){case'insert':n=await Pe(t.data,o),We.debug('ApplyVarChangeForMessage (Pure)','处理 Insert 指令完成',{inputStat:o,outputStat:n.finalStat,log:n.editLog});break;case'edit':n=await ze(t.data,e.message_id,o,a),We.debug('ApplyVarChangeForMessage (Pure)','处理 Edit 指令完成',{inputStat:o,outputStat:n.finalStat,log:n.editLog});break;case'delete':n=await Te(t.data,o),We.debug('ApplyVarChangeForMessage (Pure)','处理 Delete 指令完成',{inputStat:o,outputStat:n.finalStat,log:n.editLog});break;default:We.warn('ApplyVarChangeForMessage (Pure)','遇到未知的指令类型',t);continue}o=n.finalStat,n.editLog&&n.editLog.length>0&&i.push(...n.editLog)}return We.debug('ApplyVarChangeForMessage (Pure)','所有指令处理完成',{finalStat:o,finalEditLog:i}),{finalStat:o,finalEditLog:i,mk:r}}catch(n){return We.error('ApplyVarChangeForMessage (Pure)',`变量计算异常: ${n?.message||n}`,{error:n,message:e,initialStat:t,meta:a}),{finalStat:t,finalEditLog:[],mk:r}}},Ue=new O('ERA变量框架/core/sync'),Ke=e=>{const t=be(e);return t||null},Ge=(e,t,a,n)=>{if(n)return Ue.debug('findDivergencePoint','强制模式：设置重算起点为 0。'),{type:'FULL_RECALC',recalcId:0};const r=e.map(Ke);let s=-1;const o=Math.min(r.length,t.length);for(let e=0;e<o;e++)if(r[e]!==t[e]){s=e;break}if(-1===s&&r.length!==t.length&&(s=o),-1===s){const t=e.length>0?e.length-1:0;return Ue.debug('findDivergencePoint',`所有MK均匹配。启动模拟写入，强制重算最后一条消息 (ID: ${t})。`),{type:'FULL_RECALC',recalcId:t}}const i=_.difference(t,r);return 0===_.difference(r,t).length&&i.length>0&&((e,t)=>{for(const a of e)if(a&&ae(_.get(t,[p,a])).length>0)return!1;return!0})(i,a)?(Ue.debug('findDivergencePoint','检测到纯粹的无害删除。建议执行快速同步。'),{type:'FAST_SYNC',newSelectedMks:r}):(Ue.debug('findDivergencePoint',`检测到需要分歧点重算。将从最早的分歧点 (ID: ${s}) 开始。`),{type:'FULL_RECALC',recalcId:s})},Ye=async(e=!1,t,a=!1)=>{try{e?Ue.warn('resyncStateOnHistoryChange','强制完全重算模式已启动！'):Ue.debug('resyncStateOnHistoryChange','聊天记录变更，启动状态同步...');const n={繁体转简体:N.value.繁体转简体},r=getChatMessages('0-{{lastMessageId}}',{include_swipes:!0});Ue.debug('resyncStateOnHistoryChange','获取到的 allMessages:',r);const{stat:s,meta:o}=S(),i=_.cloneDeep(_.get(o,g,[]));if(Ue.debug('resyncStateOnHistoryChange',`状态快照: oldSelectedMks.length=${i.length}, allMessages.length=${r?.length??0}`),!r||0===r.length)return void Ue.debug('resyncStateOnHistoryChange','当前聊天记录为空，不执行任何操作，同步终止。');let l;if('number'==typeof t&&Number.isFinite(t)){const e=Number(t);Ue.debug('resyncStateOnHistoryChange',`检测到定向同步请求，直接以消息 ID ${e} 作为重算起点。`),l={type:'FULL_RECALC',recalcId:e}}else l=Ge(r,i,o,e);if('FAST_SYNC'===l.type)return Ue.debug('resyncStateOnHistoryChange','执行快速同步...'),await V(e=>(_.set(e,g,l.newSelectedMks),e)),void Ue.debug('resyncStateOnHistoryChange','快速同步完成，仅修正 SelectedMks 数组。');const d=l.recalcId;let b=s;if(d>-1&&d<i.length){const e=_.get(o,p,{}),t=i[i.length-1],a=d>0?i[d-1]:void 0;t&&(Ue.debug('resyncStateOnHistoryChange',`准备一次性回滚。从: ${t}, 到: ${a||'初始状态'}`),b=function(e,t,a,n,r){const s=n.indexOf(t),o=e?n.indexOf(e):-1;if(-1===s){const e=`在序列中未找到当前MK: ${t}`;throw xe.error('rollbackStatToMK',e,{currentMK:t,selectedMks:n}),new Error(e)}if(e&&-1===o){const t=`在序列中未找到目标MK: ${e}`;throw xe.error('rollbackStatToMK',t,{targetMK:e,selectedMks:n}),new Error(t)}if(o>s)return xe.warn('rollbackStatToMK','目标MK不在过去，返回当前状态。',{targetMK:e,currentMK:t,targetIndex:o,currentIndex:s}),_.cloneDeep(a);if(o===s)return _.cloneDeep(a);let i=_.cloneDeep(a);for(let e=s;e>o;e--){const t=n[e];t&&(i=we(i,ae(r[t])))}return i}(a,t,s,i,e),Ue.debug('resyncStateOnHistoryChange','逆序回滚完成（内存中）。'))}Ue.debug('resyncStateOnHistoryChange',`从 ID ${d} 开始顺序重算...`);const m=i.slice(0,d),f=_.cloneDeep(o);for(let e=d;e<r.length;e++){if(a&&e>d){Ue.debug('resyncStateOnHistoryChange',`定向同步完成，已处理至目标消息 ID: ${d}。中止重算。`);break}const t=r[e],s=_.cloneDeep(f);_.set(s,g,m.slice(0,e));let o=be(t)||null;if(!o){Ue.debug('resyncStateOnHistoryChange',`当前消息id: ${t?.message_id??'unknown'}) 缺少 MK。为其生成.`);try{const{mk:e}=await me(t);o=e}catch(e){Ue.error('resyncStateOnHistoryChange','mk注入失败，跳过消息',{ensureError:e,message_id:t?.message_id});continue}}const{finalStat:i,finalEditLog:l,mk:c}=await Je(t,b,s,n);m[e]=o,b=i,_.set(f,[p,o],l)}Ue.debug('resyncStateOnHistoryChange','顺序重算完成。'),_.set(f,g,m),await async function(e){await updateVariablesWith(async t=>{const a=w().get(t,u,{}),n=await e(a);return w().set(t,u,n),t},c)}(()=>b),await V(()=>f),Ue.debug('resyncStateOnHistoryChange','状态同步完成。')}catch(t){Ue.error('resyncStateOnHistoryChange',`状态同步时发生严重错误: ${t?.message||t}`,{error:t,forceFullResync:e,eraData:S(),allMessages:getChatMessages('0-{{lastMessageId}}',{include_swipes:!0})})}},He=new O('ERA变量框架/ui/patch');async function qe(e){const t=getChatMessages(e);if(!t||0===t.length)return void He.warn('forceRenderMessage',`找不到消息ID为 ${e} 的消息。`);const a=t[0];await setChatMessages([{message_id:e,message:a.message}]),He.debug('forceRenderMessage',`已使用 setChatMessages 刷新消息 ${e}。`)}const Qe=new O('ERA变量框架/events/handlers/sync');async function Xe(e,t,a,n,r=!1){const{type:s}=e;Qe.debug('handleSyncEvent',`事件 ${s} 触发状态同步流程...`);const o='manual_full_sync'===s;await Ye(o,n,r),t.resync=!0,'combo_sync'!=s&&async function(){const e=getVariables({type:'script',script_id:getScriptId()});if(!_.get(e,'强制重载功能',!1))return void He.debug('forceRenderRecentMessages','强制重载功能未启用, 跳过。');const t=_.get(e,'强制重载消息数',1);He.log('forceRenderRecentMessages',`开始强制重载, 数量: ${t}`),await new Promise(e=>setTimeout(e,1e3));const a=getChatMessages('0-{{lastMessageId}}');if(!a||0===a.length)return void He.warn('forceRenderRecentMessages','无法获取到任何消息, 终止重载。');const n=a.slice(-t);for(const e of n)He.debug('forceRenderRecentMessages',`正在强制渲染消息: ${e.message_id}`),await qe(e.message_id),await new Promise(e=>setTimeout(e,100));He.log('forceRenderRecentMessages','强制重载完成。')}(),await fe(a.mk);const i=getChatMessages('0-{{lastMessageId}}',{include_swipes:!0});Qe.debug('handleSyncEvent','完成sync处理后的消息列表',i),Me(a)}const Ze=new O('ERA变量框架/events/handlers/api/handler');let et=null;async function tt(e){const t=(e=>{try{return JSON.stringify(e,null,2)}catch(e){return`<<stringify失败: ${e?.message||e}>>`}})(e.blockContent),a=`\n<${e.blockTag}>\n${t}\n</${e.blockTag}>`,n=await ue();if(!n)return void Ze.warn('performApiWrite','找不到任何 AI 消息，无法执行 API 写入。');const r=(ce(n)??'')+a;Ze.debug('performApiWrite',`实时写入 API 任务 (${e.blockTag}) 到消息 ID ${n.message_id}...`),await pe(n,r),Ce()}function at(e,t,a){const{type:n,detail:r}=e;var s,o;t.api=!0,n===f.INSERT_BY_OBJECT?tt({blockTag:'VariableInsert',blockContent:r}):n===f.UPDATE_BY_OBJECT?function(e){tt({blockTag:'VariableEdit',blockContent:e})}(r):n===f.INSERT_BY_PATH?(s=r.path,o=r.value,tt({blockTag:'VariableInsert',blockContent:_.set({},s,o)})):n===f.UPDATE_BY_PATH?function(e,t){tt({blockTag:'VariableEdit',blockContent:_.set({},e,t)})}(r.path,r.value):n===f.DELETE_BY_OBJECT?function(e){tt({blockTag:'VariableDelete',blockContent:e})}(r):n===f.DELETE_BY_PATH?function(e){tt({blockTag:'VariableDelete',blockContent:_.set({},e,{})})}(r.path):n===f.GET_CURRENT_VARS?function(e){let t;Ze.debug('handleGetCurrentVars','请求获取当前变量。');try{const{stat:e,meta:a}=S(),n=_.get(a,g,[]),r=n[n.length-1]||'',s=n.length-1,o=getChatMessages('0-{{lastMessageId}}',{include_swipes:!1})[s];t={mk:r,message_id:s,is_user:!!o&&de(o),stat:Z(e),statWithoutMeta:Z(A(e))}}catch(e){const a=`获取当前变量时发生错误: ${e instanceof Error?e.message:String(e)}`;Ze.error('handleGetCurrentVars',a),t={error:a}}Ie('getCurrentVars',e,t)}(r):n===f.GET_SNAPSHOT_AT_MK?function(e){let t;Ze.debug('handleGetSnapshotAtMk','请求获取历史快照...');try{const a=e?.mk;if(!a)throw new Error('请求缺少 "mk" 参数。');Ze.debug('handleGetSnapshotAtMk',`MK: ${a}`);const n=Ae(a);if(n){const{meta:e}=S(),r=_.get(e,g,[]).indexOf(a),s=getChatMessages('0-{{lastMessageId}}',{include_swipes:!1})[r];t={mk:a,message_id:r,is_user:!!s&&de(s),stat:Z(n),statWithoutMeta:Z(A(n))}}else{const e=`找不到 MK "${a}" 对应的快照。`;Ze.warn('handleGetSnapshotAtMk',e),t={error:e,stat:null}}}catch(e){const a=`获取快照时发生错误: ${e instanceof Error?e.message:String(e)}`;Ze.error('handleGetSnapshotAtMk',a),t={error:a}}Ie('getSnapshotAtMk',e,t)}(r):n===f.GET_SNAPSHOTS_BETWEEN_MKS?function(e){const{startMk:t,endMk:a}=e||{};let n;Ze.debug('handleGetSnapshotsBetweenMks',`请求获取批量快照，从: ${t||'开始'}, 到: ${a||'结束'}`);try{const e=Se(t,a);if(e){const t=getChatMessages('0-{{lastMessageId}}',{include_swipes:!1});n=e.map(e=>{const a=t[e.message_id];return{...e,is_user:!!a&&de(a),stat:Z(e.stat),statWithoutMeta:Z(A(e.stat))}})}else Ze.warn('handleGetSnapshotsBetweenMks','在指定范围内没有找到快照，或范围无效。'),n=[]}catch(e){const t=`获取批量快照时发生错误: ${e instanceof Error?e.message:String(e)}`;Ze.error('handleGetSnapshotsBetweenMks',t),n={error:t}}Ie('getSnapshotsBetweenMks',e,n)}(r):n===f.GET_SNAPSHOT_AT_MID?function(e){let t;Ze.debug('handleGetSnapshotAtMId','请求获取历史快照...');try{const a=e?.message_id;if('number'!=typeof a)throw new Error('请求缺少 "message_id" 参数或类型不正确。');Ze.debug('handleGetSnapshotAtMId',`Message ID: ${a}`);const{meta:n}=S(),r=_.get(n,g,[]);if(a<0||a>=r.length)throw new Error(`Message ID ${a} 超出范围 [0, ${r.length-1}]。`);const s=r[a];if(s){const e=Ae(s);if(e){const n=getChatMessages('0-{{lastMessageId}}',{include_swipes:!1})[a];t={mk:s,message_id:a,is_user:!!n&&de(n),stat:Z(e),statWithoutMeta:Z(A(e))}}else{const e=`获取快照失败，MK: ${s} (来自 Message ID: ${a})。可能该快照已被清理。`;Ze.error('handleGetSnapshotAtMId',e),t={error:e,stat:null}}}else{const e=`Message ID ${a} 处没有找到有效的 MK。`;Ze.warn('handleGetSnapshotAtMId',e),t={error:e,stat:null}}}catch(e){const a=`获取快照时发生错误: ${e instanceof Error?e.message:String(e)}`;Ze.error('handleGetSnapshotAtMId',a),t={error:a}}Ie('getSnapshotAtMId',e,t)}(r):n===f.GET_SNAPSHOTS_BETWEEN_MIDS?function(e){const{startId:t,endId:a}=e||{};let n;Ze.debug('handleGetSnapshotsBetweenMIds',`请求获取批量快照，从 ID: ${t??'开始'}, 到 ID: ${a??'结束'}`);try{const{meta:e}=S(),r=_.get(e,g,[]),s=t??0,o=a??r.length-1;if(s>o||s<0||o>=r.length)throw new Error(`ID 范围 [${s}, ${o}] 无效或超出范围 [0, ${r.length-1}]。`);const i=r[s],l=r[o];if(!i||!l)throw new Error('指定的 ID 范围内没有找到有效的起始或结束 MK。');const c=Se(i,l);if(c){const e=getChatMessages('0-{{lastMessageId}}',{include_swipes:!1});n=c.map(t=>{const a=e[t.message_id];return{...t,is_user:!!a&&de(a),stat:Z(t.stat),statWithoutMeta:Z(A(t.stat))}})}else Ze.warn('handleGetSnapshotsBetweenMIds','在指定 ID 范围内没有找到快照。'),n=[]}catch(e){const t=`获取批量快照时发生错误: ${e instanceof Error?e.message:String(e)}`;Ze.error('handleGetSnapshotsBetweenMIds',t),n={error:t}}Ie('getSnapshotsBetweenMIds',e,n)}(r):n===f.REQUEST_WRITE_DONE?(Ze.debug('handleRequestWriteDone','接收到 writeDone 重播请求。'),et?(Ze.debug('handleRequestWriteDone','正在重播上一次的 writeDone 事件。'),Me(et)):Ze.warn('handleRequestWriteDone','没有可供重播的 writeDone 事件。')):n===f.FORCE_SYNC&&async function(e,t,a){const n=e.detail,r=n?.mode||'auto';let s;Ze.log('handleForceSync',`接收到强制同步请求，模式: ${r}`);let o=!1,i=!1;switch(r){case'full':i=!0;break;case'latest':{const e=getChatMessages(-1,{include_swipes:!0})?.[0];if(!e)return void Ze.warn('handleForceSync','聊天记录为空，无法执行 "latest" 模式。');s=e.message_id,o=!1;break}case'rollbackTo':{const e=n?.message_id;if('number'!=typeof e)return void Ze.error('handleForceSync','"rollbackTo" 模式需要一个有效的 "message_id" 参数。');s=e,o=!0;break}}const l={...e,type:i?'manual_full_sync':e.type};await Xe(l,t,a,s,o)}(e,t,a)}eventOn('era:writeDone',e=>{et=e});const nt=new O('ERA变量框架/events/dispatcher');let rt=null;function st(){const e=B.mk;return e&&rt&&rt.mk===e?(nt.debug('updateConsecutiveMkCount',`连续处理写入/同步操作的 MK: ${e}。旧计数: ${rt.count}，新计数: ${rt.count+1}`),rt.count++):(nt.debug('updateConsecutiveMkCount',`新的写入/同步操作的 MK: ${e}。重置计数为 1。前一个 MK 是: ${rt?.mk}`),rt={mk:e,count:1}),rt.count}async function ot(e,t){const{type:a}=e,n=J(a);let r=null;const s=e.detail;nt.debug('dispatchAndExecuteTask','全处理开始前快照，所有消息',getChatMessages('0-{{lastMessageId}}',{include_swipes:!0}));const o={rollback:!1,apply:!1,resync:!1,api:!1,apiWrite:!1,editedResync:!1,swipedRollback:!1};try{await async function(e,t=20,a=50){let n;if(e)if('number'==typeof e){const t=getChatMessages(e,{include_swipes:!0});n=t?t[0]:null}else n=e;else n=ue();if(!n)return le.warn('getMessageContentWithRetry','找不到有效的消息对象',{messageOrId:e}),null;for(let e=0;e<t;e++){const t=ce(n);if(t)return t;le.log('getMessageContentWithRetry',`获取消息内容失败，将在 ${a}ms 后重试 (第 ${e+1} 次)`),await new Promise(e=>setTimeout(e,a))}return le.warn('getMessageContentWithRetry',`重试 ${t} 次后仍无法获取消息内容`,{message_id:n.message_id}),ce(n)}();const t=getChatMessages(-1,{include_swipes:!0})?.[0];if(!t)return nt.warn('dispatchAndExecuteTask','无法获取最新消息，跳过任务执行。'),null;let i,l;const c='API'===J(a)&&a!==f.FORCE_SYNC;if('combo_swipe_and_regenerate'===a||c)nt.log('dispatchAndExecuteTask',`检测到 ${a} 事件，跳过 MK 和占位符注入。`),l=t.message_id,i='';else{nt.log('dispatchAndExecuteTask','调用 ensureMkForLatestMessage');const{mk:e,message_id:a,isNewKey:n}=await(async e=>{try{if(ge.debug('ensureMkForLatestMessage','接收到的最新消息对象 (msg)',e),!e||'number'!=typeof e.message_id)return ge.warn('ensureMkForLatestMessage','无效的最新消息对象或其ID，退出',{latestMessage:e}),{mk:'',message_id:null,isNewKey:!1};const{mk:t,isNew:a}=await me(e);return ge.debug('ensureMkForLatestMessage',`已为最新消息 ${e.message_id} 确保 MK 存在。 (是否新建: ${a})`),{mk:t,message_id:e.message_id,isNewKey:a}}catch(t){return ge.error('ensureMkForLatestMessage',`确保MK时异常: ${t?.message||t}`,{error:t,latestMessage:e}),{mk:'',message_id:null,isNewKey:!1}}})(t);if(!e||null===a)return nt.warn('dispatchAndExecuteTask','无法获取有效的 MK 或消息 ID，跳过任务执行。'),null;i=e,l=a,nt.log('dispatchAndExecuteTask','调用 ensurePlaceholder'),await async function(e){const t='ensurePlaceholder';if(ye.debug(t,`执行占位符保障，消息 ID: ${e}`),!N.value.在ai消息尾部生成特殊符号)return void ye.debug(t,'功能未启用，已跳过。');ye.debug(t,'功能已启用，继续执行。');const a=getChatMessages(e,{include_swipes:!0})[0];if(!a)return void ye.warn(t,`无法找到消息 ID: ${e} 对应的消息。`);if(ye.debug(t,`获取到消息对象 (ID: ${e})`,a),de(a))return void ye.debug(t,`消息 ${e} 是用户消息，已跳过。`);ye.debug(t,`消息 ${e} 是 AI 消息，继续处理。`);const n=N.value.特殊符号值,r=ce(a);if(ye.debug(t,'读取到消息内容:',{content:r}),ye.debug(t,'使用的占位符:',{placeholder:n}),r&&r.includes(n))return void ye.debug(t,'消息已包含占位符，无需操作。');const s=(r||'').trimEnd()+'\n'+n;ye.debug(t,'准备更新消息，添加占位符。',{newMessage:s});try{await pe(a,s,'affected'),ye.debug(t,'消息更新成功。')}catch(e){ye.error(t,'更新消息时发生错误。',e)}}(l)}if(null===l)return nt.warn('dispatchAndExecuteTask','无法获取有效的消息 ID，跳过任务执行。'),null;B.mk=i,r=l;const d=de(t);nt.log('dispatchAndExecuteTask',`执行任务: ${a} (分组: ${n})`);const u={mk:i,message_id:r,is_user:d,actions:o,consecutiveProcessingCount:1};switch(n){case'INIT':nt.log('dispatchAndExecuteTask','调用 initializeExternalSettings'),ve(),u.consecutiveProcessingCount=st(),nt.log('dispatchAndExecuteTask','调用 handleSyncEvent for INIT'),await Xe(e,o,u);break;case'SYNC':a===v&&(o.apiWrite=!0),u.consecutiveProcessingCount=st(),nt.log('dispatchAndExecuteTask','调用 handleSyncEvent for SYNC'),await Xe(e,o,u);break;case'API':nt.log('dispatchAndExecuteTask','调用 handleApiEvent'),at(e,o,u);break;case'UPDATE_MK_ONLY':nt.log('dispatchAndExecuteTask','调用 handleUpdateMkOnlyEvent'),await async function(e){await fe(e)}(i);break;case'DIRECTED_SYNC':if(u.consecutiveProcessingCount=st(),'combo_swipe_and_regenerate'===a){o.swipedRollback=!0;const t=r-1,a=!0;nt.log('dispatchAndExecuteTask',`处理 combo_swipe_and_regenerate 事件，目标消息 ID: ${t}, stopAtTarget: ${a}`),t<0?(nt.warn('dispatchAndExecuteTask','无法对第一条消息执行滑动回退，按普通同步处理。'),await Xe(e,o,u)):await Xe(e,o,u,t,a)}else if(a===tavern_events.MESSAGE_EDITED){o.editedResync=!0;const t=function(e){if(null==e)return le.debug('extractMessageIdFromDetail','detail 为空，无法解析 message_id。'),null;if('number'==typeof e)return Number.isFinite(e)?(le.debug('extractMessageIdFromDetail','从 number detail 获取 message_id。',{message_id:e}),e):(le.debug('extractMessageIdFromDetail','number detail 非有限值，忽略。',{detail:e}),null);if('string'==typeof e){const t=Number(e);return Number.isFinite(t)?(le.debug('extractMessageIdFromDetail','从 string detail 解析 message_id。',{raw:e,message_id:t}),t):(le.debug('extractMessageIdFromDetail','string detail 无法解析为有效数字，忽略。',{raw:e}),null)}if(Array.isArray(e)&&e.length>0){const t=Number(e[0]);return Number.isFinite(t)?(le.debug('extractMessageIdFromDetail','从数组 detail[0] 解析 message_id。',{raw:e[0],message_id:t}),t):(le.debug('extractMessageIdFromDetail','数组 detail[0] 无法解析为有效数字，忽略。',{raw:e[0]}),null)}if('object'==typeof e){if('number'==typeof e.message_id)return Number.isFinite(e.message_id)?(le.debug('extractMessageIdFromDetail','从对象 detail.message_id(number) 获取 message_id。',{message_id:e.message_id}),e.message_id):(le.debug('extractMessageIdFromDetail','对象 detail.message_id(number) 不是有限值，忽略。',{message_id:e.message_id}),null);if('string'==typeof e.message_id){const t=Number(e.message_id);return Number.isFinite(t)?(le.debug('extractMessageIdFromDetail','从对象 detail.message_id(string) 解析 message_id。',{raw:e.message_id,message_id:t}),t):(le.debug('extractMessageIdFromDetail','对象 detail.message_id(string) 无法解析为有效数字，忽略。',{raw:e.message_id}),null)}if(Array.isArray(e.eventArgs)&&e.eventArgs.length>0){const t=Number(e.eventArgs[0]);return Number.isFinite(t)?(le.debug('extractMessageIdFromDetail','从对象 detail.eventArgs[0] 解析 message_id。',{raw:e.eventArgs[0],message_id:t}),t):(le.debug('extractMessageIdFromDetail','对象 detail.eventArgs[0] 无法解析为有效数字，忽略。',{raw:e.eventArgs[0]}),null)}}return le.debug('extractMessageIdFromDetail','未能从事件 detail 中解析出有效的 message_id。',{detail:e}),null}(s),a=!1;nt.log('dispatchAndExecuteTask',`处理 MESSAGE_EDITED 事件，目标消息 ID: ${t}, stopAtTarget: ${a}`),null===t||t<0?(nt.warn('dispatchAndExecuteTask','MESSAGE_EDITED 事件缺少或无效的 message_id，按普通同步处理。',{eventDetail:s}),await Xe(e,o,u)):await Xe(e,o,u,t,a)}else nt.warn('dispatchAndExecuteTask',`接收到未明确处理的 DIRECTED_SYNC 事件: ${a}，按普通同步处理。`),await Xe(e,o,u)}}catch(e){nt.error('dispatchAndExecuteTask',`事件 ${a} 处理异常: ${e}`,e)}finally{B.mk=''}return null}const it=new O('ERA变量框架/events/queue'),lt=[];let ct=!1,dt=!1,ut=null;function pt(e,t){it.debug('pushToQueue',`接收到事件: ${e}，已推入队列。`,{detail:t}),lt.push({type:e,detail:t,timestamp:Date.now()}),async function(){if(dt)return void it.debug('processQueue','已有处理函数在排队等待，本次调用忽略。');ct&&(it.debug('processQueue','处理器忙碌，进入排队等待状态...'),dt=!0,await new Promise(e=>{ut=e}),dt=!1,it.debug('processQueue','等待结束，获取到处理权。'));if(0===lt.length)return void it.debug('processQueue','队列为空，无需处理。');ct=!0,it.debug('processQueue','处理器启动！');const e=lt[0];if('API'!==J(e.type)){const t=W.get(e.type)??100,a=20;let n=0;for(it.debug('processQueue',`启动事件收集窗口，最长等待 ${t}ms...`);n<t;){if(U(lt)){it.debug('processQueue','检测到紧急事件组合，立即结束等待。');break}await new Promise(e=>setTimeout(e,a)),n+=a}n>=t&&it.debug('processQueue',`等待时间达到 ${t}ms，正常结束等待。`)}it.debug('processQueue','事件收集窗口关闭，准备处理的队列内容:',JSON.stringify(lt.map(e=>e.type)));for(;lt.length>0;){const e=lt.splice(0,lt.length),t=K(e);it.debug('processQueue',`开始处理一个新批次，包含 ${e.length} 个原始事件，合并后为 ${t.length} 个任务。`);for(const e of t)await ot(e);it.debug('processQueue','本轮批次处理完毕。')}if(ct=!1,it.debug('processQueue','处理器空闲，已释放锁。'),ut){it.debug('processQueue','通知排队的处理器开始工作。');const e=ut;ut=null,e()}}()}const gt=new O('MacroParser');function bt(e,t,a){if(!e.includes('{{ERA'))return e;const n=t??S().stat,r=a??A(S().stat);return e.replace(/{{\s*ERA(-withmeta)?\s*:\s*([^}]+?)\s*}}/gi,(e,t,a)=>{const s='parseEraMacros',o=a.trim(),i=!!t,l=i?n:r;if(!l)return gt.warn(s,`无法获取到宏替换所需的数据 (includeMeta: ${i})`),e;let c;if(c='$ALLDATA'===o?l:_.get(l,o),void 0===c)return gt.warn(s,`在数据源中未找到路径 "${o}", 宏将替换为空字符串.`),'';const d=c;return gt.debug(s,`宏替换数据: ${o}`,{data:d}),'object'==typeof d&&null!==d?JSON.stringify(d):String(d)})}const mt=e=>{if(e.actions.swipedRollback)return void gt.debug('handleWriteDone','检测到 swipedRollback，跳过宏刷新。');const{message_id:t}=e;if('number'==typeof t)try{const a=retrieveDisplayedMessage(t);if(!a.length)return;const n=a.html();if(!n.includes('{{ERA'))return;const r=SillyTavern?.chat?.[t],s='string'==typeof r?.mes?r.mes:null,o=null!==s&&s.includes('{{ERA'),i=n.includes('{{ERA');if(!o&&!i)return;const l=o?bt(s,e.stat,e.statWithoutMeta):null,c=i?bt(n,e.stat,e.statWithoutMeta):n,d=null!==l&&l!==s,u=c!==n;if(!d&&!u)return;let p=!1;if(d){const e='function'==typeof formatAsDisplayedMessage?formatAsDisplayedMessage:null;let n=null;if(e)try{n=e(l,{message_id:t})??null}catch(e){gt.warn('handleWriteDone','formatAsDisplayedMessage failed; falling back to DOM patch.',e)}const r=SillyTavern?.updateMessageBlock;if('function'==typeof r){const e={mes:l};null!==n&&(e.message=n),r.call(SillyTavern,t,e,{rerenderMessage:!0}),p=!0}else null!==n&&(a.html(n),p=!0)}if(!p&&u){(function(e,t,a){let n=!1;const r=/{{\s*ERA/i,s=e=>{if(e.nodeType===Node.TEXT_NODE){const s=e.nodeValue??'';if(!r.test(s))return;const o=bt(s,t,a);return void(o!==s&&(e.nodeValue=o,n=!0))}if(e.nodeType!==Node.ELEMENT_NODE)return;const o=e.tagName;if('SCRIPT'===o||'STYLE'===o||'TEXTAREA'===o)return;const i=Array.from(e.childNodes);for(const e of i)s(e)};return e.each((_,e)=>{s(e)}),n})(a,e.stat,e.statWithoutMeta)&&(gt.debug('handleWriteDone',`Patched macros in-place for message_id: ${t}`),p=!0)}p&&gt.debug('handleWriteDone',`Successfully re-rendered macros for message_id: ${t}`)}catch(e){gt.error('handleWriteDone',`Failed to re-render macros for message_id: ${t}`,e)}else gt.warn('handleWriteDone','Event payload did not provide a valid message_id.')};const ft=(e,t)=>{if(t)return;if(!e.prompt.some(e=>'string'==typeof e.content&&e.content.includes('{{ERA')))return;const a=t=>{if('getCurrentVars'!==t.queryType)return;if(eventRemoveListener('era:queryResult',a),t.result&&t.result.error)return void gt.error('handleGenerateAfterData','ERA 查询 [getCurrentVars] 失败:',t.result.error);const n=t.result?.stat,r=t.result?.statWithoutMeta;if(n&&r){gt.debug('handleGenerateAfterData','成功通过事件获取到当前变量快照，准备替换宏。');for(const t of e.prompt)if('string'==typeof t.content&&t.content.includes('{{ERA')){const e=t.content;t.content=bt(e,n,r),e!==t.content&&gt.log('handleGenerateAfterData',`成功替换了 role: ${t.role} 消息中的 ERA 宏。`)}}else gt.warn('handleGenerateAfterData','无法从 era:queryResult 事件中获取完整的变量快照，跳过宏替换。')};eventOn('era:queryResult',a),gt.debug('handleGenerateAfterData','发送 era:getCurrentVars 事件以获取宏替换所需的状态。'),eventEmit('era:getCurrentVars')};$(()=>{eventOn(tavern_events.GENERATE_AFTER_DATA,ft),eventOn(h,mt),gt.log('setupMacroAutoRefresh','监听到writeDone,开始对消息中的宏进行替换.'),$(window).on('pagehide',()=>{eventRemoveListener(h,mt),gt.log('removeMacroAutoRefresh','Macro auto-refresh listener has been removed.'),eventRemoveListener(tavern_events.GENERATE_AFTER_DATA,ft)})});const ht={class:'acc'},vt=['aria-expanded'],yt={class:'title'},xt={class:'hint'},wt={class:'inner'},Et=(0,E.defineComponent)({__name:'EraAccordion',props:{title:{},defaultOpen:{type:Boolean,default:!1}},setup(e){const t=e,a=(0,E.ref)(t.defaultOpen);return(t,n)=>((0,E.openBlock)(),(0,E.createElementBlock)('section',ht,[(0,E.createCommentVNode)(' 折叠头：点击切换 '),(0,E.createElementVNode)('button',{class:'acc-head','aria-expanded':a.value?'true':'false',onClick:n[0]||(n[0]=e=>a.value=!a.value)},[(0,E.createElementVNode)('span',{class:(0,E.normalizeClass)(['caret',{open:a.value}])},'▸',2),(0,E.createCommentVNode)(' 指示箭头 '),(0,E.createElementVNode)('span',yt,(0,E.toDisplayString)(e.title),1),(0,E.createCommentVNode)(' 标题文本 '),n[1]||(n[1]=(0,E.createElementVNode)('span',{class:'spacer'},null,-1)),(0,E.createCommentVNode)(' 弹性空隙 '),(0,E.createElementVNode)('span',xt,(0,E.toDisplayString)(a.value?'收起':'展开'),1),(0,E.createCommentVNode)(' 右侧提示 ')],8,vt),(0,E.createCommentVNode)(' 内容：高度过渡（使用 CSS Grid） '),(0,E.createElementVNode)('div',{class:(0,E.normalizeClass)(['acc-body',{open:a.value}])},[(0,E.createElementVNode)('div',wt,[(0,E.renderSlot)(t.$slots,'default')])],2)]))}});o(344);var kt=o(42);const _t=(0,kt.A)(Et,[['__scopeId','data-v-f723f6d6']]),Nt={class:'meta'},At={class:'kv'},St={class:'item'},Vt=['title'],Ct={class:'item'},Mt={class:'v'},It={class:'item'},$t={class:'v'},Dt=(0,E.defineComponent)({__name:'MetaHeader',props:{mk:{},messageId:{},isUser:{type:Boolean}},setup(e){const t=new O('ERA变量框架/ui/components/EraPanelContent/MetaHeader'),a=e;return(0,E.onMounted)(()=>{}),(0,E.watch)(()=>a,e=>{t.debug('watch:props','Props 发生变化',{newProps:e})},{deep:!0}),(t,a)=>((0,E.openBlock)(),(0,E.createElementBlock)('section',Nt,[(0,E.createElementVNode)('div',At,[(0,E.createElementVNode)('div',St,[a[0]||(a[0]=(0,E.createElementVNode)('span',{class:'k'},'mk',-1)),(0,E.createCommentVNode)(' 键：mk '),(0,E.createElementVNode)('span',{class:'v',title:e.mk},(0,E.toDisplayString)(e.mk||'—'),9,Vt),(0,E.createCommentVNode)(' 值：mk ')]),(0,E.createElementVNode)('div',Ct,[a[1]||(a[1]=(0,E.createElementVNode)('span',{class:'k'},'message_id',-1)),(0,E.createCommentVNode)(' 键：message_id '),(0,E.createElementVNode)('span',Mt,(0,E.toDisplayString)(e.messageId??'—'),1),(0,E.createCommentVNode)(' 值：message_id ')]),(0,E.createElementVNode)('div',It,[a[2]||(a[2]=(0,E.createElementVNode)('span',{class:'k'},'来源',-1)),(0,E.createCommentVNode)(' 键：来源 '),(0,E.createElementVNode)('span',$t,(0,E.toDisplayString)(e.isUser?'用户':'AI'),1),(0,E.createCommentVNode)(' 值：来源 ')])])]))}});o(45);const Tt=(0,kt.A)(Dt,[['__scopeId','data-v-9a5820b4']]),Rt={class:'node'},Bt={class:'key'},Ot={class:'brace'},jt={key:0,class:'summary'},Pt={key:0,class:'json-children'},Lt={class:'brace'};const Ft=(0,E.defineComponent)({name:'JsonNode',props:{k:{type:[String,Number],required:!0},v:{required:!0},path:{type:String,required:!0},level:{type:Number,required:!0},defaultCollapsed:{type:Boolean,default:!0},maxDepth:{type:Number,default:3}},setup(e){const t=new O('ERA变量框架/ui/template/JsonNode');(0,E.onMounted)(()=>{});const a=(0,E.computed)(()=>{const t=e.v;if(null===t)return'null';if(Array.isArray(t))return'array';const a=typeof t;return'object'===a?'object':'undefined'===a?'undefined':a}),n=(0,E.computed)(()=>'array'===a.value),r=(0,E.computed)(()=>'object'===a.value),s=(0,E.computed)(()=>n.value||r.value),o=(0,E.ref)(e.level<=(e.maxDepth??3)||!e.defaultCollapsed);(0,E.watch)(o,e=>{t.debug('watch:open','折叠状态改变为: '+(e?'展开':'收起'))});const i=(0,E.computed)(()=>{const t=e.v;switch(a.value){case'string':return JSON.stringify(t);case'number':case'symbol':return String(t);case'boolean':return t?'true':'false';case'null':return'null';case'undefined':return'undefined';case'bigint':return String(t)+'n';case'function':return'ƒ()';default:return''}}),l=(0,E.computed)(()=>n.value?`Array[${e.v.length}]`:r.value?`Object{${Object.keys(e.v||{}).length}}`:''),c=(0,E.computed)(()=>{if(r.value)return e.v;if(n.value){const t={};return e.v.forEach((e,a)=>{t[String(a)]=e}),t}return{}});return{type:a,isArray:n,foldable:s,open:o,primitiveText:i,summary:l,childEntries:c}}});o(136);const zt=(0,kt.A)(Ft,[['render',function(e,t,a,n,r,s){const o=(0,E.resolveComponent)('JsonNode',!0);return(0,E.openBlock)(),(0,E.createElementBlock)(E.Fragment,null,[(0,E.createCommentVNode)(' 单条节点（支持递归） '),(0,E.createElementVNode)('div',Rt,[(0,E.createCommentVNode)(' 每个键值对 / 数组项的容器 '),(0,E.createElementVNode)('div',{class:'json-line',style:(0,E.normalizeStyle)({paddingLeft:14*e.level+'px'})},[(0,E.createCommentVNode)(' 行+缩进 '),e.foldable?((0,E.openBlock)(),(0,E.createElementBlock)('button',{key:0,class:(0,E.normalizeClass)(['caret',{open:e.open}]),'aria-label':'toggle',onClick:t[0]||(t[0]=t=>e.open=!e.open)},'▸',2)):(0,E.createCommentVNode)('v-if',!0),(0,E.createCommentVNode)(' 折叠箭头按钮 '),(0,E.createElementVNode)('span',Bt,(0,E.toDisplayString)(e.k),1),t[1]||(t[1]=(0,E.createElementVNode)('span',{class:'colon'},':',-1)),(0,E.createCommentVNode)(' 键与冒号 '),(0,E.createCommentVNode)(' 可折叠容器：只显示括号与摘要；展开后由下方 children 区域递归渲染 '),e.foldable?((0,E.openBlock)(),(0,E.createElementBlock)(E.Fragment,{key:1},[(0,E.createElementVNode)('span',Ot,(0,E.toDisplayString)(e.isArray?'[':'{'),1),(0,E.createCommentVNode)(' 容器起始括号 '),e.open?(0,E.createCommentVNode)('v-if',!0):((0,E.openBlock)(),(0,E.createElementBlock)('span',jt,(0,E.toDisplayString)(e.summary),1)),(0,E.createCommentVNode)(' 收起时的摘要 ')],64)):((0,E.openBlock)(),(0,E.createElementBlock)(E.Fragment,{key:2},[(0,E.createCommentVNode)(' 原始值：直接着色渲染 '),(0,E.createElementVNode)('span',{class:(0,E.normalizeClass)(['val',e.type])},(0,E.toDisplayString)(e.primitiveText),3),(0,E.createCommentVNode)(' 原始值文本 ')],64))],4),(0,E.createCommentVNode)(' 子元素区域：仅当可折叠且处于展开态时显示 '),e.foldable&&e.open?((0,E.openBlock)(),(0,E.createElementBlock)('div',Pt,[(0,E.createCommentVNode)(' 递归：自引用同名组件 JsonNode（依赖 name: \'JsonNode\' 实现自递归） '),((0,E.openBlock)(!0),(0,E.createElementBlock)(E.Fragment,null,(0,E.renderList)(e.childEntries,(t,a)=>((0,E.openBlock)(),(0,E.createBlock)(o,{key:e.path+'/'+String(a),k:String(a),v:t,path:e.path+'/'+String(a),level:e.level+1,'default-collapsed':e.defaultCollapsed,'max-depth':e.maxDepth},null,8,['k','v','path','level','default-collapsed','max-depth']))),128)),(0,E.createElementVNode)('div',{class:'json-line',style:(0,E.normalizeStyle)({paddingLeft:14*e.level+'px'})},[(0,E.createElementVNode)('span',Lt,(0,E.toDisplayString)(e.isArray?']':'}'),1),(0,E.createCommentVNode)(' 容器闭合括号 ')],4)])):(0,E.createCommentVNode)('v-if',!0)])],2112)}],['__scopeId','data-v-6c2ac46e']]),Wt={class:'json-root'},Jt={class:'json-line'},Ut={class:'brace'},Kt={class:'json-children'},Gt={key:1,class:'json-line',style:{paddingLeft:'14px'}},Yt={class:'json-line'},Ht={class:'brace'},qt=(0,E.defineComponent)({__name:'PrettyJsonViewer',props:{value:{},defaultCollapsed:{type:Boolean,default:!0},maxDepth:{default:3}},setup(e){const t=new O('ERA变量框架/ui/template/PrettyJsonViewer'),a=e,n=(0,E.computed)(()=>{const e=a.value,n=null!==e&&'object'==typeof e;return t.debug('isPlainObjectOrArray',`计算结果: ${n}。该值${n?'是':'不是'}普通对象或数组。`,{传入值:e}),n}),r=(0,E.computed)(()=>{const e=a.value;let n;if(null===e)n='null';else if(Array.isArray(e))n='array';else{const t=typeof e;n='undefined'===t?'undefined':t}return t.debug('primitiveType',`计算原始值类型: ${n}`,{传入值:e}),n}),s=(0,E.computed)(()=>{const e=a.value;let n;switch(r.value){case'string':n=JSON.stringify(e);break;case'number':case'symbol':n=String(e);break;case'boolean':n=e?'true':'false';break;case'null':n='null';break;case'undefined':n='undefined';break;case'bigint':n=String(e)+'n';break;case'function':n='ƒ()';break;default:n=''}return t.debug('primitiveText',`格式化原始值文本: "${n}"`,{传入值:e,类型:r.value}),n}),o=(0,E.computed)(()=>{const e=Array.isArray(a.value);return t.debug('isArrayRoot',`计算根节点是否为数组: ${e}`,{传入值:a.value}),e}),i=(0,E.computed)(()=>o.value?'[':'{'),l=(0,E.computed)(()=>o.value?']':'}');return(t,a)=>((0,E.openBlock)(),(0,E.createElementBlock)('div',Wt,[(0,E.createElementVNode)('div',Jt,[(0,E.createElementVNode)('span',Ut,(0,E.toDisplayString)(i.value),1),(0,E.createCommentVNode)(' 根开括号：对象{ / 数组[ ')]),(0,E.createElementVNode)('div',Kt,[n.value?((0,E.openBlock)(!0),(0,E.createElementBlock)(E.Fragment,{key:0},(0,E.renderList)(e.value,(t,a)=>((0,E.openBlock)(),(0,E.createBlock)(zt,{key:String(a),k:String(a),v:t,path:String(a),level:1,'default-collapsed':e.defaultCollapsed,'max-depth':e.maxDepth},null,8,['k','v','path','default-collapsed','max-depth']))),128)):((0,E.openBlock)(),(0,E.createElementBlock)('div',Gt,[a[0]||(a[0]=(0,E.createElementVNode)('span',{class:'key'},'value',-1)),a[1]||(a[1]=(0,E.createElementVNode)('span',{class:'colon'},':',-1)),(0,E.createElementVNode)('span',{class:(0,E.normalizeClass)(['val',r.value])},(0,E.toDisplayString)(s.value),3)]))]),(0,E.createElementVNode)('div',Yt,[(0,E.createElementVNode)('span',Ht,(0,E.toDisplayString)(l.value),1),(0,E.createCommentVNode)(' 根闭括号：对象} / 数组] ')])]))}});o(273);const Qt=(0,kt.A)(qt,[['__scopeId','data-v-6fc9ef75']]),Xt={class:'details-wrapper'},Zt={class:'detail-block'},ea={class:'detail-block'},ta=(0,E.defineComponent)({__name:'OperationDetails',props:{data:{}},setup:e=>(t,a)=>((0,E.openBlock)(),(0,E.createBlock)(_t,{title:'ERA 最新操作详情','default-open':!1},{default:(0,E.withCtx)(()=>[(0,E.createElementVNode)('div',Xt,[(0,E.createElementVNode)('div',Zt,[a[0]||(a[0]=(0,E.createElementVNode)('h4',{class:'detail-title'},'SelectedMks（数组）',-1)),(0,E.createVNode)(Qt,{value:e.data.selectedMks,'default-collapsed':!0,'max-depth':3},null,8,['value'])]),(0,E.createElementVNode)('div',ea,[a[1]||(a[1]=(0,E.createElementVNode)('h4',{class:'detail-title'},'EditLogs（对象）',-1)),(0,E.createVNode)(Qt,{value:e.data.editLogs,'default-collapsed':!0,'max-depth':2},null,8,['value'])])])]),_:1}))});o(38);const aa=(0,kt.A)(ta,[['__scopeId','data-v-6079192c']]),na={class:'tabs'},ra={class:'tab-bar',role:'tablist'},sa=['onClick'],oa={class:'tab-content'},ia={key:0},la={key:1},ca=(0,E.defineComponent)({__name:'TabSwitch',props:{tabs:{},active:{}},emits:['update:active'],setup(e,{emit:t}){const a=new O('ERA变量框架/ui/template/TabSwitch'),n=e,r=t,s=(0,E.ref)(n.active??'pure');return(0,E.watch)(()=>n.active,e=>{e&&(a.debug('watch:active',`外部同步 active tab 为: ${e}`),s.value=e)}),(0,E.onMounted)(()=>{}),(t,n)=>((0,E.openBlock)(),(0,E.createElementBlock)('section',na,[(0,E.createCommentVNode)(' 页签行 '),(0,E.createElementVNode)('div',ra,[((0,E.openBlock)(!0),(0,E.createElementBlock)(E.Fragment,null,(0,E.renderList)(e.tabs,e=>((0,E.openBlock)(),(0,E.createElementBlock)('button',{key:e.key,class:(0,E.normalizeClass)(['tab-btn',{active:e.key===s.value}]),role:'tab',onClick:t=>{return n=e.key,a.debug('setActive',`用户点击，切换 tab 到: ${n}`),s.value=n,void r('update:active',n);var n}},(0,E.toDisplayString)(e.label),11,sa))),128))]),(0,E.createCommentVNode)(' 内容区：根据活动键渲染对应插槽 '),(0,E.createElementVNode)('div',oa,['pure'===s.value?((0,E.openBlock)(),(0,E.createElementBlock)('div',ia,[(0,E.renderSlot)(t.$slots,'pure'),(0,E.createCommentVNode)(' 纯净状态数据内容 ')])):((0,E.openBlock)(),(0,E.createElementBlock)('div',la,[(0,E.renderSlot)(t.$slots,'full'),(0,E.createCommentVNode)(' 完整状态数据内容 ')]))])]))}});o(511);const da=(0,kt.A)(ca,[['__scopeId','data-v-2874077c']]),ua={id:'era-snapshot-ui',class:'snapshot-manager'},pa={class:'selector-wrapper'},ga={class:'select-field',role:'group','aria-labelledby':'mk-label'},ba={class:'select-container'},ma=['value'],fa={class:'selector-wrapper'},ha={class:'select-field',role:'group','aria-labelledby':'mid-label'},va={class:'id-query-container'},ya={key:0,class:'loading-indicator'},xa={key:1,class:'error-message'},wa=(0,E.defineComponent)({__name:'SnapshotManager',props:{latestData:{}},setup(e){const t=e,a=new O('ERA变量框架/ui/components/SnapshotManager'),n=(0,E.computed)(()=>t.latestData?.mk??null),r=(0,E.ref)(n.value),s=(0,E.ref)(null),o=(0,E.ref)(null),i=(0,E.ref)(!1),l=(0,E.ref)(null),c=[{key:'pure',label:'纯净状态数据'},{key:'full',label:'完整状态数据'}],d=(0,E.ref)('pure'),u=(0,E.computed)(()=>t.latestData?.selectedMks?.slice().reverse()??[]),p=(0,E.computed)(()=>o.value?o.value:r.value===n.value?t.latestData:null),g=(0,E.computed)(()=>{if(!p.value)return!1;if('is_user'in p.value)return p.value.is_user;const e=getChatMessages(p.value.message_id,{include_swipes:!1})[0];return!!e&&de(e)});(0,E.watch)(()=>n.value,e=>{r.value=e,o.value=null,s.value=null,l.value=null,i.value=!1},{immediate:!0});const b=()=>{const e=r.value;s.value=null,o.value=null,l.value=null,e&&e!==n.value?(i.value=!0,a.debug('SnapshotManager',`(MK Select) 请求快照, mk: ${e}`),eventEmit('era:getSnapshotAtMk',{mk:e})):i.value=!1},m=()=>{null===s.value||s.value<0?l.value='请输入一个有效的、非负的消息 ID。':(r.value=null,o.value=null,l.value=null,i.value=!0,a.debug('SnapshotManager',`(ID Query) 请求快照, message_id: ${s.value}`),eventEmit('era:getSnapshotAtMId',{message_id:s.value}))},f=e=>{i.value=!1;const t=(e,t)=>{e?(o.value=e,r.value=e.mk,l.value=null):(o.value=null,l.value=t)};'getSnapshotAtMk'===e.queryType&&e.request.mk===r.value?t(e.result,`未找到与 MK "${r.value}" 相关的快照。`):'getSnapshotAtMId'===e.queryType&&e.request.message_id===s.value&&t(e.result,`未找到与消息 ID "${s.value}" 相关的快照。`)},h=(e,t)=>{const a=u.value.length-1-t,r=e===n.value;if(!e)return`消息 ${a} (无MK)`;const s=`消息 ${a} (...${e.substring(e.length-6)})`;return r?`${s} (最新)`:s};return(0,E.onMounted)(()=>{eventOn('era:queryResult',f)}),(0,E.onUnmounted)(()=>{eventRemoveListener('era:queryResult',f)}),(e,t)=>((0,E.openBlock)(),(0,E.createElementBlock)(E.Fragment,null,[(0,E.createCommentVNode)(' ★ 新增唯一 id：不改变任何逻辑，仅用于限制样式作用域 '),(0,E.createElementVNode)('div',ua,[(0,E.createElementVNode)('div',pa,[(0,E.createCommentVNode)(' 外层容器：保留，改为纵向布局更协调 '),(0,E.createElementVNode)('div',ga,[(0,E.createCommentVNode)(' 字段容器：用于浮动标题 '),t[4]||(t[4]=(0,E.createElementVNode)('label',{id:'mk-label',for:'mk-selector',class:'field-label'},'按消息密钥(MK)查看',-1)),(0,E.createCommentVNode)(' 浮动小标题：不再占用水平空间 '),(0,E.createElementVNode)('div',ba,[(0,E.createCommentVNode)(' 下拉容器：保留右侧箭头与阴影效果 '),(0,E.withDirectives)((0,E.createElementVNode)('select',{id:'mk-selector','onUpdate:modelValue':t[0]||(t[0]=e=>r.value=e),class:'mk-selector',onChange:b},[t[3]||(t[3]=(0,E.createElementVNode)('option',{value:null,disabled:''},'-- 从列表中选择 --',-1)),((0,E.openBlock)(!0),(0,E.createElementBlock)(E.Fragment,null,(0,E.renderList)(u.value,(e,t)=>((0,E.openBlock)(),(0,E.createElementBlock)('option',{key:e||`null-${t}`,value:e},[(0,E.createTextVNode)((0,E.toDisplayString)(h(e,t))+' ',1),(0,E.createCommentVNode)(' 选项显示文本 ')],8,ma))),128))],544),[[E.vModelSelect,r.value]])])])]),(0,E.createElementVNode)('div',fa,[(0,E.createElementVNode)('div',ha,[t[5]||(t[5]=(0,E.createElementVNode)('label',{id:'mid-label',for:'mid-input',class:'field-label'},'按消息ID查看',-1)),(0,E.createElementVNode)('div',va,[(0,E.withDirectives)((0,E.createElementVNode)('input',{id:'mid-input','onUpdate:modelValue':t[1]||(t[1]=e=>s.value=e),type:'number',class:'mk-selector id-input',placeholder:'输入消息 ID...',onKeyup:(0,E.withKeys)(m,['enter'])},null,544),[[E.vModelText,s.value,void 0,{number:!0}]]),(0,E.createElementVNode)('button',{class:'query-button',onClick:m},'查找')])])]),i.value?((0,E.openBlock)(),(0,E.createElementBlock)('div',ya,'正在加载快照...')):(0,E.createCommentVNode)('v-if',!0),l.value?((0,E.openBlock)(),(0,E.createElementBlock)('div',xa,(0,E.toDisplayString)(l.value),1)):(0,E.createCommentVNode)('v-if',!0),p.value?((0,E.openBlock)(),(0,E.createElementBlock)(E.Fragment,{key:2},[(0,E.createVNode)(_t,{title:'消息元数据','default-open':!0},{default:(0,E.withCtx)(()=>[(0,E.createVNode)(Tt,{mk:p.value.mk,'message-id':p.value.message_id,'is-user':g.value},null,8,['mk','message-id','is-user'])]),_:1}),(0,E.createVNode)(da,{active:d.value,'onUpdate:active':t[2]||(t[2]=e=>d.value=e),tabs:c},{pure:(0,E.withCtx)(()=>[(0,E.createVNode)(Qt,{value:p.value.statWithoutMeta,'default-collapsed':!0,'max-depth':1/0},null,8,['value'])]),full:(0,E.withCtx)(()=>[(0,E.createVNode)(Qt,{value:p.value.stat,'default-collapsed':!0,'max-depth':1/0},null,8,['value'])]),_:1},8,['active'])],64)):(0,E.createCommentVNode)('v-if',!0)])],2112))}});o(820);const Ea=wa,ka={class:'era-panel'},_a={class:'panel-top'},Na={class:'panel-body'},Aa={class:'panel-content-wrapper'},Sa={key:1,class:'empty'},Va=(0,E.defineComponent)({__name:'EraPanel',props:{data:{}},setup(e){const t=new O('ERA变量框架/ui/components/EraPanel');return(a,n)=>((0,E.openBlock)(),(0,E.createElementBlock)('div',ka,[(0,E.createElementVNode)('header',_a,[n[1]||(n[1]=(0,E.createElementVNode)('h3',{class:'panel-title'},'ERA 数据面板',-1)),(0,E.createElementVNode)('button',{class:'btn-close','aria-label':'关闭',onClick:n[0]||(n[0]=e=>{return a='FloatingBall',t.debug('requestSwitchView',`请求切换视图到: ${a}`),void(window.eraUiSwitchView?window.eraUiSwitchView(a):t.warn('requestSwitchView','全局切换函数 eraUiSwitchView 未找到'));var a})},'×')]),(0,E.createElementVNode)('div',Na,[(0,E.createElementVNode)('div',Aa,[e.data?((0,E.openBlock)(),(0,E.createElementBlock)(E.Fragment,{key:0},[(0,E.createVNode)(_t,{title:'最新消息元数据','default-open':!1},{default:(0,E.withCtx)(()=>[(0,E.createVNode)(Tt,{mk:e.data.mk,'message-id':e.data.message_id,'is-user':e.data.is_user},null,8,['mk','message-id','is-user'])]),_:1}),(0,E.createVNode)(aa,{data:e.data},null,8,['data']),(0,E.createVNode)(Ea,{'latest-data':e.data},null,8,['latest-data'])],64)):((0,E.openBlock)(),(0,E.createElementBlock)('div',Sa,'等待 era:writeDone 事件数据…'))])])]))}});o(544);const Ca=(0,kt.A)(Va,[['__scopeId','data-v-1e3782f8']]),Ma=(0,E.defineComponent)({__name:'FloatingBall',emits:['click'],setup(e){new O('ERA变量框架/ui/components/FloatingBall');return(0,E.onMounted)(()=>{}),(e,t)=>((0,E.openBlock)(),(0,E.createElementBlock)('div',{class:'floating-ball',onClick:t[0]||(t[0]=t=>e.$emit('click'))},[t[1]||(t[1]=(0,E.createElementVNode)('span',{class:'era-logo','aria-hidden':'true'},'ERA',-1)),(0,E.createCommentVNode)(' 仅显示用；不拦截事件 ')]))}});o(756);const Ia=(0,kt.A)(Ma,[['__scopeId','data-v-3bb5cc6c']]),$a={class:'about-era-card',role:'complementary','aria-label':'关于 ERA'},Da=(0,E.defineComponent)({__name:'AboutEra',setup:e=>(e,t)=>((0,E.openBlock)(),(0,E.createElementBlock)('section',$a,[...t[0]||(t[0]=[(0,E.createStaticVNode)('<h4 class="card-title" data-v-9b1026a6>关于 ERA</h4><div class="info-list" data-v-9b1026a6><ul data-v-9b1026a6><li data-v-9b1026a6><strong data-v-9b1026a6>ERA 项目地址:</strong><a href="https://github.com/RockingSisyphus/ERA-EfficientRollbackArchitecture/tree/master" target="_blank" rel="noopener noreferrer" data-v-9b1026a6> GitHub </a></li><li data-v-9b1026a6><strong data-v-9b1026a6>ERA 介绍帖:</strong><a href="https://discord.com/channels/1134557553011998840/1423319849400270928" target="_blank" rel="noopener noreferrer" data-v-9b1026a6> Discord </a></li><li data-v-9b1026a6><strong data-v-9b1026a6>作者:</strong> 世界的山田</li><li data-v-9b1026a6><strong data-v-9b1026a6>ERA 框架交流群:</strong> 1006127516</li></ul></div>',2)])]))});o(76);const Ta=(0,kt.A)(Da,[['__scopeId','data-v-9b1026a6']]),Ra=toastr;var Ba=o.n(Ra);const Oa=new O('ERA变量框架/utils/regex');async function ja(e){if(!isCharacterTavernRegexesEnabled()){const e='局部正则未启用，跳过注入。';return Oa.debug('ensureCharacterRegex',e),{success:!1,status:'skipped',reason:e}}if(getTavernRegexes({scope:'character'}).some(t=>t.script_name===e.script_name))return Oa.debug('ensureCharacterRegex',`名为 "${e.script_name}" 的正则已存在，无需注入。`),{success:!0,status:'exists'};try{return Oa.debug('ensureCharacterRegex',`未找到名为 "${e.script_name}" 的正则，正在注入...`),await updateTavernRegexesWith(t=>(t.push({...e,id:'',scope:'character'}),t),{scope:'character'}),Oa.debug('ensureCharacterRegex','正则注入成功。'),{success:!0,status:'injected'}}catch(t){const a=`注入名为 "${e.script_name}" 的正则时发生错误。`;return Oa.error('ensureCharacterRegex',a,t),{success:!1,status:'failed',reason:a}}}const Pa={script_name:'ERA 数据隐藏正则',enabled:!0,run_on_edit:!0,find_regex:String.raw`/<(variable(?:insert|edit|delete))>\s*(?=[\s\S]*?\S[\s\S]*?<\/\1>)((?:(?!<(?:era_data|variable(?:think|insert|edit|delete))>|<\/\1>)[\s\S])*?)\s*<\/\1>/gi`,replace_string:'',source:{user_input:!0,ai_output:!0,slash_command:!1,world_info:!1},destination:{display:!0,prompt:!0},min_depth:null,max_depth:null},La={script_name:'ERA 元数据隐藏正则',enabled:!0,run_on_edit:!0,find_regex:String.raw`/<era_data>\s*(?=[\s\S]*?\S[\s\S]*?<\/era_data>)((?:(?!<(?:era_data|variable(?:think|insert|edit|delete))>|<\/era_data>)[\s\S])*?)\s*<\/era_data>/gi`,replace_string:'',source:{user_input:!0,ai_output:!0,slash_command:!1,world_info:!1},destination:{display:!0,prompt:!0},min_depth:null,max_depth:null},Fa={script_name:'ERA 思考块隐藏正则',enabled:!0,run_on_edit:!0,find_regex:String.raw`/<variablethink>\s*(?=[\s\S]*?\S[\s\S]*?<\/variablethink>)((?:(?!<variablethink>)[\s\S])*?)\s*<\/variablethink>/gi`,replace_string:'',source:{user_input:!0,ai_output:!0,slash_command:!1,world_info:!1},destination:{display:!0,prompt:!0},min_depth:null,max_depth:null};const za={script_name:'ERA 状态栏模板',enabled:!0,run_on_edit:!0,find_regex:'/<StatusPlaceHolderImpl\\/>/gsi',replace_string:'```html\n<!doctype html>\n<html lang="zh-CN">\n  <head>\n    <meta charset="UTF-8" />\n    <meta name="viewport" content="width=device-width, initial-scale=1.0" />\n    <title>ERA 状态栏模板</title>\n    <style>\n      body {\n        font-family:\n          -apple-system, BlinkMacSystemFont, \'Segoe UI\', Roboto, \'Helvetica Neue\', Arial, \'Noto Sans\', sans-serif,\n          \'Apple Color Emoji\', \'Segoe UI Emoji\', \'Segoe UI Symbol\', \'Noto Color Emoji\';\n        margin: 0;\n        padding: 0;\n        background-color: transparent;\n      }\n      .era-statusbar {\n        color: #e0e0e0;\n        background: linear-gradient(145deg, #2c3e50, #34495e);\n        border-radius: 12px;\n        padding: 16px;\n        margin-top: 20px;\n        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);\n        border: 1px solid #4a6278;\n        overflow: hidden;\n      }\n      .era-statusbar-header {\n        display: flex;\n        align-items: center;\n        border-bottom: 1px solid #4a6278;\n        padding-bottom: 10px;\n        margin-bottom: 12px;\n      }\n      .era-statusbar-header h4 {\n        margin: 0;\n        font-size: 1.1em;\n        font-weight: 700;\n        color: #1abc9c;\n        text-shadow: 0 0 5px rgba(26, 188, 156, 0.5);\n      }\n      .era-statusbar-grid {\n        display: grid;\n        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));\n        gap: 10px;\n      }\n      .era-statusbar-item {\n        background-color: rgba(255, 255, 255, 0.05);\n        padding: 8px 12px;\n        border-radius: 8px;\n      }\n      .era-statusbar-item-label {\n        font-size: 0.85em;\n        color: #bdc3c7;\n        margin-bottom: 4px;\n      }\n      .era-statusbar-item-value {\n        font-size: 1em;\n        font-weight: 700;\n        color: #ecf0f1;\n      }\n      .era-instructions {\n        margin-top: 16px;\n        padding-top: 12px;\n        border-top: 1px solid #4a6278;\n        font-size: 0.9em;\n        line-height: 1.6;\n      }\n      .era-instructions a {\n        color: #3498db;\n        text-decoration: none;\n      }\n      .era-instructions a:hover {\n        text-decoration: underline;\n      }\n      .era-instructions .ai-note {\n        font-size: 0.8em;\n        color: #7f8c8d;\n      }\n    </style>\n  </head>\n  <body>\n    <div class="era-statusbar">\n      <div class="era-statusbar-header">\n        <h4>角色状态</h4>\n      </div>\n      <div class="era-statusbar-grid">\n        <div class="era-statusbar-item">\n          <div class="era-statusbar-item-label">姓名</div>\n          <div class="era-statusbar-item-value" id="player-name">--</div>\n        </div>\n        <div class="era-statusbar-item">\n          <div class="era-statusbar-item-label">等级</div>\n          <div class="era-statusbar-item-value" id="player-level">--</div>\n        </div>\n        <div class="era-statusbar-item">\n          <div class="era-statusbar-item-label">生命值</div>\n          <div class="era-statusbar-item-value" id="player-hp">-- / --</div>\n        </div>\n        <div class="era-statusbar-item">\n          <div class="era-statusbar-item-label">魔力值</div>\n          <div class="era-statusbar-item-value" id="player-mp">-- / --</div>\n        </div>\n      </div>\n\n      <div class="era-statusbar-header" style="margin-top: 16px">\n        <h4>附近NPC</h4>\n      </div>\n      <div id="npc-list" class="era-statusbar-grid">\n        <div class="era-statusbar-item-label" style="padding: 8px 12px">暂无NPC信息</div>\n      </div>\n\n      \x3c!-- \n      AI 你好！当角色卡作者让你修改此文件时，请在修改后删除下面的 "instructions-wrapper"整个 div 元素。\n    --\x3e\n      <div id="instructions-wrapper">\n        <div class="era-statusbar-header" style="margin-top: 16px">\n          <h4>给角色卡作者的说明</h4>\n        </div>\n        <div class="era-instructions">\n          <strong>你接下来需要做的：</strong><br />\n          1. 自己设计角色卡用到的变量结构，并使用 &amp;lt;VariableInsert&amp;gt 标签写入角色的开场白。<br />\n          2. 在角色主世界书的‘ERA变量意图说明’条目中，添加向 AI 说明各个变量意图的提示词。<br />\n          3. 修改本状态栏的 HTML 代码，使其与**你设计的变量系统匹配**。<br />\n          <br />\n          完成第一步和第二步请参考：<br />\n          <a\n            href="https://github.com/RockingSisyphus/ERA-EfficientRollbackArchitecture/blob/master/doc/%E4%BD%A0%E6%9C%80%E5%A5%BD%E8%87%AA%E5%B7%B1%E7%9C%8B%E4%B8%80%E9%81%8D%E7%9A%84era%E5%8D%A1%E5%AE%8C%E6%95%B4%E5%88%B6%E4%BD%9C%E6%96%87%E6%A1%A3%EF%BC%88%E5%8C%85%E5%90%AB%E5%8F%98%E9%87%8F%E5%88%9D%E5%A7%8B%E5%8C%96%E5%92%8C%E4%B8%96%E7%95%8C%E4%B9%A6%E6%8F%90%E7%A4%BA%E8%AF%8D%EF%BC%89/%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E5%92%8C%E8%AF%B4%E6%98%8E%E4%BD%A0%E7%9A%84%E5%8F%98%E9%87%8F%E7%B3%BB%E7%BB%9F.md"\n            target="_blank"\n            rel="noopener noreferrer"\n            >如何设计和说明你的变量系统</a\n          >\n          <br /><br />\n          推荐你进入‘ERA 状态栏模板’正则中，将‘替换为’的内容（也就是当前模板状态栏的html代码）全部复制发送给 AI (如\n          Cline, ChatGPT, Claude等)，让它帮你完成第 3 步。为了让 AI\n          更好地理解如何修改，请同时将以下链接中的文档内容一并提供给它：<br />\n          <a\n            href="https://github.com/RockingSisyphus/ERA-EfficientRollbackArchitecture/tree/master/doc/%E9%80%82%E5%90%88%E6%8F%90%E4%BE%9B%E7%BB%99ai%E7%9A%84%E7%8A%B6%E6%80%81%E6%A0%8Fhtml%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3%EF%BC%88%E5%8F%AA%E5%8C%85%E5%90%ABhtml%E7%8A%B6%E6%80%81%E6%A0%8F%E4%BB%A3%E7%A0%81%E4%B9%A6%E5%86%99%E9%83%A8%E5%88%86%EF%BC%89"\n            target="_blank"\n            rel="noopener noreferrer"\n            >ERA 状态栏开发文档</a\n          >\n          <br /><br />\n          <strong>关于 ERA 框架:</strong><br />\n          作者: 世界的山田<br />\n          ERA 框架交流群: 1006127516<br />\n          <a\n            href="https://github.com/RockingSisyphus/ERA-EfficientRollbackArchitecture/tree/master"\n            target="_blank"\n            rel="noopener noreferrer"\n            >ERA 项目地址</a\n          >\n          |\n          <a\n            href="https://discord.com/channels/1134557553011998840/1423319849400270928"\n            target="_blank"\n            rel="noopener noreferrer"\n            >Discord 发布帖</a\n          >\n        </div>\n      </div>\n    </div>\n\n    <script>\n      document.addEventListener(\'DOMContentLoaded\', () => {\n        const playerName = document.getElementById(\'player-name\');\n        const playerLevel = document.getElementById(\'player-level\');\n        const playerHp = document.getElementById(\'player-hp\');\n        const playerMp = document.getElementById(\'player-mp\');\n        const npcListContainer = document.getElementById(\'npc-list\');\n        let isInitialLoad = true;\n\n        function updateUI(stat) {\n          // 更新玩家信息\n          const pName = _.get(stat, \'player.name\');\n          if (pName !== undefined) playerName.textContent = pName;\n          else if (isInitialLoad) playerName.textContent = \'示例数据, 完成步骤1后显示\';\n\n          const pLevel = _.get(stat, \'player.level\');\n          if (pLevel !== undefined) playerLevel.textContent = pLevel;\n          else if (isInitialLoad) playerLevel.textContent = \'示例数据, 完成步骤1后显示\';\n\n          const pHp = _.get(stat, \'player.hp\');\n          const pMaxHp = _.get(stat, \'player.max_hp\');\n          if (pHp !== undefined && pMaxHp !== undefined) playerHp.textContent = `${pHp} / ${pMaxHp}`;\n          else if (isInitialLoad) playerHp.textContent = \'示例数据, 完成步骤1后显示\';\n\n          const pMp = _.get(stat, \'player.mp\');\n          const pMaxMp = _.get(stat, \'player.max_mp\');\n          if (pMp !== undefined && pMaxMp !== undefined) playerMp.textContent = `${pMp} / ${pMaxMp}`;\n          else if (isInitialLoad) playerMp.textContent = \'示例数据, 完成步骤1后显示\';\n\n          // 更新NPC列表\n          const npcs = _.get(stat, \'world_state.npcs\', {});\n          npcListContainer.innerHTML = \'\'; // 清空旧列表\n          if (_.isEmpty(npcs)) {\n            if (isInitialLoad)\n              npcListContainer.innerHTML =\n                \'<div class="era-statusbar-item-label" style="padding: 8px 12px;">示例数据, 完成步骤1后显示</div>\';\n            else\n              npcListContainer.innerHTML =\n                \'<div class="era-statusbar-item-label" style="padding: 8px 12px;">暂无NPC信息</div>\';\n          } else {\n            for (const npcId in npcs) {\n              const npc = npcs[npcId];\n              const npcElement = document.createElement(\'div\');\n              npcElement.className = \'era-statusbar-item\';\n              npcElement.innerHTML = `\n                    <div class="era-statusbar-item-label">${npc.name || \'未知NPC\'}</div>\n                    <div class="era-statusbar-item-value">心情: ${npc.mood || \'平常\'}</div>\n                `;\n              npcListContainer.appendChild(npcElement);\n            }\n          }\n\n          isInitialLoad = false;\n        }\n\n        eventOn(\'era:writeDone\', detail => {\n          if (detail && detail.statWithoutMeta) {\n            updateUI(detail.statWithoutMeta);\n          }\n        });\n\n        eventEmit(\'era:requestWriteDone\');\n      });\n    <\/script>\n\n    \x3c!-- \n    ================================================================\n    给 AI 的参考代码 (默认注释)\n    \n    AI 你好！当角色卡作者让你修改此文件时，请参考下面的注释代码。\n    \n    ### 宏模式 (简单)\n    - **用法**: 直接在 HTML 中写入 `{{ERA:路径.到.变量}}` 宏。\n    - **优点**: 非常简单，无需编写任何 JavaScript。\n    - **缺点**: 需要在 ERA 设置中开启“强制重载状态栏”，每次变量更新都会导致整个状态栏闪烁刷新。\n    - **建议**: 你作为ai，最好提醒一下角色卡作者使用era的api，监听writeDone事件是更优雅更稳健的解决方案。\n    - **示例**: `<div class="era-statusbar-item-value">{{ERA:player.hp}} / {{ERA:player.max_hp}}</div>`\n\n    ---\n\n    ### API 模式 (进阶，推荐)\n    - **用法**: 使用 JavaScript 监听和发送 ERA 框架的事件，来动态地读写变量。\n    - **优点**: 更新平滑无闪烁，性能更好，可以实现复杂的前端交互。\n\n    #### 核心事件与数据结构\n    \n    **1. `era:writeDone` 事件**: 这是响应数据变化的**唯一推荐方式**。当任何变量发生改变后，ERA 都会广播此事件，其回调函数会接收一个包含详细信息的 `detail` 对象。\n    \n    **`writeDone` 事件的 `detail` 对象 (`WriteDonePayload`) 结构如下:**\n    ```typescript\n    {\n      mk: string; // 本次更新的消息密钥\n      message_id: number; // 本次更新的消息 ID\n      actions: {\n        rollback: boolean; // 是否执行了回滚\n        apply: boolean;    // 是否应用了来自AI输出的变量变更\n        resync: boolean;   // 是否因历史记录变化而执行了再同步\n        api: boolean;      // 是否由API直接调用触发\n        apiWrite: boolean; // 是否由API写入操作(如update/insert)触发\n      };\n      selectedMks: (string | null)[]; // 当前聊天的主干消息密钥链\n      editLogs: { [key: string]: any[] }; // 完整的编辑日志\n      stat: any; // 包含 $meta 字段的完整变量状态\n      statWithoutMeta: any; // 不含 $meta 的纯净变量状态 (推荐使用)\n      consecutiveProcessingCount: number; // 对当前消息的连续处理次数\n    }\n    ```\n\n    **2. 核心读取事件**:\n    - **`eventOn(\'era:writeDone\', callback)`**: 监听变量写入完成。\n      `eventOn(\'era:writeDone\', (detail) => { console.log(detail.statWithoutMeta); });`\n    - **`eventEmit(\'era:requestWriteDone\')`**: 主动请求一次最新变量，ERA 会以一个 `era:writeDone` 事件来响应。\n\n    **3. 核心写入事件 (通过 `eventEmit` 发送)**:\n    - **注意**: 所有写入事件最终都会触发一次 `era:writeDone`。为避免无限循环（例如：API写入 -> `writeDone` -> API写入），你可以在 `writeDone` 的监听器中检查 `detail.actions.apiWrite` 字段。\n      `eventOn(\'era:writeDone\', (detail) => { if (detail.actions.apiWrite) return; /* 避免响应由API自身触发的更新 */ });`\n    \n    - **`era:insertByObject`**: 非破坏性地插入一个或多个变量。\n      `eventEmit(\'era:insertByObject\', { player: { score: 0 } });`\n    - **`era:updateByObject`**: 修改一个或多个已存在的变量。\n      `eventEmit(\'era:updateByObject\', { player: { level: 2 } });`\n    - **`era:insertByPath`**: 在指定路径插入一个新变量。\n      `eventEmit(\'era:insertByPath\', { path: \'inventory.item_002\', value: { name: \'新物品\' } });`\n    - **`era:updateByPath`**: 修改指定路径的变量，支持数学运算。\n      `eventEmit(\'era:updateByPath\', { path: \'player.hp\', value: \'-=10\' });`\n    - **`era:deleteByPath`**: 删除指定路径的变量。\n      `eventEmit(\'era:deleteByPath\', { path: \'inventory.item_001\' });`\n    ================================================================\n  --\x3e</body>\n</html>\n\n```',source:{user_input:!1,ai_output:!0,slash_command:!1,world_info:!1},destination:{display:!0,prompt:!1},min_depth:null,max_depth:null},Wa=new O('ERA变量框架/initer/manual/regex');const Ja=new O('ERA变量框架/utils/worldbook');async function Ua(e,t){const a='injectEntryToWorldbook';if(!t.name){const e='注入失败：新条目必须包含 name 字段。';return Ja.error(a,e),{success:!1,status:'failed',reason:e}}const n=await async function(e,t){const a='isEntryInWorldbook';try{Ja.debug(a,`正在检查世界书「${e}」中是否存在条目「${t}」...`);const n=(await getWorldbook(e)).some(e=>e.name===t);return Ja.debug(a,`检查完成，世界书「${e}」中${n?'存在':'不存在'}条目「${t}」。`),n}catch(t){return Ja.error(a,`获取世界书「${e}」时发生错误。`,t),!1}}(e,t.name);if(n)return Ja.debug(a,`条目「${t.name}」已存在于世界书「${e}」中，无需注入。`),{success:!0,status:'exists'};try{return Ja.debug(a,`正在向世界书「${e}」注入新条目「${t.name}」...`),await createWorldbookEntries(e,[t]),Ja.debug(a,`成功向世界书「${e}」注入新条目「${t.name}」。`),{success:!0,status:'injected'}}catch(n){const r=`向世界书「${e}」注入条目「${t.name}」时发生错误。`;return Ja.error(a,r,n),{success:!1,status:'failed',reason:r}}}const Ka={name:'ERA 变量操作规则',content:'<variable_rule>\n# ERA 变量操作规则\n\n- **无变化则不操作**: 当变量信息与故事发展相比没有变化时，禁止生成任何指令块。\n- **新增则 `Insert`**: 当出现全新的角色、物品、状态或信息时，必须使用 `<VariableInsert>`。\n- **修改则 `Update`**: 当已有的数据需要更新其值时（如等级提升、状态改变），必须使用 `<VariableEdit>`。\n- **移除则 `Delete`**: 当数据被明确地消耗、移除或销毁时，必须使用 `<VariableDelete>`。\n\n## 指令核心规则\n- **`<VariableInsert>`**:\n    - **只增不改**: 用于添加新数据，它绝不会覆盖任何已经存在的数据。\n- **`<VariableEdit>`**:\n    - **只改不增**: 用于修改已存在的数据，它绝不会在不存在的路径上创建新数据。\n- **`<VariableDelete>`**:\n    - **删除节点**: 在指令中，使用一个 **空对象 `{}`** 作为值，表示要删除该键对应的整个节点。\n\n</variable_rule>\n\n<format_request>\n你必须根据有关要求及变量现有状态，补完 `<VariableThink>` 及 `<VariableInsert>`、`<VariableEdit>`、`<VariableDelete>` 等指令块。\n\n**严格遵守以下流程**:\n\n1.  **输出正文**:\n    -   首先，生成本次回复的正文内容。\n\n2.  **输出思考与指令**:\n    -   在正文内容之后，必须立即输出 `<VariableThink>` 块，并在其中进行思考。\n    -   在 `<VariableThink>` 块之后，必须立即输出一个或多个指令块 (`<VariableInsert>`、`<VariableEdit>`、`<VariableDelete>`)。\n\n3.  **格式要求**:\n    -   所有指令块的内容都必须是 **严格合法** 的 JSON 格式。\n    -   所有 JSON 的键（key）都必须使用双引号 `"`。\n    -   严格遵循 `<variable_rule>` 中定义的所有规则。\n\n# ** 回复内容必须仿照格式示例，以该格式回复；必须包含意图分析、变量变更分析和操作计划，以及操作计划计划生成的完整`<VariableInsert>`或`<VariableEdit>`的标签代码块来实现对ERA变量的维护 **\n\n即，必须保证最终输出格式为：\n  {其他内容（如正文）和格式}\n\n  <VariableThink>\n    1.  **意图分析**: {变量更新意图}\n    2.  **操作计划**:\n      - {操作意图}\n  </VariableThink>\n  <VariableInsert>\n  {Insert的JSON格式变量,严格遵守变量路径}\n  </VariableInsert>\n  <VariableEdit>\n  {Edit的JSON格式变量,严格遵守变量路径}\n  </VariableEdit>\n\n### 格式示例\n  {其他内容（如正文）和格式...}\n\n  <VariableThink>\n  1.  **意图分析**: 故事中出现了一个新角色 "Elara"，需要将其添加到 `characters` 对象中。同时，主角 "player" 的 `hp` 从 15 减少到了 10。\n  2.  **操作计划**:\n      -   生成一个 `<VariableInsert>` 块来添加新角色 "Elara"。\n      -   生成一个 `<VariableEdit>` 块来更新 "player" 的 `hp`。\n  </VariableThink>\n  <VariableInsert>\n  {\n    "characters": {\n      "Elara": {\n        "class": "Archer"\n      }\n    }\n  }\n  </VariableInsert>\n  <VariableEdit>\n  {\n    "characters": {\n      "player": {\n        "hp": 10\n      }\n    }\n  }\n  </VariableEdit>\n</format_request>\n',enabled:!0,strategy:{type:'constant',keys:[],keys_secondary:{logic:'and_any',keys:[]},scan_depth:'same_as_global'},position:{type:'at_depth',role:'system',depth:0,order:9999},probability:100,recursion:{prevent_incoming:!1,prevent_outgoing:!1,delay_until:null},effect:{sticky:null,cooldown:null,delay:null}},Ga={name:'ERA 变量意图说明',content:'{{//请在这里补充对你设计的变量系统的说明，以便ai理解你的意图并正确的更新变量}}\n',enabled:!0,strategy:{type:'constant',keys:[],keys_secondary:{logic:'and_any',keys:[]},scan_depth:'same_as_global'},position:{type:'at_depth',role:'system',depth:0,order:9998},probability:100,recursion:{prevent_incoming:!1,prevent_outgoing:!1,delay_until:null},effect:{sticky:null,cooldown:null,delay:null}},Ya=new O('ERA变量框架/initer/manual/worldbook');async function Ha(){const e='initEraWorldbookEntries';Ya.log(e,'开始世界书初始化...');let t=(await getCharWorldbookNames('current')).primary;if(t)Ya.debug(e,`找到主世界书: 「${t}」`);else{Ya.warn(e,'当前角色卡未绑定主世界书，将创建并绑定一个新的世界书。');try{t=await async function(){const e='createAndBindPrimaryWorldbook',t='ERA卡示例世界书';Ja.debug(e,`正在创建新的世界书「${t}」...`),await createWorldbook(t);const a=await getCharWorldbookNames('current');return a.primary=t,Ja.debug(e,`正在将新世界书「${t}」绑定为当前角色卡的主世界书...`),await rebindCharWorldbooks('current',a),Ja.debug(e,'创建并绑定成功。'),t}()}catch(t){const a='创建并绑定主世界书失败。';return Ya.error(e,a,t),{success:!1,reason:a,details:[]}}}const a=[Ka,Ga],n=[];let r=!0;for(const s of a){if(!s.name){Ya.warn(e,'发现一个没有名称的世界书条目，已跳过。',s);continue}const a=await Ua(t,s);n.push({entryName:s.name,status:a.status,reason:a.reason}),a.success||(r=!1)}return Ya.log(e,'世界书初始化完成。'),{success:r,details:n}}const qa={class:'action-buttons-card',role:'complementary','aria-label':'ERA 快捷操作'},Qa={class:'btns'},Xa={class:'btn-group'},Za={class:'btn-group'},en={class:'btn-group'},tn={class:'input-btn-combo'},an={class:'btn-group'},nn=(0,E.defineComponent)({__name:'ActionButtons',setup(e){const t=new O('ERA变量框架/ui/components/RightRailContent/ActionButtons'),a=(0,E.ref)(null);async function n(){t.log('onInjectRegex','点击“ERA 快速初始化”，开始注入...');try{try{const e=getChatMessages(0);if(!e||0===e.length)throw new Error('No messages found')}catch(e){return Ba().error('然后再次点击快速初始化','请在角色卡的开场白中添加任意内容。'),void t.warn('onInjectRegex','获取第 0 条消息失败，可能是因为聊天记录为空。',e)}const e=await async function(){if(!isCharacterTavernRegexesEnabled()){const e='当前角色卡未开启局部正则，请先在角色卡设置中启用。';return Wa.warn('initEraCharacterRegexes',e),{success:!1,reason:e,details:[]}}const e=[Pa,za,La,Fa],t=[];let a=!0;for(const n of e){const e=await ja(n);t.push({regexName:n.script_name,status:e.status,reason:e.reason}),e.success||(a=!1)}return{success:a,details:t}}();if(!e.success)return Ba().error(e.reason??'未知错误','正则初始化失败'),void t.error('onInjectRegex','正则注入失败:',e.reason);{const t=e.details.filter(e=>'injected'===e.status).length,a=e.details.filter(e=>'exists'===e.status).length;let n='';t>0&&(n+=`成功注入 ${t} 个新正则。`),a>0&&(n+=` ${a} 个正则已存在。`),n&&Ba().success(n.trim(),'正则初始化完成')}const a=await Ha();if(a.success){const e=a.details.filter(e=>'injected'===e.status).length,t=a.details.filter(e=>'exists'===e.status).length;let n='';e>0&&(n+=`成功注入 ${e} 个新条目。`),t>0&&(n+=` ${t} 个条目已存在。`),Ba().success(n.trim(),'世界书初始化完成')}else Ba().error(a.reason??'一个或多个世界书条目注入失败。','世界书初始化失败'),t.error('onInjectRegex','世界书注入失败:',a);t.log('onInjectRegex','初始化流程完成。')}catch(e){t.error('onInjectRegex','执行初始化时发生意外错误:',e),Ba().error('发生意外错误，请检查控制台获取详细信息。','初始化失败')}}function r(){t.log('onFullSync','点击“完全重算变量”，发送 era:forceSync 事件 (mode: full)。');try{eventEmit('era:forceSync',{mode:'full'}),Ba().success('已发送“完全重算变量”请求。','操作成功')}catch(e){t.error('onFullSync','发送 era:forceSync 事件时出错:',e),Ba().error('发送请求失败，请检查控制台。','操作失败')}}function s(){t.log('onLastSync','点击“重算最后一楼变量”，发送 era:forceSync 事件 (mode: latest)。');try{eventEmit('era:forceSync',{mode:'latest'}),Ba().success('已发送“重算最后一楼变量”请求。','操作成功')}catch(e){t.error('onLastSync','发送 era:forceSync 事件时出错:',e),Ba().error('发送请求失败，请检查控制台。','操作失败')}}function o(){if(null===a.value||a.value<0)Ba().warning('请输入一个有效的、非负的消息 ID。','输入无效');else{t.log('onRollbackTo',`点击“回滚到”，发送 era:forceSync 事件 (mode: rollbackTo, message_id: ${a.value})。`);try{eventEmit('era:forceSync',{mode:'rollbackTo',message_id:a.value}),Ba().success(`已发送回滚到消息 #${a.value} 的请求。`,'操作成功')}catch(e){t.error('onRollbackTo','发送 era:forceSync 事件时出错:',e),Ba().error('发送请求失败，请检查控制台。','操作失败')}}}return(e,t)=>((0,E.openBlock)(),(0,E.createElementBlock)(E.Fragment,null,[(0,E.createCommentVNode)(' 右侧操作卡：外层自包含，不依赖父组件样式 '),(0,E.createElementVNode)('section',qa,[(0,E.createCommentVNode)(' 中文注释：操作卡容器 '),t[11]||(t[11]=(0,E.createElementVNode)('h4',{class:'card-title'},'快捷操作',-1)),(0,E.createCommentVNode)(' 中文注释：卡片标题 '),(0,E.createElementVNode)('div',Qa,[(0,E.createCommentVNode)(' 中文注释：按钮垂直栈 '),(0,E.createElementVNode)('div',Xa,[(0,E.createElementVNode)('button',{class:'btn primary',title:'重新计算所有变量',onClick:(0,E.withModifiers)(r,['stop'])},[(0,E.createCommentVNode)(' 中文注释：主按钮 '),t[1]||(t[1]=(0,E.createElementVNode)('span',{class:'ico','aria-hidden':'true'},'🔄',-1)),(0,E.createCommentVNode)(' 中文注释：图标 '),t[2]||(t[2]=(0,E.createElementVNode)('span',{class:'label'},'完全重算变量',-1)),(0,E.createCommentVNode)(' 中文注释：文字 ')]),t[3]||(t[3]=(0,E.createElementVNode)('p',{class:'btn-desc'},' 当变量与预期不符时，点击此按钮可从**第一条消息**开始重新计算所有消息，以确保数据完全同步。这是一个非常耗时的操作。 ',-1))]),(0,E.createElementVNode)('div',Za,[(0,E.createElementVNode)('button',{class:'btn subtle',title:'只重算最新一楼的变量',onClick:(0,E.withModifiers)(s,['stop'])},[(0,E.createCommentVNode)(' 中文注释：次按钮 '),t[4]||(t[4]=(0,E.createElementVNode)('span',{class:'ico','aria-hidden':'true'},'♻️',-1)),(0,E.createCommentVNode)(' 中文注释：图标 '),t[5]||(t[5]=(0,E.createElementVNode)('span',{class:'label'},'重算最后一楼变量',-1)),(0,E.createCommentVNode)(' 中文注释：文字 ')]),t[6]||(t[6]=(0,E.createElementVNode)('p',{class:'btn-desc'},' 仅根据最新一条消息重新计算变量，速度较快。适用于修复最近一次操作导致的小问题或在手动编辑了最后一条消息后重新写入变量（注意，era会无视所有**用户发送的消息**中的变量更新语句）。 ',-1))]),(0,E.createCommentVNode)(' 新增：时间旅行/回滚功能 '),(0,E.createElementVNode)('div',en,[(0,E.createElementVNode)('div',tn,[(0,E.withDirectives)((0,E.createElementVNode)('input',{'onUpdate:modelValue':t[0]||(t[0]=e=>a.value=e),type:'number',class:'input-field',placeholder:'消息 ID','aria-label':'要回滚到的消息 ID'},null,512),[[E.vModelText,a.value,void 0,{number:!0}]]),(0,E.createElementVNode)('button',{class:'btn subtle combo-btn',title:'将变量状态回滚到指定消息',onClick:(0,E.withModifiers)(o,['stop'])},[...t[7]||(t[7]=[(0,E.createElementVNode)('span',{class:'ico','aria-hidden':'true'},'⏳',-1),(0,E.createElementVNode)('span',{class:'label'},'回滚到',-1)])])]),t[8]||(t[8]=(0,E.createElementVNode)('p',{class:'btn-desc'},'输入一个消息 ID，点击按钮可将变量状态“时间旅行”回该消息处理完毕后的那一刻。',-1))]),(0,E.createElementVNode)('div',an,[(0,E.createElementVNode)('button',{class:'btn danger',title:'为角色卡注入 ERA 规则',onClick:(0,E.withModifiers)(n,['stop'])},[...t[9]||(t[9]=[(0,E.createElementVNode)('span',{class:'ico','aria-hidden':'true'},'🥽',-1),(0,E.createElementVNode)('span',{class:'label'},'ERA 快速初始化',-1)])]),t[10]||(t[10]=(0,E.createElementVNode)('p',{class:'btn-desc'},[(0,E.createTextVNode)(' 【角色卡作者专用】点击后，会向当前角色卡注入四条规则：'),(0,E.createElementVNode)('br'),(0,E.createTextVNode)(' 1. 添加“ERA 数据隐藏正则”以隐藏聊天中的数据标签。'),(0,E.createElementVNode)('br'),(0,E.createTextVNode)(' 2. 添加“ERA状态栏模板”以将模板状态栏替换至消息。'),(0,E.createElementVNode)('br'),(0,E.createTextVNode)(' 3. 向角色主世界书中添加“ERA变量操作规则”条目以令ai明白era变量的操作规则。'),(0,E.createElementVNode)('br'),(0,E.createTextVNode)(' 4. 向角色主世界书中添加“ERA变量意图说明”条目以存放变量意图说明。'),(0,E.createElementVNode)('br'),(0,E.createTextVNode)(' 注意：作者可以用该功能快速注入使用era的几个基础配置。但你仍旧需要：'),(0,E.createElementVNode)('br'),(0,E.createTextVNode)(' 1. 自己设计角色卡用到的变量结构并写入角色的开场白。'),(0,E.createElementVNode)('br'),(0,E.createTextVNode)(' 2. 在角色主世界书中‘ERA变量意图说明’条目中添加向ai说明各个变量的意图的提示词。'),(0,E.createElementVNode)('br'),(0,E.createTextVNode)(' 3. 修改‘ERA状态栏模板’正则中的状态栏代码，令其与**你设计的变量系统匹配**。 ')],-1))])])])],2112))}});o(583);const rn=(0,kt.A)(nn,[['__scopeId','data-v-6bdeb56f']]),sn={class:'settings-card',role:'region','aria-label':'ERA 设置'},on=['aria-expanded'],ln={class:'chev','aria-hidden':'true'},cn={class:'content'},dn={class:'toolbar'},un={class:'vars'},pn=['title'],gn={class:'var-editor'},bn={key:0,class:'switch'},mn=['onUpdate:modelValue'],fn=['onUpdate:modelValue','placeholder'],hn=['onUpdate:modelValue','placeholder'],vn=['onUpdate:modelValue','placeholder','onInput'],yn={class:'type-chip'},xn=(0,E.defineComponent)({__name:'EraSettingsPanel',setup(e){const t=new O('ERA变量框架/ui/components/RightRailContent/EraSettingsPanel'),a=(0,E.ref)(!1),n=(0,E.ref)([]),r=(0,E.reactive)({}),s=(0,E.reactive)({}),o=(0,E.reactive)({});function i(e){try{return JSON.stringify(e,null,2)}catch{return String(e)}}function l(){try{t.debug('loadVars','尝试读取脚本设置...');const e=N.value;if(t.debug('loadVars','成功读取脚本设置:',e),!e||0===Object.keys(e).length)return t.warn('loadVars','设置对象为空，UI 将不会被填充。'),n.value=[],void Ba().info('未找到任何脚本变量。');n.value=[];for(const e of Object.keys(r))delete r[e];for(const e of Object.keys(s))delete s[e];for(const e of Object.keys(o))delete o[e];Object.entries(e).filter(([e])=>'开启悬浮球'!==e).forEach(([e,t])=>{const a='boolean'==typeof(o=t)?'boolean':'number'==typeof o&&Number.isFinite(o)?'number':'string'==typeof o?'string':'json';var o;n.value.push({key:e,value:t,type:a}),'json'===a?s[e]=i(t):r[e]=t}),Ba().success('已从脚本变量中加载最新设置。','读取成功')}catch(e){t.error('loadVars','读取脚本变量失败:',e),Ba().error('读取 ERA 设置失败，请检查浏览器控制台。','读取失败')}}function c(){a.value=!a.value,a.value&&0===n.value.length&&l()}function d(){t.log('discardEdits','点击“丢弃修改”'),l(),Ba().info('所有未保存的修改已被丢弃。','操作完成')}async function u(){const e=JSON.parse(JSON.stringify(n.value));try{const e={};n.value.forEach(t=>{if('json'===t.type){if(o[t.key]?.bad)throw new Error(`键 ${t.key} 的 JSON 格式不正确`);if(null!=s[t.key]){const a=JSON.parse(s[t.key]);t.value=a,e[t.key]=a}}else void 0!==r[t.key]&&(t.value=r[t.key],e[t.key]=r[t.key])}),Ba().success('界面已更新。正在后台保存...','操作成功'),await C(e=>{const t={...e};return Object.entries(r).forEach(([e,a])=>{t[e]=a}),Object.entries(s).forEach(([e,a])=>{if(null!=a){if(o[e]?.bad)throw new Error(`键 ${e} 的 JSON 格式不正确`);t[e]=JSON.parse(a)}}),t}),t.log('saveEdits','脚本变量已保存'),Ba().success('设置已成功保存到脚本变量。','保存成功'),window.dispatchEvent(new CustomEvent('era-settings-updated'))}catch(a){t.error('saveEdits','保存失败：',a),Ba().error(`保存失败：${a?.message??a}。正在回滚界面。`,'保存失败'),n.value=e,e.forEach(e=>{'json'===e.type?s[e.key]=i(e.value):r[e.key]=e.value})}}return(e,t)=>((0,E.openBlock)(),(0,E.createElementBlock)(E.Fragment,null,[(0,E.createCommentVNode)(' 外层卡片：与 ActionButtons 保持一致的玻璃卡风格，但默认收起 '),(0,E.createElementVNode)('section',sn,[(0,E.createCommentVNode)(' 设置卡片容器 '),(0,E.createCommentVNode)(' 标题行：可点击折叠/展开 '),(0,E.createElementVNode)('button',{class:'card-header','aria-expanded':a.value,onClick:c},[(0,E.createCommentVNode)(' 点击切换展开状态 '),t[0]||(t[0]=(0,E.createElementVNode)('span',{class:'title'},'ERA 设置',-1)),(0,E.createCommentVNode)(' 标题文字 '),(0,E.createElementVNode)('span',ln,(0,E.toDisplayString)(a.value?'▾':'▸'),1),(0,E.createCommentVNode)(' 展开箭头 ')],8,on),(0,E.createCommentVNode)(' 内容体：默认收起；展开后显示变量列表与操作 '),(0,E.withDirectives)((0,E.createElementVNode)('div',cn,[(0,E.createCommentVNode)(' 展开内容容器 '),(0,E.createCommentVNode)(' 顶部操作区：刷新/保存/重置编辑 '),(0,E.createElementVNode)('div',dn,[(0,E.createCommentVNode)(' 工具条 '),(0,E.createElementVNode)('button',{class:'mini-btn',title:'重新读取脚本变量',onClick:(0,E.withModifiers)(l,['stop'])},'🔄 重新读取'),(0,E.createCommentVNode)(' 读取按钮 '),t[1]||(t[1]=(0,E.createElementVNode)('div',{class:'spacer'},null,-1)),(0,E.createCommentVNode)(' 占位撑开 '),(0,E.createElementVNode)('button',{class:'mini-btn subtle',title:'丢弃未保存的修改',onClick:(0,E.withModifiers)(d,['stop'])},'↩︎ 丢弃修改'),(0,E.createCommentVNode)(' 丢弃编辑 '),(0,E.createElementVNode)('button',{class:'mini-btn primary',title:'保存修改到脚本变量',onClick:(0,E.withModifiers)(u,['stop'])},'💾 保存修改'),(0,E.createCommentVNode)(' 保存修改 ')]),(0,E.createCommentVNode)(' 变量列表：逐项渲染 '),(0,E.createElementVNode)('div',un,[n.value.length>0?((0,E.openBlock)(),(0,E.createElementBlock)(E.Fragment,{key:0},[(0,E.createCommentVNode)(' 有变量时渲染列表 '),((0,E.openBlock)(!0),(0,E.createElementBlock)(E.Fragment,null,(0,E.renderList)(n.value,e=>{return(0,E.openBlock)(),(0,E.createElementBlock)('div',{key:e.key,class:'var-row'},[(0,E.createCommentVNode)(' 每个变量一行 '),(0,E.createElementVNode)('label',{class:'var-key',title:e.key},(0,E.toDisplayString)(e.key),9,pn),(0,E.createCommentVNode)(' 变量名 '),(0,E.createCommentVNode)(' 根据变量类型选择不同的编辑控件 '),(0,E.createElementVNode)('div',gn,[(0,E.createCommentVNode)(' 编辑器容器 '),(0,E.createCommentVNode)(' 布尔：勾选框 '),'boolean'===e.type?((0,E.openBlock)(),(0,E.createElementBlock)('label',bn,[(0,E.createCommentVNode)(' 自定义开关外观 '),(0,E.withDirectives)((0,E.createElementVNode)('input',{'onUpdate:modelValue':t=>r[e.key]=t,type:'checkbox'},null,8,mn),[[E.vModelCheckbox,r[e.key]]]),(0,E.createCommentVNode)(' 勾选值 '),t[2]||(t[2]=(0,E.createElementVNode)('span',{class:'track'},null,-1)),(0,E.createCommentVNode)(' 轨道 ')])):'number'===e.type?((0,E.openBlock)(),(0,E.createElementBlock)(E.Fragment,{key:1},[(0,E.createCommentVNode)(' 数字：number 输入 '),(0,E.withDirectives)((0,E.createElementVNode)('input',{'onUpdate:modelValue':t=>r[e.key]=t,type:'number',class:'ipt',placeholder:String(e.value)},null,8,fn),[[E.vModelText,r[e.key],void 0,{number:!0}]]),(0,E.createCommentVNode)(' 数字输入 ')],64)):'string'===e.type?((0,E.openBlock)(),(0,E.createElementBlock)(E.Fragment,{key:2},[(0,E.createCommentVNode)(' 字符串：text 输入 '),(0,E.withDirectives)((0,E.createElementVNode)('input',{'onUpdate:modelValue':t=>r[e.key]=t,type:'text',class:'ipt',placeholder:String(e.value)},null,8,hn),[[E.vModelText,r[e.key]]]),(0,E.createCommentVNode)(' 文本输入 ')],64)):((0,E.openBlock)(),(0,E.createElementBlock)(E.Fragment,{key:3},[(0,E.createCommentVNode)(' 其他（对象/数组/null/未知）：JSON 文本域 '),(0,E.withDirectives)((0,E.createElementVNode)('textarea',{'onUpdate:modelValue':t=>s[e.key]=t,class:'ipt ta',placeholder:i(e.value),onInput:t=>function(e){const t=s[e]??'';if(''!==t.trim())try{JSON.parse(t),o[e]={ok:!0,bad:!1,msg:'JSON 格式有效'}}catch(t){o[e]={bad:!0,ok:!1,msg:`JSON 格式错误：${t?.message??''}`}}else o[e]={bad:!0,ok:!1,msg:'不能为空（若要设为 null 请写 null）'}}(e.key)},null,40,vn),[[E.vModelText,s[e.key]]]),(0,E.createCommentVNode)(' JSON 文本域 '),(0,E.createElementVNode)('span',{class:(0,E.normalizeClass)(['hint',{ok:o[e.key]?.ok,bad:o[e.key]?.bad}])},(0,E.toDisplayString)(o[e.key]?.msg??'以 JSON 格式编辑此值'),3),(0,E.createCommentVNode)(' JSON 校验提示 ')],64))]),(0,E.createCommentVNode)(' 类型徽标 '),(0,E.createElementVNode)('span',yn,(0,E.toDisplayString)((a=e.type,'boolean'===a?'布尔':'number'===a?'数字':'string'===a?'字符串':'JSON')),1),(0,E.createCommentVNode)(' 类型展示 ')]);var a}),128))],64)):((0,E.openBlock)(),(0,E.createElementBlock)(E.Fragment,{key:1},[(0,E.createCommentVNode)(' 没有变量时的占位 '),t[3]||(t[3]=(0,E.createElementVNode)('div',{class:'placeholder'},[(0,E.createElementVNode)('p',null,'未读取到任何脚本变量。'),(0,E.createCommentVNode)(' 文本提示 '),(0,E.createElementVNode)('p',{class:'dim'},[(0,E.createTextVNode)(' 请先确保在 '),(0,E.createElementVNode)('code',null,'app_ready'),(0,E.createTextVNode)(' 或初始化阶段通过 '),(0,E.createElementVNode)('code',null,'initializeExternalSettings()'),(0,E.createTextVNode)(' 写入默认变量。 ')]),(0,E.createCommentVNode)(' 辅助说明 ')],-1))],64))])],512),[[E.vShow,a.value]])])],2112))}});o(471);const wn=(0,kt.A)(xn,[['__scopeId','data-v-e1f9e9e0']]),En={class:'right-rail'},kn={class:'right-rail-content-wrapper'},_n=(0,E.defineComponent)({__name:'RightRail',setup:e=>(e,t)=>((0,E.openBlock)(),(0,E.createElementBlock)('aside',En,[(0,E.createElementVNode)('div',kn,[(0,E.createVNode)(rn),(0,E.createVNode)(wn),(0,E.createVNode)(Ta)])]))});o(682);const Nn=(0,kt.A)(_n,[['__scopeId','data-v-61d00544']]),An=(0,E.defineComponent)({__name:'ThemeManager',setup:(e,{expose:t})=>(t({isDarkMode:(0,E.ref)(!1)}),()=>{})});o(446);const Sn=An,Vn=a('ui',()=>{const e=(0,E.ref)('FloatingBall'),t=(0,E.ref)(null);return{currentView:e,eventData:t,switchView:function(t){e.value!==t&&(e.value=t)},setEventData:function(e){t.value=e}}}),Cn={class:'era-expanded-layer'},Mn={class:'era-shell'},In=(0,E.defineComponent)({__name:'App',setup(e){const t=new O('ERA变量框架/ui/App'),a=Vn(),{currentView:r,eventData:s}=n(a),o=(0,E.ref)(null),i=(0,E.ref)(!1),l=()=>{try{const e=N.value?.['开启黑夜模式']??!1;i.value=e,o.value&&(o.value.isDarkMode=e),t.debug('loadThemeSetting','主题已更新为: '+(e?'Dark':'Light'))}catch(e){t.error('loadThemeSetting','加载主题设置失败',e),i.value=!1}};(0,E.onMounted)(()=>{l(),window.addEventListener('era-settings-updated',l)}),(0,E.onBeforeUnmount)(()=>{window.removeEventListener('era-settings-updated',l)});return(e,n)=>((0,E.openBlock)(),(0,E.createElementBlock)('div',{class:(0,E.normalizeClass)(['era-app-container',{'dark-theme':i.value}])},[(0,E.createVNode)(Sn,{ref_key:'themeManager',ref:o},null,512),(0,E.withDirectives)((0,E.createVNode)(Ia,{onClick:n[0]||(n[0]=e=>{return n='ExpandedView',t.debug('requestSwitchView',`请求切换视图到: ${n}`),void a.switchView(n);var n})},null,512),[[E.vShow,'FloatingBall'===(0,E.unref)(r)]]),(0,E.withDirectives)((0,E.createElementVNode)('div',Cn,[(0,E.createCommentVNode)(' 视口级展开层：悬浮模态容器 '),(0,E.createElementVNode)('div',Mn,[(0,E.createCommentVNode)(' 新增横向壳容器：左面板 + 右侧栏 '),(0,E.createVNode)(Ca,{data:(0,E.unref)(s)},null,8,['data']),(0,E.createVNode)(Nn)])],512),[[E.vShow,'ExpandedView'===(0,E.unref)(r)]])],2))}});o(23),o(949);const $n=(0,kt.A)(In,[['__scopeId','data-v-7634a531']]);const Dn=new O('ERA变量框架/ui');let Tn=null,Rn=null;function Bn(){Dn.log('unloadUI','UI 脚本开始卸载'),Tn&&(Dn.debug('unmountVueApp','卸载 Vue 实例'),Tn.unmount(),Tn=null),$(`head > div[script_id="${getScriptId()}"]`).remove(),Rn&&(Dn.debug('unloadUI','销毁挂载点'),$(`div#era-ui-mount-point-${getScriptId()}`).remove(),Rn=null),window.removeEventListener('pagehide',Bn),Dn.log('unloadUI','UI 脚本卸载完成')}window.eraUiSwitchView=function(e){Dn.debug('switchView',`请求切换视图到: ${e}`),window.eraUiStore?window.eraUiStore.switchView(e):Dn.warn('switchView','UI store尚未初始化')},$(()=>{if(!1===N.value['开启悬浮球'])return Dn.log('initialize','悬浮球设置为关闭，开始卸载UI...'),void Bn();Dn.log('initialize','UI 脚本开始初始化'),Rn=$('<div>').attr('id',`era-ui-mount-point-${getScriptId()}`).css({position:'fixed',bottom:'20px',left:'20px','z-index':1e4}),Dn.debug('$(document).ready','创建挂载点',Rn),$('body').append(Rn),Dn.debug('$(document).ready','挂载点已添加到 body'),Tn=(0,E.createApp)($n);const e=t();Tn.use(e),Tn.mount(Rn[0]);const a=Vn(e);window.eraUiStore=a,function(){const e=getScriptId();$(`head > div[script_id="${e}"]`).remove();const t=$('<div>').attr('script_id',e).append($(document).find('head > style').clone());$('head').append(t)}(),Dn.debug('initialize','Vue App 已挂载，样式已传送'),eventOn('era:writeDone',e=>{Dn.log('era:writeDone','接收到 era:writeDone 事件，更新 store',e),a.setEventData(e)}),Dn.debug('$(document).ready','已设置 era:writeDone 事件监听器'),window.removeEventListener('pagehide',Bn),window.addEventListener('pagehide',Bn)});[...P.INIT,...P.SYNC,...P.API,...P.UPDATE_MK_ONLY,...P.COLLISION_DETECTORS,...P.COMBO_STARTERS,...P.DIRECTED_SYNC].forEach(e=>{eventOn(e,t=>pt(e,t))}),eventOn(getButtonEvent('写入变量修改'),()=>pt('manual_write')),eventOn(getButtonEvent('手动同步状态'),()=>pt('manual_sync')),eventOn(getButtonEvent('强制完全重算'),()=>pt('manual_full_sync'));