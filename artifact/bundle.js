import{createPinia as e}from'https://testingcf.jsdelivr.net/npm/pinia/+esm';var t={15:(e,t,a)=>{a.r(t),a.d(t,{default:()=>i});var n=a(93),r=a.n(n),o=a(54),s=a.n(o)()(r());s.push([e.id,'.json-line[data-v-34fc6c00]{position:relative;display:flex;align-items:center;gap:6px;padding:2px 6px;border-radius:6px}.json-line[data-v-34fc6c00]:hover{background:rgba(59,130,246,0.06)}.json-children[data-v-34fc6c00]{border-left:1px dashed rgba(107,114,128,0.25)}.key[data-v-34fc6c00]{color:#1f2937;font-weight:700}.colon[data-v-34fc6c00]{color:#6b7280}.brace[data-v-34fc6c00]{color:#9ca3af}.summary[data-v-34fc6c00]{color:#6b7280;margin-left:4px}.val.string[data-v-34fc6c00]{color:#047857}.val.number[data-v-34fc6c00]{color:#7c3aed}.val.boolean[data-v-34fc6c00]{color:#0369a1}.val.null[data-v-34fc6c00]{color:#9ca3af}.val.undefined[data-v-34fc6c00]{color:#9ca3af}.caret[data-v-34fc6c00]{width:18px;height:18px;border:1px solid rgba(0,0,0,0.06);border-radius:4px;background:#fff;line-height:16px;text-align:center;font-size:10px;color:#6b7280;cursor:pointer;box-shadow:0 1px 0 #fff,0 2px 6px rgba(0,0,0,0.06);transition:transform 0.18s ease,box-shadow 0.18s ease}.caret.open[data-v-34fc6c00]{transform:rotate(90deg);box-shadow:0 3px 10px rgba(0,0,0,0.12)}.node[data-v-34fc6c00]{overflow:clip;contain:paint;min-height:0}.json-children[data-v-34fc6c00]{overflow:clip;contain:paint}\n','']);const i=s},26:(e,t,a)=>{var n=a(947);n.__esModule&&(n=n.default),'string'==typeof n&&(n=[[e.id,n,'']]),n.locals&&(e.exports=n.locals);(0,a(424).A)('61312edb',n,!1,{ssrId:!0})},42:(e,t)=>{t.A=(e,t)=>{const a=e.__vccOpts||e;for(const[e,n]of t)a[e]=n;return a}},54:e=>{e.exports=function(e){var t=[];return t.toString=function(){return this.map(function(t){var a='',n=void 0!==t[5];return t[4]&&(a+='@supports ('.concat(t[4],') {')),t[2]&&(a+='@media '.concat(t[2],' {')),n&&(a+='@layer'.concat(t[5].length>0?' '.concat(t[5]):'',' {')),a+=e(t),n&&(a+='}'),t[2]&&(a+='}'),t[4]&&(a+='}'),a}).join('')},t.i=function(e,a,n,r,o){'string'==typeof e&&(e=[[null,e,void 0]]);var s={};if(n)for(var i=0;i<this.length;i++){var l=this[i][0];null!=l&&(s[l]=!0)}for(var d=0;d<e.length;d++){var c=[].concat(e[d]);n&&s[c[0]]||(void 0!==o&&(void 0===c[5]||(c[1]='@layer'.concat(c[5].length>0?' '.concat(c[5]):'',' {').concat(c[1],'}')),c[5]=o),a&&(c[2]?(c[1]='@media '.concat(c[2],' {').concat(c[1],'}'),c[2]=a):c[2]=a),r&&(c[4]?(c[1]='@supports ('.concat(c[4],') {').concat(c[1],'}'),c[4]=r):c[4]=''.concat(r)),t.push(c))}},t}},57:(e,t,a)=>{a.r(t),a.d(t,{default:()=>i});var n=a(93),r=a.n(n),o=a(54),s=a.n(o)()(r());s.push([e.id,'.tabs[data-v-7ab146e6]{margin-top:12px;border:1px solid rgba(0,0,0,0.06);border-radius:12px;overflow:hidden;background:linear-gradient(180deg,#fff,#fafafa)}.tab-bar[data-v-7ab146e6]{display:flex;gap:8px;padding:8px;border-bottom:1px solid rgba(0,0,0,0.06);background:linear-gradient(180deg,#f9fafb,#f3f4f6)}.tab-btn[data-v-7ab146e6]{padding:8px 12px;font-weight:800;font-size:13px;color:#6b7280;background:#fff;border:1px solid #e5e7eb;border-radius:10px;cursor:pointer}.tab-btn.active[data-v-7ab146e6]{color:#111827;border-color:#93c5fd;box-shadow:inset 0 1px 0 #fff,0 0 0 3px rgba(147,197,253,0.35)}.tab-content[data-v-7ab146e6]{padding:10px 12px;background:rgba(255,255,255,0.86)}\n','']);const i=s},93:e=>{e.exports=function(e){return e[1]}},226:(e,t,a)=>{var n=a(57);n.__esModule&&(n=n.default),'string'==typeof n&&(n=[[e.id,n,'']]),n.locals&&(e.exports=n.locals);(0,a(424).A)('cda1587c',n,!1,{ssrId:!0})},237:(e,t,a)=>{a.r(t),a.d(t,{default:()=>i});var n=a(93),r=a.n(n),o=a(54),s=a.n(o)()(r());s.push([e.id,'.json-root[data-v-036df356]{font-size:12px;color:#111827}.json-line[data-v-036df356]{position:relative;display:flex;align-items:center;gap:6px;padding:2px 6px;border-radius:6px}.json-line[data-v-036df356]:hover{background:rgba(59,130,246,0.06)}.json-children[data-v-036df356]{border-left:1px dashed rgba(107,114,128,0.25)}.key[data-v-036df356]{color:#1f2937;font-weight:700}.colon[data-v-036df356]{color:#6b7280}.brace[data-v-036df356]{color:#9ca3af}.val.string[data-v-036df356]{color:#047857}.val.number[data-v-036df356]{color:#7c3aed}.val.boolean[data-v-036df356]{color:#0369a1}.val.null[data-v-036df356]{color:#9ca3af}.val.undefined[data-v-036df356]{color:#9ca3af}.json-root[data-v-036df356]{overflow:clip;contain:layout paint;min-height:0}.json-children[data-v-036df356]{overflow:clip;contain:paint}\n','']);const i=s},251:(e,t,a)=>{a.r(t),a.d(t,{default:()=>i});var n=a(93),r=a.n(n),o=a(54),s=a.n(o)()(r());s.push([e.id,'.era-panel[data-v-57305d87]{width:min(960px,60vw);height:min(680px,86vh);display:flex;flex-direction:column;background:linear-gradient(180deg,rgba(255,255,255,0.75),rgba(255,255,255,0.65));border:1px solid rgba(255,255,255,0.6);backdrop-filter:blur(10px);border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,0.18),inset 0 1px 0 rgba(255,255,255,0.6);overflow:hidden;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}.panel-top[data-v-57305d87]{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid rgba(0,0,0,0.06);background:linear-gradient(90deg,rgba(255,255,255,0.65),rgba(255,255,255,0.45))}.panel-title[data-v-57305d87]{font-size:16px;font-weight:800;letter-spacing:0.5px;color:#1f2937}.btn-close[data-v-57305d87]{width:32px;height:32px;line-height:30px;text-align:center;border-radius:8px;border:1px solid rgba(0,0,0,0.08);background:#fff;cursor:pointer;font-size:18px;color:#6b7280;box-shadow:0 2px 8px rgba(0,0,0,0.08)}.btn-close[data-v-57305d87]:hover{transform:translateY(-1px);box-shadow:0 6px 16px rgba(0,0,0,0.12)}.panel-body[data-v-57305d87]{padding:14px 14px 16px;overflow:auto}.block[data-v-57305d87]{margin:12px 0 4px;padding:10px 12px;background:rgba(255,255,255,0.6);border:1px solid rgba(0,0,0,0.06);border-radius:12px}.block-title[data-v-57305d87]{margin:0 0 8px;font-size:13px;font-weight:800;color:#374151}.chips[data-v-57305d87]{display:flex;flex-wrap:wrap;gap:8px}.chip[data-v-57305d87]{font-size:12px;padding:6px 8px;border:1px solid rgba(0,0,0,0.06);border-radius:999px;background:linear-gradient(180deg,#fafafa,#f4f4f4);color:#6b7280;box-shadow:inset 0 1px 0 #fff}.chip.ok[data-v-57305d87]{color:#065f46;background:linear-gradient(180deg,#ecfdf5,#d1fae5);border-color:#a7f3d0}.mk-strip[data-v-57305d87]{display:flex;gap:8px;flex-wrap:wrap;max-height:140px;overflow:auto}.mk-pill[data-v-57305d87]{display:inline-flex;gap:6px;align-items:center;padding:6px 8px;background:linear-gradient(180deg,#eef2ff,#e0e7ff);color:#4338ca;border:1px solid #c7d2fe;border-radius:8px;font-size:12px}.mk-pill.is-null[data-v-57305d87]{background:linear-gradient(180deg,#f9fafb,#f3f4f6);color:#6b7280;border-color:#e5e7eb}.empty[data-v-57305d87]{height:360px;display:grid;place-items:center;color:#6b7280;font-size:14px;border:1px dashed rgba(0,0,0,0.08);border-radius:12px;background:rgba(255,255,255,0.5)}[data-v-57305d87] button[aria-expanded=\'false\']+*{height:0 !important;padding-top:0 !important;padding-bottom:0 !important;margin-top:0 !important;margin-bottom:0 !important;border-top-width:0 !important;border-bottom-width:0 !important;overflow:clip !important;contain:paint !important}[data-v-57305d87] button[aria-expanded=\'true\']+*{overflow:visible}.era-shell[data-v-57305d87]{display:flex;align-items:flex-start;gap:12px;flex-wrap:nowrap}.era-panel[data-v-57305d87]{flex:0 1 auto}.right-rail[data-v-57305d87]{width:min(320px,34vw);position:sticky;top:10px;align-self:flex-start;z-index:1}@media (max-width:1100px){.era-shell[data-v-57305d87]{flex-wrap:wrap}.right-rail[data-v-57305d87]{width:100%;position:static;margin-top:8px}}[data-v-57305d87] .floating-ball{position:fixed;right:max(16px,env(safe-area-inset-right));bottom:max(90px,env(safe-area-inset-bottom));z-index:2147483647;pointer-events:auto;touch-action:manipulation;will-change:transform}.era-expanded-layer[data-v-57305d87]{position:fixed;inset:0;display:grid;place-items:center;padding:clamp(12px,2.5vw,24px);pointer-events:auto;z-index:2147483646;background:transparent;overflow:auto}@media (max-width:640px){.era-panel[data-v-57305d87]{width:min(92vw,560px);height:min(88vh,calc(100svh - 32px))}.panel-body[data-v-57305d87]{overscroll-behavior:contain}}\n','']);const i=s},300:(e,t,a)=>{a.r(t),a.d(t,{default:()=>i});var n=a(93),r=a.n(n),o=a(54),s=a.n(o)()(r());s.push([e.id,'.settings-card[data-v-0fd50dba]{width:100%;padding:12px;margin-top:12px;background:linear-gradient(180deg,rgba(255,255,255,0.76),rgba(255,255,255,0.62));border:1px solid rgba(255,255,255,0.6);border-radius:16px;backdrop-filter:blur(10px);box-shadow:0 10px 40px rgba(0,0,0,0.16),inset 0 1px 0 rgba(255,255,255,0.6);display:flex;flex-direction:column;gap:10px}.card-header[data-v-0fd50dba]{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);background:linear-gradient(180deg,#fafafa,#f3f4f6);color:#1f2937;font-weight:800;font-size:13px;cursor:pointer;box-shadow:inset 0 1px 0 #fff,0 2px 8px rgba(0,0,0,0.08)}.card-header[data-v-0fd50dba]:hover{transform:translateY(-1px);box-shadow:inset 0 1px 0 #fff,0 6px 16px rgba(0,0,0,0.12)}.title[data-v-0fd50dba]{pointer-events:none}.chev[data-v-0fd50dba]{opacity:0.7}.content[data-v-0fd50dba]{display:flex;flex-direction:column;gap:10px}.toolbar[data-v-0fd50dba]{display:flex;align-items:center;gap:8px}.spacer[data-v-0fd50dba]{flex:1}.mini-btn[data-v-0fd50dba]{padding:6px 10px;border-radius:8px;border:1px solid rgba(0,0,0,0.08);background:linear-gradient(180deg,#fafafa,#f3f4f6);cursor:pointer;font-size:12px;font-weight:700;box-shadow:inset 0 1px 0 #fff,0 2px 6px rgba(0,0,0,0.06)}.mini-btn[data-v-0fd50dba]:hover{transform:translateY(-1px);box-shadow:inset 0 1px 0 #fff,0 5px 12px rgba(0,0,0,0.1)}.mini-btn.primary[data-v-0fd50dba]{background:linear-gradient(180deg,#e0f2fe,#bfdbfe);border-color:#93c5fd;color:#0f172a}.mini-btn.subtle[data-v-0fd50dba]{background:linear-gradient(180deg,#f9fafb,#f3f4f6);border-color:#e5e7eb}.vars[data-v-0fd50dba]{display:flex;flex-direction:column;gap:8px}.var-row[data-v-0fd50dba]{display:grid;grid-template-columns:1fr minmax(120px,1.2fr) auto;align-items:center;gap:10px;padding:8px 10px;border:1px solid rgba(0,0,0,0.06);border-radius:10px;background:linear-gradient(180deg,#ffffff,#f8fafc)}.var-key[data-v-0fd50dba]{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:12px;color:#374151;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.var-editor[data-v-0fd50dba]{display:flex;align-items:center;gap:8px}.ipt[data-v-0fd50dba]{width:100%;padding:8px 10px;border-radius:8px;border:1px solid #e5e7eb;background:#fff;font-size:12px;color:#111827;box-shadow:inset 0 1px 0 #fff}.ta[data-v-0fd50dba]{min-height:64px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}.type-chip[data-v-0fd50dba]{font-size:11px;color:#374151;background:#eef2ff;border:1px solid #c7d2fe;border-radius:999px;padding:4px 8px;white-space:nowrap}.switch[data-v-0fd50dba]{position:relative;width:42px;height:24px;display:inline-block}.switch input[data-v-0fd50dba]{opacity:0;width:0;height:0}.switch .track[data-v-0fd50dba]{position:absolute;inset:0;border-radius:999px;background:#e5e7eb;box-shadow:inset 0 1px 0 #fff;transition:background 0.2s ease}.switch .track[data-v-0fd50dba]::after{content:\'\';position:absolute;top:3px;left:3px;width:18px;height:18px;border-radius:50%;background:#fff;box-shadow:0 1px 3px rgba(0,0,0,0.2);transition:transform 0.2s ease}.switch input:checked+.track[data-v-0fd50dba]{background:#93c5fd}.switch input:checked+.track[data-v-0fd50dba]::after{transform:translateX(18px)}.hint[data-v-0fd50dba]{font-size:11px;color:#6b7280}.hint.ok[data-v-0fd50dba]{color:#065f46}.hint.bad[data-v-0fd50dba]{color:#b91c1c}.placeholder[data-v-0fd50dba]{padding:10px;color:#6b7280;font-size:12px;border:1px dashed rgba(0,0,0,0.08);border-radius:10px;background:rgba(255,255,255,0.5)}\n','']);const i=s},354:(e,t,a)=>{var n=a(251);n.__esModule&&(n=n.default),'string'==typeof n&&(n=[[e.id,n,'']]),n.locals&&(e.exports=n.locals);(0,a(424).A)('725e8828',n,!1,{ssrId:!0})},424:(e,t,a)=>{function n(e,t){for(var a=[],n={},r=0;r<t.length;r++){var o=t[r],s=o[0],i={id:e+':'+r,css:o[1],media:o[2],sourceMap:o[3]};n[s]?n[s].parts.push(i):a.push(n[s]={id:s,parts:[i]})}return a}a.d(t,{A:()=>f});var r='undefined'!=typeof document;if('undefined'!=typeof DEBUG&&DEBUG&&!r)throw new Error('vue-style-loader cannot be used in a non-browser environment. Use { target: \'node\' } in your Webpack config to indicate a server-rendering environment.');var o={},s=r&&(document.head||document.getElementsByTagName('head')[0]),i=null,l=0,d=!1,c=function(){},p=null,u='data-vue-ssr-id',g='undefined'!=typeof navigator&&/msie [6-9]\b/.test(navigator.userAgent.toLowerCase());function f(e,t,a,r){d=a,p=r||{};var s=n(e,t);return m(s),function(t){for(var a=[],r=0;r<s.length;r++){var i=s[r];(l=o[i.id]).refs--,a.push(l)}t?m(s=n(e,t)):s=[];for(r=0;r<a.length;r++){var l;if(0===(l=a[r]).refs){for(var d=0;d<l.parts.length;d++)l.parts[d]();delete o[l.id]}}}}function m(e){for(var t=0;t<e.length;t++){var a=e[t],n=o[a.id];if(n){n.refs++;for(var r=0;r<n.parts.length;r++)n.parts[r](a.parts[r]);for(;r<a.parts.length;r++)n.parts.push(v(a.parts[r]));n.parts.length>a.parts.length&&(n.parts.length=a.parts.length)}else{var s=[];for(r=0;r<a.parts.length;r++)s.push(v(a.parts[r]));o[a.id]={id:a.id,refs:1,parts:s}}}}function b(){var e=document.createElement('style');return e.type='text/css',s.appendChild(e),e}function v(e){var t,a,n=document.querySelector('style['+u+'~="'+e.id+'"]');if(n){if(d)return c;n.parentNode.removeChild(n)}if(g){var r=l++;n=i||(i=b()),t=x.bind(null,n,r,!1),a=x.bind(null,n,r,!0)}else n=b(),t=w.bind(null,n),a=function(){n.parentNode.removeChild(n)};return t(e),function(n){if(n){if(n.css===e.css&&n.media===e.media&&n.sourceMap===e.sourceMap)return;t(e=n)}else a()}}var h,y=(h=[],function(e,t){return h[e]=t,h.filter(Boolean).join('\n')});function x(e,t,a,n){var r=a?'':n.css;if(e.styleSheet)e.styleSheet.cssText=y(t,r);else{var o=document.createTextNode(r),s=e.childNodes;s[t]&&e.removeChild(s[t]),s.length?e.insertBefore(o,s[t]):e.appendChild(o)}}function w(e,t){var a=t.css,n=t.media,r=t.sourceMap;if(n&&e.setAttribute('media',n),p.ssrId&&e.setAttribute(u,t.id),r&&(a+='\n/*# sourceURL='+r.sources[0]+' */',a+='\n/*# sourceMappingURL=data:application/json;base64,'+btoa(unescape(encodeURIComponent(JSON.stringify(r))))+' */'),e.styleSheet)e.styleSheet.cssText=a;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(a))}}},472:(e,t,a)=>{var n=a(237);n.__esModule&&(n=n.default),'string'==typeof n&&(n=[[e.id,n,'']]),n.locals&&(e.exports=n.locals);(0,a(424).A)('e04e824a',n,!1,{ssrId:!0})},527:(e,t,a)=>{var n=a(796);n.__esModule&&(n=n.default),'string'==typeof n&&(n=[[e.id,n,'']]),n.locals&&(e.exports=n.locals);(0,a(424).A)('103dcb5d',n,!1,{ssrId:!0})},796:(e,t,a)=>{a.r(t),a.d(t,{default:()=>i});var n=a(93),r=a.n(n),o=a(54),s=a.n(o)()(r());s.push([e.id,'.action-buttons-card[data-v-5766043a]{width:100%;padding:12px;background:linear-gradient(180deg,rgba(255,255,255,0.76),rgba(255,255,255,0.62));border:1px solid rgba(255,255,255,0.6);border-radius:16px;backdrop-filter:blur(10px);box-shadow:0 10px 40px rgba(0,0,0,0.16),inset 0 1px 0 rgba(255,255,255,0.6);display:flex;flex-direction:column;gap:10px}.card-title[data-v-5766043a]{margin:0 0 4px;font-size:14px;font-weight:800;letter-spacing:0.3px;color:#1f2937}.btns[data-v-5766043a]{display:flex;flex-direction:column;gap:10px}.btn[data-v-5766043a]{display:grid;grid-template-columns:22px 1fr;align-items:center;-moz-column-gap:8px;column-gap:8px;padding:10px 12px;border-radius:12px;border:1px solid rgba(0,0,0,0.06);background:linear-gradient(180deg,#fafafa,#f3f4f6);color:#374151;font-weight:700;font-size:13px;cursor:pointer;box-shadow:inset 0 1px 0 #fff,0 2px 8px rgba(0,0,0,0.08);transition:transform 0.12s ease,box-shadow 0.12s ease,background 0.2s ease;text-align:left}.btn.primary[data-v-5766043a]{background:linear-gradient(180deg,#e0f2fe,#bfdbfe);border-color:#93c5fd;color:#0f172a}.btn.subtle[data-v-5766043a]{background:linear-gradient(180deg,#f9fafb,#f3f4f6);border-color:#e5e7eb}.btn[data-v-5766043a]:hover{transform:translateY(-1px);box-shadow:inset 0 1px 0 #fff,0 6px 16px rgba(0,0,0,0.12)}.btn[data-v-5766043a]:active{transform:translateY(0);box-shadow:inset 0 1px 0 #fff,0 2px 8px rgba(0,0,0,0.1)}.btn[data-v-5766043a]:focus-visible{outline:2px solid #60a5fa;outline-offset:2px}.ico[data-v-5766043a]{display:inline-grid;place-items:center;width:22px;height:22px;filter:saturate(0.95)}.label[data-v-5766043a]{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}\n','']);const i=s},821:(e,t,a)=>{a.r(t),a.d(t,{default:()=>i});var n=a(93),r=a.n(n),o=a(54),s=a.n(o)()(r());s.push([e.id,'.era-app-container{position:fixed;inset:0;z-index:2147483646;pointer-events:none;isolation:isolate;contain:layout style paint;width:100svw;height:100svh}\n','']);const i=s},840:(e,t,a)=>{var n=a(821);n.__esModule&&(n=n.default),'string'==typeof n&&(n=[[e.id,n,'']]),n.locals&&(e.exports=n.locals);(0,a(424).A)('840bf884',n,!1,{ssrId:!0})},848:(e,t,a)=>{var n=a(925);n.__esModule&&(n=n.default),'string'==typeof n&&(n=[[e.id,n,'']]),n.locals&&(e.exports=n.locals);(0,a(424).A)('568d0182',n,!1,{ssrId:!0})},917:(e,t,a)=>{var n=a(300);n.__esModule&&(n=n.default),'string'==typeof n&&(n=[[e.id,n,'']]),n.locals&&(e.exports=n.locals);(0,a(424).A)('6369cf07',n,!1,{ssrId:!0})},925:(e,t,a)=>{a.r(t),a.d(t,{default:()=>i});var n=a(93),r=a.n(n),o=a(54),s=a.n(o)()(r());s.push([e.id,'.meta[data-v-56f5fbd7]{position:relative;padding:12px 12px 14px;border:1px solid rgba(0,0,0,0.06);border-radius:12px;background:linear-gradient(180deg,#ffffff,#f9fafb);box-shadow:0 6px 18px rgba(0,0,0,0.06),inset 0 1px 0 #fff}.meta-title[data-v-56f5fbd7]{margin:0 0 10px;font-size:13px;font-weight:800;color:#374151}.kv[data-v-56f5fbd7]{display:grid;grid-template-columns:120px 1fr;gap:8px 12px}.item[data-v-56f5fbd7]{display:contents}.k[data-v-56f5fbd7]{justify-self:start;align-self:center;font-size:12px;color:#6b7280;background:#f3f4f6;border:1px solid #e5e7eb;padding:4px 8px;border-radius:8px;font-weight:700}.v[data-v-56f5fbd7]{align-self:center;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;color:#111827;background:#fff;border:1px solid #e5e7eb;padding:6px 8px;border-radius:8px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.glow[data-v-56f5fbd7]{position:absolute;left:12px;right:12px;top:-1px;height:3px;border-radius:999px;background:linear-gradient(90deg,#60a5fa,#a78bfa,#34d399,#f472b6);filter:blur(0.4px)}\n','']);const i=s},926:(e,t,a)=>{var n=a(951);n.__esModule&&(n=n.default),'string'==typeof n&&(n=[[e.id,n,'']]),n.locals&&(e.exports=n.locals);(0,a(424).A)('64daf52e',n,!1,{ssrId:!0})},947:(e,t,a)=>{a.r(t),a.d(t,{default:()=>i});var n=a(93),r=a.n(n),o=a(54),s=a.n(o)()(r());s.push([e.id,'.acc[data-v-cb8a53de]{border:1px solid rgba(0,0,0,0.06);border-radius:12px;background:linear-gradient(180deg,#fff,#fafafa);overflow:hidden}.acc-head[data-v-cb8a53de]{width:100%;display:flex;align-items:center;gap:10px;background:linear-gradient(180deg,#f9fafb,#f3f4f6);border-bottom:1px solid rgba(0,0,0,0.06);padding:10px 12px;cursor:pointer;font-weight:800;color:#374151}.caret[data-v-cb8a53de]{transition:transform 0.18s ease}.caret.open[data-v-cb8a53de]{transform:rotate(90deg)}.title[data-v-cb8a53de]{font-size:13px}.spacer[data-v-cb8a53de]{flex:1}.hint[data-v-cb8a53de]{font-size:12px;color:#6b7280}.acc-body[data-v-cb8a53de]{display:grid;grid-template-rows:0fr;transition:grid-template-rows 0.28s ease;background:rgba(255,255,255,0.82)}.acc-body.open[data-v-cb8a53de]{grid-template-rows:1fr}.inner[data-v-cb8a53de]{overflow:hidden;transition:padding 0.28s ease,visibility 0s 0.28s;padding:0 12px;visibility:hidden}.acc-body.open .inner[data-v-cb8a53de]{padding:10px 12px;visibility:visible;transition-delay:0s}\n','']);const i=s},951:(e,t,a)=>{a.r(t),a.d(t,{default:()=>i});var n=a(93),r=a.n(n),o=a(54),s=a.n(o)()(r());s.push([e.id,'.floating-ball[data-v-ee0f5b22]{--size:50px;--hue:212;--sat:100%;--lum:52%;--surface:hsl(var(--hue) var(--sat) var(--lum));--surface-2:hsl(var(--hue) 95% 64%);--ring:hsl(calc(var(--hue) + 20) 95% 65%);--shadow:rgba(0,123,255,0.36);--glow:rgba(102,200,255,0.55);--inner-shadow:rgba(0,0,0,0.22);--specular:rgba(255,255,255,0.75);--glass:rgba(255,255,255,0.18);width:var(--size);height:var(--size);border-radius:50%;position:relative;display:grid;place-items:center;cursor:pointer;-webkit-user-select:none;user-select:none;-webkit-tap-highlight-color:transparent;background:radial-gradient(120% 120% at 30% 28%,rgba(255,255,255,0.85) 0%,rgba(255,255,255,0.22) 18%,rgba(255,255,255,0) 36%),radial-gradient(120% 120% at 70% 72%,rgba(0,0,0,0.18) 0%,rgba(0,0,0,0) 38%),conic-gradient(from 210deg at 50% 50%,var(--surface),var(--surface-2),var(--surface));box-shadow:inset 0 2px 6px var(--inner-shadow),0 2px 4px rgba(0,0,0,0.08),0 10px 22px var(--shadow);transition:transform 0.28s ease,box-shadow 0.28s ease,filter 0.28s ease;will-change:transform,box-shadow,filter;animation:ball-bob-ee0f5b22 3.2s ease-in-out infinite}.floating-ball[data-v-ee0f5b22]::after{content:\'\';position:absolute;inset:-8px;border-radius:50%;background:conic-gradient(from 0deg,var(--ring),transparent 30%,transparent 70%,var(--ring));filter:blur(6px);opacity:0.55;pointer-events:none;-webkit-mask:radial-gradient(farthest-side,transparent calc(100% - 12px),#000 0);mask:radial-gradient(farthest-side,transparent calc(100% - 12px),#000 0);animation:ring-spin-ee0f5b22 12s linear infinite}.floating-ball[data-v-ee0f5b22]::before{content:\'\';position:absolute;inset:2px;border-radius:50%;background:radial-gradient(120% 80% at 26% 24%,var(--specular) 0%,rgba(255,255,255,0.2) 26%,rgba(255,255,255,0) 46%),linear-gradient(160deg,var(--glass) 0%,rgba(255,255,255,0) 50%);mix-blend-mode:screen;pointer-events:none;transition:opacity 0.28s ease,transform 0.28s ease}.floating-ball[data-v-ee0f5b22]:hover{transform:translateY(-2px) scale(1.04);box-shadow:inset 0 2px 8px rgba(0,0,0,0.22),0 4px 10px rgba(0,0,0,0.12),0 16px 36px rgba(0,123,255,0.45);filter:saturate(1.08)}.floating-ball[data-v-ee0f5b22]:hover::before{opacity:0.95;animation:shimmer-ee0f5b22 1.2s ease-out}.floating-ball[data-v-ee0f5b22]:active{transform:translateY(0) scale(0.98);box-shadow:inset 0 2px 10px rgba(0,0,0,0.28),0 2px 6px rgba(0,0,0,0.12),0 10px 22px rgba(0,123,255,0.35)}.floating-ball[data-v-ee0f5b22]:focus-visible{outline:2px solid rgba(102,200,255,0.85);outline-offset:2px}@media (prefers-reduced-motion:reduce){.floating-ball[data-v-ee0f5b22]{animation:none}.floating-ball[data-v-ee0f5b22]::after{animation:none}}@keyframes ball-bob-ee0f5b22{0%,100%{transform:translateY(0)}50%{transform:translateY(-2px)}}@keyframes ring-spin-ee0f5b22{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}@keyframes shimmer-ee0f5b22{0%{transform:translateY(-1px) scale(0.98);opacity:0.6}50%{transform:translateY(-2px) scale(1.02);opacity:1}100%{transform:translateY(-1px) scale(0.99);opacity:0.85}}.floating-ball[data-v-ee0f5b22]{--logo-scale:0.38}.era-logo[data-v-ee0f5b22]{font-weight:800;font-size:calc(var(--size) * var(--logo-scale));letter-spacing:0.02em;line-height:1;transform:translateY(-1px);white-space:nowrap;-webkit-user-select:none;user-select:none;pointer-events:none;z-index:1;background:linear-gradient(180deg,rgba(255,255,255,0.96) 0%,rgba(255,255,255,0.55) 45%,rgba(220,240,255,0.4) 65%,rgba(120,195,255,0.55) 100%),linear-gradient(180deg,rgba(0,0,0,0.38),rgba(0,0,0,0) 60%);-webkit-background-clip:text;background-clip:text;color:transparent;text-shadow:0 1px 0 rgba(255,255,255,0.75),0 2px 4px rgba(0,0,0,0.25),0 8px 18px rgba(0,123,255,0.35);filter:drop-shadow(0 0 2px rgba(102,200,255,0.25));animation:era-sheen-ee0f5b22 4s ease-in-out infinite}.floating-ball:hover .era-logo[data-v-ee0f5b22]{text-shadow:0 1px 0 rgba(255,255,255,0.85),0 3px 8px rgba(0,0,0,0.28),0 10px 26px rgba(0,123,255,0.55);filter:drop-shadow(0 0 3px rgba(102,200,255,0.38))}@keyframes era-sheen-ee0f5b22{0%,100%{background-position:0% 0%,0% 0%}50%{background-position:0% 40%,0% 0%}}\n','']);const i=s},986:(e,t,a)=>{var n=a(15);n.__esModule&&(n=n.default),'string'==typeof n&&(n=[[e.id,n,'']]),n.locals&&(e.exports=n.locals);(0,a(424).A)('0dba12a3',n,!1,{ssrId:!0})}},a={};function n(e){var r=a[e];if(void 0!==r)return r.exports;var o=a[e]={id:e,exports:{}};return t[e](o,o.exports,n),o.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var a in t)n.o(t,a)&&!n.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{'undefined'!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:'Module'}),Object.defineProperty(e,'__esModule',{value:!0})};const r=z,o=r.z.object({开启悬浮球:r.z.boolean().default(!0),强制重载功能:r.z.boolean().default(!1),强制重载消息数:r.z.number().default(2)}),s={type:'chat'},i='ERAMetaData',l='stat_data',d='EditLogs',c='SelectedMks',p='era_data',u=new RegExp(`<${p}>({.*?})<\\/${p}>`),g={INSERT_BY_OBJECT:'era:insertByObject',UPDATE_BY_OBJECT:'era:updateByObject',INSERT_BY_PATH:'era:insertByPath',UPDATE_BY_PATH:'era:updateByPath',DELETE_BY_OBJECT:'era:deleteByObject',DELETE_BY_PATH:'era:deleteByPath',GET_CURRENT_VARS:'era:getCurrentVars'},f='era:writeDone',m='era:apiWrite',b='era_debug_config';let v=[],h=[];function y(){try{const e=globalThis.localStorage?.getItem(b)||'{"enabled":[],"disabled":[]}',t=JSON.parse(e),a=e=>new RegExp(`^${e.replace(/\*/g,'.*?')}$`);v=(t.enabled||[]).map(a),h=(t.disabled||[]).map(a)}catch(e){console.error('《ERA-Log》: 加载调试配置失败。',e),v=[],h=[]}}function x(e){const t={enabled:[...new Set(e.enabled)],disabled:[...new Set(e.disabled)]};globalThis.localStorage?.setItem(b,JSON.stringify(t)),y(),console.log('%c《ERA-Log》调试模式已更新。','color: #3498db; font-weight: bold;',{'启用 (Enabled)':t.enabled,'禁用 (Disabled)':t.disabled})}if(y(),'undefined'!=typeof globalThis){const e={add(e){const t=globalThis.localStorage?.getItem(b)||'{"enabled":[],"disabled":[]}',a=JSON.parse(t),n=new Set(a.enabled||[]),r=new Set(a.disabled||[]);n.add(e),r.delete(e),x({enabled:Array.from(n),disabled:Array.from(r)})},remove(e){const t=globalThis.localStorage?.getItem(b)||'{"enabled":[],"disabled":[]}',a=JSON.parse(t),n=new Set(a.enabled||[]),r=new Set(a.disabled||[]);r.add(e),n.delete(e),x({enabled:Array.from(n),disabled:Array.from(r)})},status(){const e=globalThis.localStorage?.getItem(b)||'{"enabled":[],"disabled":[]}',t=JSON.parse(e);console.log('%c《ERA-Log》当前调试配置:','color: #3498db; font-weight: bold;',t)},clear(){x({enabled:[],disabled:[]})}};globalThis.eraDebug=e}const w={mk:''};class k{moduleName;constructor(e){this.moduleName=e||(this._getModuleNameFromStack()||'unknown')}_getModuleNameFromStack(){try{const e=((new Error).stack||'').split('\n').find(e=>e.includes('/src/ERA变量框架/')&&!e.includes('/utils/log.ts'));if(!e)return null;const t=e.match(/src\/ERA变量框架\/([^?:\s)]+)/);if(!t||!t[1])return null;let a=t[1];return a=a.replace(/\.(vue|ts|js)$/,''),a.replace(/^src\/ERA变量框架\//,'').replace(/\/index$/,'').replace(/\//g,'-')}catch(e){return console.error('《ERA-Log-Debug》: 解析模块名时发生意外错误。',e),null}}formatMessage(e,t){return`《ERA》${w.mk?`（${w.mk}）`:''}「${this.moduleName}」【${e}】${String(t)}`}debug(e,t,a){if(!(n=this.moduleName)||h.some(e=>e.test(n))||0===v.length||!v.some(e=>e.test(n)))return;var n;const r=this.formatMessage(e,t);void 0!==a?console.debug(r,a):console.debug(r)}log(e,t,a){const n=this.formatMessage(e,t);void 0!==a?console.log(`%c${n}`,'color: #3498db;',a):console.log(`%c${n}`,'color: #3498db;')}warn(e,t,a){const n=this.formatMessage(e,t);void 0!==a?console.warn(`%c${n}`,'color: #f39c12;',a):console.warn(`%c${n}`,'color: #f39c12;')}error(e,t,a){const n=this.formatMessage(e,t);void 0!==a?console.error(`%c${n}`,'color: #e74c3c; font-weight: bold;',a):console.error(`%c${n}`,'color: #e74c3c; font-weight: bold;')}}const N=new k,E={INIT:[tavern_events.APP_READY],SYNC:['manual_write',m,tavern_events.MESSAGE_RECEIVED,tavern_events.MESSAGE_DELETED,tavern_events.MESSAGE_SWIPED,tavern_events.CHAT_CHANGED,'manual_sync','manual_full_sync','combo_sync'],API:Object.values(g),UPDATE_MK_ONLY:[tavern_events.MESSAGE_SENT],COLLISION_DETECTORS:[tavern_events.GENERATION_STARTED],COMBO_STARTERS:[tavern_events.MESSAGE_UPDATED]},V=new Map([[tavern_events.MESSAGE_SWIPED,{next:tavern_events.GENERATION_STARTED,maxInterval:600}]]),C=new Map([[tavern_events.MESSAGE_UPDATED,{next:tavern_events.GENERATION_STARTED,resultType:'combo_sync',maxInterval:1600}]]),S=new Map([[tavern_events.MESSAGE_SWIPED,500],[tavern_events.MESSAGE_UPDATED,1500]]);function A(e){return E.INIT.includes(e)?'INIT':E.SYNC.includes(e)?'SYNC':E.API.includes(e)?'API':E.UPDATE_MK_ONLY.includes(e)?'UPDATE_MK_ONLY':E.COLLISION_DETECTORS.includes(e)?'COLLISION_DETECTORS':E.COMBO_STARTERS.includes(e)?'COMBO_STARTERS':'UNKNOWN'}function O(e){const t=_.cloneDeep(e),a=[];for(const t of e){if(0===a.length){a.push(t);continue}const e=a[a.length-1],n=t.timestamp-e.timestamp,r=C.get(e.type);if(r&&t.type===r.next){if(n<=r.maxInterval){N.debug('mergeEventBatch',`检测到事件组合: ${e.type} 和 ${t.type} (时间差: ${n}ms <= ${r.maxInterval}ms)。将合并为 ${r.resultType} 事件。`),a.pop(),a.push({type:r.resultType,timestamp:t.timestamp,detail:t.detail});continue}N.debug('mergeEventBatch',`检测到潜在的事件组合，但因超时而失败: ${e.type} 和 ${t.type} (时间差: ${n}ms > ${r.maxInterval}ms)。`)}const o=V.get(e.type);if(o&&t.type===o.next){if(n<=o.maxInterval){N.debug('mergeEventBatch',`检测到相邻事件对冲: ${e.type} 和 ${t.type} (时间差: ${n}ms <= ${o.maxInterval}ms)。将忽略这两个事件。`),a.pop();continue}N.debug('mergeEventBatch',`检测到潜在的事件对冲，但因超时而失败: ${e.type} 和 ${t.type} (时间差: ${n}ms > ${o.maxInterval}ms)。`)}const s=A(e.type);s===A(t.type)&&'SYNC'===s?a[a.length-1]=t:a.push(t)}const n=a.filter(e=>{const t=A(e.type),a='COLLISION_DETECTORS'===t,n='COMBO_STARTERS'===t;return(a||n)&&N.debug('mergeEventBatch',`清理未配对的事件: ${e.type}`),!a&&!n});return N.debug('mergeEventBatch',`事件合并: ${t.length} -> ${n.length}`,{before:t.map(e=>e.type),after:n.map(e=>e.type)}),n}const M=_;var D=n.n(M);function I(e){if(!D().isObject(e))return e;const t=D().cloneDeep(e);return function e(t){if(Array.isArray(t))t.forEach(t=>e(t));else if(D().isPlainObject(t))for(const a in t)a.startsWith('$')?delete t[a]:e(t[a])}(t),t}function T(){const e=getVariables(s)||{};return{meta:D().get(e,i,{}),stat:D().get(e,l,{})}}async function B(e){await updateVariablesWith(async t=>{const a=D().get(t,l,{}),n=await e(a);return D().set(t,l,n),t},s)}async function R(e){await updateVariablesWith(async t=>{const a=D().get(t,i,{}),n=await e(a);return D().set(t,i,n),t},s)}function j(){const e=getVariables({type:'script',script_id:getScriptId()});return o.parse(e??{})}async function L(e){await updateVariablesWith(async t=>{const a=o.parse(t??{});return await e(a)},{type:'script',script_id:getScriptId()})}function P(e){if(!e.includes('{{'))return e;let t=e;return t=t.replace(/{{user}}/gi,SillyTavern.name1),t=t.replace(/{{char}}/gi,SillyTavern.name2),t}const J=new k;function F(e){if(!e)return null;let t=null;if('string'==typeof e.mes)t=e.mes;else if(Array.isArray(e.swipes)){const a=Number(e.swipe_id??0);t=e.swipes[a]||null}else'string'==typeof e.message&&(t=e.message);return null===t?null:P(t)}function U(e){const t=function(e){if('string'!=typeof e)return null;const t=e.match(u);if(!t||!t[1])return null;try{const e=t[1],a=e.match(/"era-message-key"\s*=\s*"(.*?)"/),n=e.match(/"era-message-type"\s*=\s*"(.*?)"/);if(a?.[1]&&n?.[1]){const e={'era-message-key':a[1],'era-message-type':n[1]};return J.debug('parseEraData','成功解析 EraData',e),e}return J.debug('parseEraData','未能在 EraData 块中找到完整的键值对',{customFormatBlock:e}),null}catch(e){return J.warn('parseEraData','解析 EraData 块时发生异常',e),null}}(F(e));return t?'user'===t['era-message-type']:'user'===e?.role}async function K(e,t){const a=F(e);J.debug('updateMessageContent','更新前的消息内容:',a),J.debug('updateMessageContent','更新后的消息内容:',t);const n={message_id:e.message_id};if(Array.isArray(e.swipes)){const a=Number(e.swipe_id??0),r=[...e.swipes];r[a]=t,n.swipes=r}else n.message=t;await setChatMessages([n],{refresh:'none'})}function H(e){if(!e)return e;let t=String(e).trim();return t=t.replace(/^\s*(?:```|~~~)\[a-zA-Z0-9_-\]*\s*\r?\n/,''),t=t.replace(/\r?\n(?:```|~~~)\s*$/,''),t.trim()}function Y(e='',t='exact'){if('any'===t||'*'===e)return/([a-zA-Z][a-zA-Z0-9_]*)/;const a=e.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');switch(t){case'exact':return new RegExp(`(${a})`);case'prefix':return new RegExp(`(${a}[a-zA-Z0-9_]*)`);case'suffix':return new RegExp(`([a-zA-Z0-9_]*${a})`);default:return new RegExp(`([a-zA-Z0-9_]*${a}[a-zA-Z0-9_]*)`)}}function W(e,t,a=e.length){const n=new RegExp(`</${t.source}>`,'g');let r,o=null;for(;null!==(r=n.exec(e))&&r.index<a;)o=r;if(!o)return null;const s=o[1],i=o.index,l=`<${s}>`,d=e.lastIndexOf(l,i);return-1===d?W(e,t,i):{startIndex:d,endIndex:i+`</${s}>`.length,content:e.substring(d+l.length,i),tagName:s}}function G(e,t){return(t?new RegExp(`</?${t.source}>`):/<\/?\s*[a-zA-Z][a-zA-Z0-9_]*\s*>/).test(e)}function Q(e,t){const a=function(e,t){let a=e;for(;;){const e=W(a,t);if(!e)break;a=a.slice(0,e.startIndex)+a.slice(e.endIndex)}return a}(e,Y('think','contains')),n=function(e,t){const a=[];let n=e.length;for(;n>0;){const r=W(e,t,n);if(!r)break;a.unshift(r.content),n=r.startIndex}return a}(a,t),r=[];for(const e of n){const t=H(e.trim());G(t)||t&&r.push(t)}return r}const Z=new k;function q(e){if(!e)return'';const t=F(e);return function(e){if('string'!=typeof e)return null;const t=e.match(u);if(!t||!t[1])return null;try{const e=t[1],a=e.match(/"era-message-key"\s*=\s*"(.*?)"/),n=e.match(/"era-message-type"\s*=\s*"(.*?)"/);return a?.[1]&&n?.[1]?{'era-message-key':a[1],'era-message-type':n[1]}:null}catch{return null}}(t)?.['era-message-key']||''}async function X(e){if(!e||'number'!=typeof e.message_id||!e.role)return Z.warn('ensureMessageKey',`无效的消息对象结构，无法确保Key。msg=${JSON.stringify(e)}`),{mk:'',isNew:!1};const t=q(e);if(t)return{mk:t,isNew:!1};const a=`era_mk_${Date.now()}_${Math.random().toString(36).slice(2,8)}`,n='user'===e.role?'user':'assistant',r=`<${p}>{"era-message-key"="${a}","era-message-type"="${n}"}</${p}>`;Z.log('ensureMessageKey',`为消息 (ID: ${e.message_id}) 注入新的Key: ${a}`);const o=r+'\n'+(F(e)??'');return await K(e,o),{mk:a,isNew:!0}}const ee=async()=>{const e=getChatMessages(-1,{include_swipes:!0})?.[0];if(!e||'number'!=typeof e.message_id)return;const{mk:t}=await X(e);t&&await R(a=>{const n=_.get(a,c,[]);return n[e.message_id]!==t&&(n[e.message_id]=t,_.set(a,c,n)),a})},te=new k('scriptIniter-settings');async function ae(){te.log('initializeExternalSettings','开始初始化脚本设置...'),await L(async e=>(te.debug('initializeExternalSettings','当前设置:',e),e)),te.log('initializeExternalSettings','脚本设置初始化完成。')}$(()=>{ae()});const ne=new k,re={'.':'__DOT__','"':'__DQUOTE__','\'':'__SQUOTE__'},oe=_.invert(re),se=new RegExp(Object.keys(re).map(_.escapeRegExp).join('|'),'g'),ie=new RegExp(Object.values(re).map(_.escapeRegExp).join('|'),'g');function le(e){if(Array.isArray(e))return e.map(e=>le(e));if(_.isPlainObject(e)){const t={};for(const a in e)if(Object.prototype.hasOwnProperty.call(e,a)){t[a.replace(se,e=>re[e])]=le(e[a])}return t}return'string'==typeof e?e.replace(se,e=>re[e]):e}function de(e){if(Array.isArray(e))return e.map(e=>de(e));if(_.isPlainObject(e)){const t={};for(const a in e)if(Object.prototype.hasOwnProperty.call(e,a)){t[a.replace(ie,e=>oe[e])]=de(e[a])}return t}return'string'==typeof e?e.replace(ie,e=>oe[e]):e}function ce(e){if(Array.isArray(e))return e.map(e=>Array.isArray(e)||_.isPlainObject(e)?JSON.stringify(e):e);if(_.isPlainObject(e)){const t={};for(const a in e)t[a]=ce(e[a]);return t}return e}const pe=e=>{try{return JSON.stringify(e,null,2)}catch(e){return`<<stringify失败: ${e?.message||e}>>`}};function ue(e,t){return _.mergeWith(_.cloneDeep(e),_.cloneDeep(t),(e,t)=>{if(Array.isArray(e)||Array.isArray(t))return t})}function ge(e){if(Array.isArray(e))return e;if(e&&'object'==typeof e)return[e];if('string'==typeof e){const t=e.replace(/^\s*```(?:json)?\s*|\s*```\s*$/g,'');try{const e=JSON.parse(t);return Array.isArray(e)?e:[]}catch{return[]}}return[]}function fe(e){const t=[];if(!e||'string'!=typeof e)return t;const a=function(e){if(!e)return'';let t='',a=!1;for(let n=0;n<e.length;n++){const r=e[n];if('"'!==r||0!==n&&'\\'===e[n-1]||(a=!a),a){t+=r;continue}const o=e[n+1];if('/'===r&&'/'===o){const a=e.indexOf('\n',n+2);if(-1===a)break;t+='\n',n=a;continue}if('/'===r&&'*'===o){const t=e.indexOf('*/',n+2);if(-1===t)break;n=t+1;continue}if('<'===r&&'\x3c!--'===e.substring(n,n+4)){const t=e.indexOf('--\x3e',n+4);if(-1===t)break;n=t+2;continue}t+=r}return t}(e),n=a.trim();let r=0,o=-1,s=!1;for(let e=0;e<n.length;e++){const a=n[e];if('"'!==a||0!==e&&'\\'===n[e-1]||(s=!s),!s)if('{'===a)0===r&&(o=e),r++;else if('}'===a&&r>0&&(r--,0===r&&-1!==o)){const a=n.substring(o,e+1);try{const e=JSON.parse(a);t.push(e)}catch(e){ne.error(`JSONL 解析失败: ${e?.message||e}. 失败的片段: ${a}`,e)}o=-1}}return t}const me=new k,be=_.debounce(()=>{eventEmit(m),me.log('debouncedEmitApiWrite',`已触发合并后的 ${m} 事件。`)},50,{leading:!1,trailing:!0});function ve(e){const{stat:t,meta:a}=T(),n=I(t);me.debug('emitWriteDoneEvent','获取了最新的 ERA 数据并生成了纯净版',{stat:t,meta:a,statWithoutMeta:n});const r={...e,stat:de(t),statWithoutMeta:de(n),selectedMks:_.get(a,c,[]),editLogs:_.get(a,d,{})};me.debug('emitWriteDoneEvent','动态构建了完整的事件载荷',{inputPayload:e,fullPayload:r}),eventEmit(f,r),me.log('emitWriteDoneEvent',`已触发 ${f} 事件。操作: ${JSON.stringify(e.actions)}, MK: ${e.mk}, MsgID: ${e.message_id}, 连续处理次数: ${e.consecutiveProcessingCount}`)}const he=new k;async function ye(e){const t=pe(e.blockContent),a=`\n<${e.blockTag}>\n${t}\n</${e.blockTag}>`,n=await function(){const e=getChatMessages('0-{{lastMessageId}}',{include_swipes:!0});if(!e||0===e.length)return J.debug('findLastAiMessage','聊天记录为空, 未找到任何消息。'),null;for(let t=e.length-1;t>=0;t--){const a=e[t];if(!U(a))return J.debug('findLastAiMessage',`找到最后一条 AI 消息, ID: ${a.message_id}`),a}return J.debug('findLastAiMessage','未在聊天记录中找到任何 AI 消息。'),null}();if(!n)return void he.warn('performApiWrite','找不到任何 AI 消息，无法执行 API 写入。');const r=(F(n)??'')+a;he.log('performApiWrite',`实时写入 API 任务 (${e.blockTag}) 到消息 ID ${n.message_id}...`),await K(n,r),be()}function xe(e,t,a){const{type:n,detail:r}=e;var o,s;t.api=!0,n===g.INSERT_BY_OBJECT?ye({blockTag:'VariableInsert',blockContent:r}):n===g.UPDATE_BY_OBJECT?function(e){ye({blockTag:'VariableEdit',blockContent:e})}(r):n===g.INSERT_BY_PATH?(o=r.path,s=r.value,ye({blockTag:'VariableInsert',blockContent:_.set({},o,s)})):n===g.UPDATE_BY_PATH?function(e,t){ye({blockTag:'VariableEdit',blockContent:_.set({},e,t)})}(r.path,r.value):n===g.DELETE_BY_OBJECT?function(e){ye({blockTag:'VariableDelete',blockContent:e})}(r):n===g.DELETE_BY_PATH?function(e){ye({blockTag:'VariableDelete',blockContent:_.set({},e,{})})}(r.path):n===g.GET_CURRENT_VARS&&function(e){ve(e)}(a)}const we=new k;function ke(e,t,a,n){const r=t?_.get(e,t):e;if(void 0===r)return void we.warn('applyDeleteAtLevel',`VariableDelete 跳过：路径不存在 -> ${t||'(root)'}`);const o=_.get(r,['$meta','necessary']),s=_.get(a,'$meta'),i=_.isPlainObject(s)&&_.isEmpty(s)||_.has(a,['$meta','necessary']);if(_.isPlainObject(a)&&!_.isEmpty(a)){if('all'===o&&!i)return void we.warn('applyDeleteAtLevel',`VariableDelete 失败：路径 <${t}> 受 "necessary: all" 保护，其子节点无法被删除。`);for(const r of Object.keys(a)){ke(e,t?`${t}.${r}`:r,a[r],n)}return}if('self'===o||'all'===o)return void we.warn('applyDeleteAtLevel',`VariableDelete 失败：路径 <${t}> 受 "necessary: ${o}" 保护，无法被直接删除。`);if(''===t)return void we.error('applyDeleteAtLevel','VariableDelete 失败：不允许删除根对象。');const l=_.cloneDeep(r);_.unset(e,t),n.push({op:'delete',path:t,value_old:l}),we.debug('applyDeleteAtLevel',`成功删除节点: ${t}`)}const Ne=new k;function _e(e,t){if(!e)return;const a=_.get(e,'$template'),n=_.get(e,t);if(_.isPlainObject(a)&&_.isPlainObject(n)){Ne.debug('getInheritedTemplateContent',`为子节点 "${t}" 同时找到原型和特异性内容。\n      - 原型: ${JSON.stringify(a)}\n      - 特异性: ${JSON.stringify(n)}`);const e=ue(_.cloneDeep(a),n);return Ne.debug('getInheritedTemplateContent',`  - 合并后: ${JSON.stringify(e)}`),e}return _.isPlainObject(n)?(Ne.debug('getInheritedTemplateContent',`为子节点 "${t}" 只找到特异性内容: ${JSON.stringify(n)}`),n):_.isPlainObject(a)?(Ne.debug('getInheritedTemplateContent',`为子节点 "${t}" 只找到原型内容: ${JSON.stringify(a)}`),a):void Ne.debug('getInheritedTemplateContent',`在父级模板内容中未为子节点 "${t}" 找到任何可继承的规则。`)}const Ee=new k;function Ve(e,t,a,n,r,o){const s=function(e,t){const a=_.get(t,'$template');Ne.debug('resolveTemplate',`解析出的模板内容:\n    - 继承: ${JSON.stringify(e)}\n    - 父节点变量: ${JSON.stringify(a)}`);let n={};return n=ue(n,e),n=ue(n,a),Ne.debug('resolveTemplate',`合并后的最终模板内容: ${JSON.stringify(n)}`),_.isEmpty(n)?null:n}(r,o);Ee.debug('applyInsertAtLevel',`[入口] basePath: "${t||'root'}"`,{statData:_.cloneDeep(e)});const i=t?_.get(e,t):e;if(Ee.debug('applyInsertAtLevel',`[路径检查] at path: "${t||'root'}". currentNodeInVars 的值:`,i),t&&void 0===i){const r=function(e,t){if(Ne.debug('applyTemplateToPatch',`[进入] 模板内容: ${JSON.stringify(e)}, 补丁: ${JSON.stringify(t)}`),!_.isPlainObject(t))return Ne.debug('applyTemplateToPatch','[退出] 补丁不是一个普通对象，直接返回。'),t;if(!e)return Ne.debug('applyTemplateToPatch','[退出] 模板内容无效，直接返回补丁。'),t;if(_.isEmpty(t))return Ne.debug('applyTemplateToPatch','补丁为空对象，完全使用模板内容。'),_.cloneDeep(e);const a=ue(_.cloneDeep(e),t);return Ne.debug('applyTemplateToPatch',`合并模板与补丁后的结果: ${JSON.stringify(a)}`),a}(s,a),o=ce(r);return Ee.debug('applyInsertAtLevel',`最终插入数据 at ${t}:\n${JSON.stringify(o,null,2)}`),_.set(e,t,o),n.push({op:'insert',path:t,value_new:_.cloneDeep(o)}),void Ee.debug('applyInsertAtLevel',`原子性插入到新路径: ${t}`)}if(_.isPlainObject(i)&&_.isPlainObject(a)){Ee.debug('applyInsertAtLevel',`[递归补充] at path: "${t||'root'}"\n      - 当前层级模板 (localTplContent): ${JSON.stringify(s)}`);for(const r of Object.keys(a)){const o=t?`${t}.${r}`:r,l=a[r],d=_e(s,r);Ee.debug('applyInsertAtLevel',`  - 准备递归子节点: "${r}"\n      - 将传递给子节点的模板 (subInheritedContent): ${JSON.stringify(d)}`),Ve(e,o,l,n,d,i)}}else t&&Ee.warn('applyInsertAtLevel',`VariableInsert 失败：路径已存在且无法递归补充 -> ${t}`)}const Ce=new k;async function $e(e,t=!1){try{Ce.log('rollbackByMk',`开始回滚, MK=${e}`),await updateVariablesWith(t=>{const a=_.get(t,i,{}),n=_.get(t,l,{}),r=ge(_.get(a,[d,e]));if(!r||!r.length)return Ce.debug('rollbackByMk','EditLog 为空或无效，跳过回滚。'),t;for(let e=r.length-1;e>=0;e--){const t=r[e],a=String(t?.op||'').toLowerCase(),o=String(t?.path||'');o&&('insert'!==a?'update'!==a&&'delete'!==a||(void 0===t?.value_old?_.unset(n,o):_.set(n,o,_.cloneDeep(t.value_old))):_.unset(n,o))}return _.set(t,l,n),t},s),Ce.log('rollbackByMk',`回滚完成：MK=${e}`)}catch(t){Ce.error('rollbackByMk',`回滚异常：MK=${e} → ${t?.message||t}`,t)}}async function Se(e,t){Ce?.debug('findLatestNewValue',`开始为路径 <${e}> 从消息ID <${t}> 向上追溯历史值...`);const a=getChatMessages('0-{{lastMessageId}}',{include_swipes:!1});if(!a||a.length<1)return Ce?.debug('findLatestNewValue','消息历史为空，无法追溯。'),null;const n=a.findIndex(e=>e.message_id===t);if(-1===n)return Ce?.warn('findLatestNewValue',`错误：在消息列表中未找到起始消息ID: ${t}`),null;for(let t=n-1;t>=0;t--){const n=a[t],r=n?.message_id;if(Ce?.debug('findLatestNewValue',`[进度] 正在检查消息 (ID: ${r})，内容: "${(F(n)||'').substring(0,100)}..."`),U(n)||'number'!=typeof r)continue;const o=q(n);if(!o){Ce?.debug('findLatestNewValue',`[进度] 消息 (ID: ${r}) 无 MK，跳过。`);continue}const{meta:s}=T(),i=ge(_.get(s,[d,o]));if(i&&0!==i.length){Ce?.debug('findLatestNewValue',`[进度] 正在检查 MK ${o} 的 EditLog...\n${pe(i)}`);for(let t=i.length-1;t>=0;t--){const a=i[t];if(a&&a.path){if(a.path===e)return'delete'===a.op?(Ce?.error('findLatestNewValue',`>> 状态异常! 在消息(ID:${n.message_id}, MK:${o})中为路径 <${e}> 找到了 'delete' 记录。这表明 update 操作可能正在尝试修改一个已被删除的变量。`),null):(Ce?.debug('findLatestNewValue',`>> 成功! 在消息(ID:${n.message_id}, MK:${o})中找到精确路径 <${e}> 的值为: ${pe(a.value_new)}`),_.cloneDeep(a.value_new));if(e.startsWith(a.path+'.')){const t=e.substring(a.path.length+1),r=a.value_new;if(_.isPlainObject(r)&&_.has(r,t)){const e=_.get(r,t);return Ce?.debug('findLatestNewValue',`>> 成功! 在消息(ID:${n.message_id}, MK:${o})中找到父级路径 <${a.path}>, 并从中提取子路径 <${t}> 的值为: ${pe(e)}`),_.cloneDeep(e)}}}}}else Ce?.debug('findLatestNewValue',`[进度] MK ${o} 的 EditLog 为空，跳过。`)}return Ce?.debug('findLatestNewValue',`向上追溯未找到路径 ${e} 的任何历史值，将使用 null 作为旧值`),null}const Ae=new k;async function Oe(e,t,a,n,r,o){const s=t?_.get(e,t):e;if(void 0===s)return void Ae.warn('applyEditAtLevel',`VariableEdit 跳过：路径不存在 -> ${t||'(root)'}`);const i=_.get(s,['$meta','updatable'],!0),l=!1===i&&!0===_.get(a,['$meta','updatable']);if(!1!==i||l)for(const s of Object.keys(a)){const i=t?`${t}.${s}`:s,l=a[s];if(_.isPlainObject(l)){await Oe(e,i,l,n,r,o);continue}if(!_.has(e,i)){Ae.warn('applyEditAtLevel',`VariableEdit 失败：路径非法，无法写入 -> ${i}`);continue}Ae.debug('applyEditAtLevel',`[旧值查找] 准备为路径 <${i}> 从消息 ID <${r}> 向上追溯...`);let d=await Se(i,r);null===d?(d=_.get(e,i),Ae.debug('applyEditAtLevel',`[旧值查找] 追溯未找到历史值，从当前 stat_data 中获取到旧值: ${JSON.stringify(d)}`)):Ae.debug('applyEditAtLevel',`[旧值查找] 追溯成功，找到历史旧值: ${JSON.stringify(d)}`);const c=ce(l);_.set(e,i,c),n.push({op:'update',path:i,value_old:_.cloneDeep(d),value_new:_.cloneDeep(c)}),o.set(i,_.cloneDeep(c))}else Ae.warn('applyEditAtLevel',`VariableEdit 失败：路径 <${t}> 受 "$meta.updatable: false" 保护，无法被修改。`)}const Me=new k,De=async e=>{Me.debug('ApplyVarChangeForMessage','开始处理消息...',{msg:e});try{if(!e||'number'!=typeof e.message_id)return Me.warn('ApplyVarChangeForMessage','无效消息对象或缺少 message_id，退出'),null;const t=e.message_id,a=q(e);if(!a)return Me.debug('ApplyVarChangeForMessage',`消息 (ID: ${t}) 不含 MK，跳过变量写入。`),null;if(U(e))return Me.debug('ApplyVarChangeForMessage',`消息 (ID: ${t}) 为用户消息，跳过变量写入，但保留其 MK。`),a;const n=F(e)||'',r=Q(n,Y('VariableInsert','exact')),o=Q(n,Y('VariableEdit','exact')),s=Q(n,Y('VariableDelete','exact'));Me.debug('ApplyVarChangeForMessage','delete拿到的指令',s),r.length||o.length||s.length||Me.debug('ApplyVarChangeForMessage',`消息 (ID: ${t}) 未检测到变量修改标签。`);const i=r.flatMap(e=>fe(e)),l=o.flatMap(e=>fe(e)),c=s.flatMap(e=>fe(e)),p=le(i),u=le(l),g=le(c);Me.debug('ApplyVarChangeForMessage','数据转义完成',{before:{inserts:i,edits:l,deletes:c},after:{inserts:p,edits:u,deletes:g}});const f=[];await async function(e,t){if(e.length>0){await B(async e=>(Ee.debug('processInsertBlocks','[初始状态] 进入 processInsertBlocks 时的 statData:',_.cloneDeep(e)),e));for(const a of e)if(_.isPlainObject(a)&&!_.isEmpty(a))try{await B(e=>(Ee.debug('processInsertBlocks',`处理 insertRoot: ${JSON.stringify(a)}`),Ve(e,'',a,t,null,null),e))}catch(e){Ee.error('processInsertBlocks',`处理 insertRoot 失败: ${e?.message||e}`,e)}Ee.log('processInsertBlocks','所有 VariableInsert 操作完成')}}(p,f),await async function(e,t,a){if(e.length>0){const n=new Map;for(const r of e)if(_.isPlainObject(r)&&!_.isEmpty(r))try{await B(async e=>(Ae.debug('processEditBlocks',`处理 editRoot: ${JSON.stringify(r)}`),await Oe(e,'',r,t,a,n),e))}catch(e){Ae.error('processEditBlocks',`处理 editRoot 失败: ${e?.message||e}`,e)}Ae.log('processEditBlocks','所有 VariableEdit 操作完成')}}(u,f,t),await async function(e,t){if(e.length>0){for(const a of e)if(_.isPlainObject(a)&&!_.isEmpty(a))try{await B(e=>(we.debug('processDeleteBlocks',`处理 deleteRoot: ${JSON.stringify(a)}`),ke(e,'',a,t),e))}catch(e){we.error('processDeleteBlocks',`处理 deleteRoot 失败: ${e?.message||e}`,e)}we.log('processDeleteBlocks','所有 VariableDelete 操作完成')}}(g,f);try{await R(e=>{const n=Array.isArray(f)?f:ge(f);return Me.debug('ApplyVarChangeForMessage',`准备为 MK=${a} (MsgID=${t}) 写入 EditLog:\n${JSON.stringify(n,null,2)}`),_.set(e,[d,a],JSON.stringify(n)),e}),Me.debug('ApplyVarChangeForMessage',`成功为 MK=${a} 写入 EditLog。`)}catch(e){Me.error('ApplyVarChangeForMessage',`为 MK=${a} 写入 EditLogs 失败: ${e?.message||e}`,e)}return a}catch(e){return Me.error('ApplyVarChangeForMessage',`变量写入器异常: ${e?.message||e}`,e),null}},Ie=new k,Te=e=>{const t=q(e);return t||null},Be=async(e=!1)=>{e?Ie.warn('resyncStateOnHistoryChange','强制完全重算模式已启动！'):Ie.log('resyncStateOnHistoryChange','聊天记录变更，启动状态同步...');const t=getChatMessages('0-{{lastMessageId}}',{include_swipes:!0});Ie.debug('resyncStateOnHistoryChange','获取到的 allMessages:',t);const{meta:a}=T(),n=_.cloneDeep(_.get(a,c,[]));if(Ie.debug('resyncStateOnHistoryChange',`状态快照: oldSelectedMks.length=${n.length}, allMessages.length=${t?.length??0}`),!t||0===t.length)return void Ie.log('resyncStateOnHistoryChange','当前聊天记录为空，不执行任何操作，同步终止。');let r=-1;if(e)r=0,Ie.log('resyncStateOnHistoryChange','强制模式：设置重算起点为 0。');else if(t.length<n.length){Ie.log('resyncStateOnHistoryChange','检测到消息删除。');for(let e=t.length-1;e>=0;e--){const a=Te(t[e]),o=n[e];if(Ie.debug('resyncStateOnHistoryChange',`[删除-对齐检查] i=${e}, currentMk=${a}, recordedMk=${o}`),a===o){r=e+1,Ie.log('resyncStateOnHistoryChange',`找到对齐点于 message_id=${e} (MK=${a})。将从 ID ${r} 开始检查。`);break}}-1===r&&(r=0,Ie.log('resyncStateOnHistoryChange','未找到任何对齐点，将从头开始检查。'));const e=t.map(Te).filter(e=>e),a=n.filter(e=>e),o=_.difference(a,e);if(Ie.debug('resyncStateOnHistoryChange',`旧MK序列: [${a.join(', ')}]`),Ie.debug('resyncStateOnHistoryChange',`新MK序列: [${e.join(', ')}]`),Ie.debug('resyncStateOnHistoryChange',`计算出的被删除MK: [${o.join(', ')}]`),o.length>0&&(e=>{const{meta:t}=T();for(const a of e)if(a&&ge(_.get(t,[d,a])).length>0)return!1;return!0})(o)){Ie.log('resyncStateOnHistoryChange',`检测到被删除的 ${o.length} 条消息均不含变量修改，执行快速同步。`);const e=[];for(let a=0;a<t.length;a++)e[a]=Te(t[a]);return await R(t=>(_.set(t,c,e),t)),void Ie.log('resyncStateOnHistoryChange','快速同步完成，仅修正 SelectedMks 数组。')}}else if(t.length===n.length){Ie.log('resyncStateOnHistoryChange','检测到消息长度不变，可能为修改或切换。');for(let e=t.length-1;e>=0;e--){const a=Te(t[e]),o=n[e];Ie.debug('resyncStateOnHistoryChange',`[切换-对齐检查] i=${e}, currentMk=${a}, recordedMk=${o}`),a!==o&&(r=e)}-1===r?(r=t.length>0?t.length-1:0,Ie.log('resyncStateOnHistoryChange',`所有MK均匹配。启动模拟写入，强制重算最后一条消息 (ID: ${r})。`)):Ie.log('resyncStateOnHistoryChange',`找到最早的不匹配点于 message_id=${r}。将从该点开始重算。`)}else Ie.log('resyncStateOnHistoryChange','检测到消息添加。'),r=n.length,Ie.log('resyncStateOnHistoryChange',`新增消息的写入逻辑已由同步流程接管。将从新增消息 (ID: ${r}) 开始处理。`);if(r>-1){const e=n.slice(r).filter(e=>e);if(e.length>0){Ie.log('resyncStateOnHistoryChange',`准备回滚 ${e.length} 个MK: [${e.join(', ')}]`);for(const t of e.reverse())Ie.debug('resyncStateOnHistoryChange',`[回滚] 正在回滚 MK: ${t}`),await $e(t,!0);Ie.log('resyncStateOnHistoryChange','逆序回滚完成。')}}Ie.log('resyncStateOnHistoryChange',`从 ID ${r} 开始顺序重算...`);const o=n.slice(0,r);for(let e=r;e<t.length;e++){const a=t[e];Ie.debug('resyncStateOnHistoryChange',`[重算] 正在处理消息索引: ${e}`);const n=await De(a);o[e]=n}Ie.log('resyncStateOnHistoryChange','顺序重算完成。'),await R(e=>(_.set(e,c,o),e)),Ie.log('resyncStateOnHistoryChange','状态同步完成。')},Re=new k;async function je(e){const t=getChatMessages(e);if(!t||0===t.length)return void Re.warn('forceRenderMessage',`找不到消息ID为 ${e} 的消息。`);const a=t[0];await setChatMessages([{message_id:e,message:a.message}]),Re.debug('forceRenderMessage',`已使用 setChatMessages 刷新消息 ${e}。`)}const Le=new k;async function Pe(e,t,a){const{type:n}=e;Le.debug('handleSyncEvent',`事件 ${n} 触发状态同步流程...`);const r='manual_full_sync'===n;await Be(r),t.resync=!0,'combo_sync'!=n&&async function(){const e=getVariables({type:'script',script_id:getScriptId()});if(!_.get(e,'强制重载功能',!1))return void Re.debug('forceRenderRecentMessages','强制重载功能未启用, 跳过。');const t=_.get(e,'强制重载消息数',1);Re.log('forceRenderRecentMessages',`开始强制重载, 数量: ${t}`),await new Promise(e=>setTimeout(e,1e3));const a=getChatMessages('0-{{lastMessageId}}');if(!a||0===a.length)return void Re.warn('forceRenderRecentMessages','无法获取到任何消息, 终止重载。');const n=a.slice(-t);for(const e of n)Re.debug('forceRenderRecentMessages',`正在强制渲染消息: ${e.message_id}`),await je(e.message_id),await new Promise(e=>setTimeout(e,100));Re.log('forceRenderRecentMessages','强制重载完成。')}(),await ee(),ve(a)}const Je=new k;let ze=null;function Fe(){const e=w.mk;return e&&ze&&ze.mk===e?(Je.debug('updateConsecutiveMkCount',`连续处理写入/同步操作的 MK: ${e}。旧计数: ${ze.count}，新计数: ${ze.count+1}`),ze.count++):(Je.debug('updateConsecutiveMkCount',`新的写入/同步操作的 MK: ${e}。重置计数为 1。前一个 MK 是: ${ze?.mk}`),ze={mk:e,count:1}),ze.count}async function Ue(e,t){const{type:a}=e,n=A(a);let r=null;const o={rollback:!1,apply:!1,resync:!1,api:!1,apiWrite:!1};try{const{mk:s,message_id:i,isNewKey:l}=await(async()=>{try{const e=getChatMessages(-1,{include_swipes:!0})?.[0];if(Z.debug('ensureMkForLatestMessage',`获取到的最新消息对象 (msg): ${JSON.stringify(e)}`),!e||'number'!=typeof e.message_id)return Z.warn('ensureMkForLatestMessage','无法读取最新消息或其ID，退出'),{mk:'',message_id:null,isNewKey:!1};const{mk:t,isNew:a}=await X(e);return Z.log('ensureMkForLatestMessage',`已为最新消息 ${e.message_id} 确保 MK 存在。 (是否新建: ${a})`),{mk:t,message_id:e.message_id,isNewKey:a}}catch(e){return Z.error('ensureMkForLatestMessage',`确保MK时异常: ${e?.message||e}`,e),{mk:'',message_id:null,isNewKey:!1}}})();if(!s||null===i)return Je.warn('dispatchAndExecuteTask','无法获取有效的 MK 或消息 ID，跳过任务执行。'),t;w.mk=s,r=i,l&&s&&(t={mk:s,ignoreCount:1});const{shouldSkip:d,newIgnoreRule:c}=function(e,t,a){return a&&e===tavern_events.CHARACTER_MESSAGE_RENDERED&&t===a.mk?(Je.log('handleRedundantRenderEvent',`忽略由 MK (${a.mk}) 注入触发的冗余渲染事件。剩余忽略次数: ${a.ignoreCount-1}`),a.ignoreCount--,a.ignoreCount<=0&&(a=null,Je.log('handleRedundantRenderEvent','忽略次数用完')),{shouldSkip:!0,newIgnoreRule:a}):{shouldSkip:!1,newIgnoreRule:a}}(a,s,t);if(t=c,d)return t;Je.log('dispatchAndExecuteTask',`执行任务: ${a} (分组: ${n})`);const p={mk:s,message_id:r,actions:o,consecutiveProcessingCount:1};switch(n){case'INIT':ae(),p.consecutiveProcessingCount=Fe(),await Pe(e,o,p);break;case'SYNC':p.consecutiveProcessingCount=Fe(),await Pe(e,o,p);break;case'API':xe(e,o,p);break;case'UPDATE_MK_ONLY':await async function(){await ee()}()}}catch(e){Je.error('dispatchAndExecuteTask',`事件 ${a} 处理异常: ${e}`,e)}finally{w.mk=''}return t}const Ke=new k,He=[];let Ye=!1,We=!1,Ge=null;function Qe(e,t){Ke.debug('pushToQueue',`接收到事件: ${e}，已推入队列。`,{detail:t}),He.push({type:e,detail:t,timestamp:Date.now()}),async function(){if(We)return void Ke.debug('processQueue','已有处理函数在排队等待，本次调用忽略。');Ye&&(Ke.debug('processQueue','处理器忙碌，进入排队等待状态...'),We=!0,await new Promise(e=>{Ge=e}),We=!1,Ke.debug('processQueue','等待结束，获取到处理权。'));if(0===He.length)return void Ke.debug('processQueue','队列为空，无需处理。');Ye=!0,Ke.log('processQueue','处理器启动');const e=He[0];if('API'!==A(e.type)){const t=S.get(e.type)??300;Ke.log('processQueue',`启动事件收集窗口，等待 ${t}ms...`),await new Promise(e=>setTimeout(e,t))}Ke.debug('processQueue','事件收集窗口关闭，准备处理的队列内容:',JSON.stringify(He.map(e=>e.type)));let t=null;for(;He.length>0;){const e=He.splice(0,He.length),a=O(e);Ke.debug('processQueue',`开始处理一个新批次，包含 ${e.length} 个原始事件，合并后为 ${a.length} 个任务。`);for(const e of a){t=await Ue(e,t)}Ke.debug('processQueue','本轮批次处理完毕。')}if(Ye=!1,Ke.log('processQueue','处理器空闲，已释放锁。'),Ge){Ke.debug('processQueue','通知排队的处理器开始工作。');const e=Ge;Ge=null,e()}}()}const Ze=new k;$(()=>{registerMacroLike(/{{\s*ERA(-withmeta)?\s*:\s*([^}]+?)\s*}}/gi,(e,t,a,n)=>function(e){if(!e.includes('{{ERA'))return e;const{stat:t}=T();return t?e.replace(/{{\s*ERA(-withmeta)?\s*:\s*([^}]+?)\s*}}/gi,(e,a,n)=>{const r=n.trim(),o=!!a;let s;if(s='$ALLDATA'===r?t:_.get(t,r),void 0===s)return Ze.warn('parseEraMacros',`在 stat_data 中未找到路径 "${r}", 宏将替换为空字符串.`),'';const i=o?s:I(s),l=de(i);return Ze.debug('parseEraMacros',`宏替换数据反转义: ${r}`,{before:i,after:l}),'object'==typeof l&&null!==l?JSON.stringify(l):String(l)}):(Ze.warn('parseEraMacros','无法获取到 stat_data, 宏替换失败.'),e)}(t))});const qe=Vue,Xe={class:'action-buttons-card',role:'complementary','aria-label':'ERA 快捷操作'},et={class:'btns'},tt=(0,qe.defineComponent)({__name:'ActionButtons',setup(e){const t=new k('ui-ActionButtons');function a(){t.log('onFullSync','点击“完全重算变量”，发送 manual_full_sync 事件。'),eventEmit('manual_full_sync')}function n(){t.log('onLastSync','点击“重算最后一楼变量”，发送 manual_sync 事件。'),eventEmit('manual_sync')}return(e,t)=>((0,qe.openBlock)(),(0,qe.createElementBlock)(qe.Fragment,null,[(0,qe.createCommentVNode)(' 右侧操作卡：外层自包含，不依赖父组件样式 '),(0,qe.createElementVNode)('section',Xe,[(0,qe.createCommentVNode)(' 中文注释：操作卡容器 '),t[4]||(t[4]=(0,qe.createElementVNode)('h4',{class:'card-title'},'快捷操作',-1)),(0,qe.createCommentVNode)(' 中文注释：卡片标题 '),(0,qe.createElementVNode)('div',et,[(0,qe.createCommentVNode)(' 中文注释：按钮垂直栈 '),(0,qe.createElementVNode)('button',{class:'btn primary',title:'重新计算所有变量',onClick:(0,qe.withModifiers)(a,['stop'])},[(0,qe.createCommentVNode)(' 中文注释：主按钮 '),t[0]||(t[0]=(0,qe.createElementVNode)('span',{class:'ico','aria-hidden':'true'},'🔄',-1)),(0,qe.createCommentVNode)(' 中文注释：图标 '),t[1]||(t[1]=(0,qe.createElementVNode)('span',{class:'label'},'完全重算变量',-1)),(0,qe.createCommentVNode)(' 中文注释：文字 ')]),(0,qe.createElementVNode)('button',{class:'btn subtle',title:'只重算最新一楼的变量',onClick:(0,qe.withModifiers)(n,['stop'])},[(0,qe.createCommentVNode)(' 中文注释：次按钮 '),t[2]||(t[2]=(0,qe.createElementVNode)('span',{class:'ico','aria-hidden':'true'},'♻️',-1)),(0,qe.createCommentVNode)(' 中文注释：图标 '),t[3]||(t[3]=(0,qe.createElementVNode)('span',{class:'label'},'重算最后一楼变量',-1)),(0,qe.createCommentVNode)(' 中文注释：文字 ')])])])],2112))}});n(527);var at=n(42);const nt=(0,at.A)(tt,[['__scopeId','data-v-5766043a']]),rt={class:'settings-card',role:'region','aria-label':'ERA 设置'},ot=['aria-expanded'],st={class:'chev','aria-hidden':'true'},it={class:'content'},lt={class:'toolbar'},dt={class:'vars'},ct=['title'],pt={class:'var-editor'},ut={key:0,class:'switch'},gt=['onUpdate:modelValue'],ft=['onUpdate:modelValue','placeholder'],mt=['onUpdate:modelValue','placeholder'],bt=['onUpdate:modelValue','placeholder','onInput'],vt={class:'type-chip'},ht=(0,qe.defineComponent)({__name:'EraSettingsPanel',setup(e){const t=new k,a=(0,qe.ref)(!1),n=(0,qe.ref)([]),r=(0,qe.reactive)({}),o=(0,qe.reactive)({}),s=(0,qe.reactive)({});function i(e){try{return JSON.stringify(e,null,2)}catch{return String(e)}}function l(){try{t.debug('loadVars','尝试读取脚本设置...');const e=j();if(t.debug('loadVars','成功读取脚本设置:',e),!e||0===Object.keys(e).length)return t.warn('loadVars','设置对象为空，UI 将不会被填充。'),void(n.value=[]);n.value=[];for(const e of Object.keys(r))delete r[e];for(const e of Object.keys(o))delete o[e];for(const e of Object.keys(s))delete s[e];Object.entries(e).filter(([e])=>'开启悬浮球'!==e).forEach(([e,t])=>{const a='boolean'==typeof(s=t)?'boolean':'number'==typeof s&&Number.isFinite(s)?'number':'string'==typeof s?'string':'json';var s;n.value.push({key:e,value:t,type:a}),'json'===a?o[e]=i(t):r[e]=t})}catch(e){t.error('loadVars','读取脚本变量失败:',e),alert('读取 ERA 设置失败，请检查浏览器控制台获取详细信息。')}}function d(){a.value=!a.value,a.value&&0===n.value.length&&l()}function c(){l()}async function p(){try{await L(e=>{const t={...e};return Object.entries(r).forEach(([e,a])=>{t[e]=a}),Object.entries(o).forEach(([e,a])=>{if(null!=a){if(s[e]?.bad)throw new Error(`键 ${e} 的 JSON 格式不正确`);t[e]=JSON.parse(a)}}),t}),t.log('saveEdits','脚本变量已保存'),l()}catch(e){t.error('saveEdits','保存失败：',e),alert(`保存失败：${e?.message??e}`)}}return(e,t)=>((0,qe.openBlock)(),(0,qe.createElementBlock)(qe.Fragment,null,[(0,qe.createCommentVNode)(' 外层卡片：与 ActionButtons 保持一致的玻璃卡风格，但默认收起 '),(0,qe.createElementVNode)('section',rt,[(0,qe.createCommentVNode)(' 设置卡片容器 '),(0,qe.createCommentVNode)(' 标题行：可点击折叠/展开 '),(0,qe.createElementVNode)('button',{class:'card-header','aria-expanded':a.value,onClick:d},[(0,qe.createCommentVNode)(' 点击切换展开状态 '),t[0]||(t[0]=(0,qe.createElementVNode)('span',{class:'title'},'ERA 设置',-1)),(0,qe.createCommentVNode)(' 标题文字 '),(0,qe.createElementVNode)('span',st,(0,qe.toDisplayString)(a.value?'▾':'▸'),1),(0,qe.createCommentVNode)(' 展开箭头 ')],8,ot),(0,qe.createCommentVNode)(' 内容体：默认收起；展开后显示变量列表与操作 '),(0,qe.withDirectives)((0,qe.createElementVNode)('div',it,[(0,qe.createCommentVNode)(' 展开内容容器 '),(0,qe.createCommentVNode)(' 顶部操作区：刷新/保存/重置编辑 '),(0,qe.createElementVNode)('div',lt,[(0,qe.createCommentVNode)(' 工具条 '),(0,qe.createElementVNode)('button',{class:'mini-btn',title:'重新读取脚本变量',onClick:(0,qe.withModifiers)(l,['stop'])},'🔄 重新读取'),(0,qe.createCommentVNode)(' 读取按钮 '),t[1]||(t[1]=(0,qe.createElementVNode)('div',{class:'spacer'},null,-1)),(0,qe.createCommentVNode)(' 占位撑开 '),(0,qe.createElementVNode)('button',{class:'mini-btn subtle',title:'丢弃未保存的修改',onClick:(0,qe.withModifiers)(c,['stop'])},'↩︎ 丢弃修改'),(0,qe.createCommentVNode)(' 丢弃编辑 '),(0,qe.createElementVNode)('button',{class:'mini-btn primary',title:'保存修改到脚本变量',onClick:(0,qe.withModifiers)(p,['stop'])},'💾 保存修改'),(0,qe.createCommentVNode)(' 保存修改 ')]),(0,qe.createCommentVNode)(' 变量列表：逐项渲染 '),(0,qe.createElementVNode)('div',dt,[n.value.length>0?((0,qe.openBlock)(),(0,qe.createElementBlock)(qe.Fragment,{key:0},[(0,qe.createCommentVNode)(' 有变量时渲染列表 '),((0,qe.openBlock)(!0),(0,qe.createElementBlock)(qe.Fragment,null,(0,qe.renderList)(n.value,e=>{return(0,qe.openBlock)(),(0,qe.createElementBlock)('div',{key:e.key,class:'var-row'},[(0,qe.createCommentVNode)(' 每个变量一行 '),(0,qe.createElementVNode)('label',{class:'var-key',title:e.key},(0,qe.toDisplayString)(e.key),9,ct),(0,qe.createCommentVNode)(' 变量名 '),(0,qe.createCommentVNode)(' 根据变量类型选择不同的编辑控件 '),(0,qe.createElementVNode)('div',pt,[(0,qe.createCommentVNode)(' 编辑器容器 '),(0,qe.createCommentVNode)(' 布尔：勾选框 '),'boolean'===e.type?((0,qe.openBlock)(),(0,qe.createElementBlock)('label',ut,[(0,qe.createCommentVNode)(' 自定义开关外观 '),(0,qe.withDirectives)((0,qe.createElementVNode)('input',{'onUpdate:modelValue':t=>r[e.key]=t,type:'checkbox'},null,8,gt),[[qe.vModelCheckbox,r[e.key]]]),(0,qe.createCommentVNode)(' 勾选值 '),t[2]||(t[2]=(0,qe.createElementVNode)('span',{class:'track'},null,-1)),(0,qe.createCommentVNode)(' 轨道 ')])):'number'===e.type?((0,qe.openBlock)(),(0,qe.createElementBlock)(qe.Fragment,{key:1},[(0,qe.createCommentVNode)(' 数字：number 输入 '),(0,qe.withDirectives)((0,qe.createElementVNode)('input',{'onUpdate:modelValue':t=>r[e.key]=t,type:'number',class:'ipt',placeholder:String(e.value)},null,8,ft),[[qe.vModelText,r[e.key],void 0,{number:!0}]]),(0,qe.createCommentVNode)(' 数字输入 ')],64)):'string'===e.type?((0,qe.openBlock)(),(0,qe.createElementBlock)(qe.Fragment,{key:2},[(0,qe.createCommentVNode)(' 字符串：text 输入 '),(0,qe.withDirectives)((0,qe.createElementVNode)('input',{'onUpdate:modelValue':t=>r[e.key]=t,type:'text',class:'ipt',placeholder:String(e.value)},null,8,mt),[[qe.vModelText,r[e.key]]]),(0,qe.createCommentVNode)(' 文本输入 ')],64)):((0,qe.openBlock)(),(0,qe.createElementBlock)(qe.Fragment,{key:3},[(0,qe.createCommentVNode)(' 其他（对象/数组/null/未知）：JSON 文本域 '),(0,qe.withDirectives)((0,qe.createElementVNode)('textarea',{'onUpdate:modelValue':t=>o[e.key]=t,class:'ipt ta',placeholder:i(e.value),onInput:t=>function(e){const t=o[e]??'';if(''!==t.trim())try{JSON.parse(t),s[e]={ok:!0,bad:!1,msg:'JSON 格式有效'}}catch(t){s[e]={bad:!0,ok:!1,msg:`JSON 格式错误：${t?.message??''}`}}else s[e]={bad:!0,ok:!1,msg:'不能为空（若要设为 null 请写 null）'}}(e.key)},null,40,bt),[[qe.vModelText,o[e.key]]]),(0,qe.createCommentVNode)(' JSON 文本域 '),(0,qe.createElementVNode)('span',{class:(0,qe.normalizeClass)(['hint',{ok:s[e.key]?.ok,bad:s[e.key]?.bad}])},(0,qe.toDisplayString)(s[e.key]?.msg??'以 JSON 格式编辑此值'),3),(0,qe.createCommentVNode)(' JSON 校验提示 ')],64))]),(0,qe.createCommentVNode)(' 类型徽标 '),(0,qe.createElementVNode)('span',vt,(0,qe.toDisplayString)((a=e.type,'boolean'===a?'布尔':'number'===a?'数字':'string'===a?'字符串':'JSON')),1),(0,qe.createCommentVNode)(' 类型展示 ')]);var a}),128))],64)):((0,qe.openBlock)(),(0,qe.createElementBlock)(qe.Fragment,{key:1},[(0,qe.createCommentVNode)(' 没有变量时的占位 '),t[3]||(t[3]=(0,qe.createElementVNode)('div',{class:'placeholder'},[(0,qe.createElementVNode)('p',null,'未读取到任何脚本变量。'),(0,qe.createCommentVNode)(' 文本提示 '),(0,qe.createElementVNode)('p',{class:'dim'},[(0,qe.createTextVNode)(' 请先确保在 '),(0,qe.createElementVNode)('code',null,'app_ready'),(0,qe.createTextVNode)(' 或初始化阶段通过 '),(0,qe.createElementVNode)('code',null,'initializeExternalSettings()'),(0,qe.createTextVNode)(' 写入默认变量。 ')]),(0,qe.createCommentVNode)(' 辅助说明 ')],-1))],64))])],512),[[qe.vShow,a.value]])])],2112))}});n(917);const yt=(0,at.A)(ht,[['__scopeId','data-v-0fd50dba']]),xt=(0,qe.defineComponent)({__name:'FloatingBall',emits:['click'],setup(e){const t=new k('ui-FloatingBall');return(0,qe.onMounted)(()=>{t.log('onMounted','FloatingBall.vue 组件已挂载')}),(e,t)=>((0,qe.openBlock)(),(0,qe.createElementBlock)('div',{class:'floating-ball',onClick:t[0]||(t[0]=t=>e.$emit('click'))},[t[1]||(t[1]=(0,qe.createElementVNode)('span',{class:'era-logo','aria-hidden':'true'},'ERA',-1)),(0,qe.createCommentVNode)(' 仅显示用；不拦截事件 ')]))}});n(926);const wt=(0,at.A)(xt,[['__scopeId','data-v-ee0f5b22']]),kt={class:'acc'},Nt=['aria-expanded'],_t={class:'title'},Et={class:'hint'},Vt={class:'inner'},Ct=(0,qe.defineComponent)({__name:'EraAccordion',props:{title:{},defaultOpen:{type:Boolean,default:!1}},setup(e){const t=e,a=(0,qe.ref)(t.defaultOpen);return(t,n)=>((0,qe.openBlock)(),(0,qe.createElementBlock)('section',kt,[(0,qe.createCommentVNode)(' 折叠头：点击切换 '),(0,qe.createElementVNode)('button',{class:'acc-head','aria-expanded':a.value?'true':'false',onClick:n[0]||(n[0]=e=>a.value=!a.value)},[(0,qe.createElementVNode)('span',{class:(0,qe.normalizeClass)(['caret',{open:a.value}])},'▸',2),(0,qe.createCommentVNode)(' 指示箭头 '),(0,qe.createElementVNode)('span',_t,(0,qe.toDisplayString)(e.title),1),(0,qe.createCommentVNode)(' 标题文本 '),n[1]||(n[1]=(0,qe.createElementVNode)('span',{class:'spacer'},null,-1)),(0,qe.createCommentVNode)(' 弹性空隙 '),(0,qe.createElementVNode)('span',Et,(0,qe.toDisplayString)(a.value?'收起':'展开'),1),(0,qe.createCommentVNode)(' 右侧提示 ')],8,Nt),(0,qe.createCommentVNode)(' 内容：高度过渡（使用 CSS Grid） '),(0,qe.createElementVNode)('div',{class:(0,qe.normalizeClass)(['acc-body',{open:a.value}])},[(0,qe.createElementVNode)('div',Vt,[(0,qe.renderSlot)(t.$slots,'default')])],2)]))}});n(26);const $t=(0,at.A)(Ct,[['__scopeId','data-v-cb8a53de']]),St={class:'meta'},At={class:'kv'},Ot={class:'item'},Mt=['title'],Dt={class:'item'},It={class:'v'},Tt=(0,qe.defineComponent)({__name:'MetaHeader',props:{mk:{},messageId:{}},setup(e){const t=new k('ui-MetaHeader'),a=e;return(0,qe.onMounted)(()=>{t.log('onMounted','组件已挂载',{props:a})}),(0,qe.watch)(()=>a,e=>{t.debug('watch:props','Props 发生变化',{newProps:e})},{deep:!0}),(t,a)=>((0,qe.openBlock)(),(0,qe.createElementBlock)('section',St,[a[2]||(a[2]=(0,qe.createElementVNode)('h4',{class:'meta-title'},'最新消息元数据',-1)),(0,qe.createCommentVNode)(' 小节标题 '),(0,qe.createElementVNode)('div',At,[(0,qe.createElementVNode)('div',Ot,[a[0]||(a[0]=(0,qe.createElementVNode)('span',{class:'k'},'mk',-1)),(0,qe.createCommentVNode)(' 键：mk '),(0,qe.createElementVNode)('span',{class:'v',title:e.mk},(0,qe.toDisplayString)(e.mk||'—'),9,Mt),(0,qe.createCommentVNode)(' 值：mk ')]),(0,qe.createElementVNode)('div',Dt,[a[1]||(a[1]=(0,qe.createElementVNode)('span',{class:'k'},'message_id',-1)),(0,qe.createCommentVNode)(' 键：message_id '),(0,qe.createElementVNode)('span',It,(0,qe.toDisplayString)(e.messageId??'—'),1),(0,qe.createCommentVNode)(' 值：message_id ')])]),a[3]||(a[3]=(0,qe.createElementVNode)('div',{class:'glow'},null,-1)),(0,qe.createCommentVNode)(' 装饰：流光条 ')]))}});n(848);const Bt=(0,at.A)(Tt,[['__scopeId','data-v-56f5fbd7']]),Rt={class:'node'},jt={class:'key'},Lt={class:'brace'},Pt={key:0,class:'summary'},Jt={key:0,class:'json-children'},zt={class:'brace'};const Ft=(0,qe.defineComponent)({name:'JsonNode',props:{k:{type:[String,Number],required:!0},v:{required:!0},path:{type:String,required:!0},level:{type:Number,required:!0},defaultCollapsed:{type:Boolean,default:!0},maxDepth:{type:Number,default:3}},setup(e){const t=new k;(0,qe.onMounted)(()=>{t.debug('onMounted','组件已挂载',{props:e})});const a=(0,qe.computed)(()=>{const t=e.v;if(null===t)return'null';if(Array.isArray(t))return'array';const a=typeof t;return'object'===a?'object':'undefined'===a?'undefined':a}),n=(0,qe.computed)(()=>'array'===a.value),r=(0,qe.computed)(()=>'object'===a.value),o=(0,qe.computed)(()=>n.value||r.value),s=(0,qe.ref)(e.level<=(e.maxDepth??3)||!e.defaultCollapsed);(0,qe.watch)(s,e=>{t.debug('watch:open','折叠状态改变为: '+(e?'展开':'收起'))});const i=(0,qe.computed)(()=>{const t=e.v;switch(a.value){case'string':return JSON.stringify(t);case'number':case'symbol':return String(t);case'boolean':return t?'true':'false';case'null':return'null';case'undefined':return'undefined';case'bigint':return String(t)+'n';case'function':return'ƒ()';default:return''}}),l=(0,qe.computed)(()=>n.value?`Array[${e.v.length}]`:r.value?`Object{${Object.keys(e.v||{}).length}}`:''),d=(0,qe.computed)(()=>{if(r.value)return e.v;if(n.value){const t={};return e.v.forEach((e,a)=>{t[String(a)]=e}),t}return{}});return{type:a,isArray:n,foldable:o,open:s,primitiveText:i,summary:l,childEntries:d}}});n(986);const Ut=(0,at.A)(Ft,[['render',function(e,t,a,n,r,o){const s=(0,qe.resolveComponent)('JsonNode',!0);return(0,qe.openBlock)(),(0,qe.createElementBlock)(qe.Fragment,null,[(0,qe.createCommentVNode)(' 单条节点（支持递归） '),(0,qe.createElementVNode)('div',Rt,[(0,qe.createCommentVNode)(' 每个键值对 / 数组项的容器 '),(0,qe.createElementVNode)('div',{class:'json-line',style:(0,qe.normalizeStyle)({paddingLeft:14*e.level+'px'})},[(0,qe.createCommentVNode)(' 行+缩进 '),e.foldable?((0,qe.openBlock)(),(0,qe.createElementBlock)('button',{key:0,class:(0,qe.normalizeClass)(['caret',{open:e.open}]),'aria-label':'toggle',onClick:t[0]||(t[0]=t=>e.open=!e.open)},'▸',2)):(0,qe.createCommentVNode)('v-if',!0),(0,qe.createCommentVNode)(' 折叠箭头按钮 '),(0,qe.createElementVNode)('span',jt,(0,qe.toDisplayString)(e.k),1),t[1]||(t[1]=(0,qe.createElementVNode)('span',{class:'colon'},':',-1)),(0,qe.createCommentVNode)(' 键与冒号 '),(0,qe.createCommentVNode)(' 可折叠容器：只显示括号与摘要；展开后由下方 children 区域递归渲染 '),e.foldable?((0,qe.openBlock)(),(0,qe.createElementBlock)(qe.Fragment,{key:1},[(0,qe.createElementVNode)('span',Lt,(0,qe.toDisplayString)(e.isArray?'[':'{'),1),(0,qe.createCommentVNode)(' 容器起始括号 '),e.open?(0,qe.createCommentVNode)('v-if',!0):((0,qe.openBlock)(),(0,qe.createElementBlock)('span',Pt,(0,qe.toDisplayString)(e.summary),1)),(0,qe.createCommentVNode)(' 收起时的摘要 ')],64)):((0,qe.openBlock)(),(0,qe.createElementBlock)(qe.Fragment,{key:2},[(0,qe.createCommentVNode)(' 原始值：直接着色渲染 '),(0,qe.createElementVNode)('span',{class:(0,qe.normalizeClass)(['val',e.type])},(0,qe.toDisplayString)(e.primitiveText),3),(0,qe.createCommentVNode)(' 原始值文本 ')],64))],4),(0,qe.createCommentVNode)(' 子元素区域：仅当可折叠且处于展开态时显示 '),e.foldable&&e.open?((0,qe.openBlock)(),(0,qe.createElementBlock)('div',Jt,[(0,qe.createCommentVNode)(' 递归：自引用同名组件 JsonNode（依赖 name: \'JsonNode\' 实现自递归） '),((0,qe.openBlock)(!0),(0,qe.createElementBlock)(qe.Fragment,null,(0,qe.renderList)(e.childEntries,(t,a)=>((0,qe.openBlock)(),(0,qe.createBlock)(s,{key:e.path+'/'+String(a),k:String(a),v:t,path:e.path+'/'+String(a),level:e.level+1,'default-collapsed':e.defaultCollapsed,'max-depth':e.maxDepth},null,8,['k','v','path','level','default-collapsed','max-depth']))),128)),(0,qe.createElementVNode)('div',{class:'json-line',style:(0,qe.normalizeStyle)({paddingLeft:14*e.level+'px'})},[(0,qe.createElementVNode)('span',zt,(0,qe.toDisplayString)(e.isArray?']':'}'),1),(0,qe.createCommentVNode)(' 容器闭合括号 ')],4)])):(0,qe.createCommentVNode)('v-if',!0)])],2112)}],['__scopeId','data-v-34fc6c00']]),Kt={class:'json-root'},Ht={class:'json-line'},Yt={class:'brace'},Wt={class:'json-children'},Gt={key:1,class:'json-line',style:{paddingLeft:'14px'}},Qt={class:'json-line'},Zt={class:'brace'},qt=(0,qe.defineComponent)({__name:'PrettyJsonViewer',props:{value:{},defaultCollapsed:{type:Boolean,default:!0},maxDepth:{default:3}},setup(e){const t=new k,a=e,n=(0,qe.computed)(()=>{const e=a.value,n=null!==e&&'object'==typeof e;return t.debug('isPlainObjectOrArray',`计算结果: ${n}。该值${n?'是':'不是'}普通对象或数组。`,{传入值:e}),n}),r=(0,qe.computed)(()=>{const e=a.value;let n;if(null===e)n='null';else if(Array.isArray(e))n='array';else{const t=typeof e;n='undefined'===t?'undefined':t}return t.debug('primitiveType',`计算原始值类型: ${n}`,{传入值:e}),n}),o=(0,qe.computed)(()=>{const e=a.value;let n;switch(r.value){case'string':n=JSON.stringify(e);break;case'number':case'symbol':n=String(e);break;case'boolean':n=e?'true':'false';break;case'null':n='null';break;case'undefined':n='undefined';break;case'bigint':n=String(e)+'n';break;case'function':n='ƒ()';break;default:n=''}return t.debug('primitiveText',`格式化原始值文本: "${n}"`,{传入值:e,类型:r.value}),n}),s=(0,qe.computed)(()=>{const e=Array.isArray(a.value);return t.debug('isArrayRoot',`计算根节点是否为数组: ${e}`,{传入值:a.value}),e}),i=(0,qe.computed)(()=>s.value?'[':'{'),l=(0,qe.computed)(()=>s.value?']':'}');return(t,a)=>((0,qe.openBlock)(),(0,qe.createElementBlock)('div',Kt,[(0,qe.createElementVNode)('div',Ht,[(0,qe.createElementVNode)('span',Yt,(0,qe.toDisplayString)(i.value),1),(0,qe.createCommentVNode)(' 根开括号：对象{ / 数组[ ')]),(0,qe.createElementVNode)('div',Wt,[n.value?((0,qe.openBlock)(!0),(0,qe.createElementBlock)(qe.Fragment,{key:0},(0,qe.renderList)(e.value,(t,a)=>((0,qe.openBlock)(),(0,qe.createBlock)(Ut,{key:String(a),k:String(a),v:t,path:String(a),level:1,'default-collapsed':e.defaultCollapsed,'max-depth':e.maxDepth},null,8,['k','v','path','default-collapsed','max-depth']))),128)):((0,qe.openBlock)(),(0,qe.createElementBlock)('div',Gt,[a[0]||(a[0]=(0,qe.createElementVNode)('span',{class:'key'},'value',-1)),a[1]||(a[1]=(0,qe.createElementVNode)('span',{class:'colon'},':',-1)),(0,qe.createElementVNode)('span',{class:(0,qe.normalizeClass)(['val',r.value])},(0,qe.toDisplayString)(o.value),3)]))]),(0,qe.createElementVNode)('div',Qt,[(0,qe.createElementVNode)('span',Zt,(0,qe.toDisplayString)(l.value),1),(0,qe.createCommentVNode)(' 根闭括号：对象} / 数组] ')])]))}});n(472);const Xt=(0,at.A)(qt,[['__scopeId','data-v-036df356']]),ea={class:'tabs'},ta={class:'tab-bar',role:'tablist'},aa=['onClick'],na={class:'tab-content'},ra={key:0},oa={key:1},sa=(0,qe.defineComponent)({__name:'TabSwitch',props:{tabs:{},active:{}},emits:['update:active'],setup(e,{emit:t}){const a=new k('ui-TabSwitch'),n=e,r=t,o=(0,qe.ref)(n.active??'pure');return(0,qe.watch)(()=>n.active,e=>{e&&(a.debug('watch:active',`外部同步 active tab 为: ${e}`),o.value=e)}),(0,qe.onMounted)(()=>{a.log('onMounted','组件已挂载',{props:n})}),(t,n)=>((0,qe.openBlock)(),(0,qe.createElementBlock)('section',ea,[(0,qe.createCommentVNode)(' 页签行 '),(0,qe.createElementVNode)('div',ta,[((0,qe.openBlock)(!0),(0,qe.createElementBlock)(qe.Fragment,null,(0,qe.renderList)(e.tabs,e=>((0,qe.openBlock)(),(0,qe.createElementBlock)('button',{key:e.key,class:(0,qe.normalizeClass)(['tab-btn',{active:e.key===o.value}]),role:'tab',onClick:t=>{return n=e.key,a.log('setActive',`用户点击，切换 tab 到: ${n}`),o.value=n,void r('update:active',n);var n}},(0,qe.toDisplayString)(e.label),11,aa))),128))]),(0,qe.createCommentVNode)(' 内容区：根据活动键渲染对应插槽 '),(0,qe.createElementVNode)('div',na,['pure'===o.value?((0,qe.openBlock)(),(0,qe.createElementBlock)('div',ra,[(0,qe.renderSlot)(t.$slots,'pure'),(0,qe.createCommentVNode)(' 纯净状态数据内容 ')])):((0,qe.openBlock)(),(0,qe.createElementBlock)('div',oa,[(0,qe.renderSlot)(t.$slots,'full'),(0,qe.createCommentVNode)(' 完整状态数据内容 ')]))])]))}});n(226);const ia=(0,at.A)(sa,[['__scopeId','data-v-7ab146e6']]),la={class:'era-app-container'},da={class:'era-expanded-layer'},ca={class:'era-shell'},pa={class:'era-panel'},ua={class:'panel-top'},ga={class:'panel-body'},fa={style:{display:'flex','flex-direction':'column',gap:'8px'}},ma={class:'right-rail'},ba=(0,qe.defineComponent)({__name:'App',props:{initialView:{type:String,required:!0,default:'FloatingBall'},eventData:{type:Object,default:()=>null}},setup(e){const t=new k('ui-App'),a=e,n=(0,qe.ref)(a.initialView),r=e=>{t.debug('requestSwitchView',`请求切换视图到: ${e}`),window.eraUiSwitchView?window.eraUiSwitchView(e):t.warn('requestSwitchView','全局切换函数 eraUiSwitchView 未找到')},o=(0,qe.computed)(()=>a.eventData||null),s=[{key:'pure',label:'纯净状态数据'},{key:'full',label:'完整状态数据'}],i=(0,qe.ref)('pure');return(0,qe.onMounted)(()=>{t.log('onMounted','App.vue 组件已挂载',{props:a})}),(0,qe.watch)(()=>a.eventData,(e,a)=>{t.debug('watch:eventData','eventData prop 发生变化',{newData:e,oldData:a})},{deep:!0}),(0,qe.watch)(()=>a.initialView,e=>{t.debug('watch:initialView',`initialView prop 发生变化，新视图: ${e}`),n.value=e}),(e,t)=>((0,qe.openBlock)(),(0,qe.createElementBlock)('div',la,[(0,qe.withDirectives)((0,qe.createVNode)(wt,{onClick:t[0]||(t[0]=e=>r('ExpandedView'))},null,512),[[qe.vShow,'FloatingBall'===n.value]]),(0,qe.withDirectives)((0,qe.createElementVNode)('div',da,[(0,qe.createCommentVNode)(' 视口级展开层：悬浮模态容器 '),(0,qe.createElementVNode)('div',ca,[(0,qe.createCommentVNode)(' 新增横向壳容器：左面板 + 右侧栏 '),(0,qe.createCommentVNode)(' 中文注释：横向布局容器 '),(0,qe.createElementVNode)('div',pa,[(0,qe.createCommentVNode)(' 保持面板原有结构不变 '),(0,qe.createCommentVNode)(' 中文注释：左侧 ERA 面板 '),(0,qe.createCommentVNode)(' 顶部栏：标题 + 关闭按钮 '),(0,qe.createCommentVNode)(' 中文注释：面板顶部 '),(0,qe.createElementVNode)('header',ua,[(0,qe.createCommentVNode)(' 中文注释：顶栏 '),t[3]||(t[3]=(0,qe.createElementVNode)('h3',{class:'panel-title'},'ERA 数据面板',-1)),(0,qe.createCommentVNode)(' 中文注释：标题 '),(0,qe.createElementVNode)('button',{class:'btn-close','aria-label':'关闭',onClick:t[1]||(t[1]=e=>r('FloatingBall'))},'×'),(0,qe.createCommentVNode)(' 中文注释：关闭按钮 ')]),(0,qe.createCommentVNode)(' 内容区（原样保留） '),(0,qe.createCommentVNode)(' 中文注释：面板主体 '),(0,qe.createElementVNode)('div',ga,[(0,qe.createCommentVNode)(' 中文注释：可滚动内容 '),o.value?((0,qe.openBlock)(),(0,qe.createElementBlock)(qe.Fragment,{key:0},[(0,qe.createCommentVNode)(' 中文注释：有数据则渲染 '),(0,qe.createVNode)(Bt,{mk:o.value.mk,'message-id':o.value.message_id},null,8,['mk','message-id']),(0,qe.createCommentVNode)(' 中文注释：最新消息元数据 '),(0,qe.createVNode)($t,{title:'ERA 最新操作详情','default-open':!1},{default:(0,qe.withCtx)(()=>[(0,qe.createCommentVNode)(' 中文注释：插槽 '),(0,qe.createElementVNode)('div',fa,[(0,qe.createCommentVNode)(' 中文注释：堆叠两个子折叠 '),(0,qe.createVNode)($t,{title:'SelectedMks（数组）','default-open':!1},{default:(0,qe.withCtx)(()=>[(0,qe.createCommentVNode)(' 中文注释：插槽 '),(0,qe.createVNode)(Xt,{value:o.value.selectedMks,'default-collapsed':!0,'max-depth':3},null,8,['value']),(0,qe.createCommentVNode)(' 中文注释：JSON 视图 ')]),_:1}),(0,qe.createVNode)($t,{title:'EditLogs（对象）','default-open':!1},{default:(0,qe.withCtx)(()=>[(0,qe.createCommentVNode)(' 中文注释：插槽 '),(0,qe.createVNode)(Xt,{value:o.value.editLogs,'default-collapsed':!0,'max-depth':2},null,8,['value']),(0,qe.createCommentVNode)(' 中文注释：JSON 视图 ')]),_:1})])]),_:1}),(0,qe.createVNode)(ia,{active:i.value,'onUpdate:active':t[2]||(t[2]=e=>i.value=e),tabs:s},{pure:(0,qe.withCtx)(()=>[(0,qe.createCommentVNode)(' 中文注释：纯净状态数据 '),(0,qe.createVNode)(Xt,{value:o.value.statWithoutMeta,'default-collapsed':!0,'max-depth':1/0},null,8,['value']),(0,qe.createCommentVNode)(' 中文注释：JSON 视图 ')]),full:(0,qe.withCtx)(()=>[(0,qe.createCommentVNode)(' 中文注释：完整状态数据 '),(0,qe.createVNode)(Xt,{value:o.value.stat,'default-collapsed':!0,'max-depth':1/0},null,8,['value']),(0,qe.createCommentVNode)(' 中文注释：JSON 视图 ')]),_:1},8,['active'])],64)):((0,qe.openBlock)(),(0,qe.createElementBlock)(qe.Fragment,{key:1},[(0,qe.createCommentVNode)(' 中文注释：暂无数据占位 '),t[4]||(t[4]=(0,qe.createElementVNode)('div',{class:'empty'},'等待 era:writeDone 事件数据…',-1)),(0,qe.createCommentVNode)(' 中文注释：占位提示 ')],64))])]),(0,qe.createCommentVNode)(' 右侧固定栏：只改变“位置/外部结构”，不改按钮逻辑 '),(0,qe.createElementVNode)('aside',ma,[(0,qe.createCommentVNode)(' 中文注释：右侧栏容器 '),(0,qe.createVNode)(nt),(0,qe.createCommentVNode)(' 中文注释：操作按钮组件（事件保持不变） '),(0,qe.createVNode)(yt)])])],512),[[qe.vShow,'ExpandedView'===n.value]])]))}});n(840),n(354);const va=(0,at.A)(ba,[['__scopeId','data-v-57305d87']]);const ha=new k('ui-index');let ya=null,xa=null,wa='FloatingBall',ka=null;function Na(t,a){ha.debug('renderApp',`开始渲染 App，视图: ${t}`,{dataToPass:a}),xa?(_a(),ya=(0,qe.createApp)(va,{initialView:t,eventData:a}),ya.use(e()),ya.mount(xa[0]),function(){const e=getScriptId();$(`head > div[script_id="${e}"]`).remove();const t=$('<div>').attr('script_id',e).append($('head > style',document).clone());$('head').append(t)}(),ha.debug('renderApp','渲染完成')):ha.warn('renderApp','挂载点不存在，渲染中止')}function _a(){ya&&(ha.debug('unmountVueApp','卸载 Vue 实例'),ya.unmount(),ya=null)}function Ea(){ha.log('unloadUI','UI 脚本开始卸载'),_a(),$(`head > div[script_id="${getScriptId()}"]`).remove(),xa&&(ha.debug('unloadUI','销毁挂载点'),$(`div#era-ui-mount-point-${getScriptId()}`).remove(),xa=null),ha.log('unloadUI','UI 脚本卸载完成')}window.eraUiSwitchView=function(e){ha.debug('switchView',`请求切换视图到: ${e}`),wa!==e?(wa=e,ha.log('switchView','视图已切换，重新渲染 App'),Na(e,ka)):ha.debug('switchView',`视图已经是 ${e}，无需切换`)},$(()=>{if(!1===j()['开启悬浮球'])return ha.log('initialize','UI ahow ball disabled, attempting to unload...'),void Ea();ha.log('initialize','UI 脚本开始初始化'),xa=$('<div>').attr('id',`era-ui-mount-point-${getScriptId()}`).css({position:'fixed',bottom:'20px',left:'20px','z-index':1e4}),ha.debug('$(document).ready','创建挂载点',xa),$('body').append(xa),ha.debug('$(document).ready','挂载点已添加到 body'),Na(wa,ka),eventOn('era:writeDone',e=>{ha.log('era:writeDone','接收到 era:writeDone 事件，准备刷新 UI',e),ka=e,Na(wa,ka)}),ha.debug('$(document).ready','已设置 era:writeDone 事件监听器')}),$(window).on('pagehide',Ea);[...E.INIT,...E.SYNC,...E.API,...E.UPDATE_MK_ONLY,...E.COLLISION_DETECTORS,...E.COMBO_STARTERS].forEach(e=>{eventOn(e,t=>Qe(e,t))}),eventOn(getButtonEvent('写入变量修改'),()=>Qe('manual_write')),eventOn(getButtonEvent('手动同步状态'),()=>Qe('manual_sync')),eventOn(getButtonEvent('强制完全重算'),()=>Qe('manual_full_sync'));