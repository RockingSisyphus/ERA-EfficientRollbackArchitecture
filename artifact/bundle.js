import{createPinia as e}from"https://testingcf.jsdelivr.net/npm/pinia/+esm";var t={42:(e,t)=>{t.A=(e,t)=>{const a=e.__vccOpts||e;for(const[e,n]of t)a[e]=n;return a}},43:(e,t,a)=>{a.r(t),a.d(t,{default:()=>l});var n=a(93),r=a.n(n),o=a(54),s=a.n(o)()(r());s.push([e.id,".era-panel[data-v-c606c8d0]{width:min(960px,60vw);height:min(680px,86vh);display:flex;flex-direction:column;background:linear-gradient(180deg,rgba(255,255,255,0.75),rgba(255,255,255,0.65));border:1px solid rgba(255,255,255,0.6);backdrop-filter:blur(10px);border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,0.18),inset 0 1px 0 rgba(255,255,255,0.6);overflow:hidden;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}.panel-top[data-v-c606c8d0]{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid rgba(0,0,0,0.06);background:linear-gradient(90deg,rgba(255,255,255,0.65),rgba(255,255,255,0.45))}.panel-title[data-v-c606c8d0]{font-size:16px;font-weight:800;letter-spacing:0.5px;color:#1f2937}.btn-close[data-v-c606c8d0]{width:32px;height:32px;line-height:30px;text-align:center;border-radius:8px;border:1px solid rgba(0,0,0,0.08);background:#fff;cursor:pointer;font-size:18px;color:#6b7280;box-shadow:0 2px 8px rgba(0,0,0,0.08)}.btn-close[data-v-c606c8d0]:hover{transform:translateY(-1px);box-shadow:0 6px 16px rgba(0,0,0,0.12)}.panel-body[data-v-c606c8d0]{padding:14px 14px 16px;overflow:auto}.block[data-v-c606c8d0]{margin:12px 0 4px;padding:10px 12px;background:rgba(255,255,255,0.6);border:1px solid rgba(0,0,0,0.06);border-radius:12px}.block-title[data-v-c606c8d0]{margin:0 0 8px;font-size:13px;font-weight:800;color:#374151}.chips[data-v-c606c8d0]{display:flex;flex-wrap:wrap;gap:8px}.chip[data-v-c606c8d0]{font-size:12px;padding:6px 8px;border:1px solid rgba(0,0,0,0.06);border-radius:999px;background:linear-gradient(180deg,#fafafa,#f4f4f4);color:#6b7280;box-shadow:inset 0 1px 0 #fff}.chip.ok[data-v-c606c8d0]{color:#065f46;background:linear-gradient(180deg,#ecfdf5,#d1fae5);border-color:#a7f3d0}.mk-strip[data-v-c606c8d0]{display:flex;gap:8px;flex-wrap:wrap;max-height:140px;overflow:auto}.mk-pill[data-v-c606c8d0]{display:inline-flex;gap:6px;align-items:center;padding:6px 8px;background:linear-gradient(180deg,#eef2ff,#e0e7ff);color:#4338ca;border:1px solid #c7d2fe;border-radius:8px;font-size:12px}.mk-pill.is-null[data-v-c606c8d0]{background:linear-gradient(180deg,#f9fafb,#f3f4f6);color:#6b7280;border-color:#e5e7eb}.empty[data-v-c606c8d0]{height:360px;display:grid;place-items:center;color:#6b7280;font-size:14px;border:1px dashed rgba(0,0,0,0.08);border-radius:12px;background:rgba(255,255,255,0.5)}\n",""]);const l=s},54:e=>{e.exports=function(e){var t=[];return t.toString=function(){return this.map(function(t){var a="",n=void 0!==t[5];return t[4]&&(a+="@supports (".concat(t[4],") {")),t[2]&&(a+="@media ".concat(t[2]," {")),n&&(a+="@layer".concat(t[5].length>0?" ".concat(t[5]):""," {")),a+=e(t),n&&(a+="}"),t[2]&&(a+="}"),t[4]&&(a+="}"),a}).join("")},t.i=function(e,a,n,r,o){"string"==typeof e&&(e=[[null,e,void 0]]);var s={};if(n)for(var l=0;l<this.length;l++){var i=this[l][0];null!=i&&(s[i]=!0)}for(var c=0;c<e.length;c++){var d=[].concat(e[c]);n&&s[d[0]]||(void 0!==o&&(void 0===d[5]||(d[1]="@layer".concat(d[5].length>0?" ".concat(d[5]):""," {").concat(d[1],"}")),d[5]=o),a&&(d[2]?(d[1]="@media ".concat(d[2]," {").concat(d[1],"}"),d[2]=a):d[2]=a),r&&(d[4]?(d[1]="@supports (".concat(d[4],") {").concat(d[1],"}"),d[4]=r):d[4]="".concat(r)),t.push(d))}},t}},57:(e,t,a)=>{a.r(t),a.d(t,{default:()=>l});var n=a(93),r=a.n(n),o=a(54),s=a.n(o)()(r());s.push([e.id,".meta[data-v-26691347]{position:relative;padding:12px 12px 14px;border:1px solid rgba(0,0,0,0.06);border-radius:12px;background:linear-gradient(180deg,#ffffff,#f9fafb);box-shadow:0 6px 18px rgba(0,0,0,0.06),inset 0 1px 0 #fff}.meta-title[data-v-26691347]{margin:0 0 10px;font-size:13px;font-weight:800;color:#374151}.kv[data-v-26691347]{display:grid;grid-template-columns:120px 1fr;gap:8px 12px}.item[data-v-26691347]{display:contents}.k[data-v-26691347]{justify-self:start;align-self:center;font-size:12px;color:#6b7280;background:#f3f4f6;border:1px solid #e5e7eb;padding:4px 8px;border-radius:8px;font-weight:700}.v[data-v-26691347]{align-self:center;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;color:#111827;background:#fff;border:1px solid #e5e7eb;padding:6px 8px;border-radius:8px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.glow[data-v-26691347]{position:absolute;left:12px;right:12px;top:-1px;height:3px;border-radius:999px;background:linear-gradient(90deg,#60a5fa,#a78bfa,#34d399,#f472b6);filter:blur(0.4px)}\n",""]);const l=s},93:e=>{e.exports=function(e){return e[1]}},137:(e,t,a)=>{var n=a(157);n.__esModule&&(n=n.default),"string"==typeof n&&(n=[[e.id,n,""]]),n.locals&&(e.exports=n.locals);(0,a(424).A)("d0472e06",n,!1,{ssrId:!0})},157:(e,t,a)=>{a.r(t),a.d(t,{default:()=>l});var n=a(93),r=a.n(n),o=a(54),s=a.n(o)()(r());s.push([e.id,".acc[data-v-874ac946]{border:1px solid rgba(0,0,0,0.06);border-radius:12px;background:linear-gradient(180deg,#fff,#fafafa);overflow:hidden}.acc-head[data-v-874ac946]{width:100%;display:flex;align-items:center;gap:10px;background:linear-gradient(180deg,#f9fafb,#f3f4f6);border-bottom:1px solid rgba(0,0,0,0.06);padding:10px 12px;cursor:pointer;font-weight:800;color:#374151}.caret[data-v-874ac946]{transition:transform 0.18s ease}.caret.open[data-v-874ac946]{transform:rotate(90deg)}.title[data-v-874ac946]{font-size:13px}.spacer[data-v-874ac946]{flex:1}.hint[data-v-874ac946]{font-size:12px;color:#6b7280}.acc-body[data-v-874ac946]{overflow:hidden;transition:max-height 0.28s ease;background:rgba(255,255,255,0.82)}.inner[data-v-874ac946]{padding:10px 12px}\n",""]);const l=s},186:(e,t,a)=>{a.r(t),a.d(t,{default:()=>l});var n=a(93),r=a.n(n),o=a(54),s=a.n(o)()(r());s.push([e.id,".json-root[data-v-4d5f14c2]{font-size:12px;color:#111827}.json-line[data-v-4d5f14c2]{position:relative;display:flex;align-items:center;gap:6px;padding:2px 6px;border-radius:6px}.json-line[data-v-4d5f14c2]:hover{background:rgba(59,130,246,0.06)}.json-children[data-v-4d5f14c2]{border-left:1px dashed rgba(107,114,128,0.25)}.key[data-v-4d5f14c2]{color:#1f2937;font-weight:700}.colon[data-v-4d5f14c2]{color:#6b7280}.brace[data-v-4d5f14c2]{color:#9ca3af}.val.string[data-v-4d5f14c2]{color:#047857}.val.number[data-v-4d5f14c2]{color:#7c3aed}.val.boolean[data-v-4d5f14c2]{color:#0369a1}.val.null[data-v-4d5f14c2]{color:#9ca3af}.val.undefined[data-v-4d5f14c2]{color:#9ca3af}\n",""]);const l=s},278:(e,t,a)=>{var n=a(186);n.__esModule&&(n=n.default),"string"==typeof n&&(n=[[e.id,n,""]]),n.locals&&(e.exports=n.locals);(0,a(424).A)("d31b0834",n,!1,{ssrId:!0})},350:(e,t,a)=>{a.r(t),a.d(t,{default:()=>l});var n=a(93),r=a.n(n),o=a(54),s=a.n(o)()(r());s.push([e.id,".action-buttons-container[data-v-d7f5d074]{display:flex;justify-content:center;padding-top:10px;border-top:1px solid #444;text-align:center}button[data-v-d7f5d074]{background:#555;color:white;border:1px solid #777;border-radius:4px;padding:4px 8px;margin:0 5px;cursor:pointer;font-size:12px}button[data-v-d7f5d074]:hover{background:#666}\n",""]);const l=s},424:(e,t,a)=>{function n(e,t){for(var a=[],n={},r=0;r<t.length;r++){var o=t[r],s=o[0],l={id:e+":"+r,css:o[1],media:o[2],sourceMap:o[3]};n[s]?n[s].parts.push(l):a.push(n[s]={id:s,parts:[l]})}return a}a.d(t,{A:()=>f});var r="undefined"!=typeof document;if("undefined"!=typeof DEBUG&&DEBUG&&!r)throw new Error("vue-style-loader cannot be used in a non-browser environment. Use { target: 'node' } in your Webpack config to indicate a server-rendering environment.");var o={},s=r&&(document.head||document.getElementsByTagName("head")[0]),l=null,i=0,c=!1,d=function(){},u=null,p="data-vue-ssr-id",g="undefined"!=typeof navigator&&/msie [6-9]\b/.test(navigator.userAgent.toLowerCase());function f(e,t,a,r){c=a,u=r||{};var s=n(e,t);return m(s),function(t){for(var a=[],r=0;r<s.length;r++){var l=s[r];(i=o[l.id]).refs--,a.push(i)}t?m(s=n(e,t)):s=[];for(r=0;r<a.length;r++){var i;if(0===(i=a[r]).refs){for(var c=0;c<i.parts.length;c++)i.parts[c]();delete o[i.id]}}}}function m(e){for(var t=0;t<e.length;t++){var a=e[t],n=o[a.id];if(n){n.refs++;for(var r=0;r<n.parts.length;r++)n.parts[r](a.parts[r]);for(;r<a.parts.length;r++)n.parts.push(v(a.parts[r]));n.parts.length>a.parts.length&&(n.parts.length=a.parts.length)}else{var s=[];for(r=0;r<a.parts.length;r++)s.push(v(a.parts[r]));o[a.id]={id:a.id,refs:1,parts:s}}}}function b(){var e=document.createElement("style");return e.type="text/css",s.appendChild(e),e}function v(e){var t,a,n=document.querySelector("style["+p+'~="'+e.id+'"]');if(n){if(c)return d;n.parentNode.removeChild(n)}if(g){var r=i++;n=l||(l=b()),t=x.bind(null,n,r,!1),a=x.bind(null,n,r,!0)}else n=b(),t=_.bind(null,n),a=function(){n.parentNode.removeChild(n)};return t(e),function(n){if(n){if(n.css===e.css&&n.media===e.media&&n.sourceMap===e.sourceMap)return;t(e=n)}else a()}}var y,h=(y=[],function(e,t){return y[e]=t,y.filter(Boolean).join("\n")});function x(e,t,a,n){var r=a?"":n.css;if(e.styleSheet)e.styleSheet.cssText=h(t,r);else{var o=document.createTextNode(r),s=e.childNodes;s[t]&&e.removeChild(s[t]),s.length?e.insertBefore(o,s[t]):e.appendChild(o)}}function _(e,t){var a=t.css,n=t.media,r=t.sourceMap;if(n&&e.setAttribute("media",n),u.ssrId&&e.setAttribute(p,t.id),r&&(a+="\n/*# sourceURL="+r.sources[0]+" */",a+="\n/*# sourceMappingURL=data:application/json;base64,"+btoa(unescape(encodeURIComponent(JSON.stringify(r))))+" */"),e.styleSheet)e.styleSheet.cssText=a;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(a))}}},435:(e,t,a)=>{a.r(t),a.d(t,{default:()=>l});var n=a(93),r=a.n(n),o=a(54),s=a.n(o)()(r());s.push([e.id,".floating-ball[data-v-c745ba80]{--size:50px;--hue:212;--sat:100%;--lum:52%;--surface:hsl(var(--hue) var(--sat) var(--lum));--surface-2:hsl(var(--hue) 95% 64%);--ring:hsl(calc(var(--hue) + 20) 95% 65%);--shadow:rgba(0,123,255,0.36);--glow:rgba(102,200,255,0.55);--inner-shadow:rgba(0,0,0,0.22);--specular:rgba(255,255,255,0.75);--glass:rgba(255,255,255,0.18);width:var(--size);height:var(--size);border-radius:50%;position:relative;display:grid;place-items:center;cursor:pointer;-webkit-user-select:none;user-select:none;-webkit-tap-highlight-color:transparent;background:radial-gradient(120% 120% at 30% 28%,rgba(255,255,255,0.85) 0%,rgba(255,255,255,0.22) 18%,rgba(255,255,255,0) 36%),radial-gradient(120% 120% at 70% 72%,rgba(0,0,0,0.18) 0%,rgba(0,0,0,0) 38%),conic-gradient(from 210deg at 50% 50%,var(--surface),var(--surface-2),var(--surface));box-shadow:inset 0 2px 6px var(--inner-shadow),0 2px 4px rgba(0,0,0,0.08),0 10px 22px var(--shadow);transition:transform 0.28s ease,box-shadow 0.28s ease,filter 0.28s ease;will-change:transform,box-shadow,filter;animation:ball-bob-c745ba80 3.2s ease-in-out infinite}.floating-ball[data-v-c745ba80]::after{content:'';position:absolute;inset:-8px;border-radius:50%;background:conic-gradient(from 0deg,var(--ring),transparent 30%,transparent 70%,var(--ring));filter:blur(6px);opacity:0.55;pointer-events:none;-webkit-mask:radial-gradient(farthest-side,transparent calc(100% - 12px),#000 0);mask:radial-gradient(farthest-side,transparent calc(100% - 12px),#000 0);animation:ring-spin-c745ba80 12s linear infinite}.floating-ball[data-v-c745ba80]::before{content:'';position:absolute;inset:2px;border-radius:50%;background:radial-gradient(120% 80% at 26% 24%,var(--specular) 0%,rgba(255,255,255,0.2) 26%,rgba(255,255,255,0) 46%),linear-gradient(160deg,var(--glass) 0%,rgba(255,255,255,0) 50%);mix-blend-mode:screen;pointer-events:none;transition:opacity 0.28s ease,transform 0.28s ease}.floating-ball[data-v-c745ba80]:hover{transform:translateY(-2px) scale(1.04);box-shadow:inset 0 2px 8px rgba(0,0,0,0.22),0 4px 10px rgba(0,0,0,0.12),0 16px 36px rgba(0,123,255,0.45);filter:saturate(1.08)}.floating-ball[data-v-c745ba80]:hover::before{opacity:0.95;animation:shimmer-c745ba80 1.2s ease-out}.floating-ball[data-v-c745ba80]:active{transform:translateY(0) scale(0.98);box-shadow:inset 0 2px 10px rgba(0,0,0,0.28),0 2px 6px rgba(0,0,0,0.12),0 10px 22px rgba(0,123,255,0.35)}.floating-ball[data-v-c745ba80]:focus-visible{outline:2px solid rgba(102,200,255,0.85);outline-offset:2px}@media (prefers-reduced-motion:reduce){.floating-ball[data-v-c745ba80]{animation:none}.floating-ball[data-v-c745ba80]::after{animation:none}}@keyframes ball-bob-c745ba80{0%,100%{transform:translateY(0)}50%{transform:translateY(-2px)}}@keyframes ring-spin-c745ba80{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}@keyframes shimmer-c745ba80{0%{transform:translateY(-1px) scale(0.98);opacity:0.6}50%{transform:translateY(-2px) scale(1.02);opacity:1}100%{transform:translateY(-1px) scale(0.99);opacity:0.85}}.floating-ball[data-v-c745ba80]{--logo-scale:0.38}.era-logo[data-v-c745ba80]{font-weight:800;font-size:calc(var(--size) * var(--logo-scale));letter-spacing:0.02em;line-height:1;transform:translateY(-1px);white-space:nowrap;-webkit-user-select:none;user-select:none;pointer-events:none;z-index:1;background:linear-gradient(180deg,rgba(255,255,255,0.96) 0%,rgba(255,255,255,0.55) 45%,rgba(220,240,255,0.4) 65%,rgba(120,195,255,0.55) 100%),linear-gradient(180deg,rgba(0,0,0,0.38),rgba(0,0,0,0) 60%);-webkit-background-clip:text;background-clip:text;color:transparent;text-shadow:0 1px 0 rgba(255,255,255,0.75),0 2px 4px rgba(0,0,0,0.25),0 8px 18px rgba(0,123,255,0.35);filter:drop-shadow(0 0 2px rgba(102,200,255,0.25));animation:era-sheen-c745ba80 4s ease-in-out infinite}.floating-ball:hover .era-logo[data-v-c745ba80]{text-shadow:0 1px 0 rgba(255,255,255,0.85),0 3px 8px rgba(0,0,0,0.28),0 10px 26px rgba(0,123,255,0.55);filter:drop-shadow(0 0 3px rgba(102,200,255,0.38))}@keyframes era-sheen-c745ba80{0%,100%{background-position:0% 0%,0% 0%}50%{background-position:0% 40%,0% 0%}}\n",""]);const l=s},440:(e,t,a)=>{a.r(t),a.d(t,{default:()=>l});var n=a(93),r=a.n(n),o=a(54),s=a.n(o)()(r());s.push([e.id,".json-line[data-v-6c2eb3e9]{position:relative;display:flex;align-items:center;gap:6px;padding:2px 6px;border-radius:6px}.json-line[data-v-6c2eb3e9]:hover{background:rgba(59,130,246,0.06)}.json-children[data-v-6c2eb3e9]{border-left:1px dashed rgba(107,114,128,0.25)}.key[data-v-6c2eb3e9]{color:#1f2937;font-weight:700}.colon[data-v-6c2eb3e9]{color:#6b7280}.brace[data-v-6c2eb3e9]{color:#9ca3af}.summary[data-v-6c2eb3e9]{color:#6b7280;margin-left:4px}.val.string[data-v-6c2eb3e9]{color:#047857}.val.number[data-v-6c2eb3e9]{color:#7c3aed}.val.boolean[data-v-6c2eb3e9]{color:#0369a1}.val.null[data-v-6c2eb3e9]{color:#9ca3af}.val.undefined[data-v-6c2eb3e9]{color:#9ca3af}.caret[data-v-6c2eb3e9]{width:18px;height:18px;border:1px solid rgba(0,0,0,0.06);border-radius:4px;background:#fff;line-height:16px;text-align:center;font-size:10px;color:#6b7280;cursor:pointer;box-shadow:0 1px 0 #fff,0 2px 6px rgba(0,0,0,0.06);transition:transform 0.18s ease,box-shadow 0.18s ease}.caret.open[data-v-6c2eb3e9]{transform:rotate(90deg);box-shadow:0 3px 10px rgba(0,0,0,0.12)}\n",""]);const l=s},461:(e,t,a)=>{a.r(t),a.d(t,{default:()=>l});var n=a(93),r=a.n(n),o=a(54),s=a.n(o)()(r());s.push([e.id,".tabs[data-v-1e003116]{margin-top:12px;border:1px solid rgba(0,0,0,0.06);border-radius:12px;overflow:hidden;background:linear-gradient(180deg,#fff,#fafafa)}.tab-bar[data-v-1e003116]{display:flex;gap:8px;padding:8px;border-bottom:1px solid rgba(0,0,0,0.06);background:linear-gradient(180deg,#f9fafb,#f3f4f6)}.tab-btn[data-v-1e003116]{padding:8px 12px;font-weight:800;font-size:13px;color:#6b7280;background:#fff;border:1px solid #e5e7eb;border-radius:10px;cursor:pointer}.tab-btn.active[data-v-1e003116]{color:#111827;border-color:#93c5fd;box-shadow:inset 0 1px 0 #fff,0 0 0 3px rgba(147,197,253,0.35)}.tab-content[data-v-1e003116]{padding:10px 12px;background:rgba(255,255,255,0.86)}\n",""]);const l=s},481:(e,t,a)=>{var n=a(981);n.__esModule&&(n=n.default),"string"==typeof n&&(n=[[e.id,n,""]]),n.locals&&(e.exports=n.locals);(0,a(424).A)("5bdc07f0",n,!1,{ssrId:!0})},580:(e,t,a)=>{var n=a(440);n.__esModule&&(n=n.default),"string"==typeof n&&(n=[[e.id,n,""]]),n.locals&&(e.exports=n.locals);(0,a(424).A)("6689d7f0",n,!1,{ssrId:!0})},581:(e,t,a)=>{var n=a(57);n.__esModule&&(n=n.default),"string"==typeof n&&(n=[[e.id,n,""]]),n.locals&&(e.exports=n.locals);(0,a(424).A)("44b951b1",n,!1,{ssrId:!0})},639:(e,t,a)=>{var n=a(435);n.__esModule&&(n=n.default),"string"==typeof n&&(n=[[e.id,n,""]]),n.locals&&(e.exports=n.locals);(0,a(424).A)("66270844",n,!1,{ssrId:!0})},727:(e,t,a)=>{var n=a(43);n.__esModule&&(n=n.default),"string"==typeof n&&(n=[[e.id,n,""]]),n.locals&&(e.exports=n.locals);(0,a(424).A)("221c5d4c",n,!1,{ssrId:!0})},729:(e,t,a)=>{var n=a(461);n.__esModule&&(n=n.default),"string"==typeof n&&(n=[[e.id,n,""]]),n.locals&&(e.exports=n.locals);(0,a(424).A)("5a8d7068",n,!1,{ssrId:!0})},818:(e,t,a)=>{var n=a(350);n.__esModule&&(n=n.default),"string"==typeof n&&(n=[[e.id,n,""]]),n.locals&&(e.exports=n.locals);(0,a(424).A)("1756fcb3",n,!1,{ssrId:!0})},981:(e,t,a)=>{a.r(t),a.d(t,{default:()=>l});var n=a(93),r=a.n(n),o=a(54),s=a.n(o)()(r());s.push([e.id,".era-app-container{display:flex;flex-direction:column;gap:10px}\n",""]);const l=s}},a={};function n(e){var r=a[e];if(void 0!==r)return r.exports;var o=a[e]={id:e,exports:{}};return t[e](o,o.exports,n),o.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var a in t)n.o(t,a)&&!n.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};const r={type:"chat"},o="ERAMetaData",s="stat_data",l="EditLogs",i="SelectedMks",c="era_data",d=new RegExp(`<${c}>({.*?})<\\/${c}>`),u={INSERT_BY_OBJECT:"era:insertByObject",UPDATE_BY_OBJECT:"era:updateByObject",INSERT_BY_PATH:"era:insertByPath",UPDATE_BY_PATH:"era:updateByPath",DELETE_BY_OBJECT:"era:deleteByObject",DELETE_BY_PATH:"era:deleteByPath",GET_CURRENT_VARS:"era:getCurrentVars"},p="era:writeDone",g="era:apiWrite",f="era_debug";let m,b;function v(){!function(e){const t=e.split(/[\s,]+/);m=[],b=[];for(const e of t){if(!e)continue;const t=e.replace(/\*/g,".*?");t.startsWith("-")?b.push(new RegExp(`^${t.slice(1)}$`)):m.push(new RegExp(`^${t}$`))}}(globalThis.localStorage?.getItem(f)||"")}v(),"undefined"!=typeof globalThis&&(globalThis.eraDebug=function(e){globalThis.localStorage?.setItem(f,e),v(),console.log(`%c《ERA-Log》调试模式已更新: %c${e||"(已禁用)"}%c。部分模块可能需刷新页面生效。`,"color: #3498db; font-weight: bold;","color: #f39c12; font-style: italic;","color: #3498db; font-weight: bold;")});const y={mk:""};class h{moduleName;constructor(e){this.moduleName=e||(this._getModuleNameFromStack()||"unknown")}_getModuleNameFromStack(){try{const e=(new Error).stack||"",t=e.split("\n").find(e=>e.includes("/src/ERA变量框架/")&&!e.includes("/utils/log.ts"));if(!t)return console.warn('《ERA-Log-Debug》:无法从堆栈中确定模块名，将使用 "unknown"。堆栈:',e),null;const a=t.match(/src\/ERA变量框架\/([^?:\s)]+)/);if(!a||!a[1])return console.warn("《ERA-Log-Debug》: 正则表达式无法从调用行中提取路径。调用行:",t),null;let n=a[1];return n=n.replace(/\.(vue|ts|js)$/,""),n.replace(/^src\/ERA变量框架\//,"").replace(/\/index$/,"").replace(/\//g,"-")}catch(e){return console.error("《ERA-Log-Debug》: 解析模块名时发生意外错误。",e),null}}formatMessage(e,t){return`《ERA》${y.mk?`（${y.mk}）`:""}「${this.moduleName}」【${e}】${String(t)}`}debug(e,t,a){if(!(n=this.moduleName)||b.some(e=>e.test(n))||0===m.length||!m.some(e=>e.test("all")||e.test(n)))return;var n;const r=this.formatMessage(e,t);void 0!==a?console.debug(r,a):console.debug(r)}log(e,t,a){const n=this.formatMessage(e,t);void 0!==a?console.log(`%c${n}`,"color: #3498db;",a):console.log(`%c${n}`,"color: #3498db;")}warn(e,t,a){const n=this.formatMessage(e,t);void 0!==a?console.warn(`%c${n}`,"color: #f39c12;",a):console.warn(`%c${n}`,"color: #f39c12;")}error(e,t,a){const n=this.formatMessage(e,t);void 0!==a?console.error(`%c${n}`,"color: #e74c3c; font-weight: bold;",a):console.error(`%c${n}`,"color: #e74c3c; font-weight: bold;")}}const x=new h,k={INIT:[tavern_events.APP_READY],SYNC:["manual_write",g,tavern_events.MESSAGE_RECEIVED,tavern_events.MESSAGE_DELETED,tavern_events.MESSAGE_SWIPED,tavern_events.CHAT_CHANGED,"manual_sync","manual_full_sync","combo_sync"],API:Object.values(u),UPDATE_MK_ONLY:[tavern_events.MESSAGE_SENT],COLLISION_DETECTORS:[tavern_events.GENERATION_STARTED],COMBO_STARTERS:[tavern_events.MESSAGE_UPDATED]},w=new Map([[tavern_events.MESSAGE_SWIPED,{next:tavern_events.GENERATION_STARTED,maxInterval:600}]]),E=new Map([[tavern_events.MESSAGE_UPDATED,{next:tavern_events.GENERATION_STARTED,resultType:"combo_sync",maxInterval:1600}]]),N=new Map([[tavern_events.MESSAGE_SWIPED,500],[tavern_events.MESSAGE_UPDATED,1500]]);function C(e){return k.INIT.includes(e)?"INIT":k.SYNC.includes(e)?"SYNC":k.API.includes(e)?"API":k.UPDATE_MK_ONLY.includes(e)?"UPDATE_MK_ONLY":k.COLLISION_DETECTORS.includes(e)?"COLLISION_DETECTORS":k.COMBO_STARTERS.includes(e)?"COMBO_STARTERS":"UNKNOWN"}function S(e){const t=_.cloneDeep(e),a=[];for(const t of e){if(0===a.length){a.push(t);continue}const e=a[a.length-1],n=t.timestamp-e.timestamp,r=E.get(e.type);if(r&&t.type===r.next){if(n<=r.maxInterval){x.debug("mergeEventBatch",`检测到事件组合: ${e.type} 和 ${t.type} (时间差: ${n}ms <= ${r.maxInterval}ms)。将合并为 ${r.resultType} 事件。`),a.pop(),a.push({type:r.resultType,timestamp:t.timestamp,detail:t.detail});continue}x.debug("mergeEventBatch",`检测到潜在的事件组合，但因超时而失败: ${e.type} 和 ${t.type} (时间差: ${n}ms > ${r.maxInterval}ms)。`)}const o=w.get(e.type);if(o&&t.type===o.next){if(n<=o.maxInterval){x.debug("mergeEventBatch",`检测到相邻事件对冲: ${e.type} 和 ${t.type} (时间差: ${n}ms <= ${o.maxInterval}ms)。将忽略这两个事件。`),a.pop();continue}x.debug("mergeEventBatch",`检测到潜在的事件对冲，但因超时而失败: ${e.type} 和 ${t.type} (时间差: ${n}ms > ${o.maxInterval}ms)。`)}const s=C(e.type);s===C(t.type)&&"SYNC"===s?a[a.length-1]=t:a.push(t)}const n=a.filter(e=>{const t=C(e.type),a="COLLISION_DETECTORS"===t,n="COMBO_STARTERS"===t;return(a||n)&&x.debug("mergeEventBatch",`清理未配对的事件: ${e.type}`),!a&&!n});return x.debug("mergeEventBatch",`事件合并: ${t.length} -> ${n.length}`,{before:t.map(e=>e.type),after:n.map(e=>e.type)}),n}const A=_;var M=n.n(A);function V(e){if(!M().isObject(e))return e;const t=M().cloneDeep(e);return function e(t){if(Array.isArray(t))t.forEach(t=>e(t));else if(M().isPlainObject(t))for(const a in t)a.startsWith("$")?delete t[a]:e(t[a])}(t),t}function O(){const e=getVariables(r)||{};return{meta:M().get(e,o,{}),stat:M().get(e,s,{})}}async function D(e){await updateVariablesWith(async t=>{const a=M().get(t,s,{}),n=await e(a);return M().set(t,s,n),t},r)}async function I(e){await updateVariablesWith(async t=>{const a=M().get(t,o,{}),n=await e(a);return M().set(t,o,n),t},r)}function T(e){if(!e.includes("{{"))return e;let t=e;return t=t.replace(/{{user}}/gi,SillyTavern.name1),t=t.replace(/{{char}}/gi,SillyTavern.name2),t}const B=new h;function R(e){if(!e)return null;let t=null;if("string"==typeof e.mes)t=e.mes;else if(Array.isArray(e.swipes)){const a=Number(e.swipe_id??0);t=e.swipes[a]||null}else"string"==typeof e.message&&(t=e.message);return null===t?null:T(t)}function L(e){const t=function(e){if("string"!=typeof e)return null;const t=e.match(d);if(!t||!t[1])return null;try{const e=t[1],a=e.match(/"era-message-key"\s*=\s*"(.*?)"/),n=e.match(/"era-message-type"\s*=\s*"(.*?)"/);if(a?.[1]&&n?.[1]){const e={"era-message-key":a[1],"era-message-type":n[1]};return B.debug("parseEraData","成功解析 EraData",e),e}return B.debug("parseEraData","未能在 EraData 块中找到完整的键值对",{customFormatBlock:e}),null}catch(e){return B.warn("parseEraData","解析 EraData 块时发生异常",e),null}}(R(e));return t?"user"===t["era-message-type"]:"user"===e?.role}async function P(e,t){const a=R(e);B.debug("updateMessageContent","更新前的消息内容:",a),B.debug("updateMessageContent","更新后的消息内容:",t);const n={message_id:e.message_id};if(Array.isArray(e.swipes)){const a=Number(e.swipe_id??0),r=[...e.swipes];r[a]=t,n.swipes=r}else n.message=t;await setChatMessages([n],{refresh:"none"})}function j(e){if(!e)return e;let t=String(e).trim();return t=t.replace(/^\s*(?:```|~~~)\[a-zA-Z0-9_-\]*\s*\r?\n/,""),t=t.replace(/\r?\n(?:```|~~~)\s*$/,""),t.trim()}function J(e="",t="exact"){if("any"===t||"*"===e)return/([a-zA-Z][a-zA-Z0-9_]*)/;const a=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");switch(t){case"exact":return new RegExp(`(${a})`);case"prefix":return new RegExp(`(${a}[a-zA-Z0-9_]*)`);case"suffix":return new RegExp(`([a-zA-Z0-9_]*${a})`);default:return new RegExp(`([a-zA-Z0-9_]*${a}[a-zA-Z0-9_]*)`)}}function K(e,t,a=e.length){const n=new RegExp(`</${t.source}>`,"g");let r,o=null;for(;null!==(r=n.exec(e))&&r.index<a;)o=r;if(!o)return null;const s=o[1],l=o.index,i=`<${s}>`,c=e.lastIndexOf(i,l);return-1===c?K(e,t,l):{startIndex:c,endIndex:l+`</${s}>`.length,content:e.substring(c+i.length,l),tagName:s}}function H(e,t){return(t?new RegExp(`</?${t.source}>`):/<\/?\s*[a-zA-Z][a-zA-Z0-9_]*\s*>/).test(e)}function F(e,t){const a=function(e,t){let a=e;for(;;){const e=K(a,t);if(!e)break;a=a.slice(0,e.startIndex)+a.slice(e.endIndex)}return a}(e,J("think","contains")),n=function(e,t){const a=[];let n=e.length;for(;n>0;){const r=K(e,t,n);if(!r)break;a.unshift(r.content),n=r.startIndex}return a}(a,t),r=[];for(const e of n){const t=j(e.trim());H(t)||t&&r.push(t)}return r}const Y=new h;function U(e){if(!e)return"";const t=R(e);return function(e){if("string"!=typeof e)return null;const t=e.match(d);if(!t||!t[1])return null;try{const e=t[1],a=e.match(/"era-message-key"\s*=\s*"(.*?)"/),n=e.match(/"era-message-type"\s*=\s*"(.*?)"/);return a?.[1]&&n?.[1]?{"era-message-key":a[1],"era-message-type":n[1]}:null}catch{return null}}(t)?.["era-message-key"]||""}async function W(e){if(!e||"number"!=typeof e.message_id||!e.role)return Y.warn("ensureMessageKey",`无效的消息对象结构，无法确保Key。msg=${JSON.stringify(e)}`),{mk:"",isNew:!1};const t=U(e);if(t)return{mk:t,isNew:!1};const a=`era_mk_${Date.now()}_${Math.random().toString(36).slice(2,8)}`,n="user"===e.role?"user":"assistant",r=`<${c}>{"era-message-key"="${a}","era-message-type"="${n}"}</${c}>`;Y.log("ensureMessageKey",`为消息 (ID: ${e.message_id}) 注入新的Key: ${a}`);const o=r+"\n"+(R(e)??"");return await P(e,o),{mk:a,isNew:!0}}const G=async()=>{const e=getChatMessages(-1,{include_swipes:!0})?.[0];if(!e||"number"!=typeof e.message_id)return;const{mk:t}=await W(e);t&&await I(a=>{const n=_.get(a,i,[]);return n[e.message_id]!==t&&(n[e.message_id]=t,_.set(a,i,n)),a})},Q=z,Z=new h,q=Q.z.object({强制重载功能:Q.z.boolean().default(!1),强制重载消息数:Q.z.number().default(2)}).prefault({});function X(){let e;e||(e=q.parse(getVariables({type:"script",script_id:getScriptId()})),Z.debug("initializeExternalSettings","写入脚本变量:",e),insertVariables(e,{type:"script",script_id:getScriptId()}))}$(()=>{X()});const ee=new h,te={".":"__DOT__",'"':"__DQUOTE__","'":"__SQUOTE__"},ae=_.invert(te),ne=new RegExp(Object.keys(te).map(_.escapeRegExp).join("|"),"g"),re=new RegExp(Object.values(te).map(_.escapeRegExp).join("|"),"g");function oe(e){if(Array.isArray(e))return e.map(e=>oe(e));if(_.isPlainObject(e)){const t={};for(const a in e)if(Object.prototype.hasOwnProperty.call(e,a)){t[a.replace(ne,e=>te[e])]=oe(e[a])}return t}return"string"==typeof e?e.replace(ne,e=>te[e]):e}function se(e){if(Array.isArray(e))return e.map(e=>se(e));if(_.isPlainObject(e)){const t={};for(const a in e)if(Object.prototype.hasOwnProperty.call(e,a)){t[a.replace(re,e=>ae[e])]=se(e[a])}return t}return"string"==typeof e?e.replace(re,e=>ae[e]):e}function le(e){if(Array.isArray(e))return e.map(e=>Array.isArray(e)||_.isPlainObject(e)?JSON.stringify(e):e);if(_.isPlainObject(e)){const t={};for(const a in e)t[a]=le(e[a]);return t}return e}const ie=e=>{try{return JSON.stringify(e,null,2)}catch(e){return`<<stringify失败: ${e?.message||e}>>`}};function ce(e,t){return _.mergeWith(_.cloneDeep(e),_.cloneDeep(t),(e,t)=>{if(Array.isArray(e)||Array.isArray(t))return t})}function de(e){if(Array.isArray(e))return e;if(e&&"object"==typeof e)return[e];if("string"==typeof e){const t=e.replace(/^\s*```(?:json)?\s*|\s*```\s*$/g,"");try{const e=JSON.parse(t);return Array.isArray(e)?e:[]}catch{return[]}}return[]}function ue(e){const t=[];if(!e||"string"!=typeof e)return t;const a=function(e){if(!e)return"";let t="",a=!1;for(let n=0;n<e.length;n++){const r=e[n];if('"'!==r||0!==n&&"\\"===e[n-1]||(a=!a),a){t+=r;continue}const o=e[n+1];if("/"===r&&"/"===o){const a=e.indexOf("\n",n+2);if(-1===a)break;t+="\n",n=a;continue}if("/"===r&&"*"===o){const t=e.indexOf("*/",n+2);if(-1===t)break;n=t+1;continue}if("<"===r&&"\x3c!--"===e.substring(n,n+4)){const t=e.indexOf("--\x3e",n+4);if(-1===t)break;n=t+2;continue}t+=r}return t}(e),n=a.trim();let r=0,o=-1,s=!1;for(let e=0;e<n.length;e++){const a=n[e];if('"'!==a||0!==e&&"\\"===n[e-1]||(s=!s),!s)if("{"===a)0===r&&(o=e),r++;else if("}"===a&&r>0&&(r--,0===r&&-1!==o)){const a=n.substring(o,e+1);try{const e=JSON.parse(a);t.push(e)}catch(e){ee.error(`JSONL 解析失败: ${e?.message||e}. 失败的片段: ${a}`,e)}o=-1}}return t}const pe=new h,ge=_.debounce(()=>{eventEmit(g),pe.log("debouncedEmitApiWrite",`已触发合并后的 ${g} 事件。`)},50,{leading:!1,trailing:!0});function fe(e){const t={...e,stat:se(e.stat),statWithoutMeta:se(e.statWithoutMeta)};pe.debug("emitWriteDoneEvent","writeDone事件广播数据反转义",{before:{stat:e.stat,statWithoutMeta:e.statWithoutMeta},after:{stat:t.stat,statWithoutMeta:t.statWithoutMeta}}),eventEmit(p,t),pe.log("emitWriteDoneEvent",`已触发 ${p} 事件。操作: ${JSON.stringify(e.actions)}, MK: ${e.mk}, MsgID: ${e.message_id}, 连续处理次数: ${e.consecutiveProcessingCount}`)}const me=new h;async function be(e){const t=ie(e.blockContent),a=`\n<${e.blockTag}>\n${t}\n</${e.blockTag}>`,n=await function(){const e=getChatMessages("0-{{lastMessageId}}",{include_swipes:!0});if(!e||0===e.length)return B.debug("findLastAiMessage","聊天记录为空, 未找到任何消息。"),null;for(let t=e.length-1;t>=0;t--){const a=e[t];if(!L(a))return B.debug("findLastAiMessage",`找到最后一条 AI 消息, ID: ${a.message_id}`),a}return B.debug("findLastAiMessage","未在聊天记录中找到任何 AI 消息。"),null}();if(!n)return void me.warn("performApiWrite","找不到任何 AI 消息，无法执行 API 写入。");const r=(R(n)??"")+a;me.log("performApiWrite",`实时写入 API 任务 (${e.blockTag}) 到消息 ID ${n.message_id}...`),await P(n,r),ge()}function ve(e,t,a){const{type:n,detail:r}=e;var o,s;t.api=!0,n===u.INSERT_BY_OBJECT?be({blockTag:"VariableInsert",blockContent:r}):n===u.UPDATE_BY_OBJECT?function(e){be({blockTag:"VariableEdit",blockContent:e})}(r):n===u.INSERT_BY_PATH?(o=r.path,s=r.value,be({blockTag:"VariableInsert",blockContent:_.set({},o,s)})):n===u.UPDATE_BY_PATH?function(e,t){be({blockTag:"VariableEdit",blockContent:_.set({},e,t)})}(r.path,r.value):n===u.DELETE_BY_OBJECT?function(e){be({blockTag:"VariableDelete",blockContent:e})}(r):n===u.DELETE_BY_PATH?function(e){be({blockTag:"VariableDelete",blockContent:_.set({},e,{})})}(r.path):n===u.GET_CURRENT_VARS&&function(e){fe(e)}(a)}const ye=new h;function he(e,t,a,n){const r=t?_.get(e,t):e;if(void 0===r)return void ye.warn("applyDeleteAtLevel",`VariableDelete 跳过：路径不存在 -> ${t||"(root)"}`);const o=_.get(r,["$meta","necessary"]),s=_.get(a,"$meta"),l=_.isPlainObject(s)&&_.isEmpty(s)||_.has(a,["$meta","necessary"]);if(_.isPlainObject(a)&&!_.isEmpty(a)){if("all"===o&&!l)return void ye.warn("applyDeleteAtLevel",`VariableDelete 失败：路径 <${t}> 受 "necessary: all" 保护，其子节点无法被删除。`);for(const r of Object.keys(a)){he(e,t?`${t}.${r}`:r,a[r],n)}return}if("self"===o||"all"===o)return void ye.warn("applyDeleteAtLevel",`VariableDelete 失败：路径 <${t}> 受 "necessary: ${o}" 保护，无法被直接删除。`);if(""===t)return void ye.error("applyDeleteAtLevel","VariableDelete 失败：不允许删除根对象。");const i=_.cloneDeep(r);_.unset(e,t),n.push({op:"delete",path:t,value_old:i}),ye.debug("applyDeleteAtLevel",`成功删除节点: ${t}`)}const xe=new h;function _e(e,t){if(!e)return;const a=_.get(e,"$template"),n=_.get(e,t);if(_.isPlainObject(a)&&_.isPlainObject(n)){xe.debug("getInheritedTemplateContent",`为子节点 "${t}" 同时找到原型和特异性内容。\n      - 原型: ${JSON.stringify(a)}\n      - 特异性: ${JSON.stringify(n)}`);const e=ce(_.cloneDeep(a),n);return xe.debug("getInheritedTemplateContent",`  - 合并后: ${JSON.stringify(e)}`),e}return _.isPlainObject(n)?(xe.debug("getInheritedTemplateContent",`为子节点 "${t}" 只找到特异性内容: ${JSON.stringify(n)}`),n):_.isPlainObject(a)?(xe.debug("getInheritedTemplateContent",`为子节点 "${t}" 只找到原型内容: ${JSON.stringify(a)}`),a):void xe.debug("getInheritedTemplateContent",`在父级模板内容中未为子节点 "${t}" 找到任何可继承的规则。`)}const ke=new h;function we(e,t,a,n,r,o){const s=function(e,t){const a=_.get(t,"$template");xe.debug("resolveTemplate",`解析出的模板内容:\n    - 继承: ${JSON.stringify(e)}\n    - 父节点变量: ${JSON.stringify(a)}`);let n={};return n=ce(n,e),n=ce(n,a),xe.debug("resolveTemplate",`合并后的最终模板内容: ${JSON.stringify(n)}`),_.isEmpty(n)?null:n}(r,o);ke.debug("applyInsertAtLevel",`[入口] basePath: "${t||"root"}"`,{statData:_.cloneDeep(e)});const l=t?_.get(e,t):e;if(ke.debug("applyInsertAtLevel",`[路径检查] at path: "${t||"root"}". currentNodeInVars 的值:`,l),t&&void 0===l){const r=function(e,t){if(xe.debug("applyTemplateToPatch",`[进入] 模板内容: ${JSON.stringify(e)}, 补丁: ${JSON.stringify(t)}`),!_.isPlainObject(t))return xe.debug("applyTemplateToPatch","[退出] 补丁不是一个普通对象，直接返回。"),t;if(!e)return xe.debug("applyTemplateToPatch","[退出] 模板内容无效，直接返回补丁。"),t;if(_.isEmpty(t))return xe.debug("applyTemplateToPatch","补丁为空对象，完全使用模板内容。"),_.cloneDeep(e);const a=ce(_.cloneDeep(e),t);return xe.debug("applyTemplateToPatch",`合并模板与补丁后的结果: ${JSON.stringify(a)}`),a}(s,a),o=le(r);return ke.debug("applyInsertAtLevel",`最终插入数据 at ${t}:\n${JSON.stringify(o,null,2)}`),_.set(e,t,o),n.push({op:"insert",path:t,value_new:_.cloneDeep(o)}),void ke.debug("applyInsertAtLevel",`原子性插入到新路径: ${t}`)}if(_.isPlainObject(l)&&_.isPlainObject(a)){ke.debug("applyInsertAtLevel",`[递归补充] at path: "${t||"root"}"\n      - 当前层级模板 (localTplContent): ${JSON.stringify(s)}`);for(const r of Object.keys(a)){const o=t?`${t}.${r}`:r,i=a[r],c=_e(s,r);ke.debug("applyInsertAtLevel",`  - 准备递归子节点: "${r}"\n      - 将传递给子节点的模板 (subInheritedContent): ${JSON.stringify(c)}`),we(e,o,i,n,c,l)}}else t&&ke.warn("applyInsertAtLevel",`VariableInsert 失败：路径已存在且无法递归补充 -> ${t}`)}const Ee=new h;async function $e(e,t=!1){try{Ee.log("rollbackByMk",`开始回滚, MK=${e}`),await updateVariablesWith(t=>{const a=_.get(t,o,{}),n=_.get(t,s,{}),r=de(_.get(a,[l,e]));if(!r||!r.length)return Ee.debug("rollbackByMk","EditLog 为空或无效，跳过回滚。"),t;for(let e=r.length-1;e>=0;e--){const t=r[e],a=String(t?.op||"").toLowerCase(),o=String(t?.path||"");o&&("insert"!==a?"update"!==a&&"delete"!==a||(void 0===t?.value_old?_.unset(n,o):_.set(n,o,_.cloneDeep(t.value_old))):_.unset(n,o))}return _.set(t,s,n),t},r),Ee.log("rollbackByMk",`回滚完成：MK=${e}`)}catch(t){Ee.error("rollbackByMk",`回滚异常：MK=${e} → ${t?.message||t}`,t)}}async function Ne(e,t){Ee?.debug("findLatestNewValue",`开始为路径 <${e}> 从消息ID <${t}> 向上追溯历史值...`);const a=getChatMessages("0-{{lastMessageId}}",{include_swipes:!1});if(!a||a.length<1)return Ee?.debug("findLatestNewValue","消息历史为空，无法追溯。"),null;const n=a.findIndex(e=>e.message_id===t);if(-1===n)return Ee?.warn("findLatestNewValue",`错误：在消息列表中未找到起始消息ID: ${t}`),null;for(let t=n-1;t>=0;t--){const n=a[t],r=n?.message_id;if(Ee?.debug("findLatestNewValue",`[进度] 正在检查消息 (ID: ${r})，内容: "${(R(n)||"").substring(0,100)}..."`),L(n)||"number"!=typeof r)continue;const o=U(n);if(!o){Ee?.debug("findLatestNewValue",`[进度] 消息 (ID: ${r}) 无 MK，跳过。`);continue}const{meta:s}=O(),i=de(_.get(s,[l,o]));if(i&&0!==i.length){Ee?.debug("findLatestNewValue",`[进度] 正在检查 MK ${o} 的 EditLog...\n${ie(i)}`);for(let t=i.length-1;t>=0;t--){const a=i[t];if(a&&a.path){if(a.path===e)return"delete"===a.op?(Ee?.error("findLatestNewValue",`>> 状态异常! 在消息(ID:${n.message_id}, MK:${o})中为路径 <${e}> 找到了 'delete' 记录。这表明 update 操作可能正在尝试修改一个已被删除的变量。`),null):(Ee?.debug("findLatestNewValue",`>> 成功! 在消息(ID:${n.message_id}, MK:${o})中找到精确路径 <${e}> 的值为: ${ie(a.value_new)}`),_.cloneDeep(a.value_new));if(e.startsWith(a.path+".")){const t=e.substring(a.path.length+1),r=a.value_new;if(_.isPlainObject(r)&&_.has(r,t)){const e=_.get(r,t);return Ee?.debug("findLatestNewValue",`>> 成功! 在消息(ID:${n.message_id}, MK:${o})中找到父级路径 <${a.path}>, 并从中提取子路径 <${t}> 的值为: ${ie(e)}`),_.cloneDeep(e)}}}}}else Ee?.debug("findLatestNewValue",`[进度] MK ${o} 的 EditLog 为空，跳过。`)}return Ee?.debug("findLatestNewValue",`向上追溯未找到路径 ${e} 的任何历史值，将使用 null 作为旧值`),null}const Ce=new h;async function Se(e,t,a,n,r,o){const s=t?_.get(e,t):e;if(void 0===s)return void Ce.warn("applyEditAtLevel",`VariableEdit 跳过：路径不存在 -> ${t||"(root)"}`);const l=_.get(s,["$meta","updatable"],!0),i=!1===l&&!0===_.get(a,["$meta","updatable"]);if(!1!==l||i)for(const s of Object.keys(a)){const l=t?`${t}.${s}`:s,i=a[s];if(_.isPlainObject(i)){await Se(e,l,i,n,r,o);continue}if(!_.has(e,l)){Ce.warn("applyEditAtLevel",`VariableEdit 失败：路径非法，无法写入 -> ${l}`);continue}Ce.debug("applyEditAtLevel",`[旧值查找] 准备为路径 <${l}> 从消息 ID <${r}> 向上追溯...`);let c=await Ne(l,r);null===c?(c=_.get(e,l),Ce.debug("applyEditAtLevel",`[旧值查找] 追溯未找到历史值，从当前 stat_data 中获取到旧值: ${JSON.stringify(c)}`)):Ce.debug("applyEditAtLevel",`[旧值查找] 追溯成功，找到历史旧值: ${JSON.stringify(c)}`);const d=le(i);_.set(e,l,d),n.push({op:"update",path:l,value_old:_.cloneDeep(c),value_new:_.cloneDeep(d)}),o.set(l,_.cloneDeep(d))}else Ce.warn("applyEditAtLevel",`VariableEdit 失败：路径 <${t}> 受 "$meta.updatable: false" 保护，无法被修改。`)}const Ae=new h,Me=async e=>{Ae.debug("ApplyVarChangeForMessage","开始处理消息...",{msg:e});try{if(!e||"number"!=typeof e.message_id)return Ae.warn("ApplyVarChangeForMessage","无效消息对象或缺少 message_id，退出"),null;const t=e.message_id,a=U(e);if(!a)return Ae.debug("ApplyVarChangeForMessage",`消息 (ID: ${t}) 不含 MK，跳过变量写入。`),null;if(L(e))return Ae.debug("ApplyVarChangeForMessage",`消息 (ID: ${t}) 为用户消息，跳过变量写入，但保留其 MK。`),a;const n=R(e)||"",r=F(n,J("VariableInsert","exact")),o=F(n,J("VariableEdit","exact")),s=F(n,J("VariableDelete","exact"));Ae.debug("ApplyVarChangeForMessage","delete拿到的指令",s),r.length||o.length||s.length||Ae.debug("ApplyVarChangeForMessage",`消息 (ID: ${t}) 未检测到变量修改标签。`);const i=r.flatMap(e=>ue(e)),c=o.flatMap(e=>ue(e)),d=s.flatMap(e=>ue(e)),u=oe(i),p=oe(c),g=oe(d);Ae.debug("ApplyVarChangeForMessage","数据转义完成",{before:{inserts:i,edits:c,deletes:d},after:{inserts:u,edits:p,deletes:g}});const f=[];await async function(e,t){if(e.length>0){await D(async e=>(ke.debug("processInsertBlocks","[初始状态] 进入 processInsertBlocks 时的 statData:",_.cloneDeep(e)),e));for(const a of e)if(_.isPlainObject(a)&&!_.isEmpty(a))try{await D(e=>(ke.debug("processInsertBlocks",`处理 insertRoot: ${JSON.stringify(a)}`),we(e,"",a,t,null,null),e))}catch(e){ke.error("processInsertBlocks",`处理 insertRoot 失败: ${e?.message||e}`,e)}ke.log("processInsertBlocks","所有 VariableInsert 操作完成")}}(u,f),await async function(e,t,a){if(e.length>0){const n=new Map;for(const r of e)if(_.isPlainObject(r)&&!_.isEmpty(r))try{await D(async e=>(Ce.debug("processEditBlocks",`处理 editRoot: ${JSON.stringify(r)}`),await Se(e,"",r,t,a,n),e))}catch(e){Ce.error("processEditBlocks",`处理 editRoot 失败: ${e?.message||e}`,e)}Ce.log("processEditBlocks","所有 VariableEdit 操作完成")}}(p,f,t),await async function(e,t){if(e.length>0){for(const a of e)if(_.isPlainObject(a)&&!_.isEmpty(a))try{await D(e=>(ye.debug("processDeleteBlocks",`处理 deleteRoot: ${JSON.stringify(a)}`),he(e,"",a,t),e))}catch(e){ye.error("processDeleteBlocks",`处理 deleteRoot 失败: ${e?.message||e}`,e)}ye.log("processDeleteBlocks","所有 VariableDelete 操作完成")}}(g,f);try{await I(e=>{const n=Array.isArray(f)?f:de(f);return Ae.debug("ApplyVarChangeForMessage",`准备为 MK=${a} (MsgID=${t}) 写入 EditLog:\n${JSON.stringify(n,null,2)}`),_.set(e,[l,a],JSON.stringify(n)),e}),Ae.debug("ApplyVarChangeForMessage",`成功为 MK=${a} 写入 EditLog。`)}catch(e){Ae.error("ApplyVarChangeForMessage",`为 MK=${a} 写入 EditLogs 失败: ${e?.message||e}`,e)}return a}catch(e){return Ae.error("ApplyVarChangeForMessage",`变量写入器异常: ${e?.message||e}`,e),null}},Ve=new h,Oe=e=>{const t=U(e);return t||null},De=async(e=!1)=>{e?Ve.warn("resyncStateOnHistoryChange","强制完全重算模式已启动！"):Ve.log("resyncStateOnHistoryChange","聊天记录变更，启动状态同步...");const t=getChatMessages("0-{{lastMessageId}}",{include_swipes:!0});Ve.debug("resyncStateOnHistoryChange","获取到的 allMessages:",t);const{meta:a}=O(),n=_.cloneDeep(_.get(a,i,[]));if(Ve.debug("resyncStateOnHistoryChange",`状态快照: oldSelectedMks.length=${n.length}, allMessages.length=${t?.length??0}`),!t||0===t.length)return void Ve.log("resyncStateOnHistoryChange","当前聊天记录为空，不执行任何操作，同步终止。");let r=-1;if(e)r=0,Ve.log("resyncStateOnHistoryChange","强制模式：设置重算起点为 0。");else if(t.length<n.length){Ve.log("resyncStateOnHistoryChange","检测到消息删除。");for(let e=t.length-1;e>=0;e--){const a=Oe(t[e]),o=n[e];if(Ve.debug("resyncStateOnHistoryChange",`[删除-对齐检查] i=${e}, currentMk=${a}, recordedMk=${o}`),a===o){r=e+1,Ve.log("resyncStateOnHistoryChange",`找到对齐点于 message_id=${e} (MK=${a})。将从 ID ${r} 开始检查。`);break}}-1===r&&(r=0,Ve.log("resyncStateOnHistoryChange","未找到任何对齐点，将从头开始检查。"));const e=t.map(Oe).filter(e=>e),a=n.filter(e=>e),o=_.difference(a,e);if(Ve.debug("resyncStateOnHistoryChange",`旧MK序列: [${a.join(", ")}]`),Ve.debug("resyncStateOnHistoryChange",`新MK序列: [${e.join(", ")}]`),Ve.debug("resyncStateOnHistoryChange",`计算出的被删除MK: [${o.join(", ")}]`),o.length>0&&(e=>{const{meta:t}=O();for(const a of e)if(a&&de(_.get(t,[l,a])).length>0)return!1;return!0})(o)){Ve.log("resyncStateOnHistoryChange",`检测到被删除的 ${o.length} 条消息均不含变量修改，执行快速同步。`);const e=[];for(let a=0;a<t.length;a++)e[a]=Oe(t[a]);return await I(t=>(_.set(t,i,e),t)),void Ve.log("resyncStateOnHistoryChange","快速同步完成，仅修正 SelectedMks 数组。")}}else if(t.length===n.length){Ve.log("resyncStateOnHistoryChange","检测到消息长度不变，可能为修改或切换。");for(let e=t.length-1;e>=0;e--){const a=Oe(t[e]),o=n[e];Ve.debug("resyncStateOnHistoryChange",`[切换-对齐检查] i=${e}, currentMk=${a}, recordedMk=${o}`),a!==o&&(r=e)}-1===r?(r=t.length>0?t.length-1:0,Ve.log("resyncStateOnHistoryChange",`所有MK均匹配。启动模拟写入，强制重算最后一条消息 (ID: ${r})。`)):Ve.log("resyncStateOnHistoryChange",`找到最早的不匹配点于 message_id=${r}。将从该点开始重算。`)}else Ve.log("resyncStateOnHistoryChange","检测到消息添加。"),r=n.length,Ve.log("resyncStateOnHistoryChange",`新增消息的写入逻辑已由同步流程接管。将从新增消息 (ID: ${r}) 开始处理。`);if(r>-1){const e=n.slice(r).filter(e=>e);if(e.length>0){Ve.log("resyncStateOnHistoryChange",`准备回滚 ${e.length} 个MK: [${e.join(", ")}]`);for(const t of e.reverse())Ve.debug("resyncStateOnHistoryChange",`[回滚] 正在回滚 MK: ${t}`),await $e(t,!0);Ve.log("resyncStateOnHistoryChange","逆序回滚完成。")}}Ve.log("resyncStateOnHistoryChange",`从 ID ${r} 开始顺序重算...`);const o=n.slice(0,r);for(let e=r;e<t.length;e++){const a=t[e];Ve.debug("resyncStateOnHistoryChange",`[重算] 正在处理消息索引: ${e}`);const n=await Me(a);o[e]=n}Ve.log("resyncStateOnHistoryChange","顺序重算完成。"),await I(e=>(_.set(e,i,o),e)),Ve.log("resyncStateOnHistoryChange","状态同步完成。")},Ie=new h;async function Te(e){const t=getChatMessages(e);if(!t||0===t.length)return void Ie.warn("forceRenderMessage",`找不到消息ID为 ${e} 的消息。`);const a=t[0];await setChatMessages([{message_id:e,message:a.message}]),Ie.debug("forceRenderMessage",`已使用 setChatMessages 刷新消息 ${e}。`)}const Be=new h;async function Re(e,t,a){const{type:n}=e;Be.debug("handleSyncEvent",`事件 ${n} 触发状态同步流程...`);const r="manual_full_sync"===n;await De(r),t.resync=!0,"combo_sync"!=n&&async function(){const e=getVariables({type:"script",script_id:getScriptId()});if(!_.get(e,"强制重载功能",!1))return void Ie.debug("forceRenderRecentMessages","强制重载功能未启用, 跳过。");const t=_.get(e,"强制重载消息数",1);Ie.log("forceRenderRecentMessages",`开始强制重载, 数量: ${t}`),await new Promise(e=>setTimeout(e,1e3));const a=getChatMessages("0-{{lastMessageId}}");if(!a||0===a.length)return void Ie.warn("forceRenderRecentMessages","无法获取到任何消息, 终止重载。");const n=a.slice(-t);for(const e of n)Ie.debug("forceRenderRecentMessages",`正在强制渲染消息: ${e.message_id}`),await Te(e.message_id),await new Promise(e=>setTimeout(e,100));Ie.log("forceRenderRecentMessages","强制重载完成。")}(),await G(),fe(a)}const Le=new h;let Pe=null;function je(){const e=y.mk;return e&&Pe&&Pe.mk===e?(Le.debug("updateConsecutiveMkCount",`连续处理写入/同步操作的 MK: ${e}。旧计数: ${Pe.count}，新计数: ${Pe.count+1}`),Pe.count++):(Le.debug("updateConsecutiveMkCount",`新的写入/同步操作的 MK: ${e}。重置计数为 1。前一个 MK 是: ${Pe?.mk}`),Pe={mk:e,count:1}),Pe.count}async function ze(e,t){const{type:a}=e,n=C(a);let r=null;const o={rollback:!1,apply:!1,resync:!1,api:!1,apiWrite:!1};try{const{mk:s,message_id:c,isNewKey:d}=await(async()=>{try{const e=getChatMessages(-1,{include_swipes:!0})?.[0];if(Y.debug("ensureMkForLatestMessage",`获取到的最新消息对象 (msg): ${JSON.stringify(e)}`),!e||"number"!=typeof e.message_id)return Y.warn("ensureMkForLatestMessage","无法读取最新消息或其ID，退出"),{mk:"",message_id:null,isNewKey:!1};const{mk:t,isNew:a}=await W(e);return Y.log("ensureMkForLatestMessage",`已为最新消息 ${e.message_id} 确保 MK 存在。 (是否新建: ${a})`),{mk:t,message_id:e.message_id,isNewKey:a}}catch(e){return Y.error("ensureMkForLatestMessage",`确保MK时异常: ${e?.message||e}`,e),{mk:"",message_id:null,isNewKey:!1}}})();if(!s||null===c)return Le.warn("dispatchAndExecuteTask","无法获取有效的 MK 或消息 ID，跳过任务执行。"),t;y.mk=s,r=c,d&&s&&(t={mk:s,ignoreCount:1});const{shouldSkip:u,newIgnoreRule:p}=function(e,t,a){return a&&e===tavern_events.CHARACTER_MESSAGE_RENDERED&&t===a.mk?(Le.log("handleRedundantRenderEvent",`忽略由 MK (${a.mk}) 注入触发的冗余渲染事件。剩余忽略次数: ${a.ignoreCount-1}`),a.ignoreCount--,a.ignoreCount<=0&&(a=null,Le.log("handleRedundantRenderEvent","忽略次数用完")),{shouldSkip:!0,newIgnoreRule:a}):{shouldSkip:!1,newIgnoreRule:a}}(a,s,t);if(t=p,u)return t;Le.log("dispatchAndExecuteTask",`执行任务: ${a} (分组: ${n})`);const{meta:g,stat:f}=O(),m={mk:s,message_id:r,actions:o,selectedMks:_.get(g,i,[]),editLogs:_.get(g,l,{}),stat:f,statWithoutMeta:V(f),consecutiveProcessingCount:1};switch(n){case"INIT":X(),m.consecutiveProcessingCount=je(),await Re(e,o,m);break;case"SYNC":m.consecutiveProcessingCount=je(),await Re(e,o,m);break;case"API":ve(e,o,m);break;case"UPDATE_MK_ONLY":await async function(){await G()}()}}catch(e){Le.error("dispatchAndExecuteTask",`事件 ${a} 处理异常: ${e}`,e)}finally{y.mk=""}return t}const Je=new h,Ke=[];let He=!1,Fe=!1,Ye=null;function Ue(e,t){Je.debug("pushToQueue",`接收到事件: ${e}，已推入队列。`,{detail:t}),Ke.push({type:e,detail:t,timestamp:Date.now()}),async function(){if(Fe)return void Je.debug("processQueue","已有处理函数在排队等待，本次调用忽略。");He&&(Je.debug("processQueue","处理器忙碌，进入排队等待状态..."),Fe=!0,await new Promise(e=>{Ye=e}),Fe=!1,Je.debug("processQueue","等待结束，获取到处理权。"));if(0===Ke.length)return void Je.debug("processQueue","队列为空，无需处理。");He=!0,Je.log("processQueue","处理器启动");const e=Ke[0];if("API"!==C(e.type)){const t=N.get(e.type)??300;Je.log("processQueue",`启动事件收集窗口，等待 ${t}ms...`),await new Promise(e=>setTimeout(e,t))}Je.debug("processQueue","事件收集窗口关闭，准备处理的队列内容:",JSON.stringify(Ke.map(e=>e.type)));let t=null;for(;Ke.length>0;){const e=Ke.splice(0,Ke.length),a=S(e);Je.debug("processQueue",`开始处理一个新批次，包含 ${e.length} 个原始事件，合并后为 ${a.length} 个任务。`);for(const e of a){t=await ze(e,t)}Je.debug("processQueue","本轮批次处理完毕。")}if(He=!1,Je.log("processQueue","处理器空闲，已释放锁。"),Ye){Je.debug("processQueue","通知排队的处理器开始工作。");const e=Ye;Ye=null,e()}}()}const We=new h;$(()=>{registerMacroLike(/{{\s*ERA(-withmeta)?\s*:\s*([^}]+?)\s*}}/gi,(e,t,a,n)=>function(e){if(!e.includes("{{ERA"))return e;const{stat:t}=O();return t?e.replace(/{{\s*ERA(-withmeta)?\s*:\s*([^}]+?)\s*}}/gi,(e,a,n)=>{const r=n.trim(),o=!!a;let s;if(s="$ALLDATA"===r?t:_.get(t,r),void 0===s)return We.warn("parseEraMacros",`在 stat_data 中未找到路径 "${r}", 宏将替换为空字符串.`),"";const l=o?s:V(s),i=se(l);return We.debug("parseEraMacros",`宏替换数据反转义: ${r}`,{before:l,after:i}),"object"==typeof i&&null!==i?JSON.stringify(i):String(i)}):(We.warn("parseEraMacros","无法获取到 stat_data, 宏替换失败."),e)}(t))});const Ge=Vue,Qe={class:"action-buttons-container"},Ze=(0,Ge.defineComponent)({__name:"ActionButtons",setup(e){function t(){console.log("点击“完全重算变量”，发送 manual_full_sync 事件。"),eventEmit("manual_full_sync")}function a(){console.log("点击“重算最后一楼变量”，发送 manual_sync 事件。"),eventEmit("manual_sync")}return(e,n)=>((0,Ge.openBlock)(),(0,Ge.createElementBlock)("div",Qe,[(0,Ge.createElementVNode)("button",{onClick:(0,Ge.withModifiers)(t,["stop"])},"完全重算变量"),(0,Ge.createElementVNode)("button",{onClick:(0,Ge.withModifiers)(a,["stop"])},"重算最后一楼变量")]))}});n(818);var qe=n(42);const Xe=(0,qe.A)(Ze,[["__scopeId","data-v-d7f5d074"]]),et=(0,Ge.defineComponent)({__name:"FloatingBall",emits:["click"],setup:e=>(e,t)=>((0,Ge.openBlock)(),(0,Ge.createElementBlock)("div",{class:"floating-ball",onClick:t[0]||(t[0]=t=>e.$emit("click"))},[t[1]||(t[1]=(0,Ge.createElementVNode)("span",{class:"era-logo","aria-hidden":"true"},"ERA",-1)),(0,Ge.createCommentVNode)(" 仅显示用；不拦截事件 ")]))});n(639);const tt=(0,qe.A)(et,[["__scopeId","data-v-c745ba80"]]),at={class:"acc"},nt=["aria-expanded"],rt={class:"title"},ot={class:"hint"},st={class:"inner"},lt=(0,Ge.defineComponent)({__name:"EraAccordion",props:{title:{},defaultOpen:{type:Boolean,default:!1}},setup(e){const t=e,a=(0,Ge.ref)(t.defaultOpen),n=(0,Ge.ref)(null),r=(0,Ge.ref)("0px");async function o(){await(0,Ge.nextTick)();const e=n.value;if(e)if(a.value){const t=e.scrollHeight;r.value=t+"px"}else r.value="0px";else r.value="0px"}return(0,Ge.watch)(a,()=>o()),(0,Ge.onMounted)(()=>{o(),window.addEventListener("resize",o)}),(0,Ge.onBeforeUnmount)(()=>window.removeEventListener("resize",o)),(t,o)=>((0,Ge.openBlock)(),(0,Ge.createElementBlock)("section",at,[(0,Ge.createCommentVNode)(" 折叠头：点击切换 "),(0,Ge.createElementVNode)("button",{class:"acc-head","aria-expanded":a.value?"true":"false",onClick:o[0]||(o[0]=e=>a.value=!a.value)},[(0,Ge.createElementVNode)("span",{class:(0,Ge.normalizeClass)(["caret",{open:a.value}])},"▸",2),(0,Ge.createCommentVNode)(" 指示箭头 "),(0,Ge.createElementVNode)("span",rt,(0,Ge.toDisplayString)(e.title),1),(0,Ge.createCommentVNode)(" 标题文本 "),o[1]||(o[1]=(0,Ge.createElementVNode)("span",{class:"spacer"},null,-1)),(0,Ge.createCommentVNode)(" 弹性空隙 "),(0,Ge.createElementVNode)("span",ot,(0,Ge.toDisplayString)(a.value?"收起":"展开"),1),(0,Ge.createCommentVNode)(" 右侧提示 ")],8,nt),(0,Ge.createCommentVNode)(" 内容：高度过渡 "),(0,Ge.createElementVNode)("div",{ref_key:"bodyRef",ref:n,class:"acc-body",style:(0,Ge.normalizeStyle)({maxHeight:r.value})},[(0,Ge.withDirectives)((0,Ge.createElementVNode)("div",st,[(0,Ge.createCommentVNode)(" v-show：不销毁子树，只隐藏 "),(0,Ge.renderSlot)(t.$slots,"default"),(0,Ge.createCommentVNode)(" 插槽内容 ")],512),[[Ge.vShow,a.value]])],4)]))}});n(137);const it=(0,qe.A)(lt,[["__scopeId","data-v-874ac946"]]),ct={class:"meta"},dt={class:"kv"},ut={class:"item"},pt=["title"],gt={class:"item"},ft={class:"v"},mt=(0,Ge.defineComponent)({__name:"MetaHeader",props:{mk:{},messageId:{}},setup:e=>(t,a)=>((0,Ge.openBlock)(),(0,Ge.createElementBlock)("section",ct,[a[2]||(a[2]=(0,Ge.createElementVNode)("h4",{class:"meta-title"},"最新消息元数据",-1)),(0,Ge.createCommentVNode)(" 小节标题 "),(0,Ge.createElementVNode)("div",dt,[(0,Ge.createElementVNode)("div",ut,[a[0]||(a[0]=(0,Ge.createElementVNode)("span",{class:"k"},"mk",-1)),(0,Ge.createCommentVNode)(" 键：mk "),(0,Ge.createElementVNode)("span",{class:"v",title:e.mk},(0,Ge.toDisplayString)(e.mk||"—"),9,pt),(0,Ge.createCommentVNode)(" 值：mk ")]),(0,Ge.createElementVNode)("div",gt,[a[1]||(a[1]=(0,Ge.createElementVNode)("span",{class:"k"},"message_id",-1)),(0,Ge.createCommentVNode)(" 键：message_id "),(0,Ge.createElementVNode)("span",ft,(0,Ge.toDisplayString)(e.messageId??"—"),1),(0,Ge.createCommentVNode)(" 值：message_id ")])]),a[3]||(a[3]=(0,Ge.createElementVNode)("div",{class:"glow"},null,-1)),(0,Ge.createCommentVNode)(" 装饰：流光条 ")]))});n(581);const bt=(0,qe.A)(mt,[["__scopeId","data-v-26691347"]]),vt={class:"node"},yt={class:"key"},ht={class:"brace"},xt={key:0,class:"summary"},_t={key:0,class:"json-children"},kt={class:"brace"};const wt=(0,Ge.defineComponent)({name:"JsonNode",props:{k:{type:[String,Number],required:!0},v:{required:!0},path:{type:String,required:!0},level:{type:Number,required:!0},defaultCollapsed:{type:Boolean,default:!0},maxDepth:{type:Number,default:3}},setup(e){const t=(0,Ge.computed)(()=>{const t=e.v;if(null===t)return"null";if(Array.isArray(t))return"array";const a=typeof t;return"object"===a?"object":"undefined"===a?"undefined":a}),a=(0,Ge.computed)(()=>"array"===t.value),n=(0,Ge.computed)(()=>"object"===t.value),r=(0,Ge.computed)(()=>a.value||n.value),o=(0,Ge.ref)(e.level<=(e.maxDepth??3)||!e.defaultCollapsed),s=(0,Ge.computed)(()=>{const a=e.v;switch(t.value){case"string":return JSON.stringify(a);case"number":case"symbol":return String(a);case"boolean":return a?"true":"false";case"null":return"null";case"undefined":return"undefined";case"bigint":return String(a)+"n";case"function":return"ƒ()";default:return""}}),l=(0,Ge.computed)(()=>a.value?`Array[${e.v.length}]`:n.value?`Object{${Object.keys(e.v||{}).length}}`:""),i=(0,Ge.computed)(()=>{if(n.value)return e.v;if(a.value){const t={};return e.v.forEach((e,a)=>{t[String(a)]=e}),t}return{}});return{type:t,isArray:a,foldable:r,open:o,primitiveText:s,summary:l,childEntries:i}}});n(580);const Et=(0,qe.A)(wt,[["render",function(e,t,a,n,r,o){const s=(0,Ge.resolveComponent)("JsonNode",!0);return(0,Ge.openBlock)(),(0,Ge.createElementBlock)(Ge.Fragment,null,[(0,Ge.createCommentVNode)(" 单条节点（支持递归） "),(0,Ge.createElementVNode)("div",vt,[(0,Ge.createCommentVNode)(" 每个键值对 / 数组项的容器 "),(0,Ge.createElementVNode)("div",{class:"json-line",style:(0,Ge.normalizeStyle)({paddingLeft:14*e.level+"px"})},[(0,Ge.createCommentVNode)(" 行+缩进 "),e.foldable?((0,Ge.openBlock)(),(0,Ge.createElementBlock)("button",{key:0,class:(0,Ge.normalizeClass)(["caret",{open:e.open}]),"aria-label":"toggle",onClick:t[0]||(t[0]=t=>e.open=!e.open)},"▸",2)):(0,Ge.createCommentVNode)("v-if",!0),(0,Ge.createCommentVNode)(" 折叠箭头按钮 "),(0,Ge.createElementVNode)("span",yt,(0,Ge.toDisplayString)(e.k),1),t[1]||(t[1]=(0,Ge.createElementVNode)("span",{class:"colon"},":",-1)),(0,Ge.createCommentVNode)(" 键与冒号 "),(0,Ge.createCommentVNode)(" 可折叠容器：只显示括号与摘要；展开后由下方 children 区域递归渲染 "),e.foldable?((0,Ge.openBlock)(),(0,Ge.createElementBlock)(Ge.Fragment,{key:1},[(0,Ge.createElementVNode)("span",ht,(0,Ge.toDisplayString)(e.isArray?"[":"{"),1),(0,Ge.createCommentVNode)(" 容器起始括号 "),e.open?(0,Ge.createCommentVNode)("v-if",!0):((0,Ge.openBlock)(),(0,Ge.createElementBlock)("span",xt,(0,Ge.toDisplayString)(e.summary),1)),(0,Ge.createCommentVNode)(" 收起时的摘要 ")],64)):((0,Ge.openBlock)(),(0,Ge.createElementBlock)(Ge.Fragment,{key:2},[(0,Ge.createCommentVNode)(" 原始值：直接着色渲染 "),(0,Ge.createElementVNode)("span",{class:(0,Ge.normalizeClass)(["val",e.type])},(0,Ge.toDisplayString)(e.primitiveText),3),(0,Ge.createCommentVNode)(" 原始值文本 ")],64))],4),(0,Ge.createCommentVNode)(" 子元素区域：仅当可折叠且处于展开态时显示 "),e.foldable?(0,Ge.withDirectives)(((0,Ge.openBlock)(),(0,Ge.createElementBlock)("div",_t,[(0,Ge.createCommentVNode)(" 递归：自引用同名组件 JsonNode（依赖 name: 'JsonNode' 实现自递归） "),((0,Ge.openBlock)(!0),(0,Ge.createElementBlock)(Ge.Fragment,null,(0,Ge.renderList)(e.childEntries,(t,a)=>((0,Ge.openBlock)(),(0,Ge.createBlock)(s,{key:e.path+"/"+String(a),k:String(a),v:t,path:e.path+"/"+String(a),level:e.level+1,"default-collapsed":e.defaultCollapsed,"max-depth":e.maxDepth},null,8,["k","v","path","level","default-collapsed","max-depth"]))),128)),(0,Ge.createElementVNode)("div",{class:"json-line",style:(0,Ge.normalizeStyle)({paddingLeft:14*e.level+"px"})},[(0,Ge.createElementVNode)("span",kt,(0,Ge.toDisplayString)(e.isArray?"]":"}"),1),(0,Ge.createCommentVNode)(" 容器闭合括号 ")],4)],512)),[[Ge.vShow,e.open]]):(0,Ge.createCommentVNode)("v-if",!0)])],2112)}],["__scopeId","data-v-6c2eb3e9"]]),$t={class:"json-root"},Nt={class:"json-line"},Ct={class:"brace"},St={class:"json-children"},At={key:1,class:"json-line",style:{paddingLeft:"14px"}},Mt={class:"json-line"},Vt={class:"brace"},Ot=(0,Ge.defineComponent)({__name:"PrettyJsonViewer",props:{value:{},defaultCollapsed:{type:Boolean,default:!0},maxDepth:{default:3}},setup(e){const t=e,a=(0,Ge.computed)(()=>{const e=t.value;return null!==e&&"object"==typeof e}),n=(0,Ge.computed)(()=>{const e=t.value;if(null===e)return"null";if(Array.isArray(e))return"array";const a=typeof e;return"undefined"===a?"undefined":a}),r=(0,Ge.computed)(()=>{const e=t.value;switch(n.value){case"string":return JSON.stringify(e);case"number":case"symbol":return String(e);case"boolean":return e?"true":"false";case"null":return"null";case"undefined":return"undefined";case"bigint":return String(e)+"n";case"function":return"ƒ()";default:return""}}),o=(0,Ge.computed)(()=>Array.isArray(t.value)),s=(0,Ge.computed)(()=>o.value?"[":"{"),l=(0,Ge.computed)(()=>o.value?"]":"}");return(t,i)=>((0,Ge.openBlock)(),(0,Ge.createElementBlock)("div",$t,[(0,Ge.createElementVNode)("div",Nt,[(0,Ge.createElementVNode)("span",Ct,(0,Ge.toDisplayString)(s.value),1),(0,Ge.createCommentVNode)(" 根开括号：对象{ / 数组[ ")]),(0,Ge.createElementVNode)("div",St,[a.value?((0,Ge.openBlock)(),(0,Ge.createElementBlock)(Ge.Fragment,{key:0},[(0,Ge.createCommentVNode)(" 对象根：按键枚举 "),o.value?((0,Ge.openBlock)(),(0,Ge.createElementBlock)(Ge.Fragment,{key:1},[(0,Ge.createCommentVNode)(" 数组根：按索引枚举 "),((0,Ge.openBlock)(!0),(0,Ge.createElementBlock)(Ge.Fragment,null,(0,Ge.renderList)(e.value,(t,a)=>((0,Ge.openBlock)(),(0,Ge.createBlock)(Et,{key:String(a),k:String(a),v:t,path:String(a),level:1,"default-collapsed":e.defaultCollapsed,"max-depth":e.maxDepth},null,8,["k","v","path","default-collapsed","max-depth"]))),128))],64)):((0,Ge.openBlock)(!0),(0,Ge.createElementBlock)(Ge.Fragment,{key:0},(0,Ge.renderList)(e.value,(t,a)=>((0,Ge.openBlock)(),(0,Ge.createBlock)(Et,{key:String(a),k:String(a),v:t,path:String(a),level:1,"default-collapsed":e.defaultCollapsed,"max-depth":e.maxDepth},null,8,["k","v","path","default-collapsed","max-depth"]))),128))],64)):((0,Ge.openBlock)(),(0,Ge.createElementBlock)("div",At,[i[0]||(i[0]=(0,Ge.createElementVNode)("span",{class:"key"},"value",-1)),i[1]||(i[1]=(0,Ge.createElementVNode)("span",{class:"colon"},":",-1)),(0,Ge.createElementVNode)("span",{class:(0,Ge.normalizeClass)(["val",n.value])},(0,Ge.toDisplayString)(r.value),3)]))]),(0,Ge.createElementVNode)("div",Mt,[(0,Ge.createElementVNode)("span",Vt,(0,Ge.toDisplayString)(l.value),1),(0,Ge.createCommentVNode)(" 根闭括号：对象} / 数组] ")])]))}});n(278);const Dt=(0,qe.A)(Ot,[["__scopeId","data-v-4d5f14c2"]]),It={class:"tabs"},Tt={class:"tab-bar",role:"tablist"},Bt=["onClick"],Rt={class:"tab-content"},Lt={key:0},Pt={key:1},jt=(0,Ge.defineComponent)({__name:"TabSwitch",props:{tabs:{},active:{}},emits:["update:active"],setup(e,{emit:t}){const a=e,n=t,r=(0,Ge.ref)(a.active??"pure");return(0,Ge.watch)(()=>a.active,e=>{e&&(r.value=e)}),(t,a)=>((0,Ge.openBlock)(),(0,Ge.createElementBlock)("section",It,[(0,Ge.createCommentVNode)(" 页签行 "),(0,Ge.createElementVNode)("div",Tt,[((0,Ge.openBlock)(!0),(0,Ge.createElementBlock)(Ge.Fragment,null,(0,Ge.renderList)(e.tabs,e=>((0,Ge.openBlock)(),(0,Ge.createElementBlock)("button",{key:e.key,class:(0,Ge.normalizeClass)(["tab-btn",{active:e.key===r.value}]),role:"tab",onClick:t=>{return a=e.key,r.value=a,void n("update:active",a);var a}},(0,Ge.toDisplayString)(e.label),11,Bt))),128))]),(0,Ge.createCommentVNode)(" 内容区：根据活动键渲染对应插槽 "),(0,Ge.createElementVNode)("div",Rt,["pure"===r.value?((0,Ge.openBlock)(),(0,Ge.createElementBlock)("div",Lt,[(0,Ge.renderSlot)(t.$slots,"pure"),(0,Ge.createCommentVNode)(" 纯净状态数据内容 ")])):((0,Ge.openBlock)(),(0,Ge.createElementBlock)("div",Pt,[(0,Ge.renderSlot)(t.$slots,"full"),(0,Ge.createCommentVNode)(" 完整状态数据内容 ")]))])]))}});n(729);const zt=(0,qe.A)(jt,[["__scopeId","data-v-1e003116"]]),Jt={class:"era-app-container"},Kt={class:"era-panel"},Ht={class:"panel-top"},Ft={class:"panel-body"},Yt=(0,Ge.defineComponent)({__name:"App",props:{initialView:{type:String,required:!0,default:"FloatingBall"},eventData:{type:Object,default:()=>null}},setup(e){const t=e,a=(0,Ge.ref)(t.initialView),n=e=>{window.eraUiSwitchView&&window.eraUiSwitchView(e)},r=(0,Ge.computed)(()=>t.eventData||null),o=[{key:"pure",label:"纯净状态数据"},{key:"full",label:"完整状态数据"}],s=(0,Ge.ref)("pure");return(e,t)=>((0,Ge.openBlock)(),(0,Ge.createElementBlock)("div",Jt,[(0,Ge.withDirectives)((0,Ge.createVNode)(tt,{onClick:t[0]||(t[0]=e=>n("ExpandedView"))},null,512),[[Ge.vShow,"FloatingBall"===a.value]]),(0,Ge.withDirectives)((0,Ge.createElementVNode)("div",null,[(0,Ge.createCommentVNode)(" EraDataPanel 的内容直接在这里展开 "),(0,Ge.createElementVNode)("div",Kt,[(0,Ge.createCommentVNode)(" 顶部栏：标题 + 关闭按钮 "),(0,Ge.createElementVNode)("header",Ht,[t[3]||(t[3]=(0,Ge.createElementVNode)("h3",{class:"panel-title"},"ERA 数据面板",-1)),(0,Ge.createElementVNode)("button",{class:"btn-close","aria-label":"关闭",onClick:t[1]||(t[1]=e=>n("FloatingBall"))},"×")]),(0,Ge.createCommentVNode)(" 内容区 "),(0,Ge.createElementVNode)("div",Ft,[r.value?((0,Ge.openBlock)(),(0,Ge.createElementBlock)(Ge.Fragment,{key:0},[(0,Ge.createCommentVNode)(" 1. 最新消息元数据 "),(0,Ge.createVNode)(bt,{mk:r.value.mk,"message-id":r.value.message_id},null,8,["mk","message-id"]),(0,Ge.createCommentVNode)(" 2. 可折叠：ERA 最新操作详情 "),(0,Ge.createVNode)(it,{title:"ERA 最新操作详情","default-open":!1},{default:(0,Ge.withCtx)(()=>[(0,Ge.createVNode)(it,{title:"SelectedMks（数组）","default-open":!1},{default:(0,Ge.withCtx)(()=>[(0,Ge.createVNode)(Dt,{value:r.value.selectedMks,"default-collapsed":!0,"max-depth":3},null,8,["value"])]),_:1}),(0,Ge.createVNode)(it,{title:"EditLogs（对象）","default-open":!1},{default:(0,Ge.withCtx)(()=>[(0,Ge.createVNode)(Dt,{value:r.value.editLogs,"default-collapsed":!0,"max-depth":2},null,8,["value"])]),_:1})]),_:1}),(0,Ge.createCommentVNode)(" 3. Tab：状态数据主区 "),(0,Ge.createVNode)(zt,{active:s.value,"onUpdate:active":t[2]||(t[2]=e=>s.value=e),tabs:o},{pure:(0,Ge.withCtx)(()=>[(0,Ge.createVNode)(Dt,{value:r.value.statWithoutMeta,"default-collapsed":!0,"max-depth":1/0},null,8,["value"])]),full:(0,Ge.withCtx)(()=>[(0,Ge.createVNode)(Dt,{value:r.value.stat,"default-collapsed":!0,"max-depth":1/0},null,8,["value"])]),_:1},8,["active"])],64)):((0,Ge.openBlock)(),(0,Ge.createElementBlock)(Ge.Fragment,{key:1},[(0,Ge.createCommentVNode)(" 无数据占位 "),t[4]||(t[4]=(0,Ge.createElementVNode)("div",{class:"empty"},"等待 era:writeDone 事件数据…",-1))],64))])]),(0,Ge.createVNode)(Xe)],512),[[Ge.vShow,"ExpandedView"===a.value]])]))}});n(481),n(727);const Ut=(0,qe.A)(Yt,[["__scopeId","data-v-c606c8d0"]]);let Wt=null,Gt=null,Qt="FloatingBall",Zt=null;function qt(t,a){Gt&&(Wt&&Wt.unmount(),Wt=(0,Ge.createApp)(Ut,{initialView:t,eventData:a}),Wt.use(e()),Wt.mount(Gt[0]),function(){const e=getScriptId();$(`head > div[script_id="${e}"]`).remove();const t=$("<div>").attr("script_id",e).append($("head > style",document).clone());$("head").append(t)}())}window.eraUiSwitchView=function(e){Qt!==e&&(Qt=e,qt(e,Zt))},$(()=>{Gt=$("<div>").attr("id",`era-ui-mount-point-${getScriptId()}`).css({position:"fixed",bottom:"20px",left:"20px","z-index":1e4}),$("body").append(Gt),qt(Qt,Zt),eventOn("era:writeDone",e=>{Zt=e,qt(Qt,Zt)})}),$(window).on("pagehide",()=>{Wt&&Wt.unmount(),$(`head > div[script_id="${getScriptId()}"]`).remove(),Gt&&$(`div#era-ui-mount-point-${getScriptId()}`).remove()});[...k.INIT,...k.SYNC,...k.API,...k.UPDATE_MK_ONLY,...k.COLLISION_DETECTORS,...k.COMBO_STARTERS].forEach(e=>{eventOn(e,t=>Ue(e,t))}),eventOn(getButtonEvent("写入变量修改"),()=>Ue("manual_write")),eventOn(getButtonEvent("手动同步状态"),()=>Ue("manual_sync")),eventOn(getButtonEvent("强制完全重算"),()=>Ue("manual_full_sync"));