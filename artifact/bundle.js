import{createPinia as e}from"https://testingcf.jsdelivr.net/npm/pinia/+esm";var t={42:(e,t)=>{t.A=(e,t)=>{const a=e.__vccOpts||e;for(const[e,n]of t)a[e]=n;return a}},54:e=>{e.exports=function(e){var t=[];return t.toString=function(){return this.map(function(t){var a="",n=void 0!==t[5];return t[4]&&(a+="@supports (".concat(t[4],") {")),t[2]&&(a+="@media ".concat(t[2]," {")),n&&(a+="@layer".concat(t[5].length>0?" ".concat(t[5]):""," {")),a+=e(t),n&&(a+="}"),t[2]&&(a+="}"),t[4]&&(a+="}"),a}).join("")},t.i=function(e,a,n,r,o){"string"==typeof e&&(e=[[null,e,void 0]]);var s={};if(n)for(var i=0;i<this.length;i++){var l=this[i][0];null!=l&&(s[l]=!0)}for(var c=0;c<e.length;c++){var d=[].concat(e[c]);n&&s[d[0]]||(void 0!==o&&(void 0===d[5]||(d[1]="@layer".concat(d[5].length>0?" ".concat(d[5]):""," {").concat(d[1],"}")),d[5]=o),a&&(d[2]?(d[1]="@media ".concat(d[2]," {").concat(d[1],"}"),d[2]=a):d[2]=a),r&&(d[4]?(d[1]="@supports (".concat(d[4],") {").concat(d[1],"}"),d[4]=r):d[4]="".concat(r)),t.push(d))}},t}},93:e=>{e.exports=function(e){return e[1]}},100:(e,t,a)=>{a.r(t),a.d(t,{default:()=>i});var n=a(93),r=a.n(n),o=a(54),s=a.n(o)()(r());s.push([e.id,".json-line[data-v-4cec1669]{position:relative;display:flex;align-items:center;gap:6px;padding:2px 6px;border-radius:6px}.json-line[data-v-4cec1669]:hover{background:rgba(59,130,246,0.06)}.json-children[data-v-4cec1669]{border-left:1px dashed rgba(107,114,128,0.25)}.key[data-v-4cec1669]{color:#1f2937;font-weight:700}.colon[data-v-4cec1669]{color:#6b7280}.brace[data-v-4cec1669]{color:#9ca3af}.summary[data-v-4cec1669]{color:#6b7280;margin-left:4px}.val.string[data-v-4cec1669]{color:#047857}.val.number[data-v-4cec1669]{color:#7c3aed}.val.boolean[data-v-4cec1669]{color:#0369a1}.val.null[data-v-4cec1669]{color:#9ca3af}.val.undefined[data-v-4cec1669]{color:#9ca3af}.caret[data-v-4cec1669]{width:18px;height:18px;border:1px solid rgba(0,0,0,0.06);border-radius:4px;background:#fff;line-height:16px;text-align:center;font-size:10px;color:#6b7280;cursor:pointer;box-shadow:0 1px 0 #fff,0 2px 6px rgba(0,0,0,0.06);transition:transform 0.18s ease,box-shadow 0.18s ease}.caret.open[data-v-4cec1669]{transform:rotate(90deg);box-shadow:0 3px 10px rgba(0,0,0,0.12)}.node[data-v-4cec1669]{overflow:clip;contain:paint;min-height:0}.json-children[data-v-4cec1669]{overflow:clip;contain:paint}\n\n",""]);const i=s},109:(e,t,a)=>{a.r(t),a.d(t,{default:()=>i});var n=a(93),r=a.n(n),o=a(54),s=a.n(o)()(r());s.push([e.id,".era-panel[data-v-2eb98172]{width:min(960px,60vw);height:min(680px,86vh);display:flex;flex-direction:column;background:linear-gradient(180deg,rgba(255,255,255,0.75),rgba(255,255,255,0.65));border:1px solid rgba(255,255,255,0.6);backdrop-filter:blur(10px);border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,0.18),inset 0 1px 0 rgba(255,255,255,0.6);overflow:hidden;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}.panel-top[data-v-2eb98172]{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid rgba(0,0,0,0.06);background:linear-gradient(90deg,rgba(255,255,255,0.65),rgba(255,255,255,0.45))}.panel-title[data-v-2eb98172]{font-size:16px;font-weight:800;letter-spacing:0.5px;color:#1f2937}.btn-close[data-v-2eb98172]{width:32px;height:32px;line-height:30px;text-align:center;border-radius:8px;border:1px solid rgba(0,0,0,0.08);background:#fff;cursor:pointer;font-size:18px;color:#6b7280;box-shadow:0 2px 8px rgba(0,0,0,0.08)}.btn-close[data-v-2eb98172]:hover{transform:translateY(-1px);box-shadow:0 6px 16px rgba(0,0,0,0.12)}.panel-body[data-v-2eb98172]{padding:14px 14px 16px;overflow:auto}.block[data-v-2eb98172]{margin:12px 0 4px;padding:10px 12px;background:rgba(255,255,255,0.6);border:1px solid rgba(0,0,0,0.06);border-radius:12px}.block-title[data-v-2eb98172]{margin:0 0 8px;font-size:13px;font-weight:800;color:#374151}.chips[data-v-2eb98172]{display:flex;flex-wrap:wrap;gap:8px}.chip[data-v-2eb98172]{font-size:12px;padding:6px 8px;border:1px solid rgba(0,0,0,0.06);border-radius:999px;background:linear-gradient(180deg,#fafafa,#f4f4f4);color:#6b7280;box-shadow:inset 0 1px 0 #fff}.chip.ok[data-v-2eb98172]{color:#065f46;background:linear-gradient(180deg,#ecfdf5,#d1fae5);border-color:#a7f3d0}.mk-strip[data-v-2eb98172]{display:flex;gap:8px;flex-wrap:wrap;max-height:140px;overflow:auto}.mk-pill[data-v-2eb98172]{display:inline-flex;gap:6px;align-items:center;padding:6px 8px;background:linear-gradient(180deg,#eef2ff,#e0e7ff);color:#4338ca;border:1px solid #c7d2fe;border-radius:8px;font-size:12px}.mk-pill.is-null[data-v-2eb98172]{background:linear-gradient(180deg,#f9fafb,#f3f4f6);color:#6b7280;border-color:#e5e7eb}.empty[data-v-2eb98172]{height:360px;display:grid;place-items:center;color:#6b7280;font-size:14px;border:1px dashed rgba(0,0,0,0.08);border-radius:12px;background:rgba(255,255,255,0.5)}[data-v-2eb98172] button[aria-expanded='false']+*{height:0 !important;padding-top:0 !important;padding-bottom:0 !important;margin-top:0 !important;margin-bottom:0 !important;border-top-width:0 !important;border-bottom-width:0 !important;overflow:clip !important;contain:paint !important}[data-v-2eb98172] button[aria-expanded='true']+*{overflow:visible}.era-shell[data-v-2eb98172]{display:flex;align-items:flex-start;gap:12px;flex-wrap:nowrap}.era-panel[data-v-2eb98172]{flex:0 1 auto}.right-rail[data-v-2eb98172]{width:min(320px,34vw);position:sticky;top:10px;align-self:flex-start;z-index:1}@media (max-width:1100px){.era-shell[data-v-2eb98172]{flex-wrap:wrap}.right-rail[data-v-2eb98172]{width:100%;position:static;margin-top:8px}}[data-v-2eb98172] .floating-ball{position:fixed;right:max(16px,env(safe-area-inset-right));bottom:max(16px,env(safe-area-inset-bottom));z-index:2147483647;pointer-events:auto;touch-action:manipulation;will-change:transform}.era-expanded-layer[data-v-2eb98172]{position:fixed;inset:0;display:grid;place-items:center;padding:clamp(12px,2.5vw,24px);pointer-events:auto;z-index:2147483646;background:transparent;overflow:auto}@media (max-width:640px){.era-panel[data-v-2eb98172]{width:min(92vw,560px);height:min(88vh,calc(100svh - 32px))}.panel-body[data-v-2eb98172]{overscroll-behavior:contain}}\n\n\n",""]);const i=s},168:(e,t,a)=>{var n=a(100);n.__esModule&&(n=n.default),"string"==typeof n&&(n=[[e.id,n,""]]),n.locals&&(e.exports=n.locals);(0,a(424).A)("41ca7890",n,!1,{ssrId:!0})},173:(e,t,a)=>{a.r(t),a.d(t,{default:()=>i});var n=a(93),r=a.n(n),o=a(54),s=a.n(o)()(r());s.push([e.id,".action-buttons-card[data-v-5766043a]{width:100%;padding:12px;background:linear-gradient(180deg,rgba(255,255,255,0.76),rgba(255,255,255,0.62));border:1px solid rgba(255,255,255,0.6);border-radius:16px;backdrop-filter:blur(10px);box-shadow:0 10px 40px rgba(0,0,0,0.16),inset 0 1px 0 rgba(255,255,255,0.6);display:flex;flex-direction:column;gap:10px}.card-title[data-v-5766043a]{margin:0 0 4px;font-size:14px;font-weight:800;letter-spacing:0.3px;color:#1f2937}.btns[data-v-5766043a]{display:flex;flex-direction:column;gap:10px}.btn[data-v-5766043a]{display:grid;grid-template-columns:22px 1fr;align-items:center;-moz-column-gap:8px;column-gap:8px;padding:10px 12px;border-radius:12px;border:1px solid rgba(0,0,0,0.06);background:linear-gradient(180deg,#fafafa,#f3f4f6);color:#374151;font-weight:700;font-size:13px;cursor:pointer;box-shadow:inset 0 1px 0 #fff,0 2px 8px rgba(0,0,0,0.08);transition:transform 0.12s ease,box-shadow 0.12s ease,background 0.2s ease;text-align:left}.btn.primary[data-v-5766043a]{background:linear-gradient(180deg,#e0f2fe,#bfdbfe);border-color:#93c5fd;color:#0f172a}.btn.subtle[data-v-5766043a]{background:linear-gradient(180deg,#f9fafb,#f3f4f6);border-color:#e5e7eb}.btn[data-v-5766043a]:hover{transform:translateY(-1px);box-shadow:inset 0 1px 0 #fff,0 6px 16px rgba(0,0,0,0.12)}.btn[data-v-5766043a]:active{transform:translateY(0);box-shadow:inset 0 1px 0 #fff,0 2px 8px rgba(0,0,0,0.1)}.btn[data-v-5766043a]:focus-visible{outline:2px solid #60a5fa;outline-offset:2px}.ico[data-v-5766043a]{display:inline-grid;place-items:center;width:22px;height:22px;filter:saturate(0.95)}.label[data-v-5766043a]{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}\n",""]);const i=s},192:(e,t,a)=>{a.r(t),a.d(t,{default:()=>i});var n=a(93),r=a.n(n),o=a(54),s=a.n(o)()(r());s.push([e.id,".acc[data-v-cb8a53de]{border:1px solid rgba(0,0,0,0.06);border-radius:12px;background:linear-gradient(180deg,#fff,#fafafa);overflow:hidden}.acc-head[data-v-cb8a53de]{width:100%;display:flex;align-items:center;gap:10px;background:linear-gradient(180deg,#f9fafb,#f3f4f6);border-bottom:1px solid rgba(0,0,0,0.06);padding:10px 12px;cursor:pointer;font-weight:800;color:#374151}.caret[data-v-cb8a53de]{transition:transform 0.18s ease}.caret.open[data-v-cb8a53de]{transform:rotate(90deg)}.title[data-v-cb8a53de]{font-size:13px}.spacer[data-v-cb8a53de]{flex:1}.hint[data-v-cb8a53de]{font-size:12px;color:#6b7280}.acc-body[data-v-cb8a53de]{display:grid;grid-template-rows:0fr;transition:grid-template-rows 0.28s ease;background:rgba(255,255,255,0.82)}.acc-body.open[data-v-cb8a53de]{grid-template-rows:1fr}.inner[data-v-cb8a53de]{overflow:hidden;transition:padding 0.28s ease,visibility 0s 0.28s;padding:0 12px;visibility:hidden}.acc-body.open .inner[data-v-cb8a53de]{padding:10px 12px;visibility:visible;transition-delay:0s}\n",""]);const i=s},223:(e,t,a)=>{var n=a(387);n.__esModule&&(n=n.default),"string"==typeof n&&(n=[[e.id,n,""]]),n.locals&&(e.exports=n.locals);(0,a(424).A)("442eb154",n,!1,{ssrId:!0})},234:(e,t,a)=>{var n=a(734);n.__esModule&&(n=n.default),"string"==typeof n&&(n=[[e.id,n,""]]),n.locals&&(e.exports=n.locals);(0,a(424).A)("b51a0090",n,!1,{ssrId:!0})},264:(e,t,a)=>{a.r(t),a.d(t,{default:()=>i});var n=a(93),r=a.n(n),o=a(54),s=a.n(o)()(r());s.push([e.id,".floating-ball[data-v-ee0f5b22]{--size:50px;--hue:212;--sat:100%;--lum:52%;--surface:hsl(var(--hue) var(--sat) var(--lum));--surface-2:hsl(var(--hue) 95% 64%);--ring:hsl(calc(var(--hue) + 20) 95% 65%);--shadow:rgba(0,123,255,0.36);--glow:rgba(102,200,255,0.55);--inner-shadow:rgba(0,0,0,0.22);--specular:rgba(255,255,255,0.75);--glass:rgba(255,255,255,0.18);width:var(--size);height:var(--size);border-radius:50%;position:relative;display:grid;place-items:center;cursor:pointer;-webkit-user-select:none;user-select:none;-webkit-tap-highlight-color:transparent;background:radial-gradient(120% 120% at 30% 28%,rgba(255,255,255,0.85) 0%,rgba(255,255,255,0.22) 18%,rgba(255,255,255,0) 36%),radial-gradient(120% 120% at 70% 72%,rgba(0,0,0,0.18) 0%,rgba(0,0,0,0) 38%),conic-gradient(from 210deg at 50% 50%,var(--surface),var(--surface-2),var(--surface));box-shadow:inset 0 2px 6px var(--inner-shadow),0 2px 4px rgba(0,0,0,0.08),0 10px 22px var(--shadow);transition:transform 0.28s ease,box-shadow 0.28s ease,filter 0.28s ease;will-change:transform,box-shadow,filter;animation:ball-bob-ee0f5b22 3.2s ease-in-out infinite}.floating-ball[data-v-ee0f5b22]::after{content:'';position:absolute;inset:-8px;border-radius:50%;background:conic-gradient(from 0deg,var(--ring),transparent 30%,transparent 70%,var(--ring));filter:blur(6px);opacity:0.55;pointer-events:none;-webkit-mask:radial-gradient(farthest-side,transparent calc(100% - 12px),#000 0);mask:radial-gradient(farthest-side,transparent calc(100% - 12px),#000 0);animation:ring-spin-ee0f5b22 12s linear infinite}.floating-ball[data-v-ee0f5b22]::before{content:'';position:absolute;inset:2px;border-radius:50%;background:radial-gradient(120% 80% at 26% 24%,var(--specular) 0%,rgba(255,255,255,0.2) 26%,rgba(255,255,255,0) 46%),linear-gradient(160deg,var(--glass) 0%,rgba(255,255,255,0) 50%);mix-blend-mode:screen;pointer-events:none;transition:opacity 0.28s ease,transform 0.28s ease}.floating-ball[data-v-ee0f5b22]:hover{transform:translateY(-2px) scale(1.04);box-shadow:inset 0 2px 8px rgba(0,0,0,0.22),0 4px 10px rgba(0,0,0,0.12),0 16px 36px rgba(0,123,255,0.45);filter:saturate(1.08)}.floating-ball[data-v-ee0f5b22]:hover::before{opacity:0.95;animation:shimmer-ee0f5b22 1.2s ease-out}.floating-ball[data-v-ee0f5b22]:active{transform:translateY(0) scale(0.98);box-shadow:inset 0 2px 10px rgba(0,0,0,0.28),0 2px 6px rgba(0,0,0,0.12),0 10px 22px rgba(0,123,255,0.35)}.floating-ball[data-v-ee0f5b22]:focus-visible{outline:2px solid rgba(102,200,255,0.85);outline-offset:2px}@media (prefers-reduced-motion:reduce){.floating-ball[data-v-ee0f5b22]{animation:none}.floating-ball[data-v-ee0f5b22]::after{animation:none}}@keyframes ball-bob-ee0f5b22{0%,100%{transform:translateY(0)}50%{transform:translateY(-2px)}}@keyframes ring-spin-ee0f5b22{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}@keyframes shimmer-ee0f5b22{0%{transform:translateY(-1px) scale(0.98);opacity:0.6}50%{transform:translateY(-2px) scale(1.02);opacity:1}100%{transform:translateY(-1px) scale(0.99);opacity:0.85}}.floating-ball[data-v-ee0f5b22]{--logo-scale:0.38}.era-logo[data-v-ee0f5b22]{font-weight:800;font-size:calc(var(--size) * var(--logo-scale));letter-spacing:0.02em;line-height:1;transform:translateY(-1px);white-space:nowrap;-webkit-user-select:none;user-select:none;pointer-events:none;z-index:1;background:linear-gradient(180deg,rgba(255,255,255,0.96) 0%,rgba(255,255,255,0.55) 45%,rgba(220,240,255,0.4) 65%,rgba(120,195,255,0.55) 100%),linear-gradient(180deg,rgba(0,0,0,0.38),rgba(0,0,0,0) 60%);-webkit-background-clip:text;background-clip:text;color:transparent;text-shadow:0 1px 0 rgba(255,255,255,0.75),0 2px 4px rgba(0,0,0,0.25),0 8px 18px rgba(0,123,255,0.35);filter:drop-shadow(0 0 2px rgba(102,200,255,0.25));animation:era-sheen-ee0f5b22 4s ease-in-out infinite}.floating-ball:hover .era-logo[data-v-ee0f5b22]{text-shadow:0 1px 0 rgba(255,255,255,0.85),0 3px 8px rgba(0,0,0,0.28),0 10px 26px rgba(0,123,255,0.55);filter:drop-shadow(0 0 3px rgba(102,200,255,0.38))}@keyframes era-sheen-ee0f5b22{0%,100%{background-position:0% 0%,0% 0%}50%{background-position:0% 40%,0% 0%}}\n",""]);const i=s},318:(e,t,a)=>{a.r(t),a.d(t,{default:()=>i});var n=a(93),r=a.n(n),o=a(54),s=a.n(o)()(r());s.push([e.id,".meta[data-v-56f5fbd7]{position:relative;padding:12px 12px 14px;border:1px solid rgba(0,0,0,0.06);border-radius:12px;background:linear-gradient(180deg,#ffffff,#f9fafb);box-shadow:0 6px 18px rgba(0,0,0,0.06),inset 0 1px 0 #fff}.meta-title[data-v-56f5fbd7]{margin:0 0 10px;font-size:13px;font-weight:800;color:#374151}.kv[data-v-56f5fbd7]{display:grid;grid-template-columns:120px 1fr;gap:8px 12px}.item[data-v-56f5fbd7]{display:contents}.k[data-v-56f5fbd7]{justify-self:start;align-self:center;font-size:12px;color:#6b7280;background:#f3f4f6;border:1px solid #e5e7eb;padding:4px 8px;border-radius:8px;font-weight:700}.v[data-v-56f5fbd7]{align-self:center;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;color:#111827;background:#fff;border:1px solid #e5e7eb;padding:6px 8px;border-radius:8px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.glow[data-v-56f5fbd7]{position:absolute;left:12px;right:12px;top:-1px;height:3px;border-radius:999px;background:linear-gradient(90deg,#60a5fa,#a78bfa,#34d399,#f472b6);filter:blur(0.4px)}\n",""]);const i=s},387:(e,t,a)=>{a.r(t),a.d(t,{default:()=>i});var n=a(93),r=a.n(n),o=a(54),s=a.n(o)()(r());s.push([e.id,".settings-card[data-v-3c2a864c]{width:100%;padding:12px;margin-top:12px;background:linear-gradient(180deg,rgba(255,255,255,0.76),rgba(255,255,255,0.62));border:1px solid rgba(255,255,255,0.6);border-radius:16px;backdrop-filter:blur(10px);box-shadow:0 10px 40px rgba(0,0,0,0.16),inset 0 1px 0 rgba(255,255,255,0.6);display:flex;flex-direction:column;gap:10px}.card-header[data-v-3c2a864c]{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);background:linear-gradient(180deg,#fafafa,#f3f4f6);color:#1f2937;font-weight:800;font-size:13px;cursor:pointer;box-shadow:inset 0 1px 0 #fff,0 2px 8px rgba(0,0,0,0.08)}.card-header[data-v-3c2a864c]:hover{transform:translateY(-1px);box-shadow:inset 0 1px 0 #fff,0 6px 16px rgba(0,0,0,0.12)}.title[data-v-3c2a864c]{pointer-events:none}.chev[data-v-3c2a864c]{opacity:0.7}.content[data-v-3c2a864c]{display:flex;flex-direction:column;gap:10px}.toolbar[data-v-3c2a864c]{display:flex;align-items:center;gap:8px}.spacer[data-v-3c2a864c]{flex:1}.mini-btn[data-v-3c2a864c]{padding:6px 10px;border-radius:8px;border:1px solid rgba(0,0,0,0.08);background:linear-gradient(180deg,#fafafa,#f3f4f6);cursor:pointer;font-size:12px;font-weight:700;box-shadow:inset 0 1px 0 #fff,0 2px 6px rgba(0,0,0,0.06)}.mini-btn[data-v-3c2a864c]:hover{transform:translateY(-1px);box-shadow:inset 0 1px 0 #fff,0 5px 12px rgba(0,0,0,0.1)}.mini-btn.primary[data-v-3c2a864c]{background:linear-gradient(180deg,#e0f2fe,#bfdbfe);border-color:#93c5fd;color:#0f172a}.mini-btn.subtle[data-v-3c2a864c]{background:linear-gradient(180deg,#f9fafb,#f3f4f6);border-color:#e5e7eb}.vars[data-v-3c2a864c]{display:flex;flex-direction:column;gap:8px}.var-row[data-v-3c2a864c]{display:grid;grid-template-columns:1fr minmax(120px,1.2fr) auto;align-items:center;gap:10px;padding:8px 10px;border:1px solid rgba(0,0,0,0.06);border-radius:10px;background:linear-gradient(180deg,#ffffff,#f8fafc)}.var-key[data-v-3c2a864c]{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:12px;color:#374151;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.var-editor[data-v-3c2a864c]{display:flex;align-items:center;gap:8px}.ipt[data-v-3c2a864c]{width:100%;padding:8px 10px;border-radius:8px;border:1px solid #e5e7eb;background:#fff;font-size:12px;color:#111827;box-shadow:inset 0 1px 0 #fff}.ta[data-v-3c2a864c]{min-height:64px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}.type-chip[data-v-3c2a864c]{font-size:11px;color:#374151;background:#eef2ff;border:1px solid #c7d2fe;border-radius:999px;padding:4px 8px;white-space:nowrap}.switch[data-v-3c2a864c]{position:relative;width:42px;height:24px;display:inline-block}.switch input[data-v-3c2a864c]{opacity:0;width:0;height:0}.switch .track[data-v-3c2a864c]{position:absolute;inset:0;border-radius:999px;background:#e5e7eb;box-shadow:inset 0 1px 0 #fff;transition:background 0.2s ease}.switch .track[data-v-3c2a864c]::after{content:'';position:absolute;top:3px;left:3px;width:18px;height:18px;border-radius:50%;background:#fff;box-shadow:0 1px 3px rgba(0,0,0,0.2);transition:transform 0.2s ease}.switch input:checked+.track[data-v-3c2a864c]{background:#93c5fd}.switch input:checked+.track[data-v-3c2a864c]::after{transform:translateX(18px)}.hint[data-v-3c2a864c]{font-size:11px;color:#6b7280}.hint.ok[data-v-3c2a864c]{color:#065f46}.hint.bad[data-v-3c2a864c]{color:#b91c1c}.placeholder[data-v-3c2a864c]{padding:10px;color:#6b7280;font-size:12px;border:1px dashed rgba(0,0,0,0.08);border-radius:10px;background:rgba(255,255,255,0.5)}\n",""]);const i=s},424:(e,t,a)=>{function n(e,t){for(var a=[],n={},r=0;r<t.length;r++){var o=t[r],s=o[0],i={id:e+":"+r,css:o[1],media:o[2],sourceMap:o[3]};n[s]?n[s].parts.push(i):a.push(n[s]={id:s,parts:[i]})}return a}a.d(t,{A:()=>f});var r="undefined"!=typeof document;if("undefined"!=typeof DEBUG&&DEBUG&&!r)throw new Error("vue-style-loader cannot be used in a non-browser environment. Use { target: 'node' } in your Webpack config to indicate a server-rendering environment.");var o={},s=r&&(document.head||document.getElementsByTagName("head")[0]),i=null,l=0,c=!1,d=function(){},p=null,u="data-vue-ssr-id",g="undefined"!=typeof navigator&&/msie [6-9]\b/.test(navigator.userAgent.toLowerCase());function f(e,t,a,r){c=a,p=r||{};var s=n(e,t);return m(s),function(t){for(var a=[],r=0;r<s.length;r++){var i=s[r];(l=o[i.id]).refs--,a.push(l)}t?m(s=n(e,t)):s=[];for(r=0;r<a.length;r++){var l;if(0===(l=a[r]).refs){for(var c=0;c<l.parts.length;c++)l.parts[c]();delete o[l.id]}}}}function m(e){for(var t=0;t<e.length;t++){var a=e[t],n=o[a.id];if(n){n.refs++;for(var r=0;r<n.parts.length;r++)n.parts[r](a.parts[r]);for(;r<a.parts.length;r++)n.parts.push(v(a.parts[r]));n.parts.length>a.parts.length&&(n.parts.length=a.parts.length)}else{var s=[];for(r=0;r<a.parts.length;r++)s.push(v(a.parts[r]));o[a.id]={id:a.id,refs:1,parts:s}}}}function b(){var e=document.createElement("style");return e.type="text/css",s.appendChild(e),e}function v(e){var t,a,n=document.querySelector("style["+u+'~="'+e.id+'"]');if(n){if(c)return d;n.parentNode.removeChild(n)}if(g){var r=l++;n=i||(i=b()),t=x.bind(null,n,r,!1),a=x.bind(null,n,r,!0)}else n=b(),t=w.bind(null,n),a=function(){n.parentNode.removeChild(n)};return t(e),function(n){if(n){if(n.css===e.css&&n.media===e.media&&n.sourceMap===e.sourceMap)return;t(e=n)}else a()}}var h,y=(h=[],function(e,t){return h[e]=t,h.filter(Boolean).join("\n")});function x(e,t,a,n){var r=a?"":n.css;if(e.styleSheet)e.styleSheet.cssText=y(t,r);else{var o=document.createTextNode(r),s=e.childNodes;s[t]&&e.removeChild(s[t]),s.length?e.insertBefore(o,s[t]):e.appendChild(o)}}function w(e,t){var a=t.css,n=t.media,r=t.sourceMap;if(n&&e.setAttribute("media",n),p.ssrId&&e.setAttribute(u,t.id),r&&(a+="\n/*# sourceURL="+r.sources[0]+" */",a+="\n/*# sourceMappingURL=data:application/json;base64,"+btoa(unescape(encodeURIComponent(JSON.stringify(r))))+" */"),e.styleSheet)e.styleSheet.cssText=a;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(a))}}},447:(e,t,a)=>{var n=a(467);n.__esModule&&(n=n.default),"string"==typeof n&&(n=[[e.id,n,""]]),n.locals&&(e.exports=n.locals);(0,a(424).A)("1dafd168",n,!1,{ssrId:!0})},467:(e,t,a)=>{a.r(t),a.d(t,{default:()=>i});var n=a(93),r=a.n(n),o=a(54),s=a.n(o)()(r());s.push([e.id,".era-app-container{position:fixed;inset:0;z-index:2147483646;pointer-events:none;isolation:isolate;contain:layout style paint;width:100svw;height:100svh}\n\n",""]);const i=s},530:(e,t,a)=>{var n=a(318);n.__esModule&&(n=n.default),"string"==typeof n&&(n=[[e.id,n,""]]),n.locals&&(e.exports=n.locals);(0,a(424).A)("c8140b84",n,!1,{ssrId:!0})},532:(e,t,a)=>{var n=a(192);n.__esModule&&(n=n.default),"string"==typeof n&&(n=[[e.id,n,""]]),n.locals&&(e.exports=n.locals);(0,a(424).A)("20abdb4c",n,!1,{ssrId:!0})},734:(e,t,a)=>{a.r(t),a.d(t,{default:()=>i});var n=a(93),r=a.n(n),o=a(54),s=a.n(o)()(r());s.push([e.id,".json-root[data-v-eebe0c8c]{font-size:12px;color:#111827}.json-line[data-v-eebe0c8c]{position:relative;display:flex;align-items:center;gap:6px;padding:2px 6px;border-radius:6px}.json-line[data-v-eebe0c8c]:hover{background:rgba(59,130,246,0.06)}.json-children[data-v-eebe0c8c]{border-left:1px dashed rgba(107,114,128,0.25)}.key[data-v-eebe0c8c]{color:#1f2937;font-weight:700}.colon[data-v-eebe0c8c]{color:#6b7280}.brace[data-v-eebe0c8c]{color:#9ca3af}.val.string[data-v-eebe0c8c]{color:#047857}.val.number[data-v-eebe0c8c]{color:#7c3aed}.val.boolean[data-v-eebe0c8c]{color:#0369a1}.val.null[data-v-eebe0c8c]{color:#9ca3af}.val.undefined[data-v-eebe0c8c]{color:#9ca3af}.json-root[data-v-eebe0c8c]{overflow:clip;contain:layout paint;min-height:0}.json-children[data-v-eebe0c8c]{overflow:clip;contain:paint}\n\n",""]);const i=s},737:(e,t,a)=>{var n=a(109);n.__esModule&&(n=n.default),"string"==typeof n&&(n=[[e.id,n,""]]),n.locals&&(e.exports=n.locals);(0,a(424).A)("56b5b6b6",n,!1,{ssrId:!0})},756:(e,t,a)=>{a.r(t),a.d(t,{default:()=>i});var n=a(93),r=a.n(n),o=a(54),s=a.n(o)()(r());s.push([e.id,".tabs[data-v-7ab146e6]{margin-top:12px;border:1px solid rgba(0,0,0,0.06);border-radius:12px;overflow:hidden;background:linear-gradient(180deg,#fff,#fafafa)}.tab-bar[data-v-7ab146e6]{display:flex;gap:8px;padding:8px;border-bottom:1px solid rgba(0,0,0,0.06);background:linear-gradient(180deg,#f9fafb,#f3f4f6)}.tab-btn[data-v-7ab146e6]{padding:8px 12px;font-weight:800;font-size:13px;color:#6b7280;background:#fff;border:1px solid #e5e7eb;border-radius:10px;cursor:pointer}.tab-btn.active[data-v-7ab146e6]{color:#111827;border-color:#93c5fd;box-shadow:inset 0 1px 0 #fff,0 0 0 3px rgba(147,197,253,0.35)}.tab-content[data-v-7ab146e6]{padding:10px 12px;background:rgba(255,255,255,0.86)}\n",""]);const i=s},836:(e,t,a)=>{var n=a(264);n.__esModule&&(n=n.default),"string"==typeof n&&(n=[[e.id,n,""]]),n.locals&&(e.exports=n.locals);(0,a(424).A)("354d2f26",n,!1,{ssrId:!0})},865:(e,t,a)=>{var n=a(173);n.__esModule&&(n=n.default),"string"==typeof n&&(n=[[e.id,n,""]]),n.locals&&(e.exports=n.locals);(0,a(424).A)("6aec6adc",n,!1,{ssrId:!0})},872:(e,t,a)=>{var n=a(756);n.__esModule&&(n=n.default),"string"==typeof n&&(n=[[e.id,n,""]]),n.locals&&(e.exports=n.locals);(0,a(424).A)("c206fafe",n,!1,{ssrId:!0})}},a={};function n(e){var r=a[e];if(void 0!==r)return r.exports;var o=a[e]={id:e,exports:{}};return t[e](o,o.exports,n),o.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var a in t)n.o(t,a)&&!n.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};const r={type:"chat"},o="ERAMetaData",s="stat_data",i="EditLogs",l="SelectedMks",c="era_data",d=new RegExp(`<${c}>({.*?})<\\/${c}>`),p={INSERT_BY_OBJECT:"era:insertByObject",UPDATE_BY_OBJECT:"era:updateByObject",INSERT_BY_PATH:"era:insertByPath",UPDATE_BY_PATH:"era:updateByPath",DELETE_BY_OBJECT:"era:deleteByObject",DELETE_BY_PATH:"era:deleteByPath",GET_CURRENT_VARS:"era:getCurrentVars"},u="era:writeDone",g="era:apiWrite",f="era_debug_config";let m=[],b=[];function v(){try{const e=globalThis.localStorage?.getItem(f)||'{"enabled":[],"disabled":[]}',t=JSON.parse(e),a=e=>new RegExp(`^${e.replace(/\*/g,".*?")}$`);m=(t.enabled||[]).map(a),b=(t.disabled||[]).map(a)}catch(e){console.error("《ERA-Log》: 加载调试配置失败。",e),m=[],b=[]}}function h(e){const t={enabled:[...new Set(e.enabled)],disabled:[...new Set(e.disabled)]};globalThis.localStorage?.setItem(f,JSON.stringify(t)),v(),console.log("%c《ERA-Log》调试模式已更新。","color: #3498db; font-weight: bold;",{"启用 (Enabled)":t.enabled,"禁用 (Disabled)":t.disabled})}if(v(),"undefined"!=typeof globalThis){const e={add(e){const t=globalThis.localStorage?.getItem(f)||'{"enabled":[],"disabled":[]}',a=JSON.parse(t),n=new Set(a.enabled||[]),r=new Set(a.disabled||[]);n.add(e),r.delete(e),h({enabled:Array.from(n),disabled:Array.from(r)})},remove(e){const t=globalThis.localStorage?.getItem(f)||'{"enabled":[],"disabled":[]}',a=JSON.parse(t),n=new Set(a.enabled||[]),r=new Set(a.disabled||[]);r.add(e),n.delete(e),h({enabled:Array.from(n),disabled:Array.from(r)})},status(){const e=globalThis.localStorage?.getItem(f)||'{"enabled":[],"disabled":[]}',t=JSON.parse(e);console.log("%c《ERA-Log》当前调试配置:","color: #3498db; font-weight: bold;",t)},clear(){h({enabled:[],disabled:[]})}};globalThis.eraDebug=e}const y={mk:""};class x{moduleName;constructor(e){this.moduleName=e||(this._getModuleNameFromStack()||"unknown")}_getModuleNameFromStack(){try{const e=((new Error).stack||"").split("\n").find(e=>e.includes("/src/ERA变量框架/")&&!e.includes("/utils/log.ts"));if(!e)return null;const t=e.match(/src\/ERA变量框架\/([^?:\s)]+)/);if(!t||!t[1])return null;let a=t[1];return a=a.replace(/\.(vue|ts|js)$/,""),a.replace(/^src\/ERA变量框架\//,"").replace(/\/index$/,"").replace(/\//g,"-")}catch(e){return console.error("《ERA-Log-Debug》: 解析模块名时发生意外错误。",e),null}}formatMessage(e,t){return`《ERA》${y.mk?`（${y.mk}）`:""}「${this.moduleName}」【${e}】${String(t)}`}debug(e,t,a){if(!(n=this.moduleName)||b.some(e=>e.test(n))||0===m.length||!m.some(e=>e.test(n)))return;var n;const r=this.formatMessage(e,t);void 0!==a?console.debug(r,a):console.debug(r)}log(e,t,a){const n=this.formatMessage(e,t);void 0!==a?console.log(`%c${n}`,"color: #3498db;",a):console.log(`%c${n}`,"color: #3498db;")}warn(e,t,a){const n=this.formatMessage(e,t);void 0!==a?console.warn(`%c${n}`,"color: #f39c12;",a):console.warn(`%c${n}`,"color: #f39c12;")}error(e,t,a){const n=this.formatMessage(e,t);void 0!==a?console.error(`%c${n}`,"color: #e74c3c; font-weight: bold;",a):console.error(`%c${n}`,"color: #e74c3c; font-weight: bold;")}}const w=new x,k={INIT:[tavern_events.APP_READY],SYNC:["manual_write",g,tavern_events.MESSAGE_RECEIVED,tavern_events.MESSAGE_DELETED,tavern_events.MESSAGE_SWIPED,tavern_events.CHAT_CHANGED,"manual_sync","manual_full_sync","combo_sync"],API:Object.values(p),UPDATE_MK_ONLY:[tavern_events.MESSAGE_SENT],COLLISION_DETECTORS:[tavern_events.GENERATION_STARTED],COMBO_STARTERS:[tavern_events.MESSAGE_UPDATED]},N=new Map([[tavern_events.MESSAGE_SWIPED,{next:tavern_events.GENERATION_STARTED,maxInterval:600}]]),E=new Map([[tavern_events.MESSAGE_UPDATED,{next:tavern_events.GENERATION_STARTED,resultType:"combo_sync",maxInterval:1600}]]),V=new Map([[tavern_events.MESSAGE_SWIPED,500],[tavern_events.MESSAGE_UPDATED,1500]]);function C(e){return k.INIT.includes(e)?"INIT":k.SYNC.includes(e)?"SYNC":k.API.includes(e)?"API":k.UPDATE_MK_ONLY.includes(e)?"UPDATE_MK_ONLY":k.COLLISION_DETECTORS.includes(e)?"COLLISION_DETECTORS":k.COMBO_STARTERS.includes(e)?"COMBO_STARTERS":"UNKNOWN"}function S(e){const t=_.cloneDeep(e),a=[];for(const t of e){if(0===a.length){a.push(t);continue}const e=a[a.length-1],n=t.timestamp-e.timestamp,r=E.get(e.type);if(r&&t.type===r.next){if(n<=r.maxInterval){w.debug("mergeEventBatch",`检测到事件组合: ${e.type} 和 ${t.type} (时间差: ${n}ms <= ${r.maxInterval}ms)。将合并为 ${r.resultType} 事件。`),a.pop(),a.push({type:r.resultType,timestamp:t.timestamp,detail:t.detail});continue}w.debug("mergeEventBatch",`检测到潜在的事件组合，但因超时而失败: ${e.type} 和 ${t.type} (时间差: ${n}ms > ${r.maxInterval}ms)。`)}const o=N.get(e.type);if(o&&t.type===o.next){if(n<=o.maxInterval){w.debug("mergeEventBatch",`检测到相邻事件对冲: ${e.type} 和 ${t.type} (时间差: ${n}ms <= ${o.maxInterval}ms)。将忽略这两个事件。`),a.pop();continue}w.debug("mergeEventBatch",`检测到潜在的事件对冲，但因超时而失败: ${e.type} 和 ${t.type} (时间差: ${n}ms > ${o.maxInterval}ms)。`)}const s=C(e.type);s===C(t.type)&&"SYNC"===s?a[a.length-1]=t:a.push(t)}const n=a.filter(e=>{const t=C(e.type),a="COLLISION_DETECTORS"===t,n="COMBO_STARTERS"===t;return(a||n)&&w.debug("mergeEventBatch",`清理未配对的事件: ${e.type}`),!a&&!n});return w.debug("mergeEventBatch",`事件合并: ${t.length} -> ${n.length}`,{before:t.map(e=>e.type),after:n.map(e=>e.type)}),n}const A=_;var O=n.n(A);function M(e){if(!O().isObject(e))return e;const t=O().cloneDeep(e);return function e(t){if(Array.isArray(t))t.forEach(t=>e(t));else if(O().isPlainObject(t))for(const a in t)a.startsWith("$")?delete t[a]:e(t[a])}(t),t}function D(){const e=getVariables(r)||{};return{meta:O().get(e,o,{}),stat:O().get(e,s,{})}}async function I(e){await updateVariablesWith(async t=>{const a=O().get(t,s,{}),n=await e(a);return O().set(t,s,n),t},r)}async function T(e){await updateVariablesWith(async t=>{const a=O().get(t,o,{}),n=await e(a);return O().set(t,o,n),t},r)}function B(e){if(!e.includes("{{"))return e;let t=e;return t=t.replace(/{{user}}/gi,SillyTavern.name1),t=t.replace(/{{char}}/gi,SillyTavern.name2),t}const R=new x;function j(e){if(!e)return null;let t=null;if("string"==typeof e.mes)t=e.mes;else if(Array.isArray(e.swipes)){const a=Number(e.swipe_id??0);t=e.swipes[a]||null}else"string"==typeof e.message&&(t=e.message);return null===t?null:B(t)}function L(e){const t=function(e){if("string"!=typeof e)return null;const t=e.match(d);if(!t||!t[1])return null;try{const e=t[1],a=e.match(/"era-message-key"\s*=\s*"(.*?)"/),n=e.match(/"era-message-type"\s*=\s*"(.*?)"/);if(a?.[1]&&n?.[1]){const e={"era-message-key":a[1],"era-message-type":n[1]};return R.debug("parseEraData","成功解析 EraData",e),e}return R.debug("parseEraData","未能在 EraData 块中找到完整的键值对",{customFormatBlock:e}),null}catch(e){return R.warn("parseEraData","解析 EraData 块时发生异常",e),null}}(j(e));return t?"user"===t["era-message-type"]:"user"===e?.role}async function P(e,t){const a=j(e);R.debug("updateMessageContent","更新前的消息内容:",a),R.debug("updateMessageContent","更新后的消息内容:",t);const n={message_id:e.message_id};if(Array.isArray(e.swipes)){const a=Number(e.swipe_id??0),r=[...e.swipes];r[a]=t,n.swipes=r}else n.message=t;await setChatMessages([n],{refresh:"none"})}function J(e){if(!e)return e;let t=String(e).trim();return t=t.replace(/^\s*(?:```|~~~)\[a-zA-Z0-9_-\]*\s*\r?\n/,""),t=t.replace(/\r?\n(?:```|~~~)\s*$/,""),t.trim()}function F(e="",t="exact"){if("any"===t||"*"===e)return/([a-zA-Z][a-zA-Z0-9_]*)/;const a=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");switch(t){case"exact":return new RegExp(`(${a})`);case"prefix":return new RegExp(`(${a}[a-zA-Z0-9_]*)`);case"suffix":return new RegExp(`([a-zA-Z0-9_]*${a})`);default:return new RegExp(`([a-zA-Z0-9_]*${a}[a-zA-Z0-9_]*)`)}}function K(e,t,a=e.length){const n=new RegExp(`</${t.source}>`,"g");let r,o=null;for(;null!==(r=n.exec(e))&&r.index<a;)o=r;if(!o)return null;const s=o[1],i=o.index,l=`<${s}>`,c=e.lastIndexOf(l,i);return-1===c?K(e,t,i):{startIndex:c,endIndex:i+`</${s}>`.length,content:e.substring(c+l.length,i),tagName:s}}function U(e,t){return(t?new RegExp(`</?${t.source}>`):/<\/?\s*[a-zA-Z][a-zA-Z0-9_]*\s*>/).test(e)}function H(e,t){const a=function(e,t){let a=e;for(;;){const e=K(a,t);if(!e)break;a=a.slice(0,e.startIndex)+a.slice(e.endIndex)}return a}(e,F("think","contains")),n=function(e,t){const a=[];let n=e.length;for(;n>0;){const r=K(e,t,n);if(!r)break;a.unshift(r.content),n=r.startIndex}return a}(a,t),r=[];for(const e of n){const t=J(e.trim());U(t)||t&&r.push(t)}return r}const Y=new x;function W(e){if(!e)return"";const t=j(e);return function(e){if("string"!=typeof e)return null;const t=e.match(d);if(!t||!t[1])return null;try{const e=t[1],a=e.match(/"era-message-key"\s*=\s*"(.*?)"/),n=e.match(/"era-message-type"\s*=\s*"(.*?)"/);return a?.[1]&&n?.[1]?{"era-message-key":a[1],"era-message-type":n[1]}:null}catch{return null}}(t)?.["era-message-key"]||""}async function G(e){if(!e||"number"!=typeof e.message_id||!e.role)return Y.warn("ensureMessageKey",`无效的消息对象结构，无法确保Key。msg=${JSON.stringify(e)}`),{mk:"",isNew:!1};const t=W(e);if(t)return{mk:t,isNew:!1};const a=`era_mk_${Date.now()}_${Math.random().toString(36).slice(2,8)}`,n="user"===e.role?"user":"assistant",r=`<${c}>{"era-message-key"="${a}","era-message-type"="${n}"}</${c}>`;Y.log("ensureMessageKey",`为消息 (ID: ${e.message_id}) 注入新的Key: ${a}`);const o=r+"\n"+(j(e)??"");return await P(e,o),{mk:a,isNew:!0}}const Q=async()=>{const e=getChatMessages(-1,{include_swipes:!0})?.[0];if(!e||"number"!=typeof e.message_id)return;const{mk:t}=await G(e);t&&await T(a=>{const n=_.get(a,l,[]);return n[e.message_id]!==t&&(n[e.message_id]=t,_.set(a,l,n)),a})},Z=z,q=new x,X=Z.z.object({强制重载功能:Z.z.boolean().default(!1),强制重载消息数:Z.z.number().default(2)}).prefault({});function ee(){let e;e||(e=X.parse(getVariables({type:"script",script_id:getScriptId()})),q.debug("initializeExternalSettings","写入脚本变量:",e),insertVariables(e,{type:"script",script_id:getScriptId()}))}$(()=>{ee()});const te=new x,ae={".":"__DOT__",'"':"__DQUOTE__","'":"__SQUOTE__"},ne=_.invert(ae),re=new RegExp(Object.keys(ae).map(_.escapeRegExp).join("|"),"g"),oe=new RegExp(Object.values(ae).map(_.escapeRegExp).join("|"),"g");function se(e){if(Array.isArray(e))return e.map(e=>se(e));if(_.isPlainObject(e)){const t={};for(const a in e)if(Object.prototype.hasOwnProperty.call(e,a)){t[a.replace(re,e=>ae[e])]=se(e[a])}return t}return"string"==typeof e?e.replace(re,e=>ae[e]):e}function ie(e){if(Array.isArray(e))return e.map(e=>ie(e));if(_.isPlainObject(e)){const t={};for(const a in e)if(Object.prototype.hasOwnProperty.call(e,a)){t[a.replace(oe,e=>ne[e])]=ie(e[a])}return t}return"string"==typeof e?e.replace(oe,e=>ne[e]):e}function le(e){if(Array.isArray(e))return e.map(e=>Array.isArray(e)||_.isPlainObject(e)?JSON.stringify(e):e);if(_.isPlainObject(e)){const t={};for(const a in e)t[a]=le(e[a]);return t}return e}const ce=e=>{try{return JSON.stringify(e,null,2)}catch(e){return`<<stringify失败: ${e?.message||e}>>`}};function de(e,t){return _.mergeWith(_.cloneDeep(e),_.cloneDeep(t),(e,t)=>{if(Array.isArray(e)||Array.isArray(t))return t})}function pe(e){if(Array.isArray(e))return e;if(e&&"object"==typeof e)return[e];if("string"==typeof e){const t=e.replace(/^\s*```(?:json)?\s*|\s*```\s*$/g,"");try{const e=JSON.parse(t);return Array.isArray(e)?e:[]}catch{return[]}}return[]}function ue(e){const t=[];if(!e||"string"!=typeof e)return t;const a=function(e){if(!e)return"";let t="",a=!1;for(let n=0;n<e.length;n++){const r=e[n];if('"'!==r||0!==n&&"\\"===e[n-1]||(a=!a),a){t+=r;continue}const o=e[n+1];if("/"===r&&"/"===o){const a=e.indexOf("\n",n+2);if(-1===a)break;t+="\n",n=a;continue}if("/"===r&&"*"===o){const t=e.indexOf("*/",n+2);if(-1===t)break;n=t+1;continue}if("<"===r&&"\x3c!--"===e.substring(n,n+4)){const t=e.indexOf("--\x3e",n+4);if(-1===t)break;n=t+2;continue}t+=r}return t}(e),n=a.trim();let r=0,o=-1,s=!1;for(let e=0;e<n.length;e++){const a=n[e];if('"'!==a||0!==e&&"\\"===n[e-1]||(s=!s),!s)if("{"===a)0===r&&(o=e),r++;else if("}"===a&&r>0&&(r--,0===r&&-1!==o)){const a=n.substring(o,e+1);try{const e=JSON.parse(a);t.push(e)}catch(e){te.error(`JSONL 解析失败: ${e?.message||e}. 失败的片段: ${a}`,e)}o=-1}}return t}const ge=new x,fe=_.debounce(()=>{eventEmit(g),ge.log("debouncedEmitApiWrite",`已触发合并后的 ${g} 事件。`)},50,{leading:!1,trailing:!0});function me(e){const{stat:t,meta:a}=D(),n=M(t);ge.debug("emitWriteDoneEvent","获取了最新的 ERA 数据并生成了纯净版",{stat:t,meta:a,statWithoutMeta:n});const r={...e,stat:ie(t),statWithoutMeta:ie(n),selectedMks:_.get(a,l,[]),editLogs:_.get(a,i,{})};ge.debug("emitWriteDoneEvent","动态构建了完整的事件载荷",{inputPayload:e,fullPayload:r}),eventEmit(u,r),ge.log("emitWriteDoneEvent",`已触发 ${u} 事件。操作: ${JSON.stringify(e.actions)}, MK: ${e.mk}, MsgID: ${e.message_id}, 连续处理次数: ${e.consecutiveProcessingCount}`)}const be=new x;async function ve(e){const t=ce(e.blockContent),a=`\n<${e.blockTag}>\n${t}\n</${e.blockTag}>`,n=await function(){const e=getChatMessages("0-{{lastMessageId}}",{include_swipes:!0});if(!e||0===e.length)return R.debug("findLastAiMessage","聊天记录为空, 未找到任何消息。"),null;for(let t=e.length-1;t>=0;t--){const a=e[t];if(!L(a))return R.debug("findLastAiMessage",`找到最后一条 AI 消息, ID: ${a.message_id}`),a}return R.debug("findLastAiMessage","未在聊天记录中找到任何 AI 消息。"),null}();if(!n)return void be.warn("performApiWrite","找不到任何 AI 消息，无法执行 API 写入。");const r=(j(n)??"")+a;be.log("performApiWrite",`实时写入 API 任务 (${e.blockTag}) 到消息 ID ${n.message_id}...`),await P(n,r),fe()}function he(e,t,a){const{type:n,detail:r}=e;var o,s;t.api=!0,n===p.INSERT_BY_OBJECT?ve({blockTag:"VariableInsert",blockContent:r}):n===p.UPDATE_BY_OBJECT?function(e){ve({blockTag:"VariableEdit",blockContent:e})}(r):n===p.INSERT_BY_PATH?(o=r.path,s=r.value,ve({blockTag:"VariableInsert",blockContent:_.set({},o,s)})):n===p.UPDATE_BY_PATH?function(e,t){ve({blockTag:"VariableEdit",blockContent:_.set({},e,t)})}(r.path,r.value):n===p.DELETE_BY_OBJECT?function(e){ve({blockTag:"VariableDelete",blockContent:e})}(r):n===p.DELETE_BY_PATH?function(e){ve({blockTag:"VariableDelete",blockContent:_.set({},e,{})})}(r.path):n===p.GET_CURRENT_VARS&&function(e){me(e)}(a)}const ye=new x;function xe(e,t,a,n){const r=t?_.get(e,t):e;if(void 0===r)return void ye.warn("applyDeleteAtLevel",`VariableDelete 跳过：路径不存在 -> ${t||"(root)"}`);const o=_.get(r,["$meta","necessary"]),s=_.get(a,"$meta"),i=_.isPlainObject(s)&&_.isEmpty(s)||_.has(a,["$meta","necessary"]);if(_.isPlainObject(a)&&!_.isEmpty(a)){if("all"===o&&!i)return void ye.warn("applyDeleteAtLevel",`VariableDelete 失败：路径 <${t}> 受 "necessary: all" 保护，其子节点无法被删除。`);for(const r of Object.keys(a)){xe(e,t?`${t}.${r}`:r,a[r],n)}return}if("self"===o||"all"===o)return void ye.warn("applyDeleteAtLevel",`VariableDelete 失败：路径 <${t}> 受 "necessary: ${o}" 保护，无法被直接删除。`);if(""===t)return void ye.error("applyDeleteAtLevel","VariableDelete 失败：不允许删除根对象。");const l=_.cloneDeep(r);_.unset(e,t),n.push({op:"delete",path:t,value_old:l}),ye.debug("applyDeleteAtLevel",`成功删除节点: ${t}`)}const we=new x;function ke(e,t){if(!e)return;const a=_.get(e,"$template"),n=_.get(e,t);if(_.isPlainObject(a)&&_.isPlainObject(n)){we.debug("getInheritedTemplateContent",`为子节点 "${t}" 同时找到原型和特异性内容。\n      - 原型: ${JSON.stringify(a)}\n      - 特异性: ${JSON.stringify(n)}`);const e=de(_.cloneDeep(a),n);return we.debug("getInheritedTemplateContent",`  - 合并后: ${JSON.stringify(e)}`),e}return _.isPlainObject(n)?(we.debug("getInheritedTemplateContent",`为子节点 "${t}" 只找到特异性内容: ${JSON.stringify(n)}`),n):_.isPlainObject(a)?(we.debug("getInheritedTemplateContent",`为子节点 "${t}" 只找到原型内容: ${JSON.stringify(a)}`),a):void we.debug("getInheritedTemplateContent",`在父级模板内容中未为子节点 "${t}" 找到任何可继承的规则。`)}const _e=new x;function Ne(e,t,a,n,r,o){const s=function(e,t){const a=_.get(t,"$template");we.debug("resolveTemplate",`解析出的模板内容:\n    - 继承: ${JSON.stringify(e)}\n    - 父节点变量: ${JSON.stringify(a)}`);let n={};return n=de(n,e),n=de(n,a),we.debug("resolveTemplate",`合并后的最终模板内容: ${JSON.stringify(n)}`),_.isEmpty(n)?null:n}(r,o);_e.debug("applyInsertAtLevel",`[入口] basePath: "${t||"root"}"`,{statData:_.cloneDeep(e)});const i=t?_.get(e,t):e;if(_e.debug("applyInsertAtLevel",`[路径检查] at path: "${t||"root"}". currentNodeInVars 的值:`,i),t&&void 0===i){const r=function(e,t){if(we.debug("applyTemplateToPatch",`[进入] 模板内容: ${JSON.stringify(e)}, 补丁: ${JSON.stringify(t)}`),!_.isPlainObject(t))return we.debug("applyTemplateToPatch","[退出] 补丁不是一个普通对象，直接返回。"),t;if(!e)return we.debug("applyTemplateToPatch","[退出] 模板内容无效，直接返回补丁。"),t;if(_.isEmpty(t))return we.debug("applyTemplateToPatch","补丁为空对象，完全使用模板内容。"),_.cloneDeep(e);const a=de(_.cloneDeep(e),t);return we.debug("applyTemplateToPatch",`合并模板与补丁后的结果: ${JSON.stringify(a)}`),a}(s,a),o=le(r);return _e.debug("applyInsertAtLevel",`最终插入数据 at ${t}:\n${JSON.stringify(o,null,2)}`),_.set(e,t,o),n.push({op:"insert",path:t,value_new:_.cloneDeep(o)}),void _e.debug("applyInsertAtLevel",`原子性插入到新路径: ${t}`)}if(_.isPlainObject(i)&&_.isPlainObject(a)){_e.debug("applyInsertAtLevel",`[递归补充] at path: "${t||"root"}"\n      - 当前层级模板 (localTplContent): ${JSON.stringify(s)}`);for(const r of Object.keys(a)){const o=t?`${t}.${r}`:r,l=a[r],c=ke(s,r);_e.debug("applyInsertAtLevel",`  - 准备递归子节点: "${r}"\n      - 将传递给子节点的模板 (subInheritedContent): ${JSON.stringify(c)}`),Ne(e,o,l,n,c,i)}}else t&&_e.warn("applyInsertAtLevel",`VariableInsert 失败：路径已存在且无法递归补充 -> ${t}`)}const Ee=new x;async function Ve(e,t=!1){try{Ee.log("rollbackByMk",`开始回滚, MK=${e}`),await updateVariablesWith(t=>{const a=_.get(t,o,{}),n=_.get(t,s,{}),r=pe(_.get(a,[i,e]));if(!r||!r.length)return Ee.debug("rollbackByMk","EditLog 为空或无效，跳过回滚。"),t;for(let e=r.length-1;e>=0;e--){const t=r[e],a=String(t?.op||"").toLowerCase(),o=String(t?.path||"");o&&("insert"!==a?"update"!==a&&"delete"!==a||(void 0===t?.value_old?_.unset(n,o):_.set(n,o,_.cloneDeep(t.value_old))):_.unset(n,o))}return _.set(t,s,n),t},r),Ee.log("rollbackByMk",`回滚完成：MK=${e}`)}catch(t){Ee.error("rollbackByMk",`回滚异常：MK=${e} → ${t?.message||t}`,t)}}async function Ce(e,t){Ee?.debug("findLatestNewValue",`开始为路径 <${e}> 从消息ID <${t}> 向上追溯历史值...`);const a=getChatMessages("0-{{lastMessageId}}",{include_swipes:!1});if(!a||a.length<1)return Ee?.debug("findLatestNewValue","消息历史为空，无法追溯。"),null;const n=a.findIndex(e=>e.message_id===t);if(-1===n)return Ee?.warn("findLatestNewValue",`错误：在消息列表中未找到起始消息ID: ${t}`),null;for(let t=n-1;t>=0;t--){const n=a[t],r=n?.message_id;if(Ee?.debug("findLatestNewValue",`[进度] 正在检查消息 (ID: ${r})，内容: "${(j(n)||"").substring(0,100)}..."`),L(n)||"number"!=typeof r)continue;const o=W(n);if(!o){Ee?.debug("findLatestNewValue",`[进度] 消息 (ID: ${r}) 无 MK，跳过。`);continue}const{meta:s}=D(),l=pe(_.get(s,[i,o]));if(l&&0!==l.length){Ee?.debug("findLatestNewValue",`[进度] 正在检查 MK ${o} 的 EditLog...\n${ce(l)}`);for(let t=l.length-1;t>=0;t--){const a=l[t];if(a&&a.path){if(a.path===e)return"delete"===a.op?(Ee?.error("findLatestNewValue",`>> 状态异常! 在消息(ID:${n.message_id}, MK:${o})中为路径 <${e}> 找到了 'delete' 记录。这表明 update 操作可能正在尝试修改一个已被删除的变量。`),null):(Ee?.debug("findLatestNewValue",`>> 成功! 在消息(ID:${n.message_id}, MK:${o})中找到精确路径 <${e}> 的值为: ${ce(a.value_new)}`),_.cloneDeep(a.value_new));if(e.startsWith(a.path+".")){const t=e.substring(a.path.length+1),r=a.value_new;if(_.isPlainObject(r)&&_.has(r,t)){const e=_.get(r,t);return Ee?.debug("findLatestNewValue",`>> 成功! 在消息(ID:${n.message_id}, MK:${o})中找到父级路径 <${a.path}>, 并从中提取子路径 <${t}> 的值为: ${ce(e)}`),_.cloneDeep(e)}}}}}else Ee?.debug("findLatestNewValue",`[进度] MK ${o} 的 EditLog 为空，跳过。`)}return Ee?.debug("findLatestNewValue",`向上追溯未找到路径 ${e} 的任何历史值，将使用 null 作为旧值`),null}const $e=new x;async function Se(e,t,a,n,r,o){const s=t?_.get(e,t):e;if(void 0===s)return void $e.warn("applyEditAtLevel",`VariableEdit 跳过：路径不存在 -> ${t||"(root)"}`);const i=_.get(s,["$meta","updatable"],!0),l=!1===i&&!0===_.get(a,["$meta","updatable"]);if(!1!==i||l)for(const s of Object.keys(a)){const i=t?`${t}.${s}`:s,l=a[s];if(_.isPlainObject(l)){await Se(e,i,l,n,r,o);continue}if(!_.has(e,i)){$e.warn("applyEditAtLevel",`VariableEdit 失败：路径非法，无法写入 -> ${i}`);continue}$e.debug("applyEditAtLevel",`[旧值查找] 准备为路径 <${i}> 从消息 ID <${r}> 向上追溯...`);let c=await Ce(i,r);null===c?(c=_.get(e,i),$e.debug("applyEditAtLevel",`[旧值查找] 追溯未找到历史值，从当前 stat_data 中获取到旧值: ${JSON.stringify(c)}`)):$e.debug("applyEditAtLevel",`[旧值查找] 追溯成功，找到历史旧值: ${JSON.stringify(c)}`);const d=le(l);_.set(e,i,d),n.push({op:"update",path:i,value_old:_.cloneDeep(c),value_new:_.cloneDeep(d)}),o.set(i,_.cloneDeep(d))}else $e.warn("applyEditAtLevel",`VariableEdit 失败：路径 <${t}> 受 "$meta.updatable: false" 保护，无法被修改。`)}const Ae=new x,Oe=async e=>{Ae.debug("ApplyVarChangeForMessage","开始处理消息...",{msg:e});try{if(!e||"number"!=typeof e.message_id)return Ae.warn("ApplyVarChangeForMessage","无效消息对象或缺少 message_id，退出"),null;const t=e.message_id,a=W(e);if(!a)return Ae.debug("ApplyVarChangeForMessage",`消息 (ID: ${t}) 不含 MK，跳过变量写入。`),null;if(L(e))return Ae.debug("ApplyVarChangeForMessage",`消息 (ID: ${t}) 为用户消息，跳过变量写入，但保留其 MK。`),a;const n=j(e)||"",r=H(n,F("VariableInsert","exact")),o=H(n,F("VariableEdit","exact")),s=H(n,F("VariableDelete","exact"));Ae.debug("ApplyVarChangeForMessage","delete拿到的指令",s),r.length||o.length||s.length||Ae.debug("ApplyVarChangeForMessage",`消息 (ID: ${t}) 未检测到变量修改标签。`);const l=r.flatMap(e=>ue(e)),c=o.flatMap(e=>ue(e)),d=s.flatMap(e=>ue(e)),p=se(l),u=se(c),g=se(d);Ae.debug("ApplyVarChangeForMessage","数据转义完成",{before:{inserts:l,edits:c,deletes:d},after:{inserts:p,edits:u,deletes:g}});const f=[];await async function(e,t){if(e.length>0){await I(async e=>(_e.debug("processInsertBlocks","[初始状态] 进入 processInsertBlocks 时的 statData:",_.cloneDeep(e)),e));for(const a of e)if(_.isPlainObject(a)&&!_.isEmpty(a))try{await I(e=>(_e.debug("processInsertBlocks",`处理 insertRoot: ${JSON.stringify(a)}`),Ne(e,"",a,t,null,null),e))}catch(e){_e.error("processInsertBlocks",`处理 insertRoot 失败: ${e?.message||e}`,e)}_e.log("processInsertBlocks","所有 VariableInsert 操作完成")}}(p,f),await async function(e,t,a){if(e.length>0){const n=new Map;for(const r of e)if(_.isPlainObject(r)&&!_.isEmpty(r))try{await I(async e=>($e.debug("processEditBlocks",`处理 editRoot: ${JSON.stringify(r)}`),await Se(e,"",r,t,a,n),e))}catch(e){$e.error("processEditBlocks",`处理 editRoot 失败: ${e?.message||e}`,e)}$e.log("processEditBlocks","所有 VariableEdit 操作完成")}}(u,f,t),await async function(e,t){if(e.length>0){for(const a of e)if(_.isPlainObject(a)&&!_.isEmpty(a))try{await I(e=>(ye.debug("processDeleteBlocks",`处理 deleteRoot: ${JSON.stringify(a)}`),xe(e,"",a,t),e))}catch(e){ye.error("processDeleteBlocks",`处理 deleteRoot 失败: ${e?.message||e}`,e)}ye.log("processDeleteBlocks","所有 VariableDelete 操作完成")}}(g,f);try{await T(e=>{const n=Array.isArray(f)?f:pe(f);return Ae.debug("ApplyVarChangeForMessage",`准备为 MK=${a} (MsgID=${t}) 写入 EditLog:\n${JSON.stringify(n,null,2)}`),_.set(e,[i,a],JSON.stringify(n)),e}),Ae.debug("ApplyVarChangeForMessage",`成功为 MK=${a} 写入 EditLog。`)}catch(e){Ae.error("ApplyVarChangeForMessage",`为 MK=${a} 写入 EditLogs 失败: ${e?.message||e}`,e)}return a}catch(e){return Ae.error("ApplyVarChangeForMessage",`变量写入器异常: ${e?.message||e}`,e),null}},Me=new x,De=e=>{const t=W(e);return t||null},Ie=async(e=!1)=>{e?Me.warn("resyncStateOnHistoryChange","强制完全重算模式已启动！"):Me.log("resyncStateOnHistoryChange","聊天记录变更，启动状态同步...");const t=getChatMessages("0-{{lastMessageId}}",{include_swipes:!0});Me.debug("resyncStateOnHistoryChange","获取到的 allMessages:",t);const{meta:a}=D(),n=_.cloneDeep(_.get(a,l,[]));if(Me.debug("resyncStateOnHistoryChange",`状态快照: oldSelectedMks.length=${n.length}, allMessages.length=${t?.length??0}`),!t||0===t.length)return void Me.log("resyncStateOnHistoryChange","当前聊天记录为空，不执行任何操作，同步终止。");let r=-1;if(e)r=0,Me.log("resyncStateOnHistoryChange","强制模式：设置重算起点为 0。");else if(t.length<n.length){Me.log("resyncStateOnHistoryChange","检测到消息删除。");for(let e=t.length-1;e>=0;e--){const a=De(t[e]),o=n[e];if(Me.debug("resyncStateOnHistoryChange",`[删除-对齐检查] i=${e}, currentMk=${a}, recordedMk=${o}`),a===o){r=e+1,Me.log("resyncStateOnHistoryChange",`找到对齐点于 message_id=${e} (MK=${a})。将从 ID ${r} 开始检查。`);break}}-1===r&&(r=0,Me.log("resyncStateOnHistoryChange","未找到任何对齐点，将从头开始检查。"));const e=t.map(De).filter(e=>e),a=n.filter(e=>e),o=_.difference(a,e);if(Me.debug("resyncStateOnHistoryChange",`旧MK序列: [${a.join(", ")}]`),Me.debug("resyncStateOnHistoryChange",`新MK序列: [${e.join(", ")}]`),Me.debug("resyncStateOnHistoryChange",`计算出的被删除MK: [${o.join(", ")}]`),o.length>0&&(e=>{const{meta:t}=D();for(const a of e)if(a&&pe(_.get(t,[i,a])).length>0)return!1;return!0})(o)){Me.log("resyncStateOnHistoryChange",`检测到被删除的 ${o.length} 条消息均不含变量修改，执行快速同步。`);const e=[];for(let a=0;a<t.length;a++)e[a]=De(t[a]);return await T(t=>(_.set(t,l,e),t)),void Me.log("resyncStateOnHistoryChange","快速同步完成，仅修正 SelectedMks 数组。")}}else if(t.length===n.length){Me.log("resyncStateOnHistoryChange","检测到消息长度不变，可能为修改或切换。");for(let e=t.length-1;e>=0;e--){const a=De(t[e]),o=n[e];Me.debug("resyncStateOnHistoryChange",`[切换-对齐检查] i=${e}, currentMk=${a}, recordedMk=${o}`),a!==o&&(r=e)}-1===r?(r=t.length>0?t.length-1:0,Me.log("resyncStateOnHistoryChange",`所有MK均匹配。启动模拟写入，强制重算最后一条消息 (ID: ${r})。`)):Me.log("resyncStateOnHistoryChange",`找到最早的不匹配点于 message_id=${r}。将从该点开始重算。`)}else Me.log("resyncStateOnHistoryChange","检测到消息添加。"),r=n.length,Me.log("resyncStateOnHistoryChange",`新增消息的写入逻辑已由同步流程接管。将从新增消息 (ID: ${r}) 开始处理。`);if(r>-1){const e=n.slice(r).filter(e=>e);if(e.length>0){Me.log("resyncStateOnHistoryChange",`准备回滚 ${e.length} 个MK: [${e.join(", ")}]`);for(const t of e.reverse())Me.debug("resyncStateOnHistoryChange",`[回滚] 正在回滚 MK: ${t}`),await Ve(t,!0);Me.log("resyncStateOnHistoryChange","逆序回滚完成。")}}Me.log("resyncStateOnHistoryChange",`从 ID ${r} 开始顺序重算...`);const o=n.slice(0,r);for(let e=r;e<t.length;e++){const a=t[e];Me.debug("resyncStateOnHistoryChange",`[重算] 正在处理消息索引: ${e}`);const n=await Oe(a);o[e]=n}Me.log("resyncStateOnHistoryChange","顺序重算完成。"),await T(e=>(_.set(e,l,o),e)),Me.log("resyncStateOnHistoryChange","状态同步完成。")},Te=new x;async function Be(e){const t=getChatMessages(e);if(!t||0===t.length)return void Te.warn("forceRenderMessage",`找不到消息ID为 ${e} 的消息。`);const a=t[0];await setChatMessages([{message_id:e,message:a.message}]),Te.debug("forceRenderMessage",`已使用 setChatMessages 刷新消息 ${e}。`)}const Re=new x;async function je(e,t,a){const{type:n}=e;Re.debug("handleSyncEvent",`事件 ${n} 触发状态同步流程...`);const r="manual_full_sync"===n;await Ie(r),t.resync=!0,"combo_sync"!=n&&async function(){const e=getVariables({type:"script",script_id:getScriptId()});if(!_.get(e,"强制重载功能",!1))return void Te.debug("forceRenderRecentMessages","强制重载功能未启用, 跳过。");const t=_.get(e,"强制重载消息数",1);Te.log("forceRenderRecentMessages",`开始强制重载, 数量: ${t}`),await new Promise(e=>setTimeout(e,1e3));const a=getChatMessages("0-{{lastMessageId}}");if(!a||0===a.length)return void Te.warn("forceRenderRecentMessages","无法获取到任何消息, 终止重载。");const n=a.slice(-t);for(const e of n)Te.debug("forceRenderRecentMessages",`正在强制渲染消息: ${e.message_id}`),await Be(e.message_id),await new Promise(e=>setTimeout(e,100));Te.log("forceRenderRecentMessages","强制重载完成。")}(),await Q(),me(a)}const Le=new x;let Pe=null;function Je(){const e=y.mk;return e&&Pe&&Pe.mk===e?(Le.debug("updateConsecutiveMkCount",`连续处理写入/同步操作的 MK: ${e}。旧计数: ${Pe.count}，新计数: ${Pe.count+1}`),Pe.count++):(Le.debug("updateConsecutiveMkCount",`新的写入/同步操作的 MK: ${e}。重置计数为 1。前一个 MK 是: ${Pe?.mk}`),Pe={mk:e,count:1}),Pe.count}async function ze(e,t){const{type:a}=e,n=C(a);let r=null;const o={rollback:!1,apply:!1,resync:!1,api:!1,apiWrite:!1};try{const{mk:s,message_id:i,isNewKey:l}=await(async()=>{try{const e=getChatMessages(-1,{include_swipes:!0})?.[0];if(Y.debug("ensureMkForLatestMessage",`获取到的最新消息对象 (msg): ${JSON.stringify(e)}`),!e||"number"!=typeof e.message_id)return Y.warn("ensureMkForLatestMessage","无法读取最新消息或其ID，退出"),{mk:"",message_id:null,isNewKey:!1};const{mk:t,isNew:a}=await G(e);return Y.log("ensureMkForLatestMessage",`已为最新消息 ${e.message_id} 确保 MK 存在。 (是否新建: ${a})`),{mk:t,message_id:e.message_id,isNewKey:a}}catch(e){return Y.error("ensureMkForLatestMessage",`确保MK时异常: ${e?.message||e}`,e),{mk:"",message_id:null,isNewKey:!1}}})();if(!s||null===i)return Le.warn("dispatchAndExecuteTask","无法获取有效的 MK 或消息 ID，跳过任务执行。"),t;y.mk=s,r=i,l&&s&&(t={mk:s,ignoreCount:1});const{shouldSkip:c,newIgnoreRule:d}=function(e,t,a){return a&&e===tavern_events.CHARACTER_MESSAGE_RENDERED&&t===a.mk?(Le.log("handleRedundantRenderEvent",`忽略由 MK (${a.mk}) 注入触发的冗余渲染事件。剩余忽略次数: ${a.ignoreCount-1}`),a.ignoreCount--,a.ignoreCount<=0&&(a=null,Le.log("handleRedundantRenderEvent","忽略次数用完")),{shouldSkip:!0,newIgnoreRule:a}):{shouldSkip:!1,newIgnoreRule:a}}(a,s,t);if(t=d,c)return t;Le.log("dispatchAndExecuteTask",`执行任务: ${a} (分组: ${n})`);const p={mk:s,message_id:r,actions:o,consecutiveProcessingCount:1};switch(n){case"INIT":ee(),p.consecutiveProcessingCount=Je(),await je(e,o,p);break;case"SYNC":p.consecutiveProcessingCount=Je(),await je(e,o,p);break;case"API":he(e,o,p);break;case"UPDATE_MK_ONLY":await async function(){await Q()}()}}catch(e){Le.error("dispatchAndExecuteTask",`事件 ${a} 处理异常: ${e}`,e)}finally{y.mk=""}return t}const Fe=new x,Ke=[];let Ue=!1,He=!1,Ye=null;function We(e,t){Fe.debug("pushToQueue",`接收到事件: ${e}，已推入队列。`,{detail:t}),Ke.push({type:e,detail:t,timestamp:Date.now()}),async function(){if(He)return void Fe.debug("processQueue","已有处理函数在排队等待，本次调用忽略。");Ue&&(Fe.debug("processQueue","处理器忙碌，进入排队等待状态..."),He=!0,await new Promise(e=>{Ye=e}),He=!1,Fe.debug("processQueue","等待结束，获取到处理权。"));if(0===Ke.length)return void Fe.debug("processQueue","队列为空，无需处理。");Ue=!0,Fe.log("processQueue","处理器启动");const e=Ke[0];if("API"!==C(e.type)){const t=V.get(e.type)??300;Fe.log("processQueue",`启动事件收集窗口，等待 ${t}ms...`),await new Promise(e=>setTimeout(e,t))}Fe.debug("processQueue","事件收集窗口关闭，准备处理的队列内容:",JSON.stringify(Ke.map(e=>e.type)));let t=null;for(;Ke.length>0;){const e=Ke.splice(0,Ke.length),a=S(e);Fe.debug("processQueue",`开始处理一个新批次，包含 ${e.length} 个原始事件，合并后为 ${a.length} 个任务。`);for(const e of a){t=await ze(e,t)}Fe.debug("processQueue","本轮批次处理完毕。")}if(Ue=!1,Fe.log("processQueue","处理器空闲，已释放锁。"),Ye){Fe.debug("processQueue","通知排队的处理器开始工作。");const e=Ye;Ye=null,e()}}()}const Ge=new x;$(()=>{registerMacroLike(/{{\s*ERA(-withmeta)?\s*:\s*([^}]+?)\s*}}/gi,(e,t,a,n)=>function(e){if(!e.includes("{{ERA"))return e;const{stat:t}=D();return t?e.replace(/{{\s*ERA(-withmeta)?\s*:\s*([^}]+?)\s*}}/gi,(e,a,n)=>{const r=n.trim(),o=!!a;let s;if(s="$ALLDATA"===r?t:_.get(t,r),void 0===s)return Ge.warn("parseEraMacros",`在 stat_data 中未找到路径 "${r}", 宏将替换为空字符串.`),"";const i=o?s:M(s),l=ie(i);return Ge.debug("parseEraMacros",`宏替换数据反转义: ${r}`,{before:i,after:l}),"object"==typeof l&&null!==l?JSON.stringify(l):String(l)}):(Ge.warn("parseEraMacros","无法获取到 stat_data, 宏替换失败."),e)}(t))});const Qe=Vue,Ze={class:"settings-card",role:"region","aria-label":"ERA 设置"},qe=["aria-expanded"],Xe={class:"chev","aria-hidden":"true"},et={class:"content"},tt={class:"toolbar"},at={class:"vars"},nt=["title"],rt={class:"var-editor"},ot={key:0,class:"switch"},st=["onUpdate:modelValue"],it=["onUpdate:modelValue","placeholder"],lt=["onUpdate:modelValue","placeholder"],ct=["onUpdate:modelValue","placeholder","onInput"],dt={class:"type-chip"},pt=(0,Qe.defineComponent)({__name:"EraSettingsPanel",setup(e){const t=new x("ui-EraSettingsPanel"),a=(0,Qe.ref)(!1),n=(0,Qe.ref)([]),r=(0,Qe.reactive)({}),o=(0,Qe.reactive)({}),s=(0,Qe.reactive)({});function i(e){try{return JSON.stringify(e,null,2)}catch{return String(e)}}function l(){try{const e=getScriptId(),a=getVariables({type:"script",script_id:e})??{};t.debug("loadVars","脚本变量：",a),n.value=[];for(const e of Object.keys(r))delete r[e];for(const e of Object.keys(o))delete o[e];for(const e of Object.keys(s))delete s[e];Object.entries(a).forEach(([e,t])=>{const a="boolean"==typeof(s=t)?"boolean":"number"==typeof s&&Number.isFinite(s)?"number":"string"==typeof s?"string":"json";var s;n.value.push({key:e,value:t,type:a}),"json"===a?o[e]=i(t):r[e]=t})}catch(e){t.error("loadVars","读取脚本变量失败：",e)}}function c(){a.value=!a.value,a.value&&0===n.value.length&&l()}function d(){l()}function p(){try{const e=getScriptId(),a={...getVariables({type:"script",script_id:e})??{}};Object.entries(r).forEach(([e,t])=>{a[e]=t}),Object.entries(o).forEach(([e,t])=>{if(null!=t){if(s[e]?.bad)throw new Error(`键 ${e} 的 JSON 格式不正确`);a[e]=JSON.parse(t)}}),replaceVariables(a,{type:"script",script_id:e}),t.log("saveEdits","脚本变量已保存：",a),eventEmit?.("era:variables_updated",{scope:"script",keys:Object.keys(a)}),l()}catch(e){t.error("saveEdits","保存失败：",e),alert(`保存失败：${e?.message??e}`)}}return(e,t)=>((0,Qe.openBlock)(),(0,Qe.createElementBlock)(Qe.Fragment,null,[(0,Qe.createCommentVNode)(" 外层卡片：与 ActionButtons 保持一致的玻璃卡风格，但默认收起 "),(0,Qe.createElementVNode)("section",Ze,[(0,Qe.createCommentVNode)(" 设置卡片容器 "),(0,Qe.createCommentVNode)(" 标题行：可点击折叠/展开 "),(0,Qe.createElementVNode)("button",{class:"card-header","aria-expanded":a.value,onClick:c},[(0,Qe.createCommentVNode)(" 点击切换展开状态 "),t[0]||(t[0]=(0,Qe.createElementVNode)("span",{class:"title"},"ERA 设置",-1)),(0,Qe.createCommentVNode)(" 标题文字 "),(0,Qe.createElementVNode)("span",Xe,(0,Qe.toDisplayString)(a.value?"▾":"▸"),1),(0,Qe.createCommentVNode)(" 展开箭头 ")],8,qe),(0,Qe.createCommentVNode)(" 内容体：默认收起；展开后显示变量列表与操作 "),(0,Qe.withDirectives)((0,Qe.createElementVNode)("div",et,[(0,Qe.createCommentVNode)(" 展开内容容器 "),(0,Qe.createCommentVNode)(" 顶部操作区：刷新/保存/重置编辑 "),(0,Qe.createElementVNode)("div",tt,[(0,Qe.createCommentVNode)(" 工具条 "),(0,Qe.createElementVNode)("button",{class:"mini-btn",title:"重新读取脚本变量",onClick:(0,Qe.withModifiers)(l,["stop"])},"🔄 重新读取"),(0,Qe.createCommentVNode)(" 读取按钮 "),t[1]||(t[1]=(0,Qe.createElementVNode)("div",{class:"spacer"},null,-1)),(0,Qe.createCommentVNode)(" 占位撑开 "),(0,Qe.createElementVNode)("button",{class:"mini-btn subtle",title:"丢弃未保存的修改",onClick:(0,Qe.withModifiers)(d,["stop"])},"↩︎ 丢弃修改"),(0,Qe.createCommentVNode)(" 丢弃编辑 "),(0,Qe.createElementVNode)("button",{class:"mini-btn primary",title:"保存修改到脚本变量",onClick:(0,Qe.withModifiers)(p,["stop"])},"💾 保存修改"),(0,Qe.createCommentVNode)(" 保存修改 ")]),(0,Qe.createCommentVNode)(" 变量列表：逐项渲染 "),(0,Qe.createElementVNode)("div",at,[n.value.length>0?((0,Qe.openBlock)(),(0,Qe.createElementBlock)(Qe.Fragment,{key:0},[(0,Qe.createCommentVNode)(" 有变量时渲染列表 "),((0,Qe.openBlock)(!0),(0,Qe.createElementBlock)(Qe.Fragment,null,(0,Qe.renderList)(n.value,e=>{return(0,Qe.openBlock)(),(0,Qe.createElementBlock)("div",{key:e.key,class:"var-row"},[(0,Qe.createCommentVNode)(" 每个变量一行 "),(0,Qe.createElementVNode)("label",{class:"var-key",title:e.key},(0,Qe.toDisplayString)(e.key),9,nt),(0,Qe.createCommentVNode)(" 变量名 "),(0,Qe.createCommentVNode)(" 根据变量类型选择不同的编辑控件 "),(0,Qe.createElementVNode)("div",rt,[(0,Qe.createCommentVNode)(" 编辑器容器 "),(0,Qe.createCommentVNode)(" 布尔：勾选框 "),"boolean"===e.type?((0,Qe.openBlock)(),(0,Qe.createElementBlock)("label",ot,[(0,Qe.createCommentVNode)(" 自定义开关外观 "),(0,Qe.withDirectives)((0,Qe.createElementVNode)("input",{"onUpdate:modelValue":t=>r[e.key]=t,type:"checkbox"},null,8,st),[[Qe.vModelCheckbox,r[e.key]]]),(0,Qe.createCommentVNode)(" 勾选值 "),t[2]||(t[2]=(0,Qe.createElementVNode)("span",{class:"track"},null,-1)),(0,Qe.createCommentVNode)(" 轨道 ")])):"number"===e.type?((0,Qe.openBlock)(),(0,Qe.createElementBlock)(Qe.Fragment,{key:1},[(0,Qe.createCommentVNode)(" 数字：number 输入 "),(0,Qe.withDirectives)((0,Qe.createElementVNode)("input",{"onUpdate:modelValue":t=>r[e.key]=t,type:"number",class:"ipt",placeholder:String(e.value)},null,8,it),[[Qe.vModelText,r[e.key],void 0,{number:!0}]]),(0,Qe.createCommentVNode)(" 数字输入 ")],64)):"string"===e.type?((0,Qe.openBlock)(),(0,Qe.createElementBlock)(Qe.Fragment,{key:2},[(0,Qe.createCommentVNode)(" 字符串：text 输入 "),(0,Qe.withDirectives)((0,Qe.createElementVNode)("input",{"onUpdate:modelValue":t=>r[e.key]=t,type:"text",class:"ipt",placeholder:String(e.value)},null,8,lt),[[Qe.vModelText,r[e.key]]]),(0,Qe.createCommentVNode)(" 文本输入 ")],64)):((0,Qe.openBlock)(),(0,Qe.createElementBlock)(Qe.Fragment,{key:3},[(0,Qe.createCommentVNode)(" 其他（对象/数组/null/未知）：JSON 文本域 "),(0,Qe.withDirectives)((0,Qe.createElementVNode)("textarea",{"onUpdate:modelValue":t=>o[e.key]=t,class:"ipt ta",placeholder:i(e.value),onInput:t=>function(e){const t=o[e]??"";if(""!==t.trim())try{JSON.parse(t),s[e]={ok:!0,bad:!1,msg:"JSON 格式有效"}}catch(t){s[e]={bad:!0,ok:!1,msg:`JSON 格式错误：${t?.message??""}`}}else s[e]={bad:!0,ok:!1,msg:"不能为空（若要设为 null 请写 null）"}}(e.key)},null,40,ct),[[Qe.vModelText,o[e.key]]]),(0,Qe.createCommentVNode)(" JSON 文本域 "),(0,Qe.createElementVNode)("span",{class:(0,Qe.normalizeClass)(["hint",{ok:s[e.key]?.ok,bad:s[e.key]?.bad}])},(0,Qe.toDisplayString)(s[e.key]?.msg??"以 JSON 格式编辑此值"),3),(0,Qe.createCommentVNode)(" JSON 校验提示 ")],64))]),(0,Qe.createCommentVNode)(" 类型徽标 "),(0,Qe.createElementVNode)("span",dt,(0,Qe.toDisplayString)((a=e.type,"boolean"===a?"布尔":"number"===a?"数字":"string"===a?"字符串":"JSON")),1),(0,Qe.createCommentVNode)(" 类型展示 ")]);var a}),128))],64)):((0,Qe.openBlock)(),(0,Qe.createElementBlock)(Qe.Fragment,{key:1},[(0,Qe.createCommentVNode)(" 没有变量时的占位 "),t[3]||(t[3]=(0,Qe.createElementVNode)("div",{class:"placeholder"},[(0,Qe.createElementVNode)("p",null,"未读取到任何脚本变量。"),(0,Qe.createCommentVNode)(" 文本提示 "),(0,Qe.createElementVNode)("p",{class:"dim"},[(0,Qe.createTextVNode)(" 请先确保在 "),(0,Qe.createElementVNode)("code",null,"app_ready"),(0,Qe.createTextVNode)(" 或初始化阶段通过 "),(0,Qe.createElementVNode)("code",null,"initializeExternalSettings()"),(0,Qe.createTextVNode)(" 写入默认变量。 ")]),(0,Qe.createCommentVNode)(" 辅助说明 ")],-1))],64))])],512),[[Qe.vShow,a.value]])])],2112))}});n(223);var ut=n(42);const gt=(0,ut.A)(pt,[["__scopeId","data-v-3c2a864c"]]),ft={class:"action-buttons-card",role:"complementary","aria-label":"ERA 快捷操作"},mt={class:"btns"},bt=(0,Qe.defineComponent)({__name:"ActionButtons",setup(e){const t=new x("ui-ActionButtons");function a(){t.log("onFullSync","点击“完全重算变量”，发送 manual_full_sync 事件。"),eventEmit("manual_full_sync")}function n(){t.log("onLastSync","点击“重算最后一楼变量”，发送 manual_sync 事件。"),eventEmit("manual_sync")}return(e,t)=>((0,Qe.openBlock)(),(0,Qe.createElementBlock)(Qe.Fragment,null,[(0,Qe.createCommentVNode)(" 右侧操作卡：外层自包含，不依赖父组件样式 "),(0,Qe.createElementVNode)("section",ft,[(0,Qe.createCommentVNode)(" 中文注释：操作卡容器 "),t[4]||(t[4]=(0,Qe.createElementVNode)("h4",{class:"card-title"},"快捷操作",-1)),(0,Qe.createCommentVNode)(" 中文注释：卡片标题 "),(0,Qe.createElementVNode)("div",mt,[(0,Qe.createCommentVNode)(" 中文注释：按钮垂直栈 "),(0,Qe.createElementVNode)("button",{class:"btn primary",title:"重新计算所有变量",onClick:(0,Qe.withModifiers)(a,["stop"])},[(0,Qe.createCommentVNode)(" 中文注释：主按钮 "),t[0]||(t[0]=(0,Qe.createElementVNode)("span",{class:"ico","aria-hidden":"true"},"🔄",-1)),(0,Qe.createCommentVNode)(" 中文注释：图标 "),t[1]||(t[1]=(0,Qe.createElementVNode)("span",{class:"label"},"完全重算变量",-1)),(0,Qe.createCommentVNode)(" 中文注释：文字 ")]),(0,Qe.createElementVNode)("button",{class:"btn subtle",title:"只重算最新一楼的变量",onClick:(0,Qe.withModifiers)(n,["stop"])},[(0,Qe.createCommentVNode)(" 中文注释：次按钮 "),t[2]||(t[2]=(0,Qe.createElementVNode)("span",{class:"ico","aria-hidden":"true"},"♻️",-1)),(0,Qe.createCommentVNode)(" 中文注释：图标 "),t[3]||(t[3]=(0,Qe.createElementVNode)("span",{class:"label"},"重算最后一楼变量",-1)),(0,Qe.createCommentVNode)(" 中文注释：文字 ")])])])],2112))}});n(865);const vt=(0,ut.A)(bt,[["__scopeId","data-v-5766043a"]]),ht=(0,Qe.defineComponent)({__name:"FloatingBall",emits:["click"],setup(e){const t=new x("ui-FloatingBall");return(0,Qe.onMounted)(()=>{t.log("onMounted","FloatingBall.vue 组件已挂载")}),(e,t)=>((0,Qe.openBlock)(),(0,Qe.createElementBlock)("div",{class:"floating-ball",onClick:t[0]||(t[0]=t=>e.$emit("click"))},[t[1]||(t[1]=(0,Qe.createElementVNode)("span",{class:"era-logo","aria-hidden":"true"},"ERA",-1)),(0,Qe.createCommentVNode)(" 仅显示用；不拦截事件 ")]))}});n(836);const yt=(0,ut.A)(ht,[["__scopeId","data-v-ee0f5b22"]]),xt={class:"acc"},wt=["aria-expanded"],kt={class:"title"},_t={class:"hint"},Nt={class:"inner"},Et=(0,Qe.defineComponent)({__name:"EraAccordion",props:{title:{},defaultOpen:{type:Boolean,default:!1}},setup(e){const t=e,a=(0,Qe.ref)(t.defaultOpen);return(t,n)=>((0,Qe.openBlock)(),(0,Qe.createElementBlock)("section",xt,[(0,Qe.createCommentVNode)(" 折叠头：点击切换 "),(0,Qe.createElementVNode)("button",{class:"acc-head","aria-expanded":a.value?"true":"false",onClick:n[0]||(n[0]=e=>a.value=!a.value)},[(0,Qe.createElementVNode)("span",{class:(0,Qe.normalizeClass)(["caret",{open:a.value}])},"▸",2),(0,Qe.createCommentVNode)(" 指示箭头 "),(0,Qe.createElementVNode)("span",kt,(0,Qe.toDisplayString)(e.title),1),(0,Qe.createCommentVNode)(" 标题文本 "),n[1]||(n[1]=(0,Qe.createElementVNode)("span",{class:"spacer"},null,-1)),(0,Qe.createCommentVNode)(" 弹性空隙 "),(0,Qe.createElementVNode)("span",_t,(0,Qe.toDisplayString)(a.value?"收起":"展开"),1),(0,Qe.createCommentVNode)(" 右侧提示 ")],8,wt),(0,Qe.createCommentVNode)(" 内容：高度过渡（使用 CSS Grid） "),(0,Qe.createElementVNode)("div",{class:(0,Qe.normalizeClass)(["acc-body",{open:a.value}])},[(0,Qe.createElementVNode)("div",Nt,[(0,Qe.renderSlot)(t.$slots,"default")])],2)]))}});n(532);const Vt=(0,ut.A)(Et,[["__scopeId","data-v-cb8a53de"]]),Ct={class:"meta"},$t={class:"kv"},St={class:"item"},At=["title"],Ot={class:"item"},Mt={class:"v"},Dt=(0,Qe.defineComponent)({__name:"MetaHeader",props:{mk:{},messageId:{}},setup(e){const t=new x("ui-MetaHeader"),a=e;return(0,Qe.onMounted)(()=>{t.log("onMounted","组件已挂载",{props:a})}),(0,Qe.watch)(()=>a,e=>{t.debug("watch:props","Props 发生变化",{newProps:e})},{deep:!0}),(t,a)=>((0,Qe.openBlock)(),(0,Qe.createElementBlock)("section",Ct,[a[2]||(a[2]=(0,Qe.createElementVNode)("h4",{class:"meta-title"},"最新消息元数据",-1)),(0,Qe.createCommentVNode)(" 小节标题 "),(0,Qe.createElementVNode)("div",$t,[(0,Qe.createElementVNode)("div",St,[a[0]||(a[0]=(0,Qe.createElementVNode)("span",{class:"k"},"mk",-1)),(0,Qe.createCommentVNode)(" 键：mk "),(0,Qe.createElementVNode)("span",{class:"v",title:e.mk},(0,Qe.toDisplayString)(e.mk||"—"),9,At),(0,Qe.createCommentVNode)(" 值：mk ")]),(0,Qe.createElementVNode)("div",Ot,[a[1]||(a[1]=(0,Qe.createElementVNode)("span",{class:"k"},"message_id",-1)),(0,Qe.createCommentVNode)(" 键：message_id "),(0,Qe.createElementVNode)("span",Mt,(0,Qe.toDisplayString)(e.messageId??"—"),1),(0,Qe.createCommentVNode)(" 值：message_id ")])]),a[3]||(a[3]=(0,Qe.createElementVNode)("div",{class:"glow"},null,-1)),(0,Qe.createCommentVNode)(" 装饰：流光条 ")]))}});n(530);const It=(0,ut.A)(Dt,[["__scopeId","data-v-56f5fbd7"]]),Tt={class:"node"},Bt={class:"key"},Rt={class:"brace"},jt={key:0,class:"summary"},Lt={key:0,class:"json-children"},Pt={class:"brace"};const Jt=(0,Qe.defineComponent)({name:"JsonNode",props:{k:{type:[String,Number],required:!0},v:{required:!0},path:{type:String,required:!0},level:{type:Number,required:!0},defaultCollapsed:{type:Boolean,default:!0},maxDepth:{type:Number,default:3}},setup(e){const t=new x(`ui-JsonNode[${e.path}]`);(0,Qe.onMounted)(()=>{t.log("onMounted","组件已挂载",{props:e})});const a=(0,Qe.computed)(()=>{const t=e.v;if(null===t)return"null";if(Array.isArray(t))return"array";const a=typeof t;return"object"===a?"object":"undefined"===a?"undefined":a}),n=(0,Qe.computed)(()=>"array"===a.value),r=(0,Qe.computed)(()=>"object"===a.value),o=(0,Qe.computed)(()=>n.value||r.value),s=(0,Qe.ref)(e.level<=(e.maxDepth??3)||!e.defaultCollapsed);(0,Qe.watch)(s,e=>{t.debug("watch:open","折叠状态改变为: "+(e?"展开":"收起"))});const i=(0,Qe.computed)(()=>{const t=e.v;switch(a.value){case"string":return JSON.stringify(t);case"number":case"symbol":return String(t);case"boolean":return t?"true":"false";case"null":return"null";case"undefined":return"undefined";case"bigint":return String(t)+"n";case"function":return"ƒ()";default:return""}}),l=(0,Qe.computed)(()=>n.value?`Array[${e.v.length}]`:r.value?`Object{${Object.keys(e.v||{}).length}}`:""),c=(0,Qe.computed)(()=>{if(r.value)return e.v;if(n.value){const t={};return e.v.forEach((e,a)=>{t[String(a)]=e}),t}return{}});return{type:a,isArray:n,foldable:o,open:s,primitiveText:i,summary:l,childEntries:c}}});n(168);const zt=(0,ut.A)(Jt,[["render",function(e,t,a,n,r,o){const s=(0,Qe.resolveComponent)("JsonNode",!0);return(0,Qe.openBlock)(),(0,Qe.createElementBlock)(Qe.Fragment,null,[(0,Qe.createCommentVNode)(" 单条节点（支持递归） "),(0,Qe.createElementVNode)("div",Tt,[(0,Qe.createCommentVNode)(" 每个键值对 / 数组项的容器 "),(0,Qe.createElementVNode)("div",{class:"json-line",style:(0,Qe.normalizeStyle)({paddingLeft:14*e.level+"px"})},[(0,Qe.createCommentVNode)(" 行+缩进 "),e.foldable?((0,Qe.openBlock)(),(0,Qe.createElementBlock)("button",{key:0,class:(0,Qe.normalizeClass)(["caret",{open:e.open}]),"aria-label":"toggle",onClick:t[0]||(t[0]=t=>e.open=!e.open)},"▸",2)):(0,Qe.createCommentVNode)("v-if",!0),(0,Qe.createCommentVNode)(" 折叠箭头按钮 "),(0,Qe.createElementVNode)("span",Bt,(0,Qe.toDisplayString)(e.k),1),t[1]||(t[1]=(0,Qe.createElementVNode)("span",{class:"colon"},":",-1)),(0,Qe.createCommentVNode)(" 键与冒号 "),(0,Qe.createCommentVNode)(" 可折叠容器：只显示括号与摘要；展开后由下方 children 区域递归渲染 "),e.foldable?((0,Qe.openBlock)(),(0,Qe.createElementBlock)(Qe.Fragment,{key:1},[(0,Qe.createElementVNode)("span",Rt,(0,Qe.toDisplayString)(e.isArray?"[":"{"),1),(0,Qe.createCommentVNode)(" 容器起始括号 "),e.open?(0,Qe.createCommentVNode)("v-if",!0):((0,Qe.openBlock)(),(0,Qe.createElementBlock)("span",jt,(0,Qe.toDisplayString)(e.summary),1)),(0,Qe.createCommentVNode)(" 收起时的摘要 ")],64)):((0,Qe.openBlock)(),(0,Qe.createElementBlock)(Qe.Fragment,{key:2},[(0,Qe.createCommentVNode)(" 原始值：直接着色渲染 "),(0,Qe.createElementVNode)("span",{class:(0,Qe.normalizeClass)(["val",e.type])},(0,Qe.toDisplayString)(e.primitiveText),3),(0,Qe.createCommentVNode)(" 原始值文本 ")],64))],4),(0,Qe.createCommentVNode)(" 子元素区域：仅当可折叠且处于展开态时显示 "),e.foldable&&e.open?((0,Qe.openBlock)(),(0,Qe.createElementBlock)("div",Lt,[(0,Qe.createCommentVNode)(" 递归：自引用同名组件 JsonNode（依赖 name: 'JsonNode' 实现自递归） "),((0,Qe.openBlock)(!0),(0,Qe.createElementBlock)(Qe.Fragment,null,(0,Qe.renderList)(e.childEntries,(t,a)=>((0,Qe.openBlock)(),(0,Qe.createBlock)(s,{key:e.path+"/"+String(a),k:String(a),v:t,path:e.path+"/"+String(a),level:e.level+1,"default-collapsed":e.defaultCollapsed,"max-depth":e.maxDepth},null,8,["k","v","path","level","default-collapsed","max-depth"]))),128)),(0,Qe.createElementVNode)("div",{class:"json-line",style:(0,Qe.normalizeStyle)({paddingLeft:14*e.level+"px"})},[(0,Qe.createElementVNode)("span",Pt,(0,Qe.toDisplayString)(e.isArray?"]":"}"),1),(0,Qe.createCommentVNode)(" 容器闭合括号 ")],4)])):(0,Qe.createCommentVNode)("v-if",!0)])],2112)}],["__scopeId","data-v-4cec1669"]]),Ft={class:"json-root"},Kt={class:"json-line"},Ut={class:"brace"},Ht={class:"json-children"},Yt={key:1,class:"json-line",style:{paddingLeft:"14px"}},Wt={class:"json-line"},Gt={class:"brace"},Qt=(0,Qe.defineComponent)({__name:"PrettyJsonViewer",props:{value:{},defaultCollapsed:{type:Boolean,default:!0},maxDepth:{default:3}},setup(e){const t=new x,a=e,n=(0,Qe.computed)(()=>{const e=a.value,n=null!==e&&"object"==typeof e;return t.debug("isPlainObjectOrArray",`计算结果: ${n}。该值${n?"是":"不是"}普通对象或数组。`,{传入值:e}),n}),r=(0,Qe.computed)(()=>{const e=a.value;let n;if(null===e)n="null";else if(Array.isArray(e))n="array";else{const t=typeof e;n="undefined"===t?"undefined":t}return t.debug("primitiveType",`计算原始值类型: ${n}`,{传入值:e}),n}),o=(0,Qe.computed)(()=>{const e=a.value;let n;switch(r.value){case"string":n=JSON.stringify(e);break;case"number":case"symbol":n=String(e);break;case"boolean":n=e?"true":"false";break;case"null":n="null";break;case"undefined":n="undefined";break;case"bigint":n=String(e)+"n";break;case"function":n="ƒ()";break;default:n=""}return t.debug("primitiveText",`格式化原始值文本: "${n}"`,{传入值:e,类型:r.value}),n}),s=(0,Qe.computed)(()=>{const e=Array.isArray(a.value);return t.debug("isArrayRoot",`计算根节点是否为数组: ${e}`,{传入值:a.value}),e}),i=(0,Qe.computed)(()=>s.value?"[":"{"),l=(0,Qe.computed)(()=>s.value?"]":"}");return(t,a)=>((0,Qe.openBlock)(),(0,Qe.createElementBlock)("div",Ft,[(0,Qe.createElementVNode)("div",Kt,[(0,Qe.createElementVNode)("span",Ut,(0,Qe.toDisplayString)(i.value),1),(0,Qe.createCommentVNode)(" 根开括号：对象{ / 数组[ ")]),(0,Qe.createElementVNode)("div",Ht,[n.value?((0,Qe.openBlock)(!0),(0,Qe.createElementBlock)(Qe.Fragment,{key:0},(0,Qe.renderList)(e.value,(t,a)=>((0,Qe.openBlock)(),(0,Qe.createBlock)(zt,{key:String(a),k:String(a),v:t,path:String(a),level:1,"default-collapsed":e.defaultCollapsed,"max-depth":e.maxDepth},null,8,["k","v","path","default-collapsed","max-depth"]))),128)):((0,Qe.openBlock)(),(0,Qe.createElementBlock)("div",Yt,[a[0]||(a[0]=(0,Qe.createElementVNode)("span",{class:"key"},"value",-1)),a[1]||(a[1]=(0,Qe.createElementVNode)("span",{class:"colon"},":",-1)),(0,Qe.createElementVNode)("span",{class:(0,Qe.normalizeClass)(["val",r.value])},(0,Qe.toDisplayString)(o.value),3)]))]),(0,Qe.createElementVNode)("div",Wt,[(0,Qe.createElementVNode)("span",Gt,(0,Qe.toDisplayString)(l.value),1),(0,Qe.createCommentVNode)(" 根闭括号：对象} / 数组] ")])]))}});n(234);const Zt=(0,ut.A)(Qt,[["__scopeId","data-v-eebe0c8c"]]),qt={class:"tabs"},Xt={class:"tab-bar",role:"tablist"},ea=["onClick"],ta={class:"tab-content"},aa={key:0},na={key:1},ra=(0,Qe.defineComponent)({__name:"TabSwitch",props:{tabs:{},active:{}},emits:["update:active"],setup(e,{emit:t}){const a=new x("ui-TabSwitch"),n=e,r=t,o=(0,Qe.ref)(n.active??"pure");return(0,Qe.watch)(()=>n.active,e=>{e&&(a.debug("watch:active",`外部同步 active tab 为: ${e}`),o.value=e)}),(0,Qe.onMounted)(()=>{a.log("onMounted","组件已挂载",{props:n})}),(t,n)=>((0,Qe.openBlock)(),(0,Qe.createElementBlock)("section",qt,[(0,Qe.createCommentVNode)(" 页签行 "),(0,Qe.createElementVNode)("div",Xt,[((0,Qe.openBlock)(!0),(0,Qe.createElementBlock)(Qe.Fragment,null,(0,Qe.renderList)(e.tabs,e=>((0,Qe.openBlock)(),(0,Qe.createElementBlock)("button",{key:e.key,class:(0,Qe.normalizeClass)(["tab-btn",{active:e.key===o.value}]),role:"tab",onClick:t=>{return n=e.key,a.log("setActive",`用户点击，切换 tab 到: ${n}`),o.value=n,void r("update:active",n);var n}},(0,Qe.toDisplayString)(e.label),11,ea))),128))]),(0,Qe.createCommentVNode)(" 内容区：根据活动键渲染对应插槽 "),(0,Qe.createElementVNode)("div",ta,["pure"===o.value?((0,Qe.openBlock)(),(0,Qe.createElementBlock)("div",aa,[(0,Qe.renderSlot)(t.$slots,"pure"),(0,Qe.createCommentVNode)(" 纯净状态数据内容 ")])):((0,Qe.openBlock)(),(0,Qe.createElementBlock)("div",na,[(0,Qe.renderSlot)(t.$slots,"full"),(0,Qe.createCommentVNode)(" 完整状态数据内容 ")]))])]))}});n(872);const oa=(0,ut.A)(ra,[["__scopeId","data-v-7ab146e6"]]),sa={class:"era-app-container"},ia={class:"era-expanded-layer"},la={class:"era-shell"},ca={class:"era-panel"},da={class:"panel-top"},pa={class:"panel-body"},ua={style:{display:"flex","flex-direction":"column",gap:"8px"}},ga={class:"right-rail"},fa=(0,Qe.defineComponent)({__name:"App",props:{initialView:{type:String,required:!0,default:"FloatingBall"},eventData:{type:Object,default:()=>null}},setup(e){const t=new x("ui-App"),a=e,n=(0,Qe.ref)(a.initialView),r=e=>{t.debug("requestSwitchView",`请求切换视图到: ${e}`),window.eraUiSwitchView?window.eraUiSwitchView(e):t.warn("requestSwitchView","全局切换函数 eraUiSwitchView 未找到")},o=(0,Qe.computed)(()=>a.eventData||null),s=[{key:"pure",label:"纯净状态数据"},{key:"full",label:"完整状态数据"}],i=(0,Qe.ref)("pure");return(0,Qe.onMounted)(()=>{t.log("onMounted","App.vue 组件已挂载",{props:a})}),(0,Qe.watch)(()=>a.eventData,(e,a)=>{t.debug("watch:eventData","eventData prop 发生变化",{newData:e,oldData:a})},{deep:!0}),(0,Qe.watch)(()=>a.initialView,e=>{t.debug("watch:initialView",`initialView prop 发生变化，新视图: ${e}`),n.value=e}),(e,t)=>((0,Qe.openBlock)(),(0,Qe.createElementBlock)("div",sa,[(0,Qe.withDirectives)((0,Qe.createVNode)(yt,{onClick:t[0]||(t[0]=e=>r("ExpandedView"))},null,512),[[Qe.vShow,"FloatingBall"===n.value]]),(0,Qe.withDirectives)((0,Qe.createElementVNode)("div",ia,[(0,Qe.createCommentVNode)(" 视口级展开层：悬浮模态容器 "),(0,Qe.createElementVNode)("div",la,[(0,Qe.createCommentVNode)(" 新增横向壳容器：左面板 + 右侧栏 "),(0,Qe.createCommentVNode)(" 中文注释：横向布局容器 "),(0,Qe.createElementVNode)("div",ca,[(0,Qe.createCommentVNode)(" 保持面板原有结构不变 "),(0,Qe.createCommentVNode)(" 中文注释：左侧 ERA 面板 "),(0,Qe.createCommentVNode)(" 顶部栏：标题 + 关闭按钮 "),(0,Qe.createCommentVNode)(" 中文注释：面板顶部 "),(0,Qe.createElementVNode)("header",da,[(0,Qe.createCommentVNode)(" 中文注释：顶栏 "),t[3]||(t[3]=(0,Qe.createElementVNode)("h3",{class:"panel-title"},"ERA 数据面板",-1)),(0,Qe.createCommentVNode)(" 中文注释：标题 "),(0,Qe.createElementVNode)("button",{class:"btn-close","aria-label":"关闭",onClick:t[1]||(t[1]=e=>r("FloatingBall"))},"×"),(0,Qe.createCommentVNode)(" 中文注释：关闭按钮 ")]),(0,Qe.createCommentVNode)(" 内容区（原样保留） "),(0,Qe.createCommentVNode)(" 中文注释：面板主体 "),(0,Qe.createElementVNode)("div",pa,[(0,Qe.createCommentVNode)(" 中文注释：可滚动内容 "),o.value?((0,Qe.openBlock)(),(0,Qe.createElementBlock)(Qe.Fragment,{key:0},[(0,Qe.createCommentVNode)(" 中文注释：有数据则渲染 "),(0,Qe.createVNode)(It,{mk:o.value.mk,"message-id":o.value.message_id},null,8,["mk","message-id"]),(0,Qe.createCommentVNode)(" 中文注释：最新消息元数据 "),(0,Qe.createVNode)(Vt,{title:"ERA 最新操作详情","default-open":!1},{default:(0,Qe.withCtx)(()=>[(0,Qe.createCommentVNode)(" 中文注释：插槽 "),(0,Qe.createElementVNode)("div",ua,[(0,Qe.createCommentVNode)(" 中文注释：堆叠两个子折叠 "),(0,Qe.createVNode)(Vt,{title:"SelectedMks（数组）","default-open":!1},{default:(0,Qe.withCtx)(()=>[(0,Qe.createCommentVNode)(" 中文注释：插槽 "),(0,Qe.createVNode)(Zt,{value:o.value.selectedMks,"default-collapsed":!0,"max-depth":3},null,8,["value"]),(0,Qe.createCommentVNode)(" 中文注释：JSON 视图 ")]),_:1}),(0,Qe.createVNode)(Vt,{title:"EditLogs（对象）","default-open":!1},{default:(0,Qe.withCtx)(()=>[(0,Qe.createCommentVNode)(" 中文注释：插槽 "),(0,Qe.createVNode)(Zt,{value:o.value.editLogs,"default-collapsed":!0,"max-depth":2},null,8,["value"]),(0,Qe.createCommentVNode)(" 中文注释：JSON 视图 ")]),_:1})])]),_:1}),(0,Qe.createVNode)(oa,{active:i.value,"onUpdate:active":t[2]||(t[2]=e=>i.value=e),tabs:s},{pure:(0,Qe.withCtx)(()=>[(0,Qe.createCommentVNode)(" 中文注释：纯净状态数据 "),(0,Qe.createVNode)(Zt,{value:o.value.statWithoutMeta,"default-collapsed":!0,"max-depth":1/0},null,8,["value"]),(0,Qe.createCommentVNode)(" 中文注释：JSON 视图 ")]),full:(0,Qe.withCtx)(()=>[(0,Qe.createCommentVNode)(" 中文注释：完整状态数据 "),(0,Qe.createVNode)(Zt,{value:o.value.stat,"default-collapsed":!0,"max-depth":1/0},null,8,["value"]),(0,Qe.createCommentVNode)(" 中文注释：JSON 视图 ")]),_:1},8,["active"])],64)):((0,Qe.openBlock)(),(0,Qe.createElementBlock)(Qe.Fragment,{key:1},[(0,Qe.createCommentVNode)(" 中文注释：暂无数据占位 "),t[4]||(t[4]=(0,Qe.createElementVNode)("div",{class:"empty"},"等待 era:writeDone 事件数据…",-1)),(0,Qe.createCommentVNode)(" 中文注释：占位提示 ")],64))])]),(0,Qe.createCommentVNode)(" 右侧固定栏：只改变“位置/外部结构”，不改按钮逻辑 "),(0,Qe.createElementVNode)("aside",ga,[(0,Qe.createCommentVNode)(" 中文注释：右侧栏容器 "),(0,Qe.createVNode)(vt),(0,Qe.createCommentVNode)(" 中文注释：操作按钮组件（事件保持不变） "),(0,Qe.createVNode)(gt),(0,Qe.createCommentVNode)(" 中文注释：新增的“ERA 设置”拓展卡，默认收起 ")])])],512),[[Qe.vShow,"ExpandedView"===n.value]])]))}});n(447),n(737);const ma=(0,ut.A)(fa,[["__scopeId","data-v-2eb98172"]]);const ba=new x("ui-index");let va=null,ha=null,ya="FloatingBall",xa=null;function wa(t,a){ba.debug("renderApp",`开始渲染 App，视图: ${t}`,{dataToPass:a}),ha?(va&&(ba.debug("renderApp","卸载旧的 Vue 实例"),va.unmount()),va=(0,Qe.createApp)(ma,{initialView:t,eventData:a}),va.use(e()),va.mount(ha[0]),function(){const e=getScriptId();$(`head > div[script_id="${e}"]`).remove();const t=$("<div>").attr("script_id",e).append($("head > style",document).clone());$("head").append(t)}(),ba.debug("renderApp","渲染完成")):ba.warn("renderApp","挂载点不存在，渲染中止")}window.eraUiSwitchView=function(e){ba.debug("switchView",`请求切换视图到: ${e}`),ya!==e?(ya=e,ba.log("switchView","视图已切换，重新渲染 App"),wa(e,xa)):ba.debug("switchView",`视图已经是 ${e}，无需切换`)},$(()=>{ba.log("$(document).ready","UI 脚本开始初始化"),ha=$("<div>").attr("id",`era-ui-mount-point-${getScriptId()}`).css({position:"fixed",bottom:"20px",left:"20px","z-index":1e4}),ba.debug("$(document).ready","创建挂载点",ha),$("body").append(ha),ba.debug("$(document).ready","挂载点已添加到 body"),wa(ya,xa),eventOn("era:writeDone",e=>{ba.log("era:writeDone","接收到 era:writeDone 事件，准备刷新 UI",e),xa=e,wa(ya,xa)}),ba.debug("$(document).ready","已设置 era:writeDone 事件监听器")}),$(window).on("pagehide",()=>{ba.log("pagehide","UI 脚本开始卸载"),va&&(ba.debug("pagehide","卸载 Vue 实例"),va.unmount()),$(`head > div[script_id="${getScriptId()}"]`).remove(),ha&&(ba.debug("pagehide","销毁挂载点"),$(`div#era-ui-mount-point-${getScriptId()}`).remove()),ba.log("pagehide","UI 脚本卸载完成")});[...k.INIT,...k.SYNC,...k.API,...k.UPDATE_MK_ONLY,...k.COLLISION_DETECTORS,...k.COMBO_STARTERS].forEach(e=>{eventOn(e,t=>We(e,t))}),eventOn(getButtonEvent("写入变量修改"),()=>We("manual_write")),eventOn(getButtonEvent("手动同步状态"),()=>We("manual_sync")),eventOn(getButtonEvent("强制完全重算"),()=>We("manual_full_sync"));